<!DOCTYPE html>
<html lang="en">

<head>
  <title>NextGen Digital Library | Web Development Project by Aditya Kumar</title>
  <meta name="description"
    content="NextGen Digital Library - A modern web platform for digital resources. Created by Aditya Kumar, Web Developer.">
  <meta name="keywords" content="NextGen, Digital Library, Aditya Kumar, Web Developer, NIELIT, Project">
  <meta name="author" content="Aditya Kumar">

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://adityakumar12xyz.github.io/NextGen/">
  <meta property="og:title" content="NextGen Digital Library - Aditya Kumar">
  <meta property="og:description"
    content="Explore the NextGen Digital Library, a web development project showcasing digital resource management.">
  <meta name="google-site-verification" content="9uLHaP53sHpPBy6U9jzpeNOmJIbCl11ZRMo8hN7dyaw" />

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>NextGen Library</title>
  <link rel="icon" type="image/png" href="favicon1.png">

  <!-- Cropper.js CSS for circular photo cropping -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <!-- Google Fonts: Outfit for Premium Branding -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">

  <style>
    /* Add external dependencies here */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* Animated Gradient Background */
      background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364, #0b132b, #1c2541);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: white;
      transition: 0.4s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Interactive VFX Canvas */
    #vfx-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
      opacity: 0.6;
    }

    /* Background Animation Keyframes */
    @keyframes gradientBG {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* HEADER */
    #globalTicker {
      background: #ff4757;
      color: white;
      padding: 8px;
      font-weight: bold;
      text-align: center;
      font-size: 14px;
      display: none;
    }

    header {
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #000000cc;
      flex-wrap: wrap;
    }

    @media (max-width: 480px) {
      header {
        padding: 10px;
        flex-direction: row;
        justify-content: space-between;
        gap: 10px;
      }

      header h2 {
        margin: 0;
        font-size: 20px;
      }
    }

    /* SEARCH */
    input {
      padding: 8px;
      border: none;
      border-radius: 5px;
    }

    /* LOGIN SCREEN */
    #loginScreen {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      /* Transparent background to show body animated gradient */
      background: transparent;
      backdrop-filter: blur(5px);
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 999;
    }

    .light #loginScreen {
      background: rgba(240, 244, 248, 0.8);
    }

    .login-box {
      /* Advanced Glassmorphism */
      background: rgba(15, 32, 39, 0.45);
      border: 1px solid rgba(0, 255, 255, 0.2);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      width: 95%;
      max-width: 420px;
      margin: 10px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .login-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 255, 255, 0.15), inset 0 0 20px rgba(0, 255, 255, 0.2);
    }

    .light .login-box {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .login-box h2 {
      margin-bottom: 25px;
      color: cyan;
      font-size: 28px;
      text-shadow: 0 0 10px cyan;
    }

    .light .login-box h2 {
      color: #0056b3;
      text-shadow: none;
    }

    .login-input {
      width: 100%;
      padding: 14px;
      margin-bottom: 20px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 255, 0.3);
      color: white;
      font-size: 16px;
      outline: none;
      box-sizing: border-box;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .light .login-input {
      background: rgba(255, 255, 255, 0.7);
      color: #333;
      border: 1px solid rgba(0, 86, 179, 0.3);
    }

    .login-input:focus {
      box-shadow: 0 0 10px cyan;
    }

    .light .login-input:focus {
      box-shadow: 0 0 10px #0056b3;
      border-color: #0056b3;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
      font-size: 18px;
      background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .light .login-btn {
      background: linear-gradient(90deg, #0056b3 0%, #007bff 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(0, 86, 179, 0.3);
    }

    .login-btn:hover {
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
      transform: translateY(-3px) scale(1.02);
    }

    .light .login-btn:hover {
      background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
      box-shadow: 0 6px 15px rgba(0, 86, 179, 0.4);
      transform: translateY(-2px);
    }

    .auth-toggle {
      margin-top: 15px;
      font-size: 14px;
      color: #ddd;
    }

    .light .auth-toggle {
      color: #666;
    }

    .auth-toggle span {
      color: cyan;
      cursor: pointer;
      text-decoration: underline;
      font-weight: bold;
    }

    .light .auth-toggle span {
      color: #0056b3;
    }

    .admin-link {
      margin-top: 15px;
      font-size: 13px;
      color: #888;
      text-align: right;
      cursor: pointer;
      transition: 0.3s;
    }

    .admin-link:hover {
      color: cyan;
    }

    /* ADMIN DASHBOARD */
    #adminDashboard {
      display: none;
      padding: 40px;
      max-width: 1200px;
      margin: 40px auto;
      background: rgba(15, 32, 39, 0.85);
      border: 1px solid rgba(0, 242, 254, 0.3);
      border-radius: 20px;
      color: white;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(0, 242, 254, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .light #adminDashboard {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 86, 179, 0.3);
      color: #333;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .admin-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 25px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .admin-table th,
    .admin-table td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 16px;
      text-align: left;
      background: rgba(0, 0, 0, 0.2);
    }

    .admin-table tr:last-child td {
      border-bottom: none;
    }

    .admin-table tr:hover td {
      background: rgba(0, 242, 254, 0.05);
    }

    .light .admin-table th,
    .light .admin-table td {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.5);
    }

    .admin-table th {
      background: linear-gradient(90deg, #0f2027 0%, #203a43 100%);
      color: #00f2fe;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }

    .light .admin-table th {
      background: #f0f4f8;
      color: #0056b3;
    }

    /* CMS DYNAMIC FIELDS */
    .cms-dynamic-field {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .cms-add-btn {
      background: linear-gradient(90deg, #00cec9 0%, #81ecec 100%);
      color: #2d3436;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-top: 5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 206, 201, 0.3);
    }

    .cms-add-btn:hover {
      box-shadow: 0 6px 15px rgba(0, 206, 201, 0.5);
      transform: translateY(-2px);
    }

    .cms-del-btn {
      background: linear-gradient(90deg, #ff4757 0%, #ff6b81 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3);
      font-weight: 600;
    }

    .cms-del-btn:hover {
      box-shadow: 0 6px 15px rgba(255, 71, 87, 0.5);
      transform: translateY(-2px);
    }

    /* SELECT DROPDOWN FOR SIGN UP */
    select.login-input {
      appearance: none;
      -webkit-appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="cyan" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
      background-repeat: no-repeat;
      background-position-x: 95%;
      background-position-y: 50%;
    }

    .light select.login-input {
      background-image: url('data:image/svg+xml;utf8,<svg fill="%230056b3" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
    }

    select.login-input option {
      background: #001f3f;
      color: white;
    }

    .light select.login-input option {
      background: white;
      color: black;
    }

    /* WELCOME */
    #welcomeScreen {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: fixed;
      width: 100%;
      height: 100vh;
      top: 0;
      left: 0;
      background: transparent;
      backdrop-filter: blur(10px);
      z-index: 998;
    }

    #typingText {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(90deg, #00f2fe, #4facfe, #00f2fe);
      background-size: 200% auto;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      animation: shine 3s linear infinite;
      margin-bottom: 10px;
      text-shadow: 0 0 30px rgba(0, 242, 254, 0.3);
    }

    @keyframes shine {
      to {
        background-position: 200% center;
      }
    }

    /* PREMIUM BRANDING */
    @keyframes brandShimmer {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 200% 50%;
      }
    }

    .premium-brand {
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(90deg, #00f2fe, #4facfe, #706fd3, #00f2fe);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: brandShimmer 5s linear infinite;
      text-shadow: 0 0 15px rgba(0, 242, 254, 0.4);
      font-weight: 900;
      letter-spacing: 1.5px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.3s ease;
    }

    .premium-brand:hover {
      transform: scale(1.02);
      text-shadow: 0 0 25px rgba(0, 242, 254, 0.7);
    }

    .brand-emoji {
      filter: drop-shadow(0 0 8px cyan);
      animation: floatEmoji 3s ease-in-out infinite;
    }

    @keyframes floatEmoji {

      0%,
      100% {
        transform: translateY(0) rotate(0);
      }

      50% {
        transform: translateY(-5px) rotate(10deg);
      }
    }

    @media (max-width: 768px) {
      #typingText {
        font-size: 32px;
      }
    }

    @media (max-width: 480px) {
      #typingText {
        font-size: 24px;
      }
    }

    /* SUBJECTS */
    .subjects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .subjects {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      .subjects {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px;
      }
    }

    .box {
      /* Deep space glassmorphic */
      background: rgba(15, 32, 39, 0.6);
      padding: 30px;
      border-radius: 20px;
      cursor: pointer;
      border: 1px solid rgba(0, 242, 254, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(0, 242, 254, 0.05);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 15px;
      position: relative;
      overflow: hidden;
      /* 3D TILT FOUNDATION */
      transform-style: preserve-3d;
      perspective: 1000px;
    }

    /* Glow effect on hover */
    .box::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0, 242, 254, 0.4);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: -1;
    }

    .box h1 {
      margin: 0;
      font-size: 48px;
      filter: drop-shadow(0 0 15px rgba(0, 242, 254, 0.6));
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .box {
        padding: 20px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      .box {
        padding: 15px;
        font-size: 14px;
      }
    }

    .box:hover {
      transform: translateY(-10px) scale(1.02);
      border-color: rgba(0, 242, 254, 0.6);
    }

    .box:hover::after {
      opacity: 1;
    }

    .box:hover h1 {
      transform: scale(1.1);
    }

    /* CHAPTERS */
    .chapters,
    .content {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    li {
      padding: 10px;
      margin: 8px 0;
      background: #ffffff22;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Admin Delete Subject Button inside li */
    .delete-subject-btn {
      background: #ff4757;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    /* CONTENT */
    .section {
      background: rgba(15, 32, 39, 0.6);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      border: 1px solid rgba(0, 242, 254, 0.2);
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 242, 254, 0.15);
      border-color: rgba(0, 242, 254, 0.4);
    }

    /* PROGRESS TRACKING STYLES */
    .progress-box {
      background: rgba(15, 32, 39, 0.7);
      padding: 30px;
      border-radius: 20px;
      border: 1px solid rgba(46, 204, 113, 0.4);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4), inset 0 0 20px rgba(46, 204, 113, 0.05);
      backdrop-filter: blur(15px);
      transition: transform 0.3s ease;
    }

    .progress-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 0 15px rgba(46, 204, 113, 0.2);
    }

    .subj-progress {
      margin-bottom: 25px;
    }

    .subj-progress-title {
      display: flex;
      justify-content: space-between;
      color: #00f2fe;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00f2fe, #4facfe, #00f2fe);
      background-size: 200% auto;
      border-radius: 10px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      animation: shine 3s linear infinite;
    }

    .progress-details {
      font-size: 13px;
      color: #ccc;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .progress-details span {
      background: rgba(0, 0, 0, 0.3);
      padding: 3px 8px;
      border-radius: 4px;
    }



    /* BUTTON */
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
      color: white;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 242, 254, 0.3);
    }

    button:hover {
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 242, 254, 0.5);
    }

    @media (max-width: 480px) {
      button {
        padding: 10px 15px;
        font-size: 14px;
      }
    }

    /* SEMESTER VIEW WITH MOTIVATION */
    #semesters {
      display: grid !important;
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 20px;
      align-items: start;
    }

    #semesterContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }



    /* DARK AND LIGHT MODE */
    .light {
      background: #f0f4f8;
      /* Soft light background */
      color: #333;
    }

    .light header {
      background: #ffffff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .light header h2 {
      text-shadow: none;
      color: #0056b3;
    }

    .light .box,
    .light .info-box,
    .light .motivation-box,
    .light .tasks-box {
      background: #ffffff;
      border-color: #d1d5db;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      color: #333;
    }

    .light .box h1 {
      filter: invert(0.8) hue-rotate(180deg) drop-shadow(0 0 5px rgba(0, 0, 0, 0.2));
    }

    .light .box:hover,
    .light .info-box:hover {
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      border-color: #0056b3;
    }

    .light .motivation-box h3,
    .light .progress-box h3,
    .light .info-box h3 {
      color: #0056b3;
      border-bottom-color: #0056b3;
    }

    .light .motivation-box p {
      color: #444;
      text-shadow: none;
    }

    .light .progress-box {
      border-color: #0056b3;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background: white;
    }

    .light .subj-progress-title {
      color: #0056b3;
    }

    .light .progress-bar {
      background: #e5e7eb;
    }

    .light .progress-details span {
      background: #f0f4f8;
      color: #0056b3;
      border: 1px solid #d1d5db;
    }


    .light h2,
    .light #subjectTitle,
    .light #chapterTitle {
      color: #222;
    }

    .light .section {
      background: #ffffff;
      color: #333;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* ABOUT & TERMS SECTION */
    .info-section {
      display: block;
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .info-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }

    .info-box {
      background: rgba(15, 32, 39, 0.6);
      border: 1px solid rgba(0, 242, 254, 0.3);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
      transition: all 0.4s ease;
    }

    .info-box:hover {
      box-shadow: 0 15px 40px rgba(0, 242, 254, 0.15);
      transform: translateY(-8px);
      border-color: rgba(0, 242, 254, 0.6);
    }

    .info-box h3 {
      color: #00f2fe;
      font-size: 26px;
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(0, 242, 254, 0.3);
      padding-bottom: 12px;
      text-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
    }

    .info-box p {
      font-size: 14px;
      line-height: 1.8;
      color: #ddd;
    }

    .info-box ul {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }

    .info-box li {
      padding: 8px 0;
      padding-left: 20px;
      position: relative;
      font-size: 13px;
      color: #ccc;
    }

    .info-box li:before {
      content: "‚ñ∏";
      position: absolute;
      left: 0;
      color: cyan;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .info-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .info-box {
        padding: 20px;
      }

      .info-box h3 {
        font-size: 20px;
      }
    }

    /* SEMESTER MOTIVATION & TASKS */
    .semester-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 20px;
      max-width: 1200px;
      margin: 20px auto;
    }

    .motivation-box,
    .tasks-box {
      background: rgba(15, 32, 39, 0.6);
      border: 1px solid rgba(0, 242, 254, 0.3);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
      transition: transform 0.3s ease;
    }

    .motivation-box:hover,
    .tasks-box:hover {
      transform: translateY(-5px);
    }

    .motivation-box h3,
    .tasks-box h3 {
      color: cyan;
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }

    .motivation-box p {
      font-size: 18px;
      line-height: 1.6;
      color: #fff;
      font-style: italic;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .task-list li {
      display: flex;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      background: #ffffff11;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    .task-list li:hover {
      background: #ffffff22;
      transform: translateX(5px);
    }

    .task-list input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: cyan;
    }

    .task-list li.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }

    .task-list li.completed input[type="checkbox"] {
      accent-color: #00ff00;
    }

    /* PREMIUM NOTES & BOOK */
    .premium-box {
      background: rgba(30, 25, 10, 0.7);
      border: 1px solid rgba(255, 215, 0, 0.5);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4), inset 0 0 20px rgba(255, 215, 0, 0.05);
    }

    .premium-box::after {
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
    }

    .premium-box:hover {
      border-color: rgba(255, 215, 0, 0.8);
    }

    .premium-box h1 {
      filter: drop-shadow(0 0 15px gold) contrast(1.2) brightness(1.2);
    }

    .locked-option {
      position: relative;
    }

    .locked-option::after {
      content: 'üîí';
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      filter: drop-shadow(0 0 5px gold);
    }

    .light .premium-box {
      background: #fff8e1;
      border-color: #ffc107;
      color: #333;
      box-shadow: 0 4px 6px rgba(255, 193, 7, 0.3);
    }

    .light .premium-box:hover {
      box-shadow: 0 10px 15px rgba(255, 193, 7, 0.5);
    }

    .light .locked-option::after {
      filter: none;
    }

    /* PAYMENT MODAL */
    #paymentModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-in-out;
    }

    .payment-box {
      background: rgba(10, 20, 30, 0.95);
      border: 2px solid gold;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
      max-width: 400px;
      width: 90%;
      max-height: 90vh;
      /* Set maximum height relative to viewport */
      overflow-y: auto;
      /* Enable vertical scrolling */
      position: relative;
    }

    .light .payment-box {
      background: white;
      border-color: #ffc107;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    .payment-box h2 {
      color: gold;
      margin-top: 0;
    }

    .light .payment-box h2 {
      color: #ff9800;
    }

    .payment-amount {
      font-size: 32px;
      font-weight: bold;
      color: white;
      margin: 15px 0;
    }

    .light .payment-amount {
      color: #333;
    }

    .qr-container img {
      width: 200px;
      height: 200px;
      border-radius: 10px;
      border: 2px solid cyan;
      margin-bottom: 10px;
    }

    .upi-id {
      font-size: 16px;
      color: cyan;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }

    .light .upi-id {
      color: #0056b3;
    }

    .pay-btn-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .pay-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      transition: 0.3s;
    }

    .gpay-btn {
      background: #ea4335;
      color: white;
    }

    .phonepe-btn {
      background: #5f259f;
      color: white;
    }

    .confirm-pay-btn {
      background: gold;
      color: black;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    }

    .confirm-pay-btn:hover {
      background: #ffcc00;
      box-shadow: 0 0 25px gold;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: transparent;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    .light .close-modal {
      color: black;
    }

    /* CONFETTI ANIMATION */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: gold;
      animation: fall linear forwards;
    }

    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(720deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* BANNER SLIDER */
    .slider-main {
      width: 100%;
      max-width: 1472px;
      margin: 0 auto 20px auto;
      position: relative;
      overflow: hidden;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }

    .slider-wrapper {
      display: flex;
      transition: transform 0.5s ease-in-out;
      width: 100%;
    }

    .slider-slide {
      min-width: 100%;
      position: relative;
      cursor: pointer;
    }

    .slider-slide img {
      width: 100%;
      aspect-ratio: 92/45;
      max-width: 1472px;
      max-height: 720px;
      object-fit: cover;
      display: block;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .slider-slide img {
        height: auto;
      }
    }

    @media (max-width: 480px) {
      .slider-slide img {
        height: auto;
      }
    }

    .slider-nav {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
    }

    .slider-dot {
      width: 12px;
      height: 12px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      cursor: pointer;
      transition: 0.3s;
    }

    .slider-dot.active {
      background: cyan;
      box-shadow: 0 0 10px cyan;
    }

    /* PREMIUM FOOTER */
    footer {
      padding: 40px 20px;
      margin-top: auto;
      background: rgba(15, 32, 39, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 242, 254, 0.2);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      position: relative;
      z-index: 10;
    }

    .social-links {
      display: flex;
      gap: 25px;
      margin-top: 5px;
    }

    .social-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 242, 254, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .social-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(0, 242, 254, 0.2), transparent);
      transform: translateX(-100%);
      transition: 0.5s;
    }

    .social-btn:hover::before {
      transform: translateX(100%);
    }

    .social-btn:hover {
      transform: translateY(-8px) scale(1.1);
      border-color: cyan;
      box-shadow: 0 0 25px rgba(0, 242, 254, 0.5), inset 0 0 10px rgba(0, 242, 254, 0.2);
      background: rgba(0, 242, 254, 0.1);
    }

    .social-btn svg {
      width: 24px;
      height: 24px;
      fill: #aaa;
      transition: all 0.3s ease;
    }

    .social-btn:hover svg {
      fill: cyan;
      filter: drop-shadow(0 0 5px cyan);
    }

    .footer-text {
      font-family: 'Outfit', sans-serif;
      font-size: 15px;
      color: #888;
      letter-spacing: 1px;
    }

    .footer-brand {
      font-weight: bold;
      color: cyan;
      text-shadow: 0 0 10px rgba(0, 242, 254, 0.3);
    }

    /* NEURAL HUD OVERLAY */
    #neuralHUD {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 900;
      pointer-events: none;
      display: none;
      flex-direction: column;
      gap: 10px;
      font-family: 'Outfit', sans-serif;
    }

    .hud-panel {
      background: rgba(15, 32, 39, 0.6);
      border: 1px solid rgba(0, 242, 254, 0.4);
      padding: 12px 20px;
      border-radius: 12px;
      backdrop-filter: blur(15px);
      box-shadow: 0 0 20px rgba(0, 242, 254, 0.1), inset 0 0 10px rgba(0, 242, 254, 0.1);
      display: flex;
      flex-direction: column;
      animation: hudSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes hudSlide {
      from {
        transform: translateX(100%) skewX(-10deg);
        opacity: 0;
      }

      to {
        transform: translateX(0) skewX(0);
        opacity: 1;
      }
    }

    .hud-label {
      font-size: 10px;
      text-transform: uppercase;
      color: #00f2fe;
      letter-spacing: 1px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .hud-value {
      font-size: 18px;
      color: white;
      font-weight: 800;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }

    /* FACE-SCAN AUTH SIMULATION */
    #faceScanOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 20, 20, 0.9);
      display: none;
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    .scan-line {
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, transparent, #00f2fe, transparent);
      box-shadow: 0 0 30px #00f2fe, 0 0 60px #00f2fe;
      position: absolute;
      top: 0;
      z-index: 2;
      animation: scanAnim 2s ease-in-out infinite;
    }

    @keyframes scanAnim {
      0% {
        top: 0%;
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        top: 100%;
        opacity: 0;
      }
    }

    .scan-mask {
      width: 300px;
      height: 300px;
      border: 2px solid rgba(0, 242, 254, 0.3);
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle, rgba(0, 242, 254, 0.1) 0%, transparent 70%);
    }

    .scan-mask::after {
      content: 'IDENTIFYING...';
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      color: #00f2fe;
      font-family: 'Outfit', sans-serif;
      font-weight: 900;
      letter-spacing: 5px;
      text-shadow: 0 0 10px #00f2fe;
      animation: blink 0.5s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.3;
      }
    }

    /* 3D FLIP-BOOK VIEWER */
    .book-opening {
      animation: bookFlip 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-origin: left center;
      perspective: 2000px;
    }

    @keyframes bookFlip {
      from {
        transform: rotateY(-90deg);
        opacity: 0;
      }

      to {
        transform: rotateY(0deg);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <canvas id="vfx-canvas"></canvas>
  <div id="faceScanOverlay">
    <div class="scan-line"></div>
    <div class="scan-mask"></div>
    <h3 style="color: white; margin-top: 40px; font-family: 'Outfit'; letter-spacing: 2px;">NEURAL INTERFACE: ACTIVATED
    </h3>
  </div>

  <div id="neuralHUD">
    <div class="hud-panel">
      <span class="hud-label">User Rank</span>
      <span id="hudRank" class="hud-value">--</span>
    </div>
    <div class="hud-panel">
      <span class="hud-label">Knowledge Points</span>
      <span id="hudPoints" class="hud-value">--</span>
    </div>
  </div>

  <div id="globalTicker"
    style="background:#ff4757; color:white; padding:8px; font-weight:bold; text-align:center; font-size:14px; display:none;">
    <marquee id="tickerText" scrollamount="5"></marquee>
  </div>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- Firebase Analytics -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <!-- html2canvas for ID Card Download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCeW3RJPGLgP1uKbN5zKQhQDJ6KTkAhPaY",
      authDomain: "nextgen-6c99e.firebaseapp.com",
      projectId: "nextgen-6c99e",
      storageBucket: "nextgen-6c99e.firebasestorage.app",
      messagingSenderId: "774793697681",
      appId: "1:774793697681:web:6bcf573562be65701c2230",
      measurementId: "G-NESY4XEM9R"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    firebase.analytics();
  </script>

  <!-- SheetJS for Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Cropper.js for Photo Cropping -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <style>
    @keyframes neuralPulse {
      0% {
        box-shadow: 0 0 5px rgba(0, 242, 254, 0.5);
        border-color: rgba(0, 242, 254, 0.5);
      }

      50% {
        box-shadow: 0 0 20px rgba(0, 242, 254, 0.8), 0 0 40px rgba(0, 242, 254, 0.4);
        border-color: cyan;
      }

      100% {
        box-shadow: 0 0 5px rgba(0, 242, 254, 0.5);
        border-color: rgba(0, 242, 254, 0.5);
      }
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100%) translateX(-50%);
        opacity: 0;
      }

      to {
        transform: translateY(0) translateX(-50%);
        opacity: 1;
      }
    }

    #neuralSyncHUD {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(11, 19, 43, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid cyan;
      color: cyan;
      padding: 12px 25px;
      border-radius: 30px;
      font-family: monospace;
      font-size: 14px;
      font-weight: bold;
      z-index: 20002;
      display: none;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
  </style>

  <div id="neuralSyncHUD">üì° Incoming Data Stream...</div>


  <header style="display:none;">
    <div style="display:flex; align-items:center; gap:10px; flex-grow:1;">
      <div style="position: relative; cursor: pointer; display: flex; align-items: center; gap: 8px;"
        onclick="openEditProfile()" title="Edit Profile">
        <img id="userProfilePicHeader" src="https://ui-avatars.com/api/?name=U&background=cyan&color=000" alt="Profile"
          style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid cyan; object-fit: cover; display: none;">
        <!-- Header Badge -->
        <div id="headerGamificationBadge"
          style="display: none; background: rgba(0,242,254,0.1); border: 1px solid rgba(0,242,254,0.3); padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; color: gold; box-shadow: 0 0 10px rgba(0,242,254,0.2);">
          --
        </div>
      </div>
      <img src="img1.png" alt="Logo" style="width: 40px; height: 40px; filter: drop-shadow(0 0 5px cyan);">
      <h2 class="premium-brand">
        <span class="brand-emoji">üõ°Ô∏è</span>
        NextGen Library
      </h2>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <!-- Global Search Bar -->
      <div style="position: relative;">
        <input type="text" id="globalSearchInput" placeholder="üîç Search Library..." oninput="searchLibrary()"
          style="padding: 8px 15px; border-radius: 20px; border: 1px solid rgba(0, 242, 254, 0.4); background: rgba(0,0,0,0.5); color: white; outline: none; box-shadow: 0 0 10px rgba(0,242,254,0.2); width: 200px; transition: width 0.3s;">
        <!-- Search Results Dropdown Modal -->
        <div id="searchResultsModal"
          style="display: none; position: absolute; top: 45px; right: 0; width: 300px; max-height: 400px; overflow-y: auto; background: rgba(11, 19, 43, 0.95); backdrop-filter: blur(15px); border: 1px solid rgba(0,242,254,0.4); border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 10000; padding: 10px; box-sizing: border-box;">
        </div>
      </div>

      <button onclick="openLeaderboard()"
        style="font-size: 14px; padding: 6px 12px; background: gold; color: black; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 0 10px gold;">üèÜ
        Leadership</button>
      <button id="themeToggleBtn" onclick="toggleMode()"
        style="font-size: 20px; padding: 8px 15px; background: transparent; border: none; box-shadow: none; cursor: pointer;"></button>
    </div>
  </header>


  <!-- LEADERBOARD MODAL -->
  <div id="loginScreen">
    <div class="login-box">

      <!-- SIGN UP FORM -->
      <div id="signUpForm">
        <img src="img1.png" alt="Logo"
          style="width: 80px; height: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px cyan);">
        <h2 class="premium-brand" style="margin-bottom: 25px; font-size: 24px;">
          <span class="brand-emoji">üìù</span> NextGen Library Registration
        </h2>
        <input type="text" id="regName" class="login-input" placeholder="Name (Letters & Spaces only)">
        <input type="number" id="regRoll" class="login-input"
          placeholder="University Roll Number / Registation Number (13 Digits)"
          style="appearance: none; -moz-appearance: textfield;">

        <div style="display: flex; gap: 10px;">
          <select id="regBranch" class="login-input" style="flex: 1;">
            <option value="" disabled selected>Course</option>
            <!-- Courses injected dynamically -->
          </select>
          <select id="regSection" class="login-input" style="flex: 1;">
            <option value="" disabled selected>Section</option>
            <option value="A1">Section A1</option>
            <option value="A2">Section A2</option>
            <option value="A3">Section A3</option>
            <option value="A4">Section A4</option>
            <option value="A5">Section A5</option>
            <option value="A6">Section A6</option>
            <option value="A7">Section A7</option>
            <option value="A8">Section A8</option>
          </select>
        </div>

        <input type="tel" id="regMobile" class="login-input" placeholder="Mobile Number">

        <button class="login-btn" onclick="handleSignUp()">Sign Up & Enter</button>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
          <p class="auth-toggle" style="margin: 0;">Already have an account? <span
              onclick="toggleAuthMode('login')">Login</span></p>
          <div class="admin-link" onclick="toggleAuthMode('admin')">Admin Login</div>
        </div>
      </div>

      <!-- LOGIN FORM -->
      <div id="loginForm" style="display: none;">
        <img src="img1.png" alt="Logo"
          style="width: 80px; height: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px cyan);">
        <h2 class="premium-brand" style="margin-bottom: 25px; font-size: 24px;">
          <span class="brand-emoji">üîë</span> NextGen Library Login
        </h2>
        <input type="text" id="loginName" class="login-input" placeholder="Name">
        <select id="loginSection" class="login-input">
          <option value="" disabled selected>Section</option>
          <option value="A1">Section A1</option>
          <option value="A2">Section A2</option>
          <option value="A3">Section A3</option>
          <option value="A4">Section A4</option>
          <option value="A5">Section A5</option>
          <option value="A6">Section A6</option>
          <option value="A7">Section A7</option>
          <option value="A8">Section A8</option>
        </select>
        <input type="tel" id="loginMobile" class="login-input" placeholder="Mobile Number">
        <button class="login-btn" onclick="handleLogin()">Log In</button>
        <p class="auth-toggle" style="text-align: right; margin-top: 5px;">Forgot Details? <span
            onclick="recoverDetails()">Click Here</span></p>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
          <p class="auth-toggle" style="margin: 0;">New user? <span onclick="toggleAuthMode('signup')">Sign Up</span>
          </p>
          <div class="admin-link" onclick="toggleAuthMode('admin')">Admin Login</div>
        </div>
      </div>

      <!-- ADMIN LOGIN FORM -->
      <div id="adminLoginForm" style="display: none;">
        <h2>üõ°Ô∏è Admin Access</h2>
        <input type="text" id="adminUser" class="login-input" placeholder="Admin Username">
        <input type="password" id="adminPass" class="login-input" placeholder="Admin Password">
        <button class="login-btn" onclick="handleAdminLogin()"
          style="background: #ff4757; color: white; box-shadow: 0 0 15px rgba(255, 71, 87, 0.5);">Authenticate</button>
        <p class="auth-toggle" style="margin-top: 20px;">Return to <span onclick="toggleAuthMode('login')">Student
            Login</span></p>
      </div>

    </div>
  </div>

  <!-- EDIT PROFILE SCREEN -->
  <div id="editProfileScreen"
    style="display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); position: fixed; width: 100%; top: 0; left: 0; z-index: 10000;">

    <!-- Floating Close Button Outside the Layout -->
    <button onclick="closeEditProfile()"
      style="position: absolute; top: 30px; right: 30px; background: #ff4757; border: 2px solid #fff; border-radius: 50%; color: white; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; box-shadow: 0 0 20px rgba(255,71,87,0.8); transition: transform 0.2s; z-index: 10001;"
      onmouseover="this.style.transform='scale(1.1) rotate(90deg)'"
      onmouseout="this.style.transform='scale(1) rotate(0deg)'">‚úï</button>

    <div class="login-box" style="position: relative; max-height: 85vh; overflow-y: auto;">
      <h2
        style="background: linear-gradient(90deg, #00f2fe, #4facfe); -webkit-background-clip: text; background-clip: text; color: transparent; margin-bottom: 20px;">
        ‚úèÔ∏è Edit Profile</h2>
      <div style="margin-bottom: 20px;">
        <img id="editProfilePicPreview" src="https://ui-avatars.com/api/?name=U"
          style="width: 110px; height: 110px; border-radius: 50%; border: 3px solid cyan; object-fit: cover; margin-bottom: 10px; box-shadow: 0 0 20px rgba(0,255,255,0.6);">
      </div>
      <div style="margin-bottom: 15px;">
        <input type="file" id="editProfilePicInput" accept="image/*" class="login-input"
          onchange="previewEditProfilePic(event)" style="padding: 5px; max-width: 250px; margin: 0 auto;">
        <p style="font-size: 11px; color: #00f2fe; margin-top: 5px; letter-spacing: 0.5px;">*Picture auto-crops to
          circle</p>
      </div>
      <input type="text" id="editName" class="login-input" placeholder="Name (Letters & Spaces only)">

      <!-- Gamification Badge Display -->
      <div id="gamificationBadge"
        style="margin-bottom: 20px; font-weight: bold; font-size: 14px; text-shadow: 0 0 5px rgba(0,255,255,0.5); padding: 10px; border-radius: 8px; background: rgba(0, 242, 254, 0.1); border: 1px solid rgba(0, 242, 254, 0.3);">
        üèÜ Points: <span id="userPoints" style="color: cyan;">0</span> | Rank: <span id="userRank"
          style="color: gold;">Beginner üå±</span>
      </div>

      <input type="number" id="editRoll" class="login-input" placeholder="University Roll Number (13 Digits)"
        style="appearance: none; -moz-appearance: textfield;">

      <div style="display: flex; gap: 10px;">
        <select id="editBranch" class="login-input" style="flex: 1;">
          <option value="BCA">BCA</option>
          <option value="BTECH">BTECH</option>
          <option value="BBA">BBA</option>
        </select>
        <select id="editSection" class="login-input" style="flex: 1;">
          <option value="A1">Section A1</option>
          <option value="A2">Section A2</option>
          <option value="A3">Section A3</option>
          <option value="A4">Section A4</option>
          <option value="A5">Section A5</option>
          <option value="A6">Section A6</option>
          <option value="A7">Section A7</option>
          <option value="A8">Section A8</option>
        </select>
      </div>

      <input type="tel" id="editMobile" class="login-input" placeholder="Mobile Number">

      <button class="login-btn" onclick="saveProfileChanges()" style="margin-bottom: 15px;">üíæ Save Changes</button>
      <button class="login-btn" onclick="downloadIDCard()"
        style="background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); color: white; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(56,239,125,0.4);">‚¨áÔ∏è
        Download ID Card</button>
      <button class="login-btn" onclick="logoutUser()"
        style="background: linear-gradient(90deg, #ff416c, #ff4b2b); color: white; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(255,75,43,0.4);">üö™
        Logout</button>
      <button class="login-btn" onclick="closeEditProfile()"
        style="background: transparent; border: 1px solid rgba(0,242,254,0.5); color: #00f2fe; box-shadow: none;">‚ùå
        Cancel</button>
    </div>

    <!-- DIGITAL ID CARD UI (Hidden but used for rendering/downloading) -->
    <div id="studentIdCard"
      style="width: 486px; height: 306px; background: #000; position: fixed; left: 0; top: 0; overflow: hidden; border-radius: 16px; border: 1px solid rgba(0,242,254,0.3); font-family: 'Segoe UI', sans-serif; box-shadow: 0 10px 30px rgba(0,0,0,0.8); text-align: left; box-sizing: border-box; z-index: -9999; pointer-events: none;">

      <!-- Premium Tech/AI Background -->
      <img src="https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?q=80&w=600&auto=format&fit=crop"
        crossorigin="anonymous"
        style="position: absolute; width:100%; height:100%; object-fit:cover; opacity: 0.6; z-index: 1; filter: contrast(1.2) saturate(1.5);">
      <div
        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: linear-gradient(135deg, #0b132b, #1c2541);">
      </div>
      <div
        style="position: absolute; top: -50px; left: -50px; width: 250px; height: 250px; background: rgba(0,242,254,0.3); border-radius: 50%; filter: blur(50px); z-index: 2;">
      </div>
      <div
        style="position: absolute; bottom: -50px; right: -50px; width: 200px; height: 200px; background: rgba(255,0,150,0.2); border-radius: 50%; filter: blur(60px); z-index: 2;">
      </div>

      <!-- Content -->
      <div style="position: relative; z-index: 3; display: flex; flex-direction: column; height: 100%;">

        <!-- Header -->
        <div
          style="display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,242,254,0.2);">
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="img1.png" style="width: 30px; height: 30px; filter: drop-shadow(0 0 5px cyan);">
            <div>
              <h3 style="margin: 0; font-size: 16px; font-weight: 800; color: #fff; letter-spacing: 1px;">NEXTGEN <span
                  style="color: #00f2fe;">LIBRARY</span></h3>
              <p style="margin: 0; font-size: 9px; color: #aaa; letter-spacing: 2px;">VIRTUAL STUDENT IDENTITY</p>
            </div>
          </div>
          <!-- Gamification Top Icon -->
          <div id="idCardRankIcon"
            style="width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #00f2fe, #4facfe); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(0,242,254,0.5);">
            <span style="font-size: 14px;">üéì</span>
          </div>
        </div>

        <!-- Body -->
        <div style="display: flex; padding: 15px 20px; gap: 20px; align-items: center; flex-grow: 1;">
          <!-- Photo -->
          <div style="position: relative; flex-shrink: 0; width: 100px; height: 100px;">
            <div
              style="position: absolute; inset: -3px; border-radius: 50%; background: linear-gradient(135deg, #00f2fe, #ff007a); z-index: 0; box-shadow: 0 0 15px rgba(0,242,254,0.5);">
            </div>
            <img id="idCardPic" src="" crossorigin="anonymous"
              style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; position: relative; z-index: 1; border: 2px solid #000;">
          </div>

          <!-- Details -->
          <div style="flex-grow: 1; color: white;">
            <h2 id="idCardName"
              style="margin: 0 0 2px 0; font-size: 22px; font-weight: 900; text-transform: uppercase; color: #fff; text-shadow: 0 0 10px rgba(0,242,254,0.5);">
              --</h2>

            <!-- Rank / Congratulations Text -->
            <p id="idCardCongrats"
              style="margin: 0 0 10px 0; font-size: 10px; color: gold; font-weight: bold; text-transform: uppercase;">
              CONGRATULATIONS ON ACHIEVING <span id="idCardRankText" style="color: #fff;">RANK</span> LEVEL ‚ú®</p>

            <table style="width: 100%; font-size: 11px; border-collapse: separate; border-spacing: 0 4px;">
              <tr>
                <td style="color: #00f2fe; font-weight: 600; width: 80px; letter-spacing: 1px;">REG/ROLL NO</td>
                <td style="color: #fff; font-weight: bold; font-family: monospace; font-size: 12px;" id="idCardRoll">--
                </td>
              </tr>
              <tr>
                <td style="color: #00f2fe; font-weight: 600; letter-spacing: 1px;">COURSE</td>
                <td style="color: #fff; font-weight: bold;" id="idCardCourse">--</td>
              </tr>
              <tr>
                <td style="color: #00f2fe; font-weight: 600; letter-spacing: 1px;">LIBRARY PTS</td>
                <td style="color: #fff; font-weight: bold; font-size: 12px; color: cyan;" id="idCardPoints">--</td>
              </tr>
            </table>
          </div>
        </div>

        <!-- Footer -->
        <div
          style="padding: 10px 20px; background: rgba(0,0,0,0.8); border-top: 1px solid rgba(0,242,254,0.3); display: flex; justify-content: space-between; align-items: center;">
          <div
            style="font-family: monospace; font-size: 14px; color: rgba(255,255,255,0.7); letter-spacing: -1px; transform: scaleY(1.5);">
            || | ||| || || | | ||||</div>
          <div style="font-size: 9px; color: #00f2fe; font-weight: bold; letter-spacing: 1px;">
            adityakumar12xyz.github.io/NextGen/
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- CROPPER UI MODAL (For Profile Photos) -->
  <div id="cropModal"
    style="display: none; position: fixed; z-index: 10005; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;">
    <h3 style="color: #00f2fe; margin-bottom: 20px; font-family: sans-serif;">‚úÇÔ∏è Adjust Your Profile Photo</h3>
    <div style="max-width: 90%; max-height: 60vh; overflow: hidden; border: 2px solid cyan; border-radius: 10px;">
      <img id="imageToCrop" src="" style="max-width: 100%; display: block;">
    </div>
    <div style="display: flex; gap: 15px; margin-top: 25px;">
      <button class="login-btn" onclick="cancelCrop()"
        style="background: transparent; border: 1px solid #ff4757; color: #ff4757; width: auto; padding: 10px 25px;">Cancel</button>
      <button class="login-btn" onclick="applyCrop()"
        style="background: linear-gradient(90deg, #11998e, #38ef7d); color: white; border: none; width: auto; padding: 10px 25px;">Crop
        & Save</button>
    </div>
  </div>
  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard">
    <div
      style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
      <h2
        style="background: linear-gradient(90deg, #00f2fe, #4facfe); -webkit-background-clip: text; background-clip: text; color: transparent; margin: 0;">
        üõ°Ô∏è Secure Admin Dashboard</h2>
      <div style="display: flex; gap: 15px; margin-top: 10px;">
        <!-- ADMIN HACK: ONE-CLICK DATA BACKUP -->
        <button onclick="backupFullData()"
          style="background: linear-gradient(90deg, #6c5ce7 0%, #a29bfe 100%); color: white; padding: 10px 20px; font-size: 14px; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);">üíæ
          JSON Backup</button>
        <button onclick="exportToExcel()"
          style="background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); color: white; padding: 10px 20px; font-size: 14px; box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);">üìä
          Export to Excel</button>
        <button onclick="adminLogout()"
          style="background: linear-gradient(90deg, #ff416c 0%, #ff4b2b 100%); color: white; padding: 10px 20px; font-size: 14px; box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);">üö™
          Logout Admin</button>
      </div>
    </div>

    <p>View all registered student data below. This info is protected.</p>
    <div style="overflow-x: auto;">
      <table class="admin-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Roll Number</th>
            <th>Branch</th>
            <th>Section</th>
            <th>Mobile Number</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="adminTableBody">
          <!-- Rows injected via JS -->
        </tbody>
      </table>
    </div>

    <!-- ADMIN HACK: USER SHADOW MODAL (Activity Logs - ID Card Style) -->
    <div id="userShadowModal"
      style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; justify-content: center; align-items: center; backdrop-filter: blur(15px);">
      <div style="position: relative;">
        <!-- Close Button Overlaid -->
        <button onclick="document.getElementById('userShadowModal').style.display='none'"
          style="position: absolute; top: -20px; right: -20px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; z-index: 20001; font-weight: bold; box-shadow: 0 0 10px rgba(0,0,0,0.5);">‚úï</button>

        <div id="shadowIdCard"
          style="width: 486px; height: 306px; background: #000; position: relative; overflow: hidden; border-radius: 16px; border: 1px solid rgba(0,242,254,0.5); font-family: 'Segoe UI', sans-serif; box-shadow: 0 0 50px rgba(0,242,254,0.3); text-align: left; box-sizing: border-box;">

          <!-- Premium Tech/AI Background (Replicated from ID Card) -->
          <img src="https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?q=80&w=600&auto=format&fit=crop"
            style="position: absolute; width:100%; height:100%; object-fit:cover; opacity: 0.5; z-index: 1; filter: contrast(1.2) hue-rotate(180deg);">
          <div
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: linear-gradient(135deg, #0b132b, #1c2541);">
          </div>

          <!-- Content -->
          <div style="position: relative; z-index: 3; display: flex; flex-direction: column; height: 100%;">
            <!-- Header -->
            <div
              style="display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,242,254,0.3);">
              <div style="display: flex; align-items: center; gap: 10px;">
                <img src="img1.png" style="width: 30px; height: 30px; filter: drop-shadow(0 0 5px cyan);">
                <div>
                  <h3 style="margin: 0; font-size: 16px; font-weight: 800; color: #fff; letter-spacing: 1px;">SHADOW
                    <span style="color: #ff4757;">SYSTEM</span>
                  </h3>
                  <p style="margin: 0; font-size: 9px; color: #aaa; letter-spacing: 2px;">NEURAL ACTIVITY OVERRIDE</p>
                </div>
              </div>
              <div
                style="width: 30px; height: 30px; border-radius: 50%; background: rgba(255,71,87,0.2); border: 1px solid #ff4757; display: flex; align-items: center; justify-content: center;">
                <span id="shadowStatusIcon" style="font-size: 14px; color: #ff4757;">üëÅÔ∏è</span>
              </div>
            </div>

            <!-- Body -->
            <div style="display: flex; padding: 15px 20px; gap: 20px; align-items: center; flex-grow: 1;">
              <!-- Photo Container -->
              <div style="position: relative; flex-shrink: 0; width: 100px; height: 100px;">
                <div
                  style="position: absolute; inset: -3px; border-radius: 50%; background: linear-gradient(135deg, #ff4757, #00f2fe); z-index: 0; box-shadow: 0 0 15px rgba(255,71,87,0.5);">
                </div>
                <img id="shadowPic" src=""
                  style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; position: relative; z-index: 1; border: 2px solid #000;">
              </div>

              <!-- Details -->
              <div id="shadowDetails" style="flex-grow: 1; color: white;">
                <!-- Injected via JS -->
              </div>
            </div>

            <!-- Footer -->
            <div
              style="padding: 10px 20px; background: rgba(255,71,87,0.1); border-top: 1px solid rgba(255,71,87,0.3); display: flex; justify-content: space-between; align-items: center;">
              <div
                style="font-family: monospace; font-size: 14px; color: rgba(255,71,87,0.7); letter-spacing: -1px; transform: scaleY(1.5);">
                || | ||| || || | | ||||</div>
              <div id="shadowTimestamp" style="font-size: 9px; color: #ff4757; font-weight: bold; letter-spacing: 1px;">
                SECURE_LINK_ENCRYPTED
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN CONTENT MANAGEMENT SYSTEM -->
    <div id="adminCMS" style="margin-top: 40px; border-top: 1px solid rgba(0,255,255,0.3); padding-top: 20px;">
      <h3 style="color: cyan; text-align: left;">üìÇ Manage Course Content</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <select id="cmsCourse" class="login-input" style="flex: 1; margin: 0; min-width: 150px;"
          onchange="onAdminCMSCourseChange()">
          <option value="" disabled selected>Course</option>
        </select>
        <select id="cmsBranch" class="login-input" style="flex: 1; margin: 0; min-width: 150px;"
          onchange="onAdminCMSBranchChange()">
          <option value="" disabled selected>Branch</option>
        </select>
      </div>

      <!-- NEW INTEGRATED INTERACTION AREA -->
      <div id="cmsInteractionArea" style="margin-top: 20px;">
        <p style="color: #888; text-align: center; padding: 20px;">Select Course and Branch to manage Semesters,
          Subjects,
          and Chapters.</p>
      </div>

      <!-- Content Editor (Visible only when a chapter is selected) -->
      <div id="cmsContentEditor" style="display: none; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
        <h4 id="selectedPathDisplay" style="color: cyan; margin-bottom: 15px;">Selected: ...</h4>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <!-- Existing Editor Fields -->
          <div style="text-align: left;">
            <label style="color: #aaa; font-size: 14px;">üìπ Video URLs (one per line)</label>
            <textarea id="cmsVideo" class="login-input" style="height: 80px;"></textarea>
          </div>
          <div style="text-align: left;">
            <label style="color: #aaa; font-size: 14px;">üìÑ PDF Google Drive Links (one per line)</label>
            <textarea id="cmsPdf" class="login-input" style="height: 80px;"></textarea>
          </div>
          <div style="text-align: left;">
            <label style="color: #aaa; font-size: 14px;">üìù Explanatory Notes (Multi-line Support)</label>
            <textarea id="cmsNotes" class="login-input" style="height: 120px;"></textarea>
          </div>
          <div style="text-align: left;">
            <label style="color: #aaa; font-size: 14px;">‚úèÔ∏è Assignment Text (Multi-line Support)</label>
            <textarea id="cmsAssignment" class="login-input" style="height: 100px;"></textarea>
          </div>
          <div style="text-align: left;">
            <label style="color: #aaa; font-size: 14px;">üè† Homework Text (Multi-line Support)</label>
            <textarea id="cmsHomework" class="login-input" style="height: 100px;"></textarea>
          </div>
          <button class="login-btn" onclick="saveAdminContent()"
            style="background: cyan; color: black; margin-top: 10px;">üíæ Save Data to Firebase</button>
        </div>
      </div>
    </div>

    <!-- ADMIN SUBJECT MANAGEMENT -->
    <div id="adminSubjectManager"
      style="margin-top: 40px; border-top: 1px solid rgba(0,255,255,0.3); padding-top: 20px;">

      <!-- MANAGE COURSES -->
      <h3 style="color: cyan; text-align: left;">üè¢ Manage Courses</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 25px;">
        <input type="text" id="newCourseName" class="login-input" placeholder="New Course Name (e.g. MCA)"
          style="flex: 2; margin-bottom: 0;">
        <button class="login-btn" onclick="addAdminCourse()"
          style="flex: 1; margin-top: 0; background: #00cec9; color: black;">‚ûï Add Course</button>
      </div>

      <!-- MANAGING SUBJECTS INTEGRATED INTO CMS ABOVE -->
    </div>

    <!-- ADMIN PREMIUM SETTINGS -->
    <div id="adminPremiumSettings"
      style="margin-top: 40px; border-top: 1px solid rgba(255,215,0,0.5); padding-top: 20px;">
      <h3 style="color: gold; text-align: left;">üíé Premium Payment Settings</h3>

      <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <select id="premConfigCourse" class="login-input" style="flex: 1; margin: 0; min-width: 120px;"
          onchange="onAdminPremConfigCourseChange()">
          <option value="" disabled selected>Select Premium Course</option>
          <option value="BCA">BCA</option>
          <option value="BTECH">BTECH</option>
          <option value="BBA">BBA</option>
        </select>
        <select id="premConfigOption" class="login-input" style="flex: 1; margin: 0; min-width: 120px;"
          onchange="onAdminPremConfigOptionChange()">
          <option value="" disabled selected>Select Option</option>
        </select>
      </div>

      <div id="premiumConfigEditor" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <label style="color: #ccc; font-size: 14px;">Upload QR Code Image:</label>
            <input type="file" id="premiumQRFile" class="login-input" accept="image/*"
              onchange="previewPremiumQR(event)" style="padding: 5px;">
            <img id="premiumQRPreview" src="" alt="QR Preview"
              style="width: 100px; height: 100px; object-fit: contain; border: 1px solid cyan; border-radius: 5px; display: none;">
          </div>
          <div>
            <label style="color: #ccc; font-size: 14px;">UPI ID:</label>
            <input type="text" id="premiumUPI" class="login-input" placeholder="e.g. 9876543210@ybl">
          </div>
          <div>
            <label style="color: #ccc; font-size: 14px;">Premium Amount ‚Çπ:</label>
            <input type="number" id="premiumAmount" class="login-input" placeholder="e.g. 499">
          </div>
        </div>
        <button class="login-btn" onclick="savePremiumConfig()"
          style="background: gold; color: black; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); margin-top: 15px;">üíæ Save
          Payment
          Settings</button>
      </div>
    </div>

    <!-- ADMIN PREMIUM CONTENT CMS -->
    <div id="adminPremiumCMS"
      style="margin-top: 40px; border-top: 1px solid rgba(0, 255, 255, 0.3); padding-top: 20px;">
      <h3 style="color: cyan; text-align: left;">üíé Manage Premium Content (PDFs)</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <select id="premCmsCourse" class="login-input" style="flex: 1; margin: 0; min-width: 120px;"
          onchange="onPremCourseChange()">
          <option value="" disabled selected>Select Premium Course</option>
          <option value="BCA">BCA</option>
          <option value="BTECH">BTECH</option>
          <option value="BBA">BBA</option>
        </select>
        <select id="premCmsOption" class="login-input" style="flex: 1; margin: 0; min-width: 120px;"
          onchange="onPremOptionChange()">
          <option value="" disabled selected>Select Option</option>
        </select>
      </div>

      <div id="premEditor" style="display: none; text-align: left;">
        <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: stretch;">
          <input type="text" id="newPremOptionName" class="login-input" placeholder="Create New Option (e.g. MBA Agra)"
            style="flex: 2; margin-bottom: 0;">
          <button class="login-btn" onclick="addPremiumOption()"
            style="flex: 1; margin-top: 0; background: gold; color: black;">‚ûï Add Option</button>
        </div>

        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <h4 style="color: gold; margin-top: 0;">Add PDF to Selected Option</h4>
          <input type="text" id="newPremPdfTitle" class="login-input" placeholder="PDF Title (e.g. Chapter 1 Notes)">
          <input type="text" id="newPremPdfLink" class="login-input" placeholder="Google Drive / PDF Link">
          <button class="login-btn" onclick="addPremiumPdf()" style="background: cyan; color: black;">Upload PDF
            Link</button>
        </div>

        <h4 style="color: #ddd;">Existing PDFs in Option</h4>
        <ul id="adminPremPdfList" style="list-style: none; padding: 0; max-height: 200px; overflow-y: auto;">
          <!-- Dynamically populated list of PDFs -->
        </ul>
      </div>
    </div>

    <!-- PENDING PREMIUM APPROVALS -->
    <div id="adminPendingPayments" style="margin-top: 40px; border-top: 1px solid #ff4757; padding-top: 20px;">
      <h3 style="color: #ff4757; text-align: left;">‚è≥ Pending Premium Approvals</h3>
      <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; overflow-x: auto;">
        <table style="width: 100%; text-align: left; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid #ff4757;">
              <th style="padding: 10px; color: gold;">Student</th>
              <th style="padding: 10px; color: gold;">Option</th>
              <th style="padding: 10px; color: gold;">UTR</th>
              <th style="padding: 10px; color: gold;">Proof</th>
              <th style="padding: 10px; color: gold;">Action</th>
            </tr>
          </thead>
          <tbody id="pendingPaymentsTableBody">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ACTIVE PREMIUM MEMBERS -->
    <div id="adminActivePremium" style="margin-top: 40px; border-top: 1px solid gold; padding-top: 20px;">
      <h3 style="color: gold; text-align: left;">üíé Active Premium Members</h3>
      <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; overflow-x: auto;">
        <table style="width: 100%; text-align: left; border-collapse: collapse;">
          <thead>
            <tr style="border-bottom: 1px solid gold;">
              <th style="padding: 10px; color: gold;">Student</th>
              <th style="padding: 10px; color: gold;">Mobile</th>
              <th style="padding: 10px; color: gold;">Detailed Plans</th>
            </tr>
          </thead>
          <tbody id="activePremiumTableBody">
            <!-- Dynamically populated -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- SITE SETTINGS -->
    <div id="adminSiteSettings"
      style="margin-top: 40px; border-top: 1px solid rgba(0, 255, 255, 0.3); padding-top: 20px; margin-bottom: 40px;">
      <h3 style="color: cyan; text-align: left;">‚öôÔ∏è Advanced Site Settings</h3>
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <div>
          <label style="color: #ccc; font-size: 14px;">Enable Premium Hub Globally:</label>
          <select id="sitePremiumToggle" class="login-input" style="margin-bottom: 0;">
            <option value="true">ON (Users can see Premium Hub)</option>
            <option value="false">OFF (Hide Premium Hub)</option>
          </select>
        </div>
        <div>
          <label style="color: #ccc; font-size: 14px;">Live Scrolling Announcement (Top Ticker):</label>
          <input type="text" id="siteTickerText" class="login-input"
            placeholder="Type announcement here... Leave blank to hide." style="margin-bottom: 0;">
        </div>
        <div>
          <label style="color: #ccc; font-size: 14px;">Welcome Subtitle (under logo):</label>
          <input type="text" id="siteWelcomeText" class="login-input" placeholder="e.g. Your Digital Learning Hub"
            style="margin-bottom: 0;">
        </div>
        <div>
          <label style="color: #ccc; font-size: 14px;">About Us Content:</label>
          <textarea id="siteAboutText" class="login-input" placeholder="Welcome to NextGen Library..."
            style="height: 80px; margin-bottom: 0;"></textarea>
        </div>

        <div style="margin-top: 15px; border-top: 1px dashed cyan; padding-top: 15px;">
          <label style="color: cyan; font-size: 16px; font-weight: bold;">üñºÔ∏è Announcement Banners
            (Auto-Swiping)</label>
          <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-top: 10px;">
            <input type="file" id="siteBannerImageInput" accept="image/*" class="login-input" style="padding: 5px;">
            <input type="text" id="siteBannerLinkInput" class="login-input"
              placeholder="Redirect Link (e.g. https://google.com) Optional">
            <button class="login-btn" onclick="addSiteBanner()"
              style="background: #00cec9; color: black; margin-top: 0;">‚ûï Add Banner</button>
          </div>
          <ul id="adminBannerList"
            style="list-style: none; padding: 0; margin-top: 15px; max-height: 250px; overflow-y: auto;">
            <!-- Banners injected here -->
          </ul>
        </div>

        <div style="margin-top: 15px; border-top: 1px dashed cyan; padding-top: 15px;">
          <label style="color: cyan; font-size: 16px; font-weight: bold;">üîî Push Notifications (Broadcast)</label>
          <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-top: 10px;">
            <p style="color: #ccc; font-size: 14px; margin-top: 0; margin-bottom: 15px;">Send a real-time notification
              to all active web users.</p>
            <input type="text" id="notifTitle" class="login-input"
              placeholder="Notification Title (e.g., New Premium Content!)" style="margin-bottom: 10px;">
            <textarea id="notifBody" class="login-input" placeholder="Notification Body/Message..."
              style="height: 60px; margin-bottom: 10px;"></textarea>
            <button class="login-btn" onclick="sendBroadcastNotification()"
              style="background: #00cec9; color: black; margin-top: 0;">üöÄ Send Notification</button>
          </div>
        </div>

      </div>
      <button class="login-btn" onclick="saveSiteSettings()"
        style="background: #28a745; color: white; margin-top: 15px;">üíæ Save Site Settings</button>
    </div>

    <!-- ADMIN SECURITY SETTINGS -->
    <div id="adminSecuritySettings"
      style="margin-top: 40px; border-top: 1px solid rgba(0, 255, 255, 0.3); padding-top: 20px; margin-bottom: 40px;">
      <h3 style="color: cyan; text-align: left;">üîê Admin Credentials</h3>
      <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
        <input type="text" id="newAdminId" class="login-input" placeholder="New Admin Username"
          style="flex: 1; margin: 0;">
        <input type="password" id="newAdminPass" class="login-input" placeholder="New Admin Password"
          style="flex: 1; margin: 0;">
        <button class="login-btn" onclick="updateAdminCredentials()"
          style="flex: 1; margin-top: 0; background: #00cec9; color: black; min-width: 150px;">Update
          Credentials</button>
      </div>
    </div>

  </div>

  <!-- WELCOME -->
  <div id="welcomeScreen" style="display:none;">
    <div style="position: absolute; top: 20px; right: 20px;">
      <button onclick="openEditProfile()"
        style="font-size: 14px; padding: 10px 20px; background: rgba(0, 242, 254, 0.1); border: 1px solid rgba(0, 242, 254, 0.5); border-radius: 8px; color: #00f2fe; cursor: pointer; backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">‚úèÔ∏è
        Edit Profile</button>
    </div>

    <!-- CSS Floating shapes for VFX -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; z-index: -1;">
      <div
        style="position: absolute; top: 10%; left: 15%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(0,242,254,0.4), transparent); filter: blur(20px); animation: float 6s ease-in-out infinite;">
      </div>
      <div
        style="position: absolute; bottom: 20%; right: 10%; width: 150px; height: 150px; background: radial-gradient(circle, rgba(79,172,254,0.3), transparent); filter: blur(30px); animation: float 8s ease-in-out infinite reverse;">
      </div>
    </div>
    <style>
      @keyframes float {
        0% {
          transform: translateY(0px) rotate(0deg);
        }

        50% {
          transform: translateY(-20px) rotate(10deg);
        }

        100% {
          transform: translateY(0px) rotate(0deg);
        }
      }
    </style>

    <img src="img1.png" alt="NextGen Library"
      style="width:220px; height:220px; margin-bottom:20px; filter:drop-shadow(0 0 25px rgba(0, 242, 254, 0.6)); animation: float 4s ease-in-out infinite;">
    <h1 id="typingText"></h1>
    <p id="welcomeSubtitle"
      style="font-size: 20px; color: #ddd; letter-spacing: 1px; font-weight: 300; margin-bottom: 30px;">Your Digital
      Learning Hub</p>
    <button onclick="enterSite()" style="padding: 15px 40px; font-size: 18px; border-radius: 30px;">Enter
      Library</button>
  </div>

  <!-- PROGRAMS VIEW WITH INFO -->
  <div id="programsWrapper" style="display:none;">
    <div id="homeSliderContainer" style="display:none;"></div>
    <div class="subjects" id="programs">
      <!-- Courses injected dynamically -->
      <div class="box premium-box" onclick="openPremiumHub()" id="premiumLinkBox">
        <h1>üíé</h1>Premium Notes & Book
      </div>
    </div>

    <!-- ABOUT & TERMS SECTION -->
    <div class="info-section">
      <div class="info-container">
        <div class="info-box">
          <h3>üìö About NextGen Library</h3>
          <div id="aboutUsContent">
            <p>Welcome to NextGen Library, your premier digital learning platform designed for modern students. We
              believe
              that quality education should be structured, accessible, and interactive.</p>
            <p>Our platform integrates:</p>
            <ul>
              <li>High-quality Video Lectures</li>
              <li>Meticulously curated Study Notes</li>
              <li>Rigorous Assignments & Practice</li>
              <li>Comprehensive Homework Guidance</li>
              <li>Instant Doubt Resolution Support</li>
            </ul>
            <p>Whether you're tackling daily challenges or seeking clarity, we provide the tools necessary for academic
              excellence and personal growth.</p>
          </div>
        </div>

        <div class="info-box">
          <h3>‚öñÔ∏è Terms & Conditions</h3>
          <ul>
            <li><strong>Usage Rights:</strong> All content is for educational purposes only</li>
            <li><strong>Intellectual Property:</strong> Content owned by NextGen Library and respective creators</li>
            <li><strong>User Responsibility:</strong> Students must use resources ethically and legally</li>
            <li><strong>Account Security:</strong> Users are responsible for account confidentiality</li>
            <li><strong>Content Accuracy:</strong> We strive for accuracy but don't guarantee completeness</li>
            <li><strong>Limitation:</strong> Not liable for indirect damages or service interruptions</li>
            <li><strong>Updates:</strong> Terms may be updated. Continued use implies acceptance</li>
            <li><strong>Support:</strong> Contact us for queries or concerns regarding any content</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- DYNAMIC NAVIGATION SECTION -->
  <div id="dynamicNavSection" style="display:none; text-align:center;">
    <button onclick="goBackDynamicNav()" style="margin-bottom:20px; padding: 10px 20px; font-size:16px;">‚¨Ö Back</button>
    <div id="branchSliderContainer" style="display:none;"></div>
    <div id="dynamicNavContainer" class="subjects"></div>
  </div>

  <!-- PREMIUM HUB NAVIGATION SECTION -->
  <div id="premiumNavSection" style="display:none; text-align:center;">
    <button onclick="goBackFromPremium()" style="margin-bottom:20px; padding: 12px 20px; font-size:16px;">‚¨Ö
      Back</button>
    <h2 style="color: gold; text-shadow: 0 0 10px gold; font-size: 28px;">üíé Premium Notes & Book</h2>
    <p style="color: #ddd;">Unlock exclusive exam-oriented materials!</p>
    <div id="premiumCoursesContainer" class="subjects">
      <!-- Courses injected dynamically -->
    </div>
    <div id="premiumOptionsContainer" class="subjects" style="display:none;">
      <!-- Injected dynamically based on selection -->
    </div>

    <div id="premiumContentContainer"
      style="display:none; text-align:left; max-width: 800px; margin: 0 auto; padding: 20px;">
      <button onclick="goBackToPremiumOptions()"
        style="margin-bottom:20px; padding: 8px 15px; font-size:14px; background: rgba(255,215,0,0.2); border: 1px solid gold; color: gold;">‚¨Ö
        Back to Options</button>
      <h3 id="activePremiumOptionTitle" style="color: gold; text-shadow: 0 0 10px gold; font-size: 24px;">Option Title
      </h3>
      <div id="premiumPdfsGrid"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
        <!-- PDFs injected here -->
      </div>
    </div>
  </div>

  <!-- PAYMENT MODAL -->
  <div id="paymentModal">
    <div class="payment-box">
      <button class="close-modal" onclick="closePaymentModal()">‚úñ</button>
      <h2>Unlock Premium Content</h2>
      <p style="color: #ccc;" id="paymentDesc">Complete payment to access this section indefinitely.</p>
      <div class="payment-amount" id="paymentAmountDisplay">‚Çπ0</div>

      <div class="qr-container">
        <img id="paymentQRDisplay" src="" alt="Scan QR Code to Pay" style="display: none;">
      </div>
      <div class="upi-id" id="paymentUPIDisplay">UPI ID: Not Set</div>

      <div class="pay-btn-group">
        <button class="pay-btn gpay-btn" onclick="payWithUpiApp('gpay')">Pay via GPay</button>
        <button class="pay-btn phonepe-btn" onclick="payWithUpiApp('phonepe')">Pay via PhonePe</button>
      </div>

      <div style="text-align: left; margin: 15px 0;">
        <label style="color: #ccc; font-size: 14px;">12-Digit UTR / Transaction ID (Mandatory):</label>
        <input type="number" id="paymentUtrInput" class="login-input" placeholder="Enter exactly 12 digits"
          style="margin-bottom: 10px;">

        <label style="color: #ccc; font-size: 14px;">Upload Payment Screenshot (Required):</label>
        <input type="file" id="paymentScreenshotInput" class="login-input" accept="image/*" style="padding: 5px;"
          onchange="previewPaymentScreenshot(event)">
        <img id="paymentScreenshotPreview" src="" alt="Screenshot"
          style="width: 100%; max-height: 150px; object-fit: contain; border: 1px solid cyan; border-radius: 5px; display: none; margin-top: 10px;">
      </div>

      <button class="confirm-pay-btn" onclick="confirmPremiumPayment()">Submit for Verification</button>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboardModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;">
    <div class="login-box"
      style="text-align: center; max-height: 80vh; overflow-y: auto; width: 90%; max-width: 500px; position: relative;">
      <button class="close-modal" onclick="closeLeaderboard()">‚úñ</button>
      <h2 style="color: gold; text-shadow: 0 0 10px gold; margin-top: 10px;">üèÜ Leadership</h2>
      <p style="color: #ccc; font-size: 14px; margin-bottom: 20px;">Top explorers of NextGen</p>
      <div id="leaderboardList" style="display: flex; flex-direction: column; gap: 10px;">
        <!-- Injected via JS -->
      </div>
    </div>
  </div>

  <!-- MOTIVATION SECTION -->
  <div id="semesterMotivationSection" style="display:none;">
    <div class="semester-section">
      <div class="motivation-box">
        <h3>‚ú® Daily Motivation</h3>
        <p id="motivationText">"Success is not final, failure is not fatal: It is the courage to continue that counts.
          Keep pushing your
          limits and remember, every expert was once a beginner. Your hard work today shapes your tomorrow. Focus on
          the
          process, and the results will follow!"</p>
      </div>

      <div class="progress-box" id="progressDashboard">
        <h3>üìä Analytics & Progress Tracking</h3>
        <p style="color: #aaa; font-size: 14px; margin-bottom: 15px;">Automatically tracking your completed videos,
          PDFs, and assignments across all subjects in this semester.</p>
        <div id="progressContent">
          <!-- Dynamically Injected Progress Bars -->
        </div>
      </div>
    </div>
  </div>

  <!-- CHAPTERS -->
  <div class="chapters" id="chapters" style="display:none;">
    <button onclick="goBackToSubjects()" style="margin-bottom:15px; font-size:16px;">‚¨Ö Back to Subjects</button>
    <h2 id="subjectTitle"></h2>
    <ul id="chapterList"></ul>
  </div>

  <!-- CONTENT -->
  <div class="content" id="content" style="display:none;">
    <button onclick="goBackChapter()" style="margin-bottom:15px; font-size:16px;">‚¨Ö Back</button>
    <h2 id="chapterTitle"></h2>

    <div class="section" id="videoSection">
      üìπ Video(s):<br>
      <div id="videoContainer" style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;"></div>
    </div>

    <div class="section" id="notesSection">
      üìù Notes:
      <div id="notesText" style="margin-top: 10px;"></div>
    </div>

    <div class="section" id="pdfSection" style="display:none;">
      üìÑ PDF Notes:<br>
      <div id="pdfContainer" style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;"></div>
    </div>

    <div class="section" id="assignmentSection">
      üìÑ Assignment:
      <div id="assignmentText" style="margin-top: 10px;"></div>
    </div>

    <div class="section" id="homeworkSection">
      üè† Homework:
      <div id="homeworkText" style="margin-top: 10px;"></div>
    </div>

    <!-- AI TUTOR CHATBOT -->
    <div id="aiTutorWidget" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
      <button id="aiTutorBtn" onclick="toggleChat()"
        style="background: cyan; color: black; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 30px; box-shadow: 0 0 15px cyan; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.3s;"
        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">ü§ñ</button>

      <div id="aiChatBox"
        style="display: none; position: absolute; bottom: 75px; right: 0; width: 350px; background: rgba(0, 15, 30, 0.95); border: 1px solid cyan; border-radius: 10px; box-shadow: 0 0 20px cyan; overflow: hidden; flex-direction: column; z-index: 1001;">
        <div
          style="background: cyan; color: black; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 16px;">ü§ñ Gemini AI Tutor</span>
          <button onclick="toggleChat()"
            style="background: transparent; border: none; font-size: 18px; cursor: pointer; color: black; font-weight: bold;">‚úñ</button>
        </div>

        <div id="aiChatHistory"
          style="height: 320px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 14px;">
          <div
            style="align-self: flex-start; background: rgba(0, 255, 255, 0.1); padding: 10px 14px; border-radius: 12px; border-bottom-left-radius: 0; max-width: 85%; border: 1px solid rgba(0, 255, 255, 0.3); color: white; line-height: 1.4;">
            Hello! I'm your AI Assistant. Ask me any doubt related to your studies, assignments, or
            homework!
          </div>
        </div>

        <div
          style="display: flex; gap: 8px; padding: 12px; border-top: 1px solid rgba(0, 255, 255, 0.3); background: rgba(0, 5, 15, 0.9);">
          <input type="text" id="aiChatInput" placeholder="Ask a doubt..."
            style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid cyan; background: rgba(0, 255, 255, 0.05); color: white; outline: none;"
            onkeypress="if(event.key === 'Enter') sendChatMessage()">
          <button onclick="sendChatMessage()"
            style="background: cyan; color: black; border: none; border-radius: 5px; padding: 0 15px; font-weight: bold; cursor: pointer; transition: background 0.3s;"
            onmouseover="this.style.background='#00cccc'" onmouseout="this.style.background='cyan'">Send</button>
        </div>
      </div>
    </div>
  </div>



  <script>
    /* AUTO TYPING */
    let text = "WELCOME TO NEXTGEN LIBRARY";
    let i = 0;
    function typing() {
      if (i < text.length) {
        let el = document.getElementById("typingText");
        if (el) el.innerHTML += text.charAt(i);
        i++;
        setTimeout(typing, 100);
      }
    }
    typing();

    /* PAGE NAVIGATION MANAGER */
    function showPage(pageId, pushToHistory = true) {
      if (!pageId) return;

      // Update Browser History if requested
      if (pushToHistory) {
        history.pushState({ pageId: pageId }, "", "#" + pageId);
      }

      // List of all main content segments
      const allPages = ["loginScreen", "welcomeScreen", "adminDashboard", "programsWrapper", "dynamicNavSection", "chapters", "content", "semesterMotivationSection", "premiumNavSection"];

      allPages.forEach(id => {
        let el = document.getElementById(id);
        if (el) {
          if (id === pageId) {
            el.style.display = (id === "loginScreen" || id === "welcomeScreen") ? "flex" : "block";
          } else {
            el.style.display = "none";
          }
        }
      });

      // Special handling for shared elements like AI Tutor, Header, Footer, Ticker
      const header = document.querySelector("header");
      const footer = document.getElementById("mainFooter");
      const aiTutor = document.getElementById("aiTutorWidget");
      const ticker = document.getElementById("globalTicker");

      const hideForAuth = ["loginScreen", "welcomeScreen", "adminDashboard"].includes(pageId);

      if (header) header.style.display = hideForAuth ? "none" : "flex";
      if (footer) footer.style.display = hideForAuth ? "none" : "block";
      if (aiTutor) aiTutor.style.display = hideForAuth ? "none" : "block";
      if (ticker) ticker.style.display = hideForAuth ? "none" : (globalSiteConfig.ticker ? "block" : "none");

      window.scrollTo(0, 0);
    }

    // Handle Browser Back/Forward Buttons
    window.onpopstate = function (event) {
      if (event.state && event.state.pageId) {
        showPage(event.state.pageId, false);
      } else {
        // Default to login or previous if no state
        showPage("loginScreen", false);
      }
    };

    // Initial State Push
    window.addEventListener('load', () => {
      // Find what page is currently active (visible)
      const allPages = ["loginScreen", "welcomeScreen", "adminDashboard", "programsWrapper", "dynamicNavSection", "chapters", "content", "semesterMotivationSection", "premiumNavSection"];
      let activePage = "loginScreen";
      allPages.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.style.display !== 'none') activePage = id;
      });
      history.replaceState({ pageId: activePage }, "", "#" + activePage);
    });

    /* DATA */
    let oldData = {
      Math: {
        "UNIT 1: Set theory. Relations and Functions": {
          video: "https://www.youtube.com/embed/LK4TtZ_vkeM?si=rF8rcCWCYnUP52z1",
          notes: "Introduction to sets, subsets, operations.",
          pdf: "https://drive.google.com/file/d/15BlIRvpsrBmS-2566uqgrcNJKWINMWOp/view?usp=drive_link",
          assignment: "Solve 10 problems from Set Theory.",
          homework: "Revise union & intersection."
        },
        "UNIT 2: Permutation, Combination and Algebraic System:": {
          video:
            "https://www.youtube.com/embed/yurSCPPloMs?si=lLz2WObc1MDPpbD2",
          notes: "Graphs, trees, properties.",
          pdf: "https://drive.google.com/file/d/1Hf9igdkNSUthYv4Ow6aKiQl3hHusU3dW/view?usp=drive_link",
          assignment: "Draw 5 graphs.",
          homework: "Study tree traversal."
        },
        "UNTI 3: Algebra of Logic:": {
          video: "https://www.youtube.com/embed/l5Vt5bzkLK0?si=G3PrWBLUvQx_3aIT",
          notes: "Boolean algebra, logical operators, truth tables.",
          pdf: "",
          assignment: "Solve 8 problems on propositional calculus.",
          homework: "Study De Morgan's laws."
        },
        "UNIT 4: Recursion and recurrence:": {
          video: "https://www.youtube.com/embed/2ii8mCFXj88?si=idXwvor_pEm4jySM",
          notes: "Lattice structures, Boolean operations, applications.",
          pdf: "",
          assignment: "Design a Boolean circuit.",
          homework: "Revise lattice properties."
        },
        "UNIT 5: Graph and Trees:": {
          video: "https://www.youtube.com/embed/la7b2jWFuhQ?si=7AeONZ9vcfbJu8D7",
          notes: "Graph traversal, connectivity, shortest paths.",
          pdf: "",
          assignment: "Solve graph problems.",
          homework: "Study BFS and DFS algorithms."
        }
      },

      Accounting: {
        "UNIT 1: Introduction to Accounting": {
          video: "https://www.youtube.com/embed/B0jZsLg8pks?si=PCIH4MLVJ09W8cBf",
          notes: "Meaning, Characteristics, Purposes and Limitations; Concepts, Convention and Generally Accepted Accounting Principles.",
          pdf: "https://drive.google.com/file/d/1urySIm4IyaEfc5KWraOTnL1bsAf9koOt/view?usp=drive_link",
          assignment: "Prepare journal entries.",
          homework: "Revise rules."
        },
        "UNIT 2:  Financial Accounting: ": {
          video: "https://www.youtube.com/embed/5pmh4cl9GKY?si=Wm9xem8uGXS_a86H",
          notes: " Double Entry Framework, Basic Concept of Journal, Ledgers-Purchase Book, Sales Book, Cash Book; Trading and Profit & Loss Account, Balance Sheet",
          pdf: "https://drive.google.com/file/d/1Z-BAht5KXnw5V4wlT1QIVqsYUcnoZJwi/view?usp=drive_link",
          assignment: "Prepare journal and ledger entries.",
          homework: "Study golden rules of accounting."
        },
        "UNIT 3: Management Accounting:": {
          video: "https://www.youtube.com/embed/gnRmh4OI3pw?si=ilYJCzzw4ZaOG8jG",
          notes: "Nature, Scope, Advantage and Limitations; Differences between Management Accounting and Financial Accounting.",
          pdf: "",
          assignment: "Prepare complete financial statements.",
          homework: "Verify trial balance."
        },
        "UNIT 4: Raising Funds:": {
          video: "https://www.youtube.com/embed/82u1qyHBMQ4?si=oygKhom2yJ7BYjq",
          notes: "Sources of Raising Funds, Simple Treatment to Issue of Shares, Forfeiture of Shares and Reissue of Forfeited Shares.",
          pdf: "",
          assignment: "Calculate depreciation and adjustments.",
          homework: "Study adjustment process."
        },
        "UNIT 5:  Computer Application:": {
          video: "https://www.youtube.com/embed/8Haz0xLfcbA?si=rzLQu9kw1WA2DMHx",
          notes: " Role of Computers in Accounting, Software Packages for Accounting",
          pdf: "",
          assignment: "Analyze financial statements.",
          homework: "Study key financial ratios."
        }
      },

      Dcld: {
        "DCLD - UNIT 1: Number Systems": {
          video: "https://www.youtube.com/embed/MxjJqq3BJU?si=6rhZmrISZh_PnFVu",
          notes: "Decimal, Binary, Octal, Hexadecimal number system, inter conversion between different number systems, different codes, gray code, ASCII code, Floating point numbers.",
          pdf: "",
          assignment: "Convert numbers between different bases.",
          homework: "Study number system conversions."
        },
        "DCLD - UNIT 2: Logic Gates and Boolean Algebra": {
          video: "https://www.youtube.com/embed/EW_2MhFu7tE?si=ti8E8NYs7Dtw4pHH",
          notes: "Elements and functions of digital Logic gates, Gate propagation delay time, logic gates applications. Boolean algebra: Boolean operations, SOP and POS forms and simplification using Karnaugh maps, Realization of expressions using universal logic gates.",
          pdf: "",
          assignment: "Simplify Boolean expressions using K-maps.",
          homework: "Study Boolean theorems."
        },
        "DCLD - UNIT 3: Combinational logical circuits": {
          video: "https://www.youtube.com/embed/pHNbm-4reIc?si=BcNoKtnKTlYu7e90",
          notes: "Design of Binary Adder- half and full, Serial, Parallel, Carry look ahead adder. Full subtracter, code converters, MUX and DEMUX, encoders and decoders, seven segment decoder.",
          pdf: "",
          assignment: "Design combinational logic circuits.",
          homework: "Study gate implementations."
        },
        "DCLD - UNIT 4: Sequential logic circuits: ": {
          video: "https://www.youtube.com/embed/v0pxOfTg18Y?si=4nq0hPKMPrurDPIj",
          notes: "Latches, key debouncer, Flip flop: SR, J-K, D, T, Master slave J-K, flipflops with preset and clear . Counters; Binary counter, synchronous counter, mod-10 counter, Generation of control signals; Controlled counter; Up-down counter, Shift register, Parity generator or checker, Synchronization of an asynchronous pulse.",
          pdf: "",
          assignment: "Design sequential circuits.",
          homework: "Study flip-flop types."
        },
        "DCLD - UNIT 5:  Microprocessor:": {
          video: "https://www.youtube.com/embed/SBh6dJMM6AI?si=5HwK09d1CBVzUZ6z",
          notes: "Architecture of a basic microcomputer, some general microprocessor system concepts: I/O ports and buses, internal architecture of a microprocessor, Microprocessor fetches, decode, execute cycle memory mapped and I/O mapped ports, I/O controls.",
          pdf: "",
          assignment: "Implement digital devices.",
          homework: "Study device applications."
        },
      },

      Oops: {
        "OOPS - UNIT 1: Principles of Object Oriented Programming (OOP)": {
          video: "https://www.youtube.com/embed/mlIUKyZIUUU?si=SBp5sE2BdgTR8UaY",
          notes: "Basic Concepts of OOP, Comparison of procedural programming and OOP, Advantages of OOP, OOP Languages, Definitions: .Class, Objects, Concepts of inheritance and encapsulation, Operator overloading, Dynamic binding. Over view of OOP using C++, Basic Program construction: main and functions, Program statements, class declaration, comments++ compilation.",
          pdf: "",
          assignment: "Write simple C++ program with classes.",
          homework: "Homework 1 (1) Define low-level, mid-level and high-level languages , (2) Write applications of OOP concepts. Homework 2 (1) Explain how namespace and header files differ from each other using real-life examples. (2) Why is procedural programming unsuitable for large-scale software systems? Explain in depth. (3) Homework 3 (1) Write the difference between function prototype and function declaration with syntax. (2) Explain the difference between class and structure. Write a small code to explain the same."
        },
        "OOPS - UNIT 2: Elements of C++ Language": {
          video: "https://www.youtube.com/embed/TOG6xCEJU3M?si=2lA-jZb7wHUhh1j7",
          notes: "Tokens and identifiers: Character set and symbols, Keywords. C++, identifiers. Variables and constants. Data Types: Basic data types, Arrays and strings, User defined data types; Operators, type conversions and type cast operators, Console I/O : cin, cout functions, Control statements: The if statement, if else; else.... if: switch statements, Loops: for and while do statements, Break, continue, go to, Functions Simple functions: Declaration of functions. Calling functions, Function definition, Passing arguments and returning values: Passing constants and variables, Pass by value. Return statement, types of functions, Passing and returning structure variables, Inline functions, Default arguments, returning by reference, pointers.",
          pdf: "",
          assignment: "Create classes with constructors and destructors.",
          homework: "Study access specifiers."
        },
        "OOPS - UNIT 3:  Classes and Objects": {
          video: "https://www.youtube.com/embed/YNuFnhRMoVs?si=zBd253Sg6HEmRzq-",
          notes: "Declaration of classes and objects in C++, Class definition. Declaration of members, objects as date time, Objects as function arguments. Array of objects, Returning objects from function, Structures and classes. Basic constructors, Parameterized constructors. Constructors with default arguments. Dynamic initialization of objects, use of copy constructor, shallow copying and deep copying, Dynamic constructors. Destructors, constraints on constructors and destructors.",
          pdf: "",
          assignment: "Create derived classes with inheritance.",
          homework: "Study inheritance types."
        },
        "OOPS - UNIT 4:  Operator Overloading": {
          video: "https://www.youtube.com/embed/0QjDxmSVryU?si=KeuZ3RawSubAmCWG",
          notes: "Overloading unary operators: Operator keyword, Arguments and return values, Laminations of increment operators, overloading binary operators. Arithmetic operators Examples: Addition of polar coordinates and concatenation of strings Multiple overloading, Comparison operators, Arithmetic assignment operators. Data and type conversions: Conversion between basic types, Conversion between objects and basic types, conversion between objects of different classes, Constraints on type conversion",
          pdf: "",
          assignment: "Implement polymorphism examples.",
          homework: "Study virtual functions."
        },
        "OOPS - UNIT 5: Derived Classes and Inheritance": {
          video: "https://www.youtube.com/embed/7ZfEp71tIec?si=ch_z8CDdZsAacdFW",
          notes: "Derived, classes and base class: Defining a derived class, accessing the bases class members, the protected access specifier, specifer. Derived class constructors. Overriding the member functions, Class hierarchies: Abstract base class. Inheritance: Public and private inheritance. Types of Inheritance single level, multi level, multiple, hybrid etc., virtual function, stream classes.",
          pdf: "",
          assignment: "Handle exceptions in C++ programs.",
          homework: "Study STL containers."
        }
      },

      Labwork: {
        "L1": { notes: "Lab 1", pdf: "https://drive.google.com/file/d/1i0CEGHhiHYnZZ7ChWoMI_QQIlDh_wElA/view?usp=drive_link" },
        "L2": { notes: "Lab 2", pdf: "https://drive.google.com/file/d/1zolBnOeqZ8nFpRAaWCresFFMEF_RO9H3/view?usp=drive_link" },
        "L3": { notes: "Lab 3", pdf: "https://drive.google.com/file/d/1XDM_QariM46DrngARJyAyJE3wMC1trUT/view?usp=drive_link" },
        "L4": { notes: "Lab 4", pdf: "https://drive.google.com/file/d/1s0haqXOUyHbgKLv9482R6e5iQ30X8T3g/view?usp=drive_link" },
        "L5": { notes: "Lab 5", pdf: "https://drive.google.com/file/d/17VEQ8xkqd8GE-4L2CqCWoYD7fl-mSN8M/view?usp=drive_link" },
        "L6": { notes: "Lab 6", pdf: "https://drive.google.com/file/d/1v6Xe1dcACGTX5uT9jBYpEFvUWh3Sak3p/view?usp=drive_link" },
        "L7": { notes: "Lab 7", pdf: "https://drive.google.com/file/d/1jekV2UHtKTpcBkuZRGZjKceM5XXy1NAk/view?usp=drive_link" },
        "L8": { notes: "Lab 8", pdf: "https://drive.google.com/file/d/1IDVA0Yb-PzDqhMyGMo881HJjx4VVaRce/view?usp=drive_link" },
        "L9": { notes: "Lab 9", pdf: "https://drive.google.com/file/d/1VmSM4IQVXO8Wq_Gfmc_MA31MFTFEwfeZ/view?usp=drive_link" },
        "L10": { notes: "Lab 10", pdf: "https://drive.google.com/file/d/1x_DqpHKEe7VFFCSbbPDziQU4CmqV5h_9/view?usp=drive_link" },
        "L11": { notes: "Lab 11", pdf: "https://drive.google.com/file/d/11qvX83gzQ9-vtTc66T3-_h51b8PcHCur/view?usp=drive_link" },
        "L12": { notes: "Lab 12", pdf: "https://drive.google.com/file/d/1I-RJ3UBs9xRtrCPfUFzAixZ9440mWXKI/view?usp=drive_link" },
        "L13": { notes: "Lab 13", pdf: "https://drive.google.com/file/d/1tWpaL9j9XSIaYzeHNHJJuhDdAP-WX-L3/view?usp=drive_link" },
        "L14": { notes: "Lab 14", pdf: "https://drive.google.com/file/d/1K7_9X1Rnl1qNEaPW4jOFzwkm4455cWCO/view?usp=drive_link" },
        "L15": { notes: "Lab 15", pdf: "https://drive.google.com/file/d/1s5GkA6oqan2EZRZ8xru1Civ_Ce25rP2R/view?usp=drive_link" },
        "L16": { notes: "Lab 16", pdf: "https://drive.google.com/file/d/1WsjzxsOjacvIw-dNhSgySGavNgZfhlf4/view?usp=drive_link" },
        "L17": { notes: "Lab 17", pdf: "https://drive.google.com/file/d/1l7xrvtM0HBJAlNSBcBSC4UjZ8ffTFsNV/view?usp=drive_link" },
        "L18": { notes: "Lab 18", pdf: "https://drive.google.com/file/d/19I44HsJlFwcteidEEm57qO-ezsJcK3Cp/view?usp=drive_link" },
        "L19": { notes: "Lab 19", pdf: "" },
        "L20": { notes: "Lab 20", pdf: "https://drive.google.com/file/d/1ZAp9brogxL2H7P6tM0y6w7tdyn0BWdq2/view?usp=drive_link" },
        "L21": { notes: "Lab 21", pdf: "https://drive.google.com/file/d/1my2W98iS59W8BbG5QU1k8J_kQx14LhsT/view?usp=drive_link" },
        "L22": { notes: "Lab 22", pdf: "https://drive.google.com/file/d/1LATPKKK-0-6o8qWeoykRrfVQsGc5K_G6/view?usp=drive_link" },
        "L23": { notes: "Lab 23", pdf: "https://drive.google.com/file/d/1L-tmZcnLtvm0a3C09tovTigK0dSF0VnT/view?usp=drive_link" },
        "L24": { notes: "Lab 24", pdf: "https://drive.google.com/file/d/1mV_LEIH7YjlzhYtJOsWQrjuGAhfeqprT/view?usp=drive_link" },
        "L25": { notes: "Lab 25", pdf: "https://drive.google.com/file/d/1JQhIymezV4WfcdepiczEx929_nnkEp1M/view?usp=drive_link" },
        "L26": { notes: "Lab 26", pdf: "" },
        "L27": { notes: "Lab 27", pdf: "" },
        "L28": { notes: "Lab 28", pdf: "" },
        "L29": { notes: "Lab 29", pdf: "" },
        "L30": { notes: "Lab 30", pdf: "" },
        "L31": { notes: "Lab 31", pdf: "" },
        "L32": { notes: "Lab 32", pdf: "" },
        "L33": { notes: "Lab 33", pdf: "" },
        "L34": { notes: "Lab 34", pdf: "" },
        "L35": { notes: "Lab 35", pdf: "" },
        "L36": { notes: "Lab 36", pdf: "" },
        "L37": { notes: "Lab 37", pdf: "" },
        "L38": { notes: "Lab 38", pdf: "" },
        "L39": { notes: "Lab 39", pdf: "" },
        "L40": { notes: "Lab 40", pdf: "" }
      },

      ComputerSkill: {
        "UNIT 1: Introduction to Computers": {
          video: "https://www.youtube.com/embed/agaLaSafbwc?si=2OQLr54YVYxY93cr",
          notes: "Computer basics, hardware components, operating systems.",
          pdf: "",
        },
      },

      CommunicationSkill: {
        "UNIT 1: Introduction to Communication": {
          video: "https://www.youtube.com/embed/99W9-1I66Jw?si=oYHcAqt1irSsG2sq",
          notes: "Communication process, types of communication, importance.",
          pdf: "",

        },
        "UNIT 2: Written Communication": {
          video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
          notes: "Business writing, emails, reports, documentation skills.",
          pdf: "",

        },
        "UNIT 3: Verbal Communication": {
          video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
          notes: "Listening skills, speaking techniques, presentation skills.",
          pdf: "",
          assignment: "",
          homework: ""
        },
        "UNIT 4: Non-Verbal Communication": {
          video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
          notes: "Body language, gestures, facial expressions, tone of voice.",
          pdf: "",

        },
        "UNIT 5: Interpersonal and Professional Communication": {
          video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
          notes: "Teamwork, conflict resolution, professional etiquette.",
          pdf: "",

        }
      }
    };

    let allSubjects = {
      "Discrete Maths": oldData.Math,
      "Accounting": oldData.Accounting,
      "Digital Logic": oldData.Dcld,
      "C++ Programming": oldData.Oops,
      "Lab Work": oldData.Labwork,
      "Computer Skills": oldData.ComputerSkill,
      "Communication": oldData.CommunicationSkill,
      "Important Qs": oldData.QuestionPractice
    };

    let defaultData = {
      "BCA": { "DDU": {}, "AKTU": {} }
    };

    for (let course in defaultData) {
      for (let branch in defaultData[course]) {
        for (let i = 1; i <= 6; i++) {
          defaultData[course][branch][i] = JSON.parse(JSON.stringify(allSubjects));
        }
      }
    }

    let data = defaultData;
    let globalSiteConfig = { ticker: "", welcome: "", about: "", premiumEnabled: true, banners: [] };
    let globalPremiumConfig = { qr: "", upi: "", amount: "" };
    let globalPremiumCourseConfigs = {};
    let isRecoveringMode = false;
    let tempRecoverMobile = "";
    let currentUserMobile = "";

    function triggerNeuralSyncNotification(msg) {
      const hud = document.getElementById("neuralSyncHUD");
      if (!hud) return;
      hud.innerText = msg;
      hud.style.display = "block";
      hud.style.animation = "neuralPulse 2s infinite, slideInUp 0.5s ease-out";
      setTimeout(() => {
        hud.style.display = "none";
      }, 5000);
    }

    // CHECK PERSISTENT LOGIN ON LOAD
    window.onload = function () {
      Promise.all([
        database.ref('courseData').once('value'),
        database.ref('premiumConfig').once('value'),
        database.ref('premiumCourseConfigs').once('value'),
        database.ref('premiumData').once('value')
      ]).then(snapshots => {
        let [courseSnap, pConfSnap, pCourseConfSnap, pDataSnap] = snapshots;
        if (courseSnap.exists() && courseSnap.val()) data = courseSnap.val();
        if (pConfSnap.exists() && pConfSnap.val()) globalPremiumConfig = pConfSnap.val();
        if (pCourseConfSnap.exists() && pCourseConfSnap.val()) globalPremiumCourseConfigs = pCourseConfSnap.val();
        if (pDataSnap.exists() && pDataSnap.val()) premiumData = pDataSnap.val();

        // ENABLE REAL-TIME NEURAL SYNC
        database.ref('courseData').on('value', snap => {
          const newData = snap.val();
          if (newData && JSON.stringify(newData) !== JSON.stringify(data)) {
            data = newData;
            triggerNeuralSyncNotification("üì° Incoming Data Stream: Course Library Updated.");
            renderStudentCourses();
            if (currentUserMobile) restoreNavState(); // Gently refresh current view
          }
        });

        loadSiteSettings();
        initAdminCMS(); // Sync all dropdowns
        renderStudentCourses();
        renderPremiumHubCourses();

        let activeUser = localStorage.getItem("activeSessionMobile");
        let expTime = localStorage.getItem("activeSessionExp");
        if (localStorage.getItem("adminSession") === "true") {
          showPage("adminDashboard");
          loadAdminData();
          renderPendingPayments();
          renderActivePremiumUsers();
        } else if (activeUser && expTime && Date.now() < parseInt(expTime)) {
          database.ref('users/' + activeUser).once('value').then((snapshot) => {
            let userData = snapshot.val();
            if (userData) {
              currentUserMobile = activeUser;

              // Sync to LocalStorage for offline and profile access
              localStorage.setItem(activeUser, JSON.stringify(userData));

              // Show profile picture button in header
              const picEl = document.getElementById('userProfilePicHeader');
              if (picEl) {
                picEl.src = userData.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name || 'U')}&background=cyan&color=000`;
                picEl.style.display = 'block';
              }

              // Show Header Badge
              const badgeEl = document.getElementById("headerGamificationBadge");
              if (badgeEl) {
                let pts = userData.timeSpent || 0;
                let badge = "Beginner üå±";
                let badgeColor = "#38ef7d";
                if (pts >= 300) { badge = "Master Scholar üëë"; badgeColor = "gold"; }
                else if (pts >= 60) { badge = "Explorer üöÄ"; badgeColor = "cyan"; }

                badgeEl.innerText = badge;
                badgeEl.style.color = badgeColor;
                badgeEl.style.borderColor = badgeColor;
                badgeEl.style.display = "block";
              }

              updateNeuralHUD(userData);

              showPage("welcomeScreen");
              document.querySelector("#welcomeScreen p").innerText = `\nWelcome back, ${userData.name}!`;
              startTimeTracking();
              setTimeout(restoreNavState, 800);
            }
          });
        }
      }).catch(err => console.error("Firebase init failed:", err));
    };

    function updateNeuralHUD(userData) {
      if (!userData) return;
      document.getElementById('neuralHUD').style.display = 'flex';

      let pts = userData.timeSpent || 0;
      let badge = "Beginner üå±";
      let badgeColor = "#38ef7d";
      if (pts >= 300) { badge = "Master üëë"; badgeColor = "gold"; }
      else if (pts >= 60) { badge = "Explorer üöÄ"; badgeColor = "cyan"; }

      document.getElementById('hudRank').innerText = badge;
      document.getElementById('hudRank').style.color = badgeColor;
      document.getElementById('hudPoints').innerText = pts + " XP";
    }

    // TIME TRACKING ENGINE
    let timeSpentInterval = null;
    let isTabVisible = true;

    document.addEventListener("visibilitychange", () => {
      isTabVisible = !document.hidden;
    });

    function startTimeTracking() {
      if (timeSpentInterval) clearInterval(timeSpentInterval);

      timeSpentInterval = setInterval(() => {
        if (!currentUserMobile || !isTabVisible) return;

        let stObj = JSON.parse(localStorage.getItem(currentUserMobile)) || {};
        stObj.timeSpent = (stObj.timeSpent || 0) + 1;

        // Sync to Local for instant UI response if needed
        localStorage.setItem(currentUserMobile, JSON.stringify(stObj));

        // Sync to Firebase directly
        database.ref('users/' + currentUserMobile + '/timeSpent').set(stObj.timeSpent);

        // Update HUD real-time
        updateNeuralHUD(stObj);
      }, 60000); // 1 minute intervals
    }

    /* AUTHENTICATION FUNCTIONS */

    function toggleAuthMode(mode) {
      document.getElementById('signUpForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('adminLoginForm').style.display = 'none';

      if (mode === 'login') {
        document.getElementById('loginForm').style.display = 'block';
      } else if (mode === 'signup') {
        document.getElementById('signUpForm').style.display = 'block';
      } else if (mode === 'admin') {
        document.getElementById('adminLoginForm').style.display = 'block';
      }
    }

    // FORGOT DETAILS RECOVERY
    function recoverDetails() {
      let rollSearch = prompt("Enter your registered University Roll Number / Registation Number to recover/edit your details:");
      if (!rollSearch || rollSearch.trim() === "") return;

      let foundUser = null;
      // We search both local and Firebase for redundancy if needed, but primarily Firebase
      database.ref('users').once('value').then(snap => {
        let users = snap.val() || {};
        for (let mobile in users) {
          if (users[mobile].roll && users[mobile].roll === rollSearch.trim()) {
            foundUser = users[mobile];
            break;
          }
        }

        if (foundUser) {
          isRecoveringMode = true;
          tempRecoverMobile = foundUser.mobile;

          document.getElementById("editName").value = foundUser.name;
          document.getElementById("editRoll").value = foundUser.roll;
          document.getElementById("editBranch").value = foundUser.branch;
          document.getElementById("editSection").value = foundUser.section;
          document.getElementById("editMobile").value = foundUser.mobile;

          document.querySelector("#editProfileScreen h2").innerText = "üõ†Ô∏è Fix Registration Details";
          document.getElementById("editProfileScreen").style.display = "flex";
        } else {
          alert("Sorry, no account found matching this Roll Number.");
        }
      });
    }

    // ID CARD GENERATOR
    function downloadIDCard() {
      if (!currentUserMobile) return;

      // Auto-Sync Data from LocalStorage before generating
      let ud = JSON.parse(localStorage.getItem(currentUserMobile));
      if (ud) {
        let picURL = ud.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(ud.name || 'U')}&background=cyan&color=000`;
        document.getElementById("idCardPic").src = picURL;
        document.getElementById("idCardName").innerText = ud.name || "STUDENT NAME";
        document.getElementById("idCardRoll").innerText = ud.roll || "--";
        document.getElementById("idCardCourse").innerText = (ud.branch || "--") + (ud.section ? " | " + ud.section : "");
        document.getElementById("idCardMobile").innerText = ud.mobile ? "+91 " + ud.mobile : "--";

        // ID Card Gamification Injection
        let pts = ud.timeSpent || 0;
        let badge = "Beginner üå±";
        let badgeColor = "#38ef7d";
        if (pts >= 300) { badge = "Master Scholar üëë"; badgeColor = "gold"; }
        else if (pts >= 60) { badge = "Explorer üöÄ"; badgeColor = "cyan"; }

        document.getElementById("idCardPoints").innerText = pts;
        document.getElementById("idCardRankText").innerText = badge.split(' ')[0]; // Just the text part
        document.getElementById("idCardRankText").style.color = badgeColor;
        document.getElementById("idCardRankIcon").innerHTML = `<span style="font-size: 14px;">${badge.split(' ')[1] || 'üéì'}</span>`;
        document.getElementById("idCardRankIcon").style.background = badgeColor === 'gold' ? 'linear-gradient(135deg, gold, orange)' : (badgeColor === 'cyan' ? 'linear-gradient(135deg, #00f2fe, #4facfe)' : 'linear-gradient(135deg, #11998e, #38ef7d)');
      }

      const idCard = document.getElementById('studentIdCard');

      const btn = event.target;
      const originalText = btn.innerText;
      btn.innerText = "‚è≥ Generating...";
      btn.disabled = true;

      // Ensure images load before snapshotting
      const imgs = idCard.querySelectorAll('img');
      let promises = Array.from(imgs).map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise((resolve) => {
          img.onload = resolve;
          img.onerror = resolve;
        });
      });

      Promise.all(promises).then(() => {
        // Temporarily scroll to top
        const origScrollY = window.scrollY;
        window.scrollTo(0, 0);

        html2canvas(idCard, {
          backgroundColor: null,
          scale: 3, // High quality
          useCORS: true, // Allow cross-origin images
          allowTaint: true,
          scrollX: 0,
          scrollY: 0,
          windowWidth: document.documentElement.offsetWidth,
          windowHeight: document.documentElement.offsetHeight,
          x: 0,
          y: 0
        }).then(canvas => {
          window.scrollTo(0, origScrollY); // Restore scroll
          const link = document.createElement('a');
          link.download = `NextGen_ID_${currentUserMobile}.png`;
          link.href = canvas.toDataURL('image/png', 1.0);
          link.click();

          btn.innerText = "‚úÖ Downloaded!";
          setTimeout(() => {
            btn.innerText = originalText;
            btn.disabled = false;
          }, 3000);
        }).catch(err => {
          window.scrollTo(0, origScrollY);
          console.error("ID Card generation failed", err);
          btn.innerText = "‚ùå Error! Try Again";
          btn.disabled = false;
          alert("Could not generate ID card. Please ensure your profile picture is loaded correctly.");
        });
      });
    }

    // PROFILE MANAGEMENT
    let cropperInstance = null;

    function previewEditProfilePic(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const image = document.getElementById('imageToCrop');
          image.src = e.target.result;
          document.getElementById('cropModal').style.display = 'flex';

          if (cropperInstance) {
            cropperInstance.destroy();
          }

          cropperInstance = new Cropper(image, {
            aspectRatio: 1, // enforced square for circle
            viewMode: 1,
            autoCropArea: 0.8,
            dragMode: 'move',
            background: false,
            minContainerHeight: 300,
            ready: function () {
              // Circle styling mask
              document.querySelector('.cropper-view-box').style.borderRadius = '50%';
              document.querySelector('.cropper-face').style.borderRadius = '50%';
            }
          });
        }
        reader.readAsDataURL(file);
      }
    }

    function cancelCrop() {
      document.getElementById('cropModal').style.display = 'none';
      document.getElementById('editProfilePicInput').value = ""; // Reset file input
      if (cropperInstance) cropperInstance.destroy();
    }

    function applyCrop() {
      if (!cropperInstance) return;

      // Output perfectly as circular PNG format if supported, or standard base64 square that our CSS rounds
      const canvas = cropperInstance.getCroppedCanvas({
        width: 300,
        height: 300
      });

      const base64Pic = canvas.toDataURL('image/png');

      document.getElementById('editProfilePicPreview').src = base64Pic;
      document.getElementById('idCardPic').src = base64Pic; // Sync to ID Card preview instantly

      // Clean up
      document.getElementById('cropModal').style.display = 'none';
      cropperInstance.destroy();
      cropperInstance = null;
    }
    function openEditProfile() {
      if (!currentUserMobile) return;
      let ud = JSON.parse(localStorage.getItem(currentUserMobile));
      if (!ud) return;

      document.getElementById("editName").value = ud.name;
      document.getElementById("editRoll").value = ud.roll;
      document.getElementById("editBranch").value = ud.branch;
      document.getElementById("editSection").value = ud.section;
      document.getElementById("editMobile").value = ud.mobile;
      document.getElementById("editMobile").disabled = true; // Cannot edit main key

      let picURL = ud.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(ud.name)}&background=cyan&color=000`;
      document.getElementById("editProfilePicPreview").src = picURL;

      // Calculate Gamification Badge
      let pts = ud.timeSpent || 0;
      let badge = "Beginner üå±";
      let badgeColor = "#38ef7d";
      if (pts >= 300) { badge = "Master Scholar üëë"; badgeColor = "gold"; }
      else if (pts >= 60) { badge = "Explorer üöÄ"; badgeColor = "cyan"; }

      document.getElementById("userPoints").innerText = pts;
      let rankEl = document.getElementById("userRank");
      if (rankEl) {
        rankEl.innerText = badge;
        rankEl.style.color = badgeColor;
      }

      // Update ID Card Data Behind the scenes
      document.getElementById("idCardPic").src = picURL;
      document.getElementById("idCardName").innerText = ud.name;
      document.getElementById("idCardRoll").innerText = ud.roll;
      document.getElementById("idCardCourse").innerText = ud.branch + (ud.section ? " | " + ud.section : "");
      document.getElementById("idCardMobile").innerText = "+91 " + ud.mobile;

      document.querySelector("#editProfileScreen h2").innerText = "‚úèÔ∏è Edit Profile";
      document.getElementById("editProfileScreen").style.display = "flex";
      isRecoveringMode = false;
    }

    // VALIDATION HELPERS
    function validateInput(name, roll, mobile) {
      if (!/^[A-Za-z\s]+$/.test(name)) {
        alert("Validation Error: Name must contain only English alphabets and spaces.");
        return false;
      }
      if (!/^\d{13}$/.test(roll)) {
        alert("Validation Error: Roll Number must be exactly 13 digits long.");
        return false;
      }
      if (!/^\d{10}$/.test(mobile)) {
        alert("Validation Error: Mobile Number must be exactly 10 digits long.");
        return false;
      }
      return true;
    }

    function handleSignUp() {
      let name = document.getElementById("regName").value.trim();
      let roll = document.getElementById("regRoll").value.trim();
      let branch = document.getElementById("regBranch").value;
      let section = document.getElementById("regSection").value;
      let mobile = document.getElementById("regMobile").value.trim();

      if (!name || !roll || !branch || !section || !mobile) {
        alert("Please fill in all details to register!");
        return;
      }

      if (!validateInput(name, roll, mobile)) return;

      let btn = document.querySelector("#signUpForm .login-btn");
      btn.innerText = "Registering...";
      btn.disabled = true;

      database.ref('users/' + mobile).once('value').then((snapshot) => {
        if (snapshot.exists()) {
          alert("An account with this mobile number already exists! Please login.");
          toggleAuthMode('login');
          btn.innerText = "Sign Up & Enter";
          btn.disabled = false;
          return;
        }

        let userData = {
          name, roll, branch, section, mobile,
          registeredAt: Date.now(),
          timeSpent: 0
        };

        // FACE SCAN SIMULATION
        document.getElementById('faceScanOverlay').style.display = 'flex';

        setTimeout(() => {
          database.ref('users/' + mobile).set(userData).then(() => {
            document.getElementById('faceScanOverlay').style.display = 'none';
            localStorage.setItem(mobile, JSON.stringify(userData));
            localStorage.setItem("activeSessionMobile", mobile);
            localStorage.setItem("activeSessionExp", (Date.now() + 5 * 60 * 60 * 1000).toString());

            currentUserMobile = mobile;
            alert("Registration Successful!");
            showPage("welcomeScreen");
            let wsP = document.querySelector("#welcomeScreen p");
            wsP.innerText = `\nWelcome, ${name}!`;

            btn.innerText = "Sign Up & Enter";
            btn.disabled = false;
            startTimeTracking();
            updateNeuralHUD(userData);
          }).catch(err => {
            document.getElementById('faceScanOverlay').style.display = 'none';
            alert("Network error, please try again.");
            btn.innerText = "Sign Up & Enter";
            btn.disabled = false;
          });
        }, 2500);
      });
    }

    function handleLogin() {
      let name = document.getElementById("loginName").value.trim();
      let mobile = document.getElementById("loginMobile").value.trim();
      let section = document.getElementById("loginSection").value;

      if (!name || !mobile || !section) {
        alert("Please enter Name, Section, and Mobile Number!");
        return;
      }

      let btn = document.querySelector("#loginForm .login-btn");
      btn.innerText = "Logging in...";
      btn.disabled = true;

      database.ref('users/' + mobile).once('value').then((snapshot) => {
        let savedData = snapshot.val();
        if (savedData && savedData.name.toLowerCase() === name.toLowerCase() && savedData.section === section) {

          // FACE SCAN SIMULATION
          document.getElementById('faceScanOverlay').style.display = 'flex';

          setTimeout(() => {
            document.getElementById('faceScanOverlay').style.display = 'none';
            localStorage.setItem(mobile, JSON.stringify(savedData));
            localStorage.setItem("activeSessionMobile", mobile);
            localStorage.setItem("activeSessionExp", (Date.now() + 5 * 60 * 60 * 1000).toString());

            currentUserMobile = mobile;
            showPage("welcomeScreen");
            let wsP = document.querySelector("#welcomeScreen p");
            wsP.innerText = wsP.innerText.split('\n')[0] + `\nWelcome back, ${savedData.name}!`;

            startTimeTracking();
            updateNeuralHUD(savedData);
            btn.innerText = "Log In";
            btn.disabled = false;
          }, 2500);
        } else {
          alert("Incorrect credentials or user not found.");
          btn.innerText = "Log In";
          btn.disabled = false;
        }
      }).catch(err => {
        alert("Login failed.");
        btn.innerText = "Log In";
        btn.disabled = false;
      });
    }

    // ADMIN FUNCTIONS
    function handleAdminLogin() {
      let user = document.getElementById("adminUser").value.trim();
      let pass = document.getElementById("adminPass").value.trim();

      database.ref('adminCredentials').once('value').then(snap => {
        let creds = snap.val() || { user: "admin", pass: "admin123" };
        if (user === creds.user && pass === creds.pass) {
          localStorage.setItem("adminSession", "true");
          showPage("adminDashboard");
          loadAdminData();
          renderPendingPayments();
          renderActivePremiumUsers();
        } else {
          alert("Invalid Admin Credentials!");
        }
      });
    }

    function adminLogout() {
      if (!confirm("Are you sure you want to logout?")) return;
      localStorage.removeItem("adminSession");
      showPage("loginScreen");
      toggleAuthMode('admin');
      document.getElementById("adminUser").value = "";
      document.getElementById("adminPass").value = "";
    }

    /* PENDING PAYMENTS ADMIN LOGIC */
    function renderPendingPayments() {
      let tbody = document.getElementById("pendingPaymentsTableBody");
      tbody.innerHTML = "<tr><td colspan='5' style='padding: 15px; text-align: center; color: cyan;'>Loading...</td></tr>";

      database.ref('pendingPayments').on('value', snap => {
        tbody.innerHTML = "";
        let pendingData = snap.val() || {};
        let pendingArr = Object.values(pendingData);
        let pendingOnly = pendingArr.filter(req => req.status === "pending");

        if (pendingOnly.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5' style='padding: 15px; text-align: center; color: #aaa;'>No pending Premium approvals.</td></tr>";
          return;
        }

        pendingOnly.forEach(req => {
          let tr = document.createElement("tr");
          tr.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
          tr.innerHTML = `
            <td style="padding: 10px;">${req.name}<br><small style="color:cyan;">${req.mobile}</small></td>
            <td style="padding: 10px;">${req.itemKey.replace('_', ' - ')}</td>
            <td style="padding: 10px; font-family: monospace;">${req.utr}</td>
            <td style="padding: 10px;">
              <button class="login-btn" onclick="viewScreenshot('${req.id}')" style="background: cyan; color: black; padding: 5px 10px; margin: 0; font-size: 12px;">üñºÔ∏è View Proof</button>
            </td>
            <td style="padding: 10px; display: flex; gap: 5px;">
              <button class="login-btn" onclick="approvePayment('${req.id}', '${req.mobile}', '${req.itemKey}')" style="background: #28a745; color: white; padding: 5px 10px; margin: 0; font-size: 12px;">‚úÖ Approve</button>
              <button class="login-btn" onclick="rejectPayment('${req.id}')" style="background: #ff4757; color: white; padding: 5px 10px; margin: 0; font-size: 12px;">‚ùå Reject</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    function viewScreenshot(reqId) {
      database.ref('pendingPayments/' + reqId).once('value').then(snap => {
        let req = snap.val();
        if (req && req.screenshot) {
          let win = window.open("");
          win.document.write(`<img src="${req.screenshot}" style="max-width:100%; display:block; margin:auto;" />`);
        } else {
          alert("Screenshot not available.");
        }
      });
    }

    function approvePayment(reqId, mobile, itemKey) {
      let days = prompt("Approve Payment - Enter number of days for premium access (leave blank for lifetime):");
      if (days === null) return; // User cancelled prompt

      let expiresAt = null;
      if (days && !isNaN(days) && parseInt(days) > 0) {
        expiresAt = Date.now() + (parseInt(days) * 24 * 60 * 60 * 1000);
      }

      let payload = {
        active: true,
        expiresAt: expiresAt
      };

      if (confirm("Are you sure you want to approve this payment and grant access?")) {
        // Set premiumUnlocked inside user's node
        database.ref(`users/${mobile}/premiumUnlocked/${itemKey}`).set(payload).then(() => {
          // Remove the pending request entirely
          return database.ref('pendingPayments/' + reqId).remove();
        }).then(() => {
          alert("‚úÖ Payment Approved! User now has access to " + itemKey);
        }).catch(err => {
          console.error(err);
          alert("‚ùå Failed to approve payment due to network error.");
        });
      }
    }

    /* ADMIN HACK: ONE-CLICK DATA BACKUP */
    function backupFullData() {
      database.ref('/').once('value').then(snap => {
        const data = snap.val();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `NextGen_Backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("‚úÖ Full Database Backup Downloaded!");
      });
    }

    /* ADMIN HACK: USER SHADOW MODE */
    function viewUserShadow(mobile) {
      database.ref(`users/${mobile}`).once('value').then(snap => {
        const u = snap.val();
        if (!u) return alert("User not found.");

        const shadowModal = document.getElementById('userShadowModal');
        const shadowDetails = document.getElementById('shadowDetails');
        const shadowPic = document.getElementById('shadowPic');
        const shadowTimestamp = document.getElementById('shadowTimestamp');

        shadowPic.src = u.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=ff4757&color=fff`;
        shadowTimestamp.innerText = `LAST_ACCESS: ${new Date().toLocaleTimeString()}`;

        let unlockedItems = "None";
        if (u.premiumUnlocked) {
          unlockedItems = Object.keys(u.premiumUnlocked).filter(k => u.premiumUnlocked[k] === true || (u.premiumUnlocked[k] && u.premiumUnlocked[k].active)).length + " SECTORS";
        }

        shadowDetails.innerHTML = `
            <h2 style="margin: 0 0 2px 0; font-size: 22px; font-weight: 900; text-transform: uppercase; color: #fff; text-shadow: 0 0 10px rgba(255,71,87,0.5);">${u.name}</h2>
            <p style="margin: 0 0 10px 0; font-size: 10px; color: #ff4757; font-weight: bold; text-transform: uppercase;">TARGET IDENTIFIED: SECURE NODE ACTIVE ‚ú®</p>
            <table style="width: 100%; font-size: 11px; border-collapse: separate; border-spacing: 0 4px;">
              <tr>
                <td style="color: #ff4757; font-weight: 600; width: 80px; letter-spacing: 1px;">MOBILE NUM</td>
                <td style="color: #fff; font-weight: bold; font-family: monospace; font-size: 12px;">+91 ${mobile}</td>
              </tr>
              <tr>
                <td style="color: #ff4757; font-weight: 600; letter-spacing: 1px;">KNOWLEDGE</td>
                <td style="color: cyan; font-weight: bold; font-size: 12px;">${u.timeSpent || 0} XP POINTS</td>
              </tr>
              <tr>
                <td style="color: #ff4757; font-weight: 600; letter-spacing: 1px;">ACCESS</td>
                <td style="color: gold; font-weight: bold;">${unlockedItems} UNLOCKED</td>
              </tr>
              <tr>
                <td style="color: #ff4757; font-weight: 600; letter-spacing: 1px;">JOINED</td>
                <td style="color: #ccc; font-size: 10px;">${u.registeredAt ? new Date(u.registeredAt).toLocaleDateString() : '--'}</td>
              </tr>
            </table>
        `;

        if (shadowModal) shadowModal.style.display = 'flex';
      });
    }

    function rejectPayment(reqId) {
      let reason = prompt("Enter rejection reason (e.g., Fake UTR, Unclear Image):");
      if (reason === null || reason.trim() === "") return; // cancelled

      // Update the request status to rejected
      database.ref('pendingPayments/' + reqId).update({
        status: "rejected",
        reason: reason.trim()
      }).then(() => {
        alert("‚ùå Request rejected and user notified.");
      }).catch(err => {
        alert("‚ùå Network Error.");
      });
    }

    function loadAdminData() {
      let tbody = document.getElementById("adminTableBody");
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Loading data...</td></tr>";

      database.ref('users').once('value').then(snap => {
        tbody.innerHTML = "";
        let hasData = false;
        let usersData = snap.val();

        if (usersData) {
          for (let key in usersData) {
            let userRecord = usersData[key];
            if (userRecord && userRecord.name && userRecord.mobile && userRecord.mobile === key && userRecord.role !== "admin") {
              hasData = true;
              let isPremium = userRecord.premiumUnlocked && Object.keys(userRecord.premiumUnlocked).some(k => {
                let pu = userRecord.premiumUnlocked[k];
                if (typeof pu === 'object' && pu.active) {
                  if (!pu.expiresAt || Date.now() <= pu.expiresAt) return true;
                }
                return pu === true;
              });

              let rowStyle = isPremium ? "background: rgba(255, 215, 0, 0.1);" : "";
              let nameDisplay = isPremium ? `üëë <span style="color: gold;">${userRecord.name}</span>` : userRecord.name;

              let tr = document.createElement("tr");
              tr.style.cssText = rowStyle;
              tr.innerHTML = `
                <td>${nameDisplay}</td>
                <td>${userRecord.roll || 'N/A'}</td>
                <td>${userRecord.branch || 'N/A'}</td>
                <td>${userRecord.section || 'N/A'}</td>
                <td>${userRecord.mobile}</td>
                <td>
                  <button onclick="viewUserShadow('${userRecord.mobile}')" style="background:#6c5ce7; color:white; padding:5px; border-radius:5px; font-size:12px;">üë§ Shadow</button>
                  <button onclick="promptRemoveUser('${userRecord.mobile}')" style="background:#ff4757; color:white; padding:5px; border-radius:5px; font-size:12px; margin-left:5px;">Remove</button>
                  <button onclick="grantPremiumManually('${userRecord.mobile}')" style="background:gold; color:black; padding:5px; border-radius:5px; margin-left:5px; font-size:12px;">+ Prem</button>
                </td>
              `;
              tbody.appendChild(tr);
            }
          }
        }
        if (!hasData) {
          tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No registered students yet.</td></tr>";
        }
      }).catch(err => {
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:red;'>Error loading data!</td></tr>";
        console.error(err);
      });

      initAdminCMS(); // Initialize the Content Management dropdowns

      let prPreview = document.getElementById("premiumQRPreview");
      let pConf = JSON.parse(localStorage.getItem("premiumConfig")) || { qr: "", upi: "", amount: "" };
      if (pConf.qr) {
        prPreview.src = pConf.qr;
        prPreview.style.display = "block";
      } else {
        prPreview.style.display = "none";
      }
      document.getElementById("premiumUPI").value = pConf.upi || "";
      document.getElementById("premiumAmount").value = pConf.amount || "";

      // Initialize Premium Config Dropdowns
      let pCmsCourse = document.getElementById("premConfigCourse");
      pCmsCourse.innerHTML = '<option value="" disabled selected>Select Premium Course</option>';
      for (let c in premiumData) {
        let opt = document.createElement("option"); opt.value = c; opt.innerText = c; pCmsCourse.appendChild(opt);
      }
      document.getElementById("premiumConfigEditor").style.display = "none";
    }

    function onAdminPremConfigCourseChange() {
      let course = document.getElementById("premConfigCourse").value;
      if (!course) return;

      let optSelect = document.getElementById("premConfigOption");
      optSelect.innerHTML = '<option value="" disabled selected>Select Option</option>';

      let options = premiumData[course] || {};
      for (let opt in options) {
        let op = document.createElement("option");
        op.value = opt;
        op.innerText = opt;
        optSelect.appendChild(op);
      }
      document.getElementById("premiumConfigEditor").style.display = "none";
    }

    function onAdminPremConfigOptionChange() {
      let course = document.getElementById("premConfigCourse").value;
      let option = document.getElementById("premConfigOption").value;
      if (!course || !option) return;

      let pConf = JSON.parse(localStorage.getItem("premiumCourseConfigs")) || {};
      let itemKey = course + "_" + option;
      let config = pConf[itemKey] || { qr: "", upi: "", amount: "" };

      let prPreview = document.getElementById("premiumQRPreview");
      if (config.qr) {
        prPreview.src = config.qr;
        prPreview.style.display = "block";
      } else {
        prPreview.style.display = "none";
      }
      document.getElementById("premiumUPI").value = config.upi || "";
      document.getElementById("premiumAmount").value = config.amount || "";

      document.getElementById("premiumConfigEditor").style.display = "block";
    }

    // Legacy CMS fields logic removed (migrated to simpler integrated drill-down UI)

    function exportToExcel() {
      database.ref('users').once('value').then(snap => {
        let studentInfoList = [];
        let usersData = snap.val();
        if (usersData) {
          for (let key in usersData) {
            let data = usersData[key];
            if (data && data.name && data.mobile && key === data.mobile && data.role !== "admin") {
              studentInfoList.push({
                Name: data.name,
                RollNumber: data.roll || 'N/A',
                Branch: data.branch || 'N/A',
                Section: data.section || 'N/A',
                Mobile: data.mobile,
                TimeSpentMins: data.timeSpent || 0,
                RegisteredAt: data.registeredAt ? new Date(data.registeredAt).toLocaleString() : 'N/A'
              });
            }
          }
        }

        if (studentInfoList.length === 0) {
          alert("No student data available to export.");
          return;
        }

        let ws = XLSX.utils.json_to_sheet(studentInfoList);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Students");
        XLSX.writeFile(wb, "NextGenLibrary_Students.xlsx");
      }).catch(err => {
        alert("Failed to fetch data for export.");
      });
    }

    /* ADVANCED SITE SETTINGS */
    function loadSiteSettings() {
      database.ref('siteConfig').once('value').then(snapshot => {
        let fbConfig = snapshot.val();
        if (fbConfig) {
          if (!fbConfig.banners) fbConfig.banners = [];
          globalSiteConfig = fbConfig;
          applySiteSettings(fbConfig);
        } else {
          applySiteSettings(globalSiteConfig);
        }
      });
    }

    function applySiteSettings(config) {
      if (!config.banners) config.banners = [];
      let premToggle = document.getElementById("sitePremiumToggle");
      if (premToggle) {
        premToggle.value = (config.premiumEnabled !== false) ? "true" : "false";
      }

      let tickerEl = document.getElementById("globalTicker");
      let tickerTextEl = document.getElementById("tickerText");

      if (config.ticker && config.ticker.trim() !== "") {
        tickerTextEl.innerText = config.ticker;
        tickerEl.style.display = "block";
        if (document.getElementById("siteTickerText")) document.getElementById("siteTickerText").value = config.ticker;
      } else {
        tickerEl.style.display = "none";
        if (document.getElementById("siteTickerText")) document.getElementById("siteTickerText").value = "";
      }

      let welcomeEl = document.getElementById("welcomeSubtitle");
      if (document.getElementById("siteWelcomeText")) {
        if (config.welcome && config.welcome.trim() !== "") {
          if (welcomeEl) welcomeEl.innerText = config.welcome;
          document.getElementById("siteWelcomeText").value = config.welcome;
        } else {
          if (welcomeEl) welcomeEl.innerText = "Your Digital Learning Hub"; // fallback
          document.getElementById("siteWelcomeText").value = "";
        }
      }

      let aboutEl = document.getElementById("aboutUsContent");
      if (document.getElementById("siteAboutText")) {
        if (config.about && config.about.trim() !== "") {
          let formattedAbout = config.about.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('');
          if (aboutEl) aboutEl.innerHTML = formattedAbout;
          document.getElementById("siteAboutText").value = config.about;
        } else {
          let def = `
            <p>Welcome to NextGen Library, your premier digital learning platform designed for modern students. We believe that quality education should be structured, accessible, and interactive.</p>
            <p>Our platform integrates:</p>
            <ul>
              <li>High-quality Video Lectures</li>
              <li>Meticulously curated Study Notes</li>
              <li>Rigorous Assignments & Practice</li>
              <li>Comprehensive Homework Guidance</li>
              <li>Instant Doubt Resolution Support</li>
            </ul>
            <p>Whether you're tackling daily challenges or seeking clarity, we provide the tools necessary for academic excellence and personal growth.</p>
          `;
          if (aboutEl) aboutEl.innerHTML = def;
          document.getElementById("siteAboutText").value = "";
        }
      }

      if (document.getElementById("adminBannerList")) {
        renderAdminBanners(config.banners);
      }
      renderUserBanners(config.banners);
    }

    function saveSiteSettings() {
      let config = globalSiteConfig;
      let ticker = document.getElementById("siteTickerText").value.trim();
      let welcome = document.getElementById("siteWelcomeText").value.trim();
      let about = document.getElementById("siteAboutText").value.trim();
      let premiumEnabled = document.getElementById("sitePremiumToggle").value === "true";
      let banners = config.banners || [];

      let payload = { ticker, welcome, about, premiumEnabled, banners };

      database.ref('siteConfig').set(payload).then(() => {
        globalSiteConfig = payload;
        loadSiteSettings();
        alert("‚úÖ Site settings updated!");
      }).catch(err => {
        console.error(err);
        alert("‚ùå Failed to update site settings.");
      });
    }

    function addSiteBanner() {
      let fileInput = document.getElementById("siteBannerImageInput");
      let linkInput = document.getElementById("siteBannerLinkInput");

      let file = fileInput.files[0];
      let link = linkInput.value.trim();

      if (!file) {
        alert("Please select an image for the banner.");
        return;
      }

      let reader = new FileReader();
      reader.onload = function (e) {
        let img = new Image();
        img.onload = function () {
          let canvas = document.createElement("canvas");
          let MAX_WIDTH = 1472;
          let MAX_HEIGHT = 720;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > MAX_WIDTH) {
              height *= MAX_WIDTH / width;
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width *= MAX_HEIGHT / height;
              height = MAX_HEIGHT;
            }
          }

          canvas.width = width;
          canvas.height = height;
          let ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          let base64 = canvas.toDataURL("image/jpeg", 0.7);

          let config = JSON.parse(localStorage.getItem("siteConfig")) || { banners: [] };
          if (!config.banners) config.banners = [];
          config.banners.push({ image: base64, link: link });

          localStorage.setItem("siteConfig", JSON.stringify(config));
          database.ref('siteConfig/banners').set(config.banners).then(() => {
            renderAdminBanners(config.banners);
            renderUserBanners(config.banners);
            fileInput.value = "";
            linkInput.value = "";
            alert("Banner added successfully!");
          });
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function deleteSiteBanner(index) {
      if (!confirm("Are you sure you want to delete this banner?")) return;
      let config = JSON.parse(localStorage.getItem("siteConfig")) || { banners: [] };
      if (!config.banners) return;

      config.banners.splice(index, 1);
      globalSiteConfig = config;

      database.ref('siteConfig/banners').set(config.banners).then(() => {
        renderAdminBanners(config.banners);
        renderUserBanners(config.banners);
      });
    }

    function renderAdminBanners(banners) {
      let list = document.getElementById("adminBannerList");
      if (!list) return;
      list.innerHTML = "";
      if (!banners || banners.length === 0) {
        list.innerHTML = "<p style='color:#ccc;'>No banners added yet.</p>";
        return;
      }

      banners.forEach((b, index) => {
        let li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.alignItems = "center";
        li.style.background = "rgba(255,255,255,0.05)";
        li.style.padding = "10px";
        li.style.marginBottom = "5px";
        li.style.borderRadius = "5px";

        let info = document.createElement("div");
        info.innerHTML = `<img src="${b.image}" style="width:100px; height:50px; object-fit:cover; vertical-align:middle; margin-right:10px; border-radius:5px;">` +
          `<a href="${b.link}" target="_blank" style="color:cyan; font-size:12px;">${b.link || 'No Link'}</a>`;

        let delBtn = document.createElement("button");
        delBtn.innerText = "‚ùå Delete";
        delBtn.style.background = "#ff4757";
        delBtn.style.color = "white";
        delBtn.style.border = "none";
        delBtn.style.padding = "5px 10px";
        delBtn.style.borderRadius = "5px";
        delBtn.style.cursor = "pointer";
        delBtn.onclick = () => deleteSiteBanner(index);

        li.appendChild(info);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    let sliderIntervals = {};
    window.sliderCurrentIndex = { home: 0, branch: 0 };

    function renderUserBanners(banners) {
      let homeContainer = document.getElementById("homeSliderContainer");
      let branchContainer = document.getElementById("branchSliderContainer");

      if (!banners || banners.length === 0) {
        if (homeContainer) { homeContainer.style.display = "none"; homeContainer.innerHTML = ""; }
        if (branchContainer) { branchContainer.style.display = "none"; branchContainer.innerHTML = ""; }
        return;
      }

      function buildSliderHtml(idPrefix) {
        let slidesHtml = banners.map((b, i) => {
          let onClick = i === 0 ? "openPremiumHub()" : (b.link ? `window.open('${b.link}', '_blank')` : '');
          return `
          <div class="slider-slide" ${onClick ? `onclick="${onClick}"` : ''}>
            <img src="${b.image}">
          </div>
          `;
        }).join('');

        let dotsHtml = banners.map((b, i) => `
          <div class="slider-dot ${i === 0 ? 'active' : ''}" onclick="goToSlide('${idPrefix}', ${i})"></div>
        `).join('');

        return `
          <div class="slider-main" id="${idPrefix}Main">
            <div class="slider-wrapper" id="${idPrefix}Wrapper" style="transform: translateX(0%); display: flex; transition: transform 0.5s ease-in-out;">
              ${slidesHtml}
            </div>
            ${banners.length > 1 ? `<div class="slider-nav" id="${idPrefix}Nav">${dotsHtml}</div>` : ''}
          </div>
        `;
      }

      if (homeContainer) {
        homeContainer.innerHTML = buildSliderHtml('home');
        homeContainer.style.display = "block";
        window.sliderCurrentIndex['home'] = 0;
        startBannerSlider('home', banners.length);
      }
      if (branchContainer) {
        branchContainer.innerHTML = buildSliderHtml('branch');
        branchContainer.style.display = "block";
        window.sliderCurrentIndex['branch'] = 0;
        startBannerSlider('branch', banners.length);
      }
    }

    window.goToSlide = function (idPrefix, index) {
      window.sliderCurrentIndex[idPrefix] = index;
      updateSlider(idPrefix);
      let totalSlides = document.querySelectorAll(`#${idPrefix}Wrapper .slider-slide`).length;
      if (totalSlides > 1) {
        startBannerSlider(idPrefix, totalSlides);
      }
    };

    function updateSlider(idPrefix) {
      let wrapper = document.getElementById(`${idPrefix}Wrapper`);
      let dots = document.querySelectorAll(`#${idPrefix}Nav .slider-dot`);
      if (!wrapper) return;

      let index = window.sliderCurrentIndex[idPrefix] || 0;
      wrapper.style.transform = `translateX(-${index * 100}%)`;

      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    }

    function startBannerSlider(idPrefix, totalSlides) {
      if (totalSlides <= 1) return;
      if (sliderIntervals[idPrefix]) clearInterval(sliderIntervals[idPrefix]);

      sliderIntervals[idPrefix] = setInterval(() => {
        let currentIndex = window.sliderCurrentIndex[idPrefix] || 0;
        window.sliderCurrentIndex[idPrefix] = (currentIndex + 1) % totalSlides;
        updateSlider(idPrefix);
      }, 3000);
    }

    /* PREMIUM CONTENT CMS SETTINGS */
    let premiumData = JSON.parse(localStorage.getItem("premiumData")) || {
      "BCA": {
        "Nimcet & MCA": [],
        "Exam point of view": []
      }
    };

    function renderStudentCourses() {
      const container = document.getElementById("programs");
      const regSelect = document.getElementById("regBranch");
      if (regSelect) regSelect.innerHTML = '<option value="" disabled selected>Course (e.g. BCA)</option>';

      if (!container) return;
      const premiumBox = document.getElementById("premiumLinkBox");

      // Clear but keep premium box
      Array.from(container.children).forEach(child => {
        if (child !== premiumBox) container.removeChild(child);
      });

      for (let course in data) {
        let icon = "üéì";
        if (course.includes("BTECH")) icon = "üè¢";
        else if (course.includes("BBA")) icon = "üíº";
        else if (course.includes("LAW")) icon = "‚öñÔ∏è"; // Keep existing LAW icon logic

        let box = document.createElement("div");
        box.className = "box";
        box.onclick = () => openStudentLevel('course', course);
        box.innerHTML = `<h1>${icon}</h1>${course}`; // Changed to h1
        container.insertBefore(box, premiumBox);

        if (regSelect) {
          let opt = document.createElement("option");
          opt.value = course;
          opt.innerText = course;
          regSelect.appendChild(opt);
        }
      }
    }

    function renderPremiumHubCourses() {
      const container = document.getElementById("premiumCoursesContainer");
      if (!container) return;
      container.innerHTML = "";

      for (let course in premiumData) {
        let icon = "üéì";
        if (course.includes("BTECH")) icon = "üè¢";
        else if (course.includes("BBA")) icon = "üíº";

        let box = document.createElement("div");
        box.className = "box";
        box.onclick = () => showPremiumOptions(course);
        box.innerHTML = `<h1>${icon}</h1>Premium ${course}`;
        container.appendChild(box);
      }
    }

    function savePremiumData() {
      database.ref('premiumData').set(premiumData).then(() => {
        // Sync to local memory
        localStorage.setItem("premiumData", JSON.stringify(premiumData));
      }).catch(err => {
        console.error("Premium data save failed", err);
      });
    }

    function onPremCourseChange() {
      let course = document.getElementById("premCmsCourse").value;
      if (!course) return;
      document.getElementById("premEditor").style.display = "block";

      let optSelect = document.getElementById("premCmsOption");
      optSelect.innerHTML = '<option value="" disabled selected>Select Option</option>';

      let options = premiumData[course] || {};
      for (let opt in options) {
        let op = document.createElement("option");
        op.value = opt;
        op.innerText = opt;
        optSelect.appendChild(op);
      }

      document.getElementById("adminPremPdfList").innerHTML = "";
    }

    function onPremOptionChange() {
      renderPremPdfList();
    }

    function addPremiumOption() {
      let course = document.getElementById("premCmsCourse").value;
      let newOptName = document.getElementById("newPremOptionName").value.trim();
      if (!course || !newOptName) {
        alert("Please select a course and type an option name.");
        return;
      }

      if (!premiumData[course]) premiumData[course] = {};
      if (premiumData[course][newOptName]) {
        alert("Option already exists!");
        return;
      }

      premiumData[course][newOptName] = [];
      savePremiumData();

      document.getElementById("newPremOptionName").value = "";
      onPremCourseChange(); // Reload dropdown
      document.getElementById("premCmsOption").value = newOptName;
      onPremOptionChange();
    }

    function addPremiumPdf() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      let title = document.getElementById("newPremPdfTitle").value.trim();
      let link = document.getElementById("newPremPdfLink").value.trim();

      if (!course || !option || !title || !link) {
        alert("Please fill out all fields.");
        return;
      }

      premiumData[course][option].push({ title, link });
      savePremiumData();

      document.getElementById("newPremPdfTitle").value = "";
      document.getElementById("newPremPdfLink").value = "";
      renderPremPdfList();
    }

    function removePremiumPdf(index) {
      if (!confirm("Are you sure you want to delete this PDF?")) return;
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;

      premiumData[course][option].splice(index, 1);
      savePremiumData();
      renderPremPdfList();
    }

    function renderPremPdfList() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      let list = document.getElementById("adminPremPdfList");
      list.innerHTML = "";

      if (!course || !option) return;

      let pdfs = premiumData[course][option];
      if (!pdfs || pdfs.length === 0) {
        list.innerHTML = "<li style='color:#ccc;'>No PDFs added yet.</li>";
        return;
      }

      pdfs.forEach((pdf, index) => {
        let li = document.createElement("li");
        li.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,255,255,0.05); margin-bottom: 5px; border-radius: 5px;";
        li.innerHTML = `
          <span><b>${pdf.title}</b> <small style="color:#aaa;">(${pdf.link})</small></span>
          <button onclick="removePremiumPdf(${index})" style="background: transparent; color: #ff4757; border: 1px solid #ff4757; padding: 3px 8px; border-radius: 3px; cursor: pointer;">Delete</button>
        `;
        list.appendChild(li);
      });
    }

    let cmsSelection = { course: "", branch: "", sem: "", sub: "", ch: "" };

    function initAdminCMS() {
      const selectors = [
        document.getElementById("cmsCourse"),
        document.getElementById("premConfigCourse"),
        document.getElementById("premCmsCourse"),
        document.getElementById("deleteCourseSelect"),
        document.getElementById("subCourse")
      ];

      selectors.forEach(sel => {
        if (!sel) return;
        sel.innerHTML = '<option value="" disabled selected>Select Course</option>';
        for (let c in data) {
          let opt = document.createElement("option");
          opt.value = c;
          opt.innerText = c;
          sel.appendChild(opt);
        }
      });
    }

    function onAdminCMSCourseChange() {
      cmsSelection.course = document.getElementById("cmsCourse").value;
      let bSelect = document.getElementById("cmsBranch");
      bSelect.innerHTML = '<option value="" disabled selected>Branch</option>';
      if (data[cmsSelection.course]) {
        for (let b in data[cmsSelection.course]) {
          let opt = document.createElement("option"); opt.value = b; opt.innerText = b; bSelect.appendChild(opt);
        }
      }
      renderCmsBranches();
      document.getElementById("cmsContentEditor").style.display = "none";
      cmsSelection.branch = "";
      cmsSelection.sem = "";
      cmsSelection.sub = "";
      cmsSelection.ch = "";
    }

    function renderCmsBranches() {
      let { course } = cmsSelection;
      if (!course) return;
      let area = document.getElementById("cmsInteractionArea");
      area.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
           <h4 style="color: cyan; margin:0;">üè¢ Branches in ${course}</h4>
           <button class="login-btn" onclick="addCMSBranch()" style="width: auto; margin:0; background: #00cec9; color: black; padding: 5px 15px;">‚ûï Add Branch</button>
        </div>
        <div id="cmsListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
      `;
      let list = document.getElementById("cmsListContainer");
      let branches = data[course] ? Object.keys(data[course]) : [];
      if (branches.length === 0) {
        list.innerHTML = "<p style='grid-column: 1/-1; color: #888; text-align: center;'>No branches found. Add one above! (e.g. DDU, AKTU, CSE)</p>";
      } else {
        branches.forEach(b => {
          let item = document.createElement("div");
          item.className = "box";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.alignItems = "center";
          item.style.padding = "10px 15px";
          item.innerHTML = `
            <span onclick="cmsSelection.branch='${b}'; document.getElementById('cmsBranch').value='${b}'; renderCmsSemesters()" style="cursor:pointer; flex: 1;">üè¢ ${b}</span>
            <button onclick="deleteCMSBranch('${b}')" style="background: #ff4757; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Delete</button>
          `;
          list.appendChild(item);
        });
      }
      document.getElementById("cmsContentEditor").style.display = "none";
    }

    function onAdminCMSBranchChange() {
      cmsSelection.course = document.getElementById("cmsCourse").value;
      cmsSelection.branch = document.getElementById("cmsBranch").value;
      renderCmsSemesters();
    }

    function renderCmsSemesters() {
      let { course, branch } = cmsSelection;
      if (!course || !branch) return;
      let area = document.getElementById("cmsInteractionArea");
      area.innerHTML = `
        <div style="margin-bottom: 15px;">
           <button onclick="renderCmsBranches()" style="background: none; border: 1px solid cyan; color: cyan; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">‚¨ÖÔ∏è Back to Branches</button>
           <div style="display: flex; justify-content: space-between; align-items: center;">
             <h4 style="color: cyan; margin:0;">üìÖ Semesters in ${branch}</h4>
             <button class="login-btn" onclick="addCMSSemester()" style="width: auto; margin:0; background: #00cec9; color: black; padding: 5px 15px;">‚ûï Add Sem</button>
           </div>
        </div>
        <div id="cmsListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
      `;
      let list = document.getElementById("cmsListContainer");

      let sems = data[course] && data[course][branch] ? Object.keys(data[course][branch]).filter(k => k !== "_initialized").sort((a, b) => a - b) : [];

      if (sems.length === 0) {
        list.innerHTML = "<p style='grid-column: 1/-1; color: #888; text-align: center;'>No semesters found. Add one above!</p>";
      } else {
        sems.forEach(s => {
          let item = document.createElement("div");
          item.className = "box";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.alignItems = "center";
          item.style.padding = "10px 15px";
          item.innerHTML = `
            <span onclick="cmsSelection.sem='${s}'; renderCmsSubjects()" style="cursor:pointer; flex: 1;">üìÖ Semester ${s}</span>
            <button onclick="deleteCMSSemester('${s}')" style="background: #ff4757; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Delete</button>
          `;
          list.appendChild(item);
        });
      }
      document.getElementById("cmsContentEditor").style.display = "none";
    }

    function renderCmsSubjects() {
      let { course, branch, sem } = cmsSelection;
      let area = document.getElementById("cmsInteractionArea");
      area.innerHTML = `
        <div style="margin-bottom: 15px;">
           <button onclick="renderCmsSemesters()" style="background: none; border: 1px solid cyan; color: cyan; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">‚¨ÖÔ∏è Back to Semesters</button>
           <div style="display: flex; justify-content: space-between; align-items: center;">
             <h4 style="color: cyan; margin:0;">üìò Subjects in Semester ${sem}</h4>
             <button class="login-btn" onclick="addCMSSubject()" style="width: auto; margin:0; background: #00cec9; color: black; padding: 5px 15px;">‚ûï Add Subject</button>
           </div>
        </div>
        <div id="cmsListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;"></div>
      `;
      let list = document.getElementById("cmsListContainer");

      let subs = data[course][branch][sem] ? Object.keys(data[course][branch][sem]).filter(k => k !== "_initialized") : [];

      if (subs.length === 0) {
        list.innerHTML = "<p style='grid-column: 1/-1; color: #888; text-align: center;'>No subjects found. Add one above!</p>";
      } else {
        subs.forEach(sub => {
          let item = document.createElement("div");
          item.className = "box";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.alignItems = "center";
          item.style.padding = "10px 15px";
          item.innerHTML = `
            <span onclick="cmsSelection.sub='${sub}'; renderCmsChapters()" style="cursor:pointer; flex: 1;">üìò ${sub}</span>
            <button onclick="deleteCMSSubject('${sub}')" style="background: #ff4757; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Delete</button>
          `;
          list.appendChild(item);
        });
      }
      document.getElementById("cmsContentEditor").style.display = "none";
    }

    function renderCmsChapters() {
      let { course, branch, sem, sub } = cmsSelection;
      let area = document.getElementById("cmsInteractionArea");
      area.innerHTML = `
        <div style="margin-bottom: 15px;">
           <button onclick="renderCmsSubjects()" style="background: none; border: 1px solid cyan; color: cyan; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">‚¨ÖÔ∏è Back to Subjects</button>
           <div style="display: flex; justify-content: space-between; align-items: center;">
             <h4 style="color: cyan; margin:0;">üìë Chapters in ${sub}</h4>
             <button class="login-btn" onclick="addCMSChapter()" style="width: auto; margin:0; background: #00cec9; color: black; padding: 5px 15px;">‚ûï Add Chapter</button>
           </div>
        </div>
        <div id="cmsListContainer" style="display: grid; grid-template-columns: 1fr; gap: 8px;"></div>
      `;
      let list = document.getElementById("cmsListContainer");

      let chaps = data[course][branch][sem][sub] ? Object.keys(data[course][branch][sem][sub]).filter(k => k !== "_initialized") : [];

      if (chaps.length === 0) {
        list.innerHTML = "<p style='color: #888; text-align: center;'>No chapters found. Add one above!</p>";
      } else {
        chaps.forEach(ch => {
          let item = document.createElement("div");
          item.className = "box";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.alignItems = "center";
          item.style.padding = "10px 15px";
          item.style.background = "rgba(255,255,255,0.05)";
          item.innerHTML = `
            <span onclick="openCmsChapter('${ch}')" style="cursor:pointer; flex: 1;">üìë ${ch}</span>
            <div style="display: flex; gap: 5px;">
              <button onclick="renameCMSChapter('${ch}')" style="background: #00e676; border: none; color: black; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Rename</button>
              <button onclick="deleteCMSChapter('${ch}')" style="background: #ff4757; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Delete</button>
            </div>
          `;
          list.appendChild(item);
        });
      }
      document.getElementById("cmsContentEditor").style.display = "none";
    }

    function openCmsChapter(ch) {
      cmsSelection.ch = ch;
      let { course, branch, sem, sub } = cmsSelection;
      let content = data[course][branch][sem][sub][ch];

      document.getElementById("selectedPathDisplay").innerText = `Selected: Sem ${sem} > ${sub} > ${ch}`;

      document.getElementById("cmsVideo").value = Array.isArray(content.video) ? content.video.join('\n') : (content.video || "");
      document.getElementById("cmsPdf").value = Array.isArray(content.pdf) ? content.pdf.join('\n') : (content.pdf || "");
      document.getElementById("cmsNotes").value = Array.isArray(content.notes) ? content.notes.join('\n') : (content.notes || "");
      document.getElementById("cmsAssignment").value = Array.isArray(content.assignment) ? content.assignment.join('\n') : (content.assignment || "");
      document.getElementById("cmsHomework").value = Array.isArray(content.homework) ? content.homework.join('\n') : (content.homework || "");

      document.getElementById("cmsContentEditor").style.display = "block";
      document.getElementById("cmsContentEditor").scrollIntoView({ behavior: 'smooth' });
    }

    function saveAdminContent() {
      let { course, branch, sem, sub, ch } = cmsSelection;
      if (!ch) return alert("Please select a chapter first.");

      let payload = {
        video: document.getElementById("cmsVideo").value.split('\n').filter(x => x.trim()),
        pdf: document.getElementById("cmsPdf").value.split('\n').filter(x => x.trim()),
        notes: document.getElementById("cmsNotes").value.split('\n').filter(x => x.trim()),
        assignment: document.getElementById("cmsAssignment").value.split('\n').filter(x => x.trim()),
        homework: document.getElementById("cmsHomework").value.split('\n').filter(x => x.trim())
      };

      data[course][branch][sem][sub][ch] = payload;
      database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${ch}`).set(payload).then(() => {
        alert("‚úÖ Content Saved Successfully!");
      }).catch(err => alert("‚ùå Save Failed: " + err));
    }

    function promptRemoveUser(mobile) {
      if (confirm(`Are you sure you want to permanently delete user with mobile ${mobile}? This action cannot be undone.`)) {
        database.ref('users/' + mobile).remove().then(() => {
          alert('User deleted successfully.');
          loadAdminData(); // Refresh the table and counts
        }).catch(err => {
          console.error(err);
          alert('Failed to delete user.');
        });
      }
    }

    function renameCMSChapter(oldCh) {
      let { course, branch, sem, sub } = cmsSelection;
      let newCh = prompt("Enter new name for chapter:", oldCh);
      if (!newCh || newCh.trim() === "" || newCh === oldCh) return;
      newCh = newCh.trim();

      if (data[course][branch][sem][sub][newCh]) return alert("Chapter with this name already exists!");

      let chData = data[course][branch][sem][sub][oldCh];
      data[course][branch][sem][sub][newCh] = chData;
      delete data[course][branch][sem][sub][oldCh];

      database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${oldCh}`).remove().then(() => {
        return database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${newCh}`).set(chData);
      }).then(() => {
        alert("‚úÖ Chapter renamed successfully!");
        renderCmsChapters();
      }).catch(err => alert("‚ùå Rename failed: " + err));
    }

    function addCMSChapter() {
      let { course, branch, sem, sub } = cmsSelection;
      if (!sub) return alert("Select Subject first.");

      let chName = prompt("Enter new Chapter name:");
      if (!chName || chName.trim() === "") return;
      chName = chName.trim();

      if (data[course][branch][sem][sub][chName]) return alert("Chapter already exists!");

      let initPayload = { video: "", notes: "", pdf: "", assignment: "", homework: "" };
      data[course][branch][sem][sub][chName] = initPayload;

      database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${chName}`).set(initPayload).then(() => {
        alert("‚úÖ New chapter added successfully!");
        renderCmsChapters();
      }).catch(err => alert("‚ùå Failed to add chapter: " + err));
    }

    function addCMSSemester() {
      let { course, branch } = cmsSelection;
      if (!course || !branch) return alert("Select Course and Branch first.");

      let newSem = prompt("Enter NEW semester number:");
      if (!newSem || newSem.trim() === "") return;
      newSem = newSem.trim();

      if (data[course] && data[course][branch] && data[course][branch][newSem]) {
        return alert("Semester already exists!");
      }

      let initPayload = { _initialized: true };
      if (!data[course]) data[course] = {};
      if (!data[course][branch]) data[course][branch] = {};
      data[course][branch][newSem] = initPayload;

      database.ref(`courseData/${course}/${branch}/${newSem}`).set(initPayload).then(() => {
        alert(`‚úÖ Semester '${newSem}' added successfully!`);
        renderCmsSemesters();
      }).catch(err => alert("‚ùå Failed to add semester: " + err));
    }

    function deleteCMSSemester(sem) {
      let { course, branch } = cmsSelection;
      if (confirm(`Are you sure you want to delete Semester ${sem}? All contents will be lost.`)) {
        delete data[course][branch][sem];
        database.ref(`courseData/${course}/${branch}/${sem}`).remove().then(() => {
          alert(`üóëÔ∏è Semester ${sem} deleted successfully!`);
          renderCmsSemesters();
          initAdminCMS();
        }).catch(err => alert("‚ùå Failed to delete semester: " + err));
      }
    }

    function addCMSBranch() {
      let { course } = cmsSelection;
      if (!course) return alert("Select Course first.");
      let bName = prompt("Enter NEW branch name (e.g. CSE, DDU, AKTU):");
      if (!bName || bName.trim() === "") return;
      bName = bName.trim();
      if (data[course][bName]) return alert("Branch already exists!");

      data[course][bName] = { _initialized: true };
      database.ref(`courseData/${course}/${bName}`).set({ _initialized: true }).then(() => {
        alert(`‚úÖ Branch '${bName}' added!`);
        onAdminCMSCourseChange(); // Refresh branches and dropdown
      });
    }

    function deleteCMSBranch(branch) {
      if (!confirm(`Are you sure you want to delete branch '${branch}' and all its content?`)) return;
      let { course } = cmsSelection;
      delete data[course][branch];
      database.ref(`courseData/${course}/${branch}`).remove().then(() => {
        alert(`üóëÔ∏è Branch '${branch}' deleted.`);
        onAdminCMSCourseChange();
      });
    }

    function addCMSSubject() {
      let { course, branch, sem } = cmsSelection;
      if (!sem) return alert("Select Semester first.");

      let subName = prompt("Enter NEW subject name:");
      if (!subName || subName.trim() === "") return;
      subName = subName.trim();

      if (data[course][branch][sem][subName]) return alert("Subject already exists!");

      let initPayload = { _initialized: true };
      data[course][branch][sem][subName] = initPayload;

      database.ref(`courseData/${course}/${branch}/${sem}/${subName}`).set(initPayload).then(() => {
        alert(`‚úÖ Subject '${subName}' added successfully!`);
        renderCmsSubjects();
      }).catch(err => alert("‚ùå Failed to add subject: " + err));
    }

    function deleteCMSSubject(sub) {
      let { course, branch, sem } = cmsSelection;
      if (confirm(`Are you sure you want to delete Subject '${sub}'?`)) {
        delete data[course][branch][sem][sub];
        database.ref(`courseData/${course}/${branch}/${sem}/${sub}`).remove().then(() => {
          alert(`üóëÔ∏è Subject '${sub}' deleted successfully!`);
          renderCmsSubjects();
        }).catch(err => alert("‚ùå Failed to delete subject: " + err));
      }
    }

    function deleteCMSChapter(ch) {
      let { course, branch, sem, sub } = cmsSelection;
      if (confirm(`Are you sure you want to delete Chapter '${ch}'?`)) {
        delete data[course][branch][sem][sub][ch];
        database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${ch}`).remove().then(() => {
          alert("‚úÖ Chapter deleted successfully!");
          renderCmsChapters();
        }).catch(err => alert("‚ùå Failed to delete chapter: " + err));
      }
    }

    // COURSE & SUBJECT MANAGER FUNCTIONS
    function addAdminCourse() {
      let newCourse = document.getElementById("newCourseName").value.trim().toUpperCase();
      if (!newCourse) return alert("Course name cannot be empty.");
      if (data[newCourse]) return alert(`Course '${newCourse}' already exists!`);

      // Initialize completely new course with generic branches & semesters
      data[newCourse] = {
        "General": {
          1: {}, 2: {}, 3: {}, 4: {}, 5: {}, 6: {}
        }
      };

      database.ref(`courseData/${newCourse}`).set(data[newCourse]).then(() => {
        document.getElementById("newCourseName").value = "";
        alert(`‚úÖ Course '${newCourse}' added successfully!`);
        initAdminCMS(); // Reload dropdowns
      });
    }

    function deleteAdminCourse() {
      let course = document.getElementById("deleteCourseSelect").value;
      if (!course) return alert("Select a course to delete.");
      if (!confirm(`CRITICAL: Are you sure you want to delete the ENTIRE course '${course}'? This cannot be undone.`)) return;

      delete data[course];
      if (premiumData[course]) delete premiumData[course];

      Promise.all([
        database.ref(`courseData/${course}`).remove(),
        database.ref(`premiumData/${course}`).remove()
      ]).then(() => {
        alert(`üóëÔ∏è Course '${course}' deleted successfully!`);
        initAdminCMS();
      }).catch(err => alert("‚ùå Failed to delete course: " + err));
    }

    // Redundant Semester Management functions removed (moved to integrated CMS)

    // Subject Quick Links logic removed (integrated into CMS)

    function grantPremiumManually(mobile) {
      let itemKey = prompt("Enter Premium Option Key (e.g. BCA_Exam point of view):");
      if (!itemKey) return;
      let days = prompt("Enter number of days for premium access (leave blank for lifetime):");

      let expiresAt = null;
      if (days && !isNaN(days) && parseInt(days) > 0) {
        expiresAt = Date.now() + (parseInt(days) * 24 * 60 * 60 * 1000);
      }

      let payload = {
        active: true,
        expiresAt: expiresAt,
        grantedBy: 'Admin'
      };

      database.ref(`users/${mobile}/premiumUnlocked/${itemKey}`).set(payload).then(() => {
        alert("‚úÖ Premium granted to " + mobile + " for " + itemKey);
        loadAdminData();
        renderActivePremiumUsers();
      }).catch(err => {
        alert("‚ùå Error granting premium.");
      });
    }

    function renderActivePremiumUsers() {
      let tbody = document.getElementById("activePremiumTableBody");
      if (!tbody) return;
      tbody.innerHTML = "<tr><td colspan='3' style='padding: 15px; text-align: center; color: cyan;'>Loading...</td></tr>";

      database.ref('users').once('value').then(snap => {
        let usersData = snap.val() || {};
        let count = 0;

        // Sort users by total time spent in descending order
        let sortedUsers = Object.values(usersData).filter(u => u.role !== 'admin' && u.name).sort((a, b) => (b.timeSpent || 0) - (a.timeSpent || 0));

        tbody.innerHTML = ""; // Clear loading message

        sortedUsers.forEach(u => {
          if (u.role === 'admin' || !u.premiumUnlocked) return;

          let activePlans = [];
          for (let itemKey in u.premiumUnlocked) {
            let pu = u.premiumUnlocked[itemKey];
            let isAct = false;
            let expText = "Lifetime";

            if (typeof pu === 'object' && pu.active) {
              if (!pu.expiresAt || Date.now() <= pu.expiresAt) {
                isAct = true;
                if (pu.expiresAt) {
                  let daysLeft = Math.ceil((pu.expiresAt - Date.now()) / (1000 * 60 * 60 * 24));
                  expText = `Expires in ${daysLeft} days`;
                }
              }
            } else if (pu === true) {
              isAct = true;
            }

            if (isAct) {
              activePlans.push(`<span style="background:rgba(255,215,0,0.2); padding:2px 5px; border-radius:3px; margin:2px; display:inline-block; font-size:12px;">${itemKey} (${expText})</span>`);
            }
          }

          if (activePlans.length > 0) {
            count++;
            let tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
            tr.innerHTML = `
               <td style="padding: 10px; color: white;">üëë ${u.name}</td>
               <td style="padding: 10px; color: cyan;">${u.mobile}</td>
               <td style="padding: 10px;">${activePlans.join(' ')}</td>
             `;
            tbody.appendChild(tr);
          }
        });

        if (count === 0) {
          tbody.innerHTML = "<tr><td colspan='3' style='padding: 15px; text-align: center; color: #aaa;'>No active premium members.</td></tr>";
        }
      });
    }

    // FORGOT DETAILS RECOVERY & EDIT PROFILE VARS
    // isRecoveringMode is declared above

    function recoverDetails() {
      let rollSearch = prompt("Enter your registered University Roll Number / Registation Number to recover/edit your details:");
      if (!rollSearch || rollSearch.trim() === "") return;

      let foundUser = null;
      for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        try {
          let data = JSON.parse(localStorage.getItem(key));
          if (data && data.roll && data.roll.toLowerCase() === rollSearch.trim().toLowerCase()) {
            foundUser = data;
            break;
          }
        } catch (e) { }
      }

      if (foundUser) {
        // Open Edit Profile screen in recovery mode
        isRecoveringMode = true;
        tempRecoverMobile = foundUser.mobile;

        document.getElementById("editName").value = foundUser.name;
        document.getElementById("editRoll").value = foundUser.roll;
        document.getElementById("editBranch").value = foundUser.branch;
        document.getElementById("editSection").value = foundUser.section;
        document.getElementById("editMobile").value = foundUser.mobile;

        document.querySelector("#editProfileScreen h2").innerText = "üõ†Ô∏è Fix Registration Details";
        showPage("editProfileScreen");
      } else {
        alert("Sorry, no account found matching this University Roll Number / Registation Number. You may need to Sign Up first.");
      }
    }

    // VALIDATION HELPERS
    function validateInput(name, roll, mobile) {
      if (!/^[A-Za-z\s]+$/.test(name)) {
        alert("Validation Error: Name must contain only English alphabets and spaces.");
        return false;
      }
      if (!/^\d{13}$/.test(roll)) {
        alert("Validation Error: DDU Roll Number must be exactly 13 digits long.");
        return false;
      }
      if (!/^\d{10}$/.test(mobile)) {
        alert("Validation Error: Mobile Number must be exactly 10 digits long.");
        return false;
      }
      return true;
    }

    /* Duplicated Auth Functions Removed - Consolidated at top of script */


    // EDIT PROFILE FUNCTIONS
    let editProfilePicBase64 = null;

    function previewEditProfilePic(event) {
      let file = event.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function (e) {
        let img = new Image();
        img.onload = function () {
          let canvas = document.createElement("canvas");
          canvas.width = 150;
          canvas.height = 150;
          let ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, 150, 150);
          editProfilePicBase64 = canvas.toDataURL("image/jpeg", 0.7);
          document.getElementById('editProfilePicPreview').src = editProfilePicBase64;
        }
        img.src = e.target.result;
      }
      reader.readAsDataURL(file);
    }

    function openEditProfile() {
      if (!currentUserMobile) {
        alert("You must be logged in to edit your profile.");
        return;
      }
      isRecoveringMode = false;
      document.querySelector("#editProfileScreen h2").innerText = "‚úèÔ∏è Edit Profile";

      const showModal = (user) => {
        document.getElementById("editName").value = user.name || "";
        document.getElementById("editRoll").value = user.roll || "";
        document.getElementById("editBranch").value = user.branch || "BCA";
        document.getElementById("editSection").value = user.section || "A1";
        document.getElementById("editMobile").value = user.mobile || "";

        editProfilePicBase64 = user.profilePic || null;
        if (editProfilePicBase64) {
          document.getElementById('editProfilePicPreview').src = editProfilePicBase64;
        } else {
          document.getElementById('editProfilePicPreview').src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(user.name || 'U') + "&background=cyan&color=000";
        }

        document.getElementById('editProfilePicInput').value = ""; // Reset the file input
        document.getElementById("editProfileScreen").style.display = "flex";
      };

      let savedData = localStorage.getItem(currentUserMobile);
      if (savedData) {
        showModal(JSON.parse(savedData));
      } else {
        // Fallback: Fetch from Firebase if localStorage is empty
        database.ref('users/' + currentUserMobile).once('value').then(snap => {
          if (snap.exists()) {
            const user = snap.val();
            localStorage.setItem(currentUserMobile, JSON.stringify(user));
            showModal(user);
          } else {
            alert("User data not found. Please log in again.");
          }
        });
      }
    }

    function closeEditProfile() {
      document.getElementById("editProfileScreen").style.display = "none";
      isRecoveringMode = false;
    }

    function saveProfileChanges() {
      let newName = document.getElementById("editName").value.trim();
      let newRoll = document.getElementById("editRoll").value.trim();
      let newBranch = document.getElementById("editBranch").value;
      let newSection = document.getElementById("editSection").value;
      let newMobile = document.getElementById("editMobile").value.trim();

      if (!newName || !newRoll || !newBranch || !newSection || !newMobile) {
        alert("Please fill in all details to update your profile!");
        return;
      }

      if (!validateInput(newName, newRoll, newMobile)) return;

      let activeMobileKey = isRecoveringMode ? tempRecoverMobile : currentUserMobile;

      // Check if mobile changed and new mobile already exists
      if (newMobile !== activeMobileKey) {
        database.ref('users/' + newMobile).once('value').then(snap => {
          if (snap.exists()) {
            alert("The new mobile number is already registered by another user.");
            return;
          } else {
            executeProfileUpdate(activeMobileKey, newName, newRoll, newBranch, newSection, newMobile);
          }
        });
      } else {
        executeProfileUpdate(activeMobileKey, newName, newRoll, newBranch, newSection, newMobile);
      }
    }

    function executeProfileUpdate(activeMobileKey, newName, newRoll, newBranch, newSection, newMobile) {
      let updatedData = {
        name: newName,
        roll: newRoll,
        branch: newBranch,
        section: newSection,
        mobile: newMobile
      };
      if (editProfilePicBase64) {
        updatedData.profilePic = editProfilePicBase64;
      }

      // Keep offline compat tracker
      let stObj = JSON.parse(localStorage.getItem(activeMobileKey)) || {};

      let btn = document.querySelector("#editProfileScreen .login-btn");
      btn.innerText = "Saving...";
      btn.disabled = true;

      database.ref('users/' + newMobile).update(updatedData).then(() => {
        if (newMobile !== activeMobileKey) {
          database.ref('users/' + activeMobileKey).remove(); // clear old node
          localStorage.removeItem(activeMobileKey);
        }

        let merged = { ...stObj, ...updatedData, progressTracker: stObj.progressTracker || {}, premiumUnlocked: stObj.premiumUnlocked || {} };
        localStorage.setItem(newMobile, JSON.stringify(merged));

        if (!isRecoveringMode) {
          currentUserMobile = newMobile; // update tracking
          localStorage.setItem("activeSessionMobile", newMobile);
          let wsP = document.querySelector("#welcomeScreen p");
          wsP.innerText = wsP.innerText.split('\n')[0] + `\nWelcome, ${newName}!`;

          if (editProfilePicBase64 && document.getElementById('userProfilePicHeader')) {
            document.getElementById('userProfilePicHeader').src = editProfilePicBase64;
            document.getElementById('userProfilePicHeader').style.display = "block";
          }
        }

        alert(isRecoveringMode ? "Registration Fixed Successfully! Please log in." : "Profile updated successfully!");
        closeEditProfile();

        btn.innerText = "üíæ Save Changes";
        btn.disabled = false;

        if (isRecoveringMode) {
          toggleAuthMode('login');
        }
      }).catch(err => {
        alert("Network Error, Failed to update profile details.");
        btn.innerText = "üíæ Save Changes";
        btn.disabled = false;
      });
    }

    function logoutUser() {
      if (!confirm("Are you sure you want to log out?")) return;
      localStorage.removeItem("activeSessionMobile");
      localStorage.removeItem("activeSessionExp");
      currentUserMobile = "";
      closeEditProfile();
      showPage("loginScreen");
      toggleAuthMode('login');
      document.getElementById("neuralHUD").style.display = "none";
      if (timeSpentInterval) clearInterval(timeSpentInterval);
    }

    // -------------- PROGRESS TRACKING LOGIC --------------
    function getStudentTracker() {
      if (!currentUserMobile) return { progressTracker: {} };
      let stObj = JSON.parse(localStorage.getItem(currentUserMobile)) || { progressTracker: {} };
      if (!stObj.progressTracker) {
        stObj.progressTracker = {};
        localStorage.setItem(currentUserMobile, JSON.stringify(stObj));
      }
      return stObj;
    }

    function toggleProgress(type, index, isChecked) {
      if (!currentUserMobile) return;

      let stObj = getStudentTracker();
      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;
      let ch = studentNavState.chapter;

      if (!c || !b || !sem || !sub || !ch) return;

      if (!stObj.progressTracker[c]) stObj.progressTracker[c] = {};
      if (!stObj.progressTracker[c][b]) stObj.progressTracker[c][b] = {};
      if (!stObj.progressTracker[c][b][sem]) stObj.progressTracker[c][b][sem] = {};
      if (!stObj.progressTracker[c][b][sem][sub]) stObj.progressTracker[c][b][sem][sub] = {};
      if (!stObj.progressTracker[c][b][sem][sub][ch]) stObj.progressTracker[c][b][sem][sub][ch] = {};
      if (!stObj.progressTracker[c][b][sem][sub][ch][type]) stObj.progressTracker[c][b][sem][sub][ch][type] = {};

      stObj.progressTracker[c][b][sem][sub][ch][type][index] = isChecked;

      localStorage.setItem(currentUserMobile, JSON.stringify(stObj));
      database.ref(`users/${currentUserMobile}/progressTracker`).set(stObj.progressTracker);
    }

    function isProgressCompleted(type, index) {
      let stObj = getStudentTracker();
      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;
      let ch = studentNavState.chapter;

      try {
        return !!stObj.progressTracker[c][b][sem][sub][ch][type][index];
      } catch (e) {
        return false;
      }
    }

    function renderProgressDashboard() {
      let dashView = document.getElementById("progressContent");
      if (!dashView) return;
      dashView.innerHTML = "";

      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;

      if (!data[c] || !data[c][b] || !data[c][b][sem]) {
        dashView.innerHTML = "<p>No data to analyze for this semester.</p>";
        return;
      }

      let semesterData = data[c][b][sem];
      let stObj = getStudentTracker();
      let overallContentSum = 0;
      let overallCompletedSum = 0;

      let htmlOutput = "";

      for (let subName in semesterData) {
        if (subName === "_initialized") continue;
        let totalItems = 0;
        let completedItems = 0;
        let breakdown = { video: { t: 0, c: 0 }, pdf: { t: 0, c: 0 }, assign: { t: 0, c: 0 }, hw: { t: 0, c: 0 } };

        let subChapters = semesterData[subName];
        if (typeof subChapters !== 'object') continue;
        for (let chName in subChapters) {
          if (chName === "_initialized") continue;
          let content = subChapters[chName];

          const processType = (type, alias) => {
            let arr = [];
            if (Array.isArray(content[type])) arr = content[type];
            else if (typeof content[type] === "string" && content[type].trim()) arr = content[type].split('\n').filter(x => x.trim());

            totalItems += arr.length;
            breakdown[alias].t += arr.length;
            overallContentSum += arr.length;

            if (arr.length > 0) {
              for (let i = 0; i < arr.length; i++) {
                try {
                  if (stObj.progressTracker[c][b][sem][subName][chName][type][i]) {
                    completedItems++;
                    breakdown[alias].c++;
                    overallCompletedSum++;
                  }
                } catch (e) { }
              }
            }
          };

          processType('video', 'video');
          processType('pdf', 'pdf');
          processType('assignment', 'assign');
          processType('homework', 'hw');
        }

        if (totalItems > 0) {
          let percentage = Math.round((completedItems / totalItems) * 100);

          htmlOutput += `
            <div class="subj-progress">
              <div class="subj-progress-title">
                <span>${subName}</span>
                <span>${percentage}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="progress-details">
                ${breakdown.video.t > 0 ? `<span>üìπ Videos: ${breakdown.video.c}/${breakdown.video.t}</span>` : ""}
                ${breakdown.pdf.t > 0 ? `<span>üìÑ PDFs: ${breakdown.pdf.c}/${breakdown.pdf.t}</span>` : ""}
                ${breakdown.assign.t > 0 ? `<span>‚úèÔ∏è Assignments: ${breakdown.assign.c}/${breakdown.assign.t}</span>` : ""}
                ${breakdown.hw.t > 0 ? `<span>üè† HW: ${breakdown.hw.c}/${breakdown.hw.t}</span>` : ""}
              </div>
            </div>
          `;
        }
      }

      if (htmlOutput) {
        let grandTotal = overallContentSum > 0 ? Math.round((overallCompletedSum / overallContentSum) * 100) : 0;
        dashView.innerHTML = `
          <h4 style="color: white; margin-bottom: 20px;">Semester Completion: ${grandTotal}% (${overallCompletedSum}/${overallContentSum} items)</h4>
          ${htmlOutput}
        `;
      } else {
        dashView.innerHTML = "<p>Ask your Admin to upload Videos/PDFs to start tracking your progress!</p>";
      }
    }

    function getProgress(chName) {
      let stObj = getStudentTracker();
      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;

      if (!data[c] || !data[c][b] || !data[c][b][sem] || !data[c][b][sem][sub] || !data[c][b][sem][sub][chName]) return 0;

      let content = data[c][b][sem][sub][chName];
      let total = 0;
      let completed = 0;

      const check = (type) => {
        let arr = [];
        if (Array.isArray(content[type])) arr = content[type];
        else if (typeof content[type] === "string" && content[type].trim()) arr = content[type].split('\n').filter(x => x.trim());

        total += arr.length;
        for (let i = 0; i < arr.length; i++) {
          try {
            if (stObj.progressTracker[c][b][sem][sub][chName][type][i]) completed++;
          } catch (e) { }
        }
      };

      check('video');
      check('pdf');
      check('assignment');
      check('homework');

      return total > 0 ? Math.round((completed / total) * 100) : 0;
    }

    // -------------- PROGRESS TRACKING LOGIC --------------
    function getStudentTracker() {
      let stObj = JSON.parse(localStorage.getItem(currentUserMobile));
      if (!stObj.progressTracker) {
        stObj.progressTracker = {}; // Backwards compat fix
        localStorage.setItem(currentUserMobile, JSON.stringify(stObj));
      }
      return stObj;
    }


    function toggleProgress(type, index, isChecked) {
      if (!currentUserMobile) return;

      let stObj = getStudentTracker();
      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;
      let ch = studentNavState.chapter;

      if (!stObj.progressTracker[c]) stObj.progressTracker[c] = {};
      if (!stObj.progressTracker[c][b]) stObj.progressTracker[c][b] = {};
      if (!stObj.progressTracker[c][b][sem]) stObj.progressTracker[c][b][sem] = {};
      if (!stObj.progressTracker[c][b][sem][sub]) stObj.progressTracker[c][b][sem][sub] = {};
      if (!stObj.progressTracker[c][b][sem][sub][ch]) stObj.progressTracker[c][b][sem][sub][ch] = {};
      if (!stObj.progressTracker[c][b][sem][sub][ch][type]) stObj.progressTracker[c][b][sem][sub][ch][type] = {};

      stObj.progressTracker[c][b][sem][sub][ch][type][index] = isChecked;

      localStorage.setItem(currentUserMobile, JSON.stringify(stObj));
    }

    function isProgressCompleted(type, index) {
      let stObj = getStudentTracker();
      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;
      let ch = studentNavState.chapter;

      try {
        return !!stObj.progressTracker[c][b][sem][sub][ch][type][index];
      } catch (e) {
        return false;
      }
    }

    function renderProgressDashboard() {
      let dashView = document.getElementById("progressContent");
      if (!dashView) return;
      dashView.innerHTML = "";

      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;

      if (!data[c] || !data[c][b] || !data[c][b][sem]) {
        dashView.innerHTML = "<p>No data to analyze for this semester.</p>";
        return;
      }

      let semesterData = data[c][b][sem];
      let stObj = getStudentTracker();
      let overallContentSum = 0;
      let overallCompletedSum = 0;

      let htmlOutput = "";

      for (let subName in semesterData) {
        if (subName === "_initialized") continue;
        let totalItems = 0;
        let completedItems = 0;
        let breakdown = { video: { t: 0, c: 0 }, pdf: { t: 0, c: 0 }, assign: { t: 0, c: 0 }, hw: { t: 0, c: 0 } };

        let subChapters = semesterData[subName];
        for (let chName in subChapters) {
          if (chName === "_initialized") continue;
          let content = subChapters[chName];

          const processType = (type, alias) => {
            let arr = [];
            if (Array.isArray(content[type])) arr = content[type];
            else if (typeof content[type] === "string" && content[type].trim()) arr = content[type].split('\n').filter(x => x.trim());

            totalItems += arr.length;
            breakdown[alias].t += arr.length;
            overallContentSum += arr.length;

            if (arr.length > 0) {
              for (let i = 0; i < arr.length; i++) {
                try {
                  if (stObj.progressTracker[c][b][sem][subName][chName][type][i]) {
                    completedItems++;
                    breakdown[alias].c++;
                    overallCompletedSum++;
                  }
                } catch (e) { }
              }
            }
          };

          processType('video', 'video');
          processType('pdf', 'pdf');
          processType('assignment', 'assign');
          processType('homework', 'hw');
        }

        if (totalItems > 0) {
          let percentage = Math.round((completedItems / totalItems) * 100);

          htmlOutput += `
            <div class="subj-progress">
              <div class="subj-progress-title">
                <span>${subName}</span>
                <span>${percentage}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="progress-details">
                ${breakdown.video.t > 0 ? `<span>üìπ Videos: ${breakdown.video.c}/${breakdown.video.t}</span>` : ""}
                ${breakdown.pdf.t > 0 ? `<span>üìÑ PDFs: ${breakdown.pdf.c}/${breakdown.pdf.t}</span>` : ""}
                ${breakdown.assign.t > 0 ? `<span>‚úèÔ∏è Assignments: ${breakdown.assign.c}/${breakdown.assign.t}</span>` : ""}
                ${breakdown.hw.t > 0 ? `<span>üè† HW: ${breakdown.hw.c}/${breakdown.hw.t}</span>` : ""}
              </div>
            </div>
          `;
        }
      }

      if (htmlOutput) {
        let grandTotal = overallContentSum > 0 ? Math.round((overallCompletedSum / overallContentSum) * 100) : 0;
        dashView.innerHTML = `
          <h4 style="color: white; margin-bottom: 20px;">Semester Completion: ${grandTotal}% (${overallCompletedSum}/${overallContentSum} items)</h4>
          ${htmlOutput}
        `;
      } else {
        dashView.innerHTML = "<p>Ask your Admin to upload Videos/PDFs to start tracking your progress!</p>";
      }
    }

    // Notification & Service Worker Setup
    let serviceWorkerReg = null;
    let fallbackNotifTime = Date.now(); // Ignore old notifications on page load

    if ('serviceWorker' in navigator && 'Notification' in window) {
      navigator.serviceWorker.register('sw.js').then(reg => {
        serviceWorkerReg = reg;
      }).catch(err => console.error("SW Registration failed: ", err));

      // Listen for push broadcasts from Firebase
      database.ref('notifications/latest').on('value', snap => {
        let data = snap.val();
        if (data && data.timestamp > fallbackNotifTime) {
          fallbackNotifTime = data.timestamp;

          // COOL HOLOGRAPHIC HUD ALERT
          triggerNeuralSyncNotification(`üí¨ ADMIN: ${data.title} - ${data.body}`);

          if (Notification.permission === 'granted') {
            navigator.serviceWorker.ready.then(reg => {
              try {
                reg.showNotification(data.title, {
                  body: data.body,
                  icon: 'img1.png',
                  badge: 'img1.png',
                  vibrate: [200, 100, 200],
                  data: { url: window.location.href }
                });
              } catch (e) {
                let n = new Notification(data.title, { body: data.body, icon: 'img1.png' });
                n.onclick = function () {
                  window.focus();
                  this.close();
                };
              }
            }).catch(() => {
              let n = new Notification(data.title, { body: data.body, icon: 'img1.png' });
              n.onclick = function () {
                window.focus();
                this.close();
              };
            });
          }
        }
      });
    }

    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Notification.requestPermission();
      }
    }

    function sendBroadcastNotification() {
      let title = document.getElementById("notifTitle").value.trim();
      let body = document.getElementById("notifBody").value.trim();
      if (!title || !body) return alert("Enter both title and body.");

      let payload = {
        title: title,
        body: body,
        timestamp: Date.now()
      };

      database.ref('notifications/latest').set(payload).then(() => {
        alert("‚úÖ Notification Broadcasted to active users!");
        document.getElementById("notifTitle").value = "";
        document.getElementById("notifBody").value = "";
      }).catch(err => alert("‚ùå Failed to broadcast."));
    }

    function openLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'flex';
      let list = document.getElementById('leaderboardList');
      list.innerHTML = "<p style='color:cyan;'>Loading leaders...</p>";

      database.ref('users').once('value').then(snap => {
        let usersData = snap.val();
        if (!usersData) {
          list.innerHTML = "<p>No users found on platform yet.</p>";
          return;
        }
        let usersArr = [];
        for (let key in usersData) {
          let u = usersData[key];
          if (u.name && u.role !== 'admin') { // assume we only show students
            usersArr.push({
              name: u.name,
              timeSpent: u.timeSpent || 0,
              pic: u.profilePic || "https://ui-avatars.com/api/?name=" + encodeURIComponent(u.name) + "&background=cyan&color=000"
            });
          }
        }
        // Ranking by timeSpent highest first
        usersArr.sort((a, b) => b.timeSpent - a.timeSpent);

        list.innerHTML = "";
        usersArr.forEach((u, idx) => {
          let isTop = idx === 0 ? "üëë " : (idx === 1 ? "ü•à " : (idx === 2 ? "ü•â " : ""));
          let borderCol = idx === 0 ? "gold" : (idx === 1 ? "silver" : (idx === 2 ? "#cd7f32" : "rgba(0,255,255,0.3)"));
          let bgCol = idx === 0 ? "rgba(255,215,0,0.1)" : "rgba(255,255,255,0.05)";
          list.innerHTML += `
            <div style="display: flex; align-items: center; gap: 15px; background: ${bgCol}; padding: 10px; border-radius: 10px; border: 1px solid ${borderCol}; transition: transform 0.2s;">
              <span style="font-size: 20px; font-weight: bold; width: 25px; color:${borderCol};">${idx + 1}.</span>
              <img src="${u.pic}" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid ${borderCol}; object-fit: cover;">
              <div style="text-align: left; flex: 1;">
                <h4 style="margin: 0; color: white;">${isTop}${u.name}</h4>
                <small style="color: #aaa;">Score: ${u.timeSpent} pts</small>
              </div>
            </div>
          `;
        });
      }).catch(err => {
        list.innerHTML = "<p style='color:red;'>Failed to load leaderboard.</p>";
      });
    }

    function closeLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'none';
    }

    function enterSite() {
      requestNotificationPermission();
      showPage("programsWrapper");
      startTimeTracking(); // start time tracking when they enter
      // Setup profile pic in header
      let stObj = JSON.parse(localStorage.getItem(currentUserMobile) || "{}");
      if (stObj.profilePic) {
        document.getElementById('userProfilePicHeader').src = stObj.profilePic;
      } else {
        document.getElementById('userProfilePicHeader').src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(stObj.name || 'U') + "&background=cyan&color=000";
      }
      document.getElementById('userProfilePicHeader').style.display = 'block';
      setTimeout(restoreNavState, 100);
    }

    function saveNavState() {
      if (!currentUserMobile) return;
      let state = {
        studentNavState: studentNavState,
        currentNavLevel: currentNavLevel,
        timestamp: Date.now()
      };
      localStorage.setItem(currentUserMobile + "_navState", JSON.stringify(state));
    }

    function restoreNavState() {
      if (!currentUserMobile) return;
      let saved = localStorage.getItem(currentUserMobile + "_navState");
      if (!saved) return;

      let state = JSON.parse(saved);
      if (Date.now() - state.timestamp > 2 * 60 * 60 * 1000) return; // 2 hour expiry

      studentNavState = state.studentNavState;
      let targetLevel = state.currentNavLevel;

      if (targetLevel === 'programs') {
        goBackToPrograms();
      } else if (targetLevel === 'branches') {
        openStudentLevel('course', studentNavState.course);
      } else if (targetLevel === 'semesters') {
        openStudentLevel('branch', studentNavState.branch);
      } else if (targetLevel === 'subjects') {
        openStudentLevel('semester', studentNavState.sem);
      } else if (targetLevel === 'chapters' || studentNavState.chapter) {
        openStudentLevel('semester', studentNavState.sem);
        if (studentNavState.subject) {
          openStudentLevel('subject', studentNavState.subject);
          if (studentNavState.chapter) {
            openStudentChapter(studentNavState.chapter);
          }
        }
      }
    }

    function goBackToPrograms() {
      document.getElementById("programsWrapper").style.display = "block";
      document.getElementById("semesterMotivationSection").style.display = "none";
    }

    let studentNavState = { course: "", branch: "", sem: "", subject: "" };
    let currentNavLevel = "programs"; // programs -> branches -> semesters -> subjects -> chapters

    function openStudentLevel(level, selection) {
      document.getElementById("programsWrapper").style.display = "none";
      document.getElementById("dynamicNavSection").style.display = "block";

      if (level === 'semester') {
        document.getElementById("semesterMotivationSection").style.display = "block";
      } else {
        document.getElementById("semesterMotivationSection").style.display = "none";
      }

      let container = document.getElementById("dynamicNavContainer");
      let html = "";

      if (level === 'course') {
        studentNavState.course = selection;
        currentNavLevel = 'branches';
        let branches = data[selection];
        for (let br in branches) {
          html += `<div class="box" onclick="openStudentLevel('branch', '${br}')">üèõÔ∏è ${br}</div>`;
        }
      }
      else if (level === 'branch') {
        studentNavState.branch = selection;
        currentNavLevel = 'semesters';
        let sems = data[studentNavState.course][selection];
        for (let s in sems) {
          if (s === "_initialized") continue;
          html += `<div class="box" onclick="openStudentLevel('semester', '${s}')">üìÖ Semester ${s}</div>`;
        }
        renderProgressDashboard(); // Show analytics on semester selection page
      }
      else if (level === 'semester') {
        studentNavState.sem = selection;
        currentNavLevel = 'subjects';
        let subs = data[studentNavState.course][studentNavState.branch][selection];
        for (let su in subs) {
          if (su === "_initialized") continue;
          html += `<div class="box" onclick="openStudentLevel('subject', '${su}')">üìò ${su}</div>`;
        }
      }
      else if (level === 'subject') {
        studentNavState.subject = selection;
        document.getElementById("dynamicNavSection").style.display = "none";
        document.getElementById("chapters").style.display = "block";

        let chapters = data[studentNavState.course][studentNavState.branch][studentNavState.sem][selection];
        let chList = document.getElementById("chapterList");
        chList.innerHTML = "";
        document.getElementById("subjectTitle").innerText = `üìö ${selection}`;

        for (let ch in chapters) {
          if (ch === "_initialized") continue;
          let prog = getProgress(ch);
          let li = document.createElement("li");
          li.innerHTML = `
            <div style="flex:1;">
              <strong>${ch}</strong>
              <div class="progress-bar-small" style="background: rgba(255,255,255,0.1); border-radius: 5px; height: 6px; margin-top: 5px; width: 80%;">
                <div style="background: #00e676; width: ${prog}%; height: 100%; border-radius: 5px; transition: width 0.3s;"></div>
              </div>
            </div>
            <button class="login-btn" onclick="openStudentChapter('${ch}')" style="margin:0; padding: 5px 15px; width:auto; font-size: 14px; margin-left:15px;">Open</button>
          `;
          chList.appendChild(li);
        }
      }
      if (level !== 'subject') {
        container.innerHTML = html;
      }
      saveNavState();
    }

    function goBackDynamicNav() {
      if (currentNavLevel === 'branches') {
        document.getElementById("dynamicNavSection").style.display = "none";
        document.getElementById("programsWrapper").style.display = "block";
        currentNavLevel = 'programs';
      } else if (currentNavLevel === 'semesters') {
        openStudentLevel('course', studentNavState.course);
      } else if (currentNavLevel === 'subjects') {
        openStudentLevel('branch', studentNavState.branch);
      }
      saveNavState();
    }

    function goBackToSubjects() {
      document.getElementById("chapters").style.display = "none";
      openStudentLevel('semester', studentNavState.sem);
      saveNavState();
    }

    function openStudentChapter(ch) {
      studentNavState.chapter = ch;
      document.getElementById("chapters").style.display = "none";
      document.getElementById("content").style.display = "block";

      document.getElementById("chapterTitle").innerText = ch;
      saveNavState();

      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;
      let chapterData = data[c][b][sem][sub][ch];

      // Helper to uniformly process arrays or fallback legacy strings
      const getArray = (val) => {
        if (!val) return [];
        if (Array.isArray(val)) return val;
        if (typeof val === "string") return val.split('\n').filter(v => v.trim() !== "");
        return [];
      };

      // Format Multi-line Text blocks with Line Breaks cleanly
      const formatTextBlocks = (arr) => arr.map(t => t ? t.replace(/\n/g, '<br>') : "").join('<br><br>');

      // Render Multiple Videos
      let vContainer = document.getElementById("videoContainer");
      vContainer.innerHTML = "";
      let videoArr = getArray(chapterData.video);

      if (videoArr.length > 0) {
        videoArr.forEach((v, idx) => {
          let wrapper = document.createElement("div");
          let iframe = document.createElement("iframe");
          iframe.width = "560";
          iframe.height = "315";
          iframe.frameBorder = "0";
          iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
          iframe.allowFullscreen = true;
          iframe.style.maxWidth = "100%";
          iframe.src = v;
          wrapper.appendChild(iframe);

          // Auto-mark as completed
          toggleProgress('video', idx, true);

          vContainer.appendChild(wrapper);
        });
        document.getElementById("videoSection").style.display = "block";
      } else {
        document.getElementById("videoSection").style.display = "none";
      }

      // Render Content Blocks
      const renderBlock = (arr, elementId, secId, type) => {
        let wrapper = document.getElementById(elementId);
        wrapper.innerHTML = "";
        if (arr.length > 0) {
          arr.forEach((text, idx) => {
            let pDiv = document.createElement("div");
            pDiv.innerHTML = formatTextBlocks([text]);
            // Auto-mark as completed
            toggleProgress(type, idx, true);
            pDiv.appendChild(document.createElement("hr"));
            wrapper.appendChild(pDiv);
          });
          document.getElementById(secId).style.display = "block";
        } else {
          document.getElementById(secId).style.display = "none";
        }
      };

      renderBlock(getArray(chapterData.assignment), "assignmentText", "assignmentSection", "assignment");
      renderBlock(getArray(chapterData.homework), "homeworkText", "homeworkSection", "homework");

      let notesArr = getArray(chapterData.notes);
      document.getElementById("notesText").innerHTML = formatTextBlocks(notesArr);

      // Render Multiple PDFs
      let pContainer = document.getElementById("pdfContainer");
      pContainer.innerHTML = "";
      let pdfArr = getArray(chapterData.pdf);

      if (pdfArr.length > 0) {
        document.getElementById("pdfSection").classList.add('book-opening');
        pdfArr.forEach((pUrl, idx) => {
          let fileId = pUrl.match(/\/d\/(.*?)\//)?.[1];
          if (fileId) {
            let wrapper = document.createElement("div");
            wrapper.style.position = "relative"; // Key for absolute overlay

            let iframe = document.createElement("iframe");
            iframe.width = "100%";
            iframe.height = "500";
            iframe.frameBorder = "0";
            iframe.style.borderRadius = "8px";
            // Prevent pop-ups to block opening in a new tab for download
            iframe.setAttribute("sandbox", "allow-scripts allow-same-origin");
            iframe.src = "https://drive.google.com/file/d/" + fileId + "/preview?rm=minimal#toolbar=0";
            wrapper.appendChild(iframe);

            // Block clicks on the top-right toolbar (Google Drive action buttons)
            let securityOverlay = document.createElement("div");
            securityOverlay.style.position = "absolute";
            securityOverlay.style.top = "0";
            securityOverlay.style.left = "0";
            securityOverlay.style.width = "100%";
            securityOverlay.style.height = "60px"; // Size of the top header toolbar
            securityOverlay.style.background = "transparent";
            securityOverlay.style.zIndex = "10";
            securityOverlay.oncontextmenu = () => false; // Prevent right-click options in this zone
            wrapper.appendChild(securityOverlay);

            // Auto-mark as completed
            toggleProgress('pdf', idx, true);

            wrapper.style.marginBottom = "15px";
            pContainer.appendChild(wrapper);
          }
        });
        document.getElementById("pdfSection").style.display = pContainer.children.length > 0 ? "block" : "none";

        // Remove animation after play to avoid issues on re-renders
        setTimeout(() => {
          document.getElementById("pdfSection").classList.remove('book-opening');
        }, 1500);
      } else {
        document.getElementById("pdfSection").style.display = "none";
      }
    }

    function goBack() {
      document.getElementById("chapters").style.display = "none";
      document.getElementById("subjects").style.display = "grid";
    }

    function goBackChapter() {
      document.getElementById("content").style.display = "none";
      document.getElementById("chapters").style.display = "block";
      saveNavState();
    }

    function toggleTask(checkbox) {
      let taskItem = checkbox.parentElement;
      if (checkbox.checked) {
        taskItem.classList.add("completed");
      } else {
        taskItem.classList.remove("completed");
      }
    }

    function toggleMode() {
      document.body.classList.toggle("light");
      let btn = document.getElementById("themeToggleBtn");
      if (document.body.classList.contains("light")) {
        btn.innerText = "üåô";
      } else {
        btn.innerText = "‚òÄÔ∏è";
      }
    }

    function searchChapter(val) {
      let items = document.querySelectorAll("li");
      items.forEach(i => {
        i.style.display = i.innerText.toLowerCase().includes(val.toLowerCase()) ? "block" : "none";
      });
    }

    // --- GEMINI AI TUTOR LOGIC ---
    // PASTE YOUR NEW GEMINI API KEY HERE (Line 3376)
    const NEXTGEN_AI = "AIzaSyD5h0roGpYOMskKeB2lCLDqjGyase42DZ0";

    function toggleChat() {
      let chatBox = document.getElementById("aiChatBox");
      if (chatBox.style.display === "none" || chatBox.style.display === "") {
        chatBox.style.display = "flex";
      } else {
        chatBox.style.display = "none";
      }
    }

    async function sendChatMessage() {
      let inputField = document.getElementById("aiChatInput");
      let message = inputField.value.trim();
      if (!message) return;

      let chatHistory = document.getElementById("aiChatHistory");

      // Add user message
      let userBubble = document.createElement("div");
      userBubble.style.cssText = "align-self: flex-end; background: cyan; color: black; padding: 10px 14px; border-radius: 12px; border-bottom-right-radius: 0; max-width: 85%; font-weight: 500; font-size: 14px;";
      userBubble.innerText = message;
      chatHistory.appendChild(userBubble);
      inputField.value = "";

      // Scroll to bottom
      chatHistory.scrollTop = chatHistory.scrollHeight;

      // Add loading state
      let loadingBubble = document.createElement("div");
      loadingBubble.style.cssText = "align-self: flex-start; background: rgba(0, 255, 255, 0.1); padding: 10px 14px; border-radius: 12px; border-bottom-left-radius: 0; max-width: 85%; border: 1px solid rgba(0, 255, 255, 0.3); font-style: italic; color: cyan; font-size: 14px;";
      loadingBubble.innerText = "Thinking...";
      chatHistory.appendChild(loadingBubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;

      if (!NEXTGEN_AI) {
        setTimeout(() => {
          chatHistory.removeChild(loadingBubble);
          addAiResponse("‚ö†Ô∏è **API Key is missing!** <br><br>Developer needs to paste the Gemini API Key into the JavaScript code (`const NEXTGEN_AI = 'YOUR_KEY_HERE'; `) for me to connect to the internet and answer your questions.");
        }, 1500);
        return;
      }

      // Call Gemini API
      try {
        let response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${NEXTGEN_AI}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: "You are a helpful AI tutor for a college student. Keep your answers concise, educational, formatted nicely with markdown if needed, and easy to understand. Student's query: " + message }] }]
          })
        });

        let data = await response.json();
        chatHistory.removeChild(loadingBubble);

        if (data.candidates && data.candidates.length > 0) {
          let aiText = data.candidates[0].content.parts[0].text;
          addAiResponse(aiText);
        } else if (data.error) {
          addAiResponse("‚ö†Ô∏è API Error: " + data.error.message);
        } else {
          addAiResponse("Sorry, I couldn't generate a response. Please try again.");
        }
      } catch (error) {
        chatHistory.removeChild(loadingBubble);
        addAiResponse("Oops! A network error occurred while connecting to my brain. Please check your internet connection.");
      }
    }

    function addAiResponse(text) {
      let chatHistory = document.getElementById("aiChatHistory");
      let aiBubble = document.createElement("div");
      aiBubble.style.cssText = "align-self: flex-start; background: rgba(0, 255, 255, 0.1); padding: 10px 14px; border-radius: 12px; border-bottom-left-radius: 0; max-width: 85%; border: 1px solid rgba(0, 255, 255, 0.3); color: white; font-size: 14px; line-height: 1.5;";

      // Convert basic markdown to HTML for better readability
      text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
      text = text.replace(/\*(.*?)\*/g, '<i>$1</i>');
      text = text.replace(/\n/g, '<br>');

      aiBubble.innerHTML = text;
      chatHistory.appendChild(aiBubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function previewPremiumQR(event) {
      let file = event.target.files[0];
      if (file) {
        let reader = new FileReader();
        reader.onload = function (e) {
          let img = new Image();
          img.onload = function () {
            let canvas = document.createElement("canvas");
            let MAX_WIDTH = 400;
            let MAX_HEIGHT = 400;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
            } else {
              if (height > MAX_HEIGHT) {
                width *= MAX_HEIGHT / height;
                height = MAX_HEIGHT;
              }
            }

            canvas.width = width;
            canvas.height = height;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            let preview = document.getElementById("premiumQRPreview");
            preview.src = canvas.toDataURL("image/jpeg", 0.6); // Compress aggressively
            preview.style.display = "block";
          };
          img.src = e.target.result;
        }
        reader.readAsDataURL(file);
      }
    }

    function savePremiumConfig() {
      let course = document.getElementById("premConfigCourse") ? document.getElementById("premConfigCourse").value : "";
      let option = document.getElementById("premConfigOption") ? document.getElementById("premConfigOption").value : "";

      if (!course || !option) {
        // fallback to saving global config if elements missing or not selected 
        saveGlobalPremiumConfig();
        return;
      }

      let preview = document.getElementById("premiumQRPreview");
      let qrBase64 = preview.src && preview.style.display !== "none" ? preview.src : "";

      let upi = document.getElementById("premiumUPI").value.trim();
      let amount = document.getElementById("premiumAmount").value.trim();

      let payload = {
        qr: qrBase64,
        upi,
        amount
      };

      let itemKey = course + "_" + option;
      let pConf = JSON.parse(localStorage.getItem("premiumCourseConfigs")) || {};
      pConf[itemKey] = payload;

      database.ref('premiumCourseConfigs/' + itemKey).set(payload).then(() => {
        localStorage.setItem("premiumCourseConfigs", JSON.stringify(pConf));
        alert("‚úÖ Premium Payment Settings for " + course + " - " + option + " saved successfully!");
      }).catch(err => {
        console.error(err);
        alert("‚ùå Failed to save! Your QR image might still be too large. Please upload an image under 1MB.");
      });
    }

    function saveGlobalPremiumConfig() {
      let preview = document.getElementById("premiumQRPreview");
      let qrBase64 = preview.src && preview.style.display !== "none" ? preview.src : "";

      let upi = document.getElementById("premiumUPI").value.trim();
      let amount = document.getElementById("premiumAmount").value.trim();

      let payload = {
        qr: qrBase64,
        upi,
        amount
      };

      database.ref('premiumConfig').set(payload).then(() => {
        localStorage.setItem("premiumConfig", JSON.stringify(payload));
        alert("‚úÖ Global Premium Payment Settings saved successfully!");
      }).catch(err => {
        console.error(err);
        alert("‚ùå Failed to save! Your QR image might still be too large. Please upload an image under 1MB.");
      });
    }

    /* PREMIUM NOTES & BOOK LOGIC */
    let selectedPremiumItem = "";

    function openPremiumHub() {
      let config = globalSiteConfig;
      if (config.premiumEnabled === false) {
        alert("Premium features are currently disabled by Admin.");
        return;
      }
      document.getElementById("programsWrapper").style.display = "none";
      document.getElementById("semesterMotivationSection").style.display = "none";
      document.getElementById("premiumNavSection").style.display = "block";
      document.getElementById("premiumCoursesContainer").style.display = "grid";
      document.getElementById("premiumOptionsContainer").style.display = "none";
    }

    function goBackFromPremium() {
      if (document.getElementById("premiumContentContainer").style.display === "block") {
        document.getElementById("premiumContentContainer").style.display = "none";
        document.getElementById("premiumOptionsContainer").style.display = "grid";
      } else if (document.getElementById("premiumOptionsContainer").style.display === "grid") {
        document.getElementById("premiumOptionsContainer").style.display = "none";
        document.getElementById("premiumCoursesContainer").style.display = "grid";
      } else {
        document.getElementById("premiumNavSection").style.display = "none";
        document.getElementById("programsWrapper").style.display = "block";
      }
    }

    function goBackToPremiumOptions() {
      document.getElementById("premiumContentContainer").style.display = "none";
      document.getElementById("premiumOptionsContainer").style.display = "grid";
    }

    function showPremiumOptions(course) {
      document.getElementById("premiumCoursesContainer").style.display = "none";
      document.getElementById("premiumContentContainer").style.display = "none"; // Hide content if any
      let container = document.getElementById("premiumOptionsContainer");
      container.style.display = "grid";
      container.innerHTML = "<p style='color:cyan; grid-column:1/-1;'>Loading premium items...</p>";

      let optionsObj = premiumData[course] || {};
      let options = Object.keys(optionsObj);

      if (options.length === 0) {
        container.innerHTML = "<p style='color:#ccc; grid-column:1/-1;'>No premium options available for this course yet.</p>";
        return;
      }

      database.ref('users/' + currentUserMobile).once('value').then(snap => {
        let stObj = snap.val() || {};
        if (!stObj.premiumUnlocked) stObj.premiumUnlocked = {};

        container.innerHTML = "";
        options.forEach(opt => {
          let itemKey = course + "_" + opt;

          let isUnlocked = false;
          let unlockData = stObj.premiumUnlocked[itemKey];
          if (unlockData) {
            if (typeof unlockData === 'object' && unlockData.active) {
              if (unlockData.expiresAt && Date.now() > unlockData.expiresAt) {
                isUnlocked = false; // Expired
              } else {
                isUnlocked = true;
              }
            } else if (unlockData === true) {
              isUnlocked = true; // Legacy
            }
          }

          let classes = "box premium-box ";
          let icon = isUnlocked ? "üîì" : "üîí";
          if (!isUnlocked) classes += "locked-option";

          container.innerHTML += `<div class="${classes}" onclick="handlePremiumClick('${course}', '${opt}', ${isUnlocked ? 'true' : 'false'})">
            <h2>${icon} ${opt}</h2>
          </div>`;
        });
      });
    }

    function handlePremiumClick(course, option, isUnlocked) {
      let itemKey = course + "_" + option;
      if (isUnlocked) {
        showPremiumContent(course, option);
      } else {
        // Check if there's a pending or rejected payment in Firebase DB
        database.ref('pendingPayments').once('value').then(snap => {
          let pendingData = snap.val() || {};
          let existingReqId = null;
          let existingReq = null;

          for (let id in pendingData) {
            let req = pendingData[id];
            if (req.mobile === currentUserMobile && req.itemKey === itemKey) {
              existingReqId = id;
              existingReq = req;
              break;
            }
          }

          if (existingReq) {
            if (existingReq.status === "pending") {
              alert("‚è≥ Your payment for this item is currently under verification by Admin.");
              return;
            } else if (existingReq.status === "rejected") {
              alert("‚ùå Admin rejected your previous payment attempt.\nReason: " + existingReq.reason + "\n\nPlease provide real proofs.");
              // Remove the rejected request so they can try again
              database.ref('pendingPayments/' + existingReqId).remove();
            }
          }

          selectedPremiumItem = itemKey;
          openPaymentModal();
        });
      }
    }

    function showPremiumContent(course, option) {
      document.getElementById("premiumOptionsContainer").style.display = "none";
      let pContainer = document.getElementById("premiumContentContainer");
      pContainer.style.display = "block";

      document.getElementById("activePremiumOptionTitle").innerHTML = `üíé ${course} - ${option}`;

      let grid = document.getElementById("premiumPdfsGrid");
      grid.innerHTML = "";

      let pdfs = premiumData[course][option] || [];

      if (pdfs.length === 0) {
        grid.innerHTML = "<p style='color:#ccc;'>No PDFs available in this section yet.</p>";
        return;
      }

      pdfs.forEach(pdf => {
        let box = document.createElement("div");
        box.style.cssText = "background: rgba(255, 255, 255, 0.05); border: 1px solid cyan; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 0 10px rgba(0,255,255,0.1);";
        box.innerHTML = `<h1 style="margin:0 0 10px 0; font-size:40px; text-shadow: 0 0 10px gold;">üìÑ</h1>
                         <h3 style="margin:0; color:white;">${pdf.title}</h3>`;
        box.onmouseenter = () => box.style.transform = "scale(1.05)";
        box.onmouseleave = () => box.style.transform = "scale(1)";
        box.onclick = () => window.open(pdf.link, "_blank");
        grid.appendChild(box);
      });
    }

    function openPaymentModal() {
      let globalConf = JSON.parse(localStorage.getItem("premiumConfig")) || {};
      let courseConfigs = JSON.parse(localStorage.getItem("premiumCourseConfigs")) || {};

      let specificConfig = courseConfigs[selectedPremiumItem];
      let pConf = specificConfig ? specificConfig : globalConf;

      let activeAmount = pConf.amount && pConf.amount.trim() !== "" ? pConf.amount : "49";
      let baseUpi = pConf.upi && pConf.upi.trim() !== "" && pConf.upi !== "admin@upi" ? pConf.upi : "adityakumar84282-1@oksbi";

      document.getElementById("paymentAmountDisplay").innerText = "‚Çπ" + activeAmount;
      document.getElementById("paymentUPIDisplay").innerText = "UPI ID: " + baseUpi;
      let qrImg = document.getElementById("paymentQRDisplay");
      if (pConf.qr && pConf.qr.startsWith("data:image")) {
        qrImg.src = pConf.qr;
        qrImg.style.display = "inline-block";
      } else if (pConf.qr && pConf.qr.trim() !== "") {
        // Fallback for old URL-based configs if any
        qrImg.src = pConf.qr;
        qrImg.style.display = "inline-block";
      } else {
        // Generate dynamic QR code if not explicitly configured
        let upiString = `upi://pay?pa=${baseUpi}&pn=NextGenLibrary&am=${activeAmount}&cu=INR`;
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(upiString)}`;
        qrImg.style.display = "inline-block";
      }

      document.getElementById("paymentModal").style.display = "flex";
    }

    function closePaymentModal() {
      document.getElementById("paymentModal").style.display = "none";
      selectedPremiumItem = "";
    }

    function payWithUpiApp(app) {
      let globalConf = JSON.parse(localStorage.getItem("premiumConfig")) || {};
      let courseConfigs = JSON.parse(localStorage.getItem("premiumCourseConfigs")) || {};

      let specificConfig = courseConfigs[selectedPremiumItem];
      let pConf = specificConfig ? specificConfig : globalConf;

      let activeAmount = pConf.amount && pConf.amount.trim() !== "" ? pConf.amount : "49";
      let baseUpi = pConf.upi && pConf.upi.trim() !== "" && pConf.upi !== "admin@upi" ? pConf.upi : "adityakumar84282-1@oksbi";

      let upiStr = `upi://pay?pa=${baseUpi}&pn=NextGenLibrary&am=${activeAmount}&cu=INR`;
      if (app === 'gpay') {
        upiStr = `tez://upi/pay?pa=${baseUpi}&pn=NextGenLibrary&am=${activeAmount}&cu=INR`;
      } else if (app === 'phonepe') {
        upiStr = `phonepe://pay?pa=${baseUpi}&pn=NextGenLibrary&am=${activeAmount}&cu=INR`;
      }
      window.location.href = upiStr;
    }

    let currentScreenshotBase64 = "";

    function previewPaymentScreenshot(event) {
      let file = event.target.files[0];
      if (file) {
        let reader = new FileReader();
        reader.onload = function (e) {
          currentScreenshotBase64 = e.target.result;
          let preview = document.getElementById("paymentScreenshotPreview");
          preview.src = currentScreenshotBase64;
          preview.style.display = "block";
        }
        reader.readAsDataURL(file);
      }
    }

    function confirmPremiumPayment() {
      if (!selectedPremiumItem) return;

      let utrInput = document.getElementById("paymentUtrInput").value.trim();
      if (!utrInput || utrInput.length !== 12) {
        alert("‚ö†Ô∏è Please enter a valid 12-Digit UTR / Transaction ID.");
        return;
      }

      if (!currentScreenshotBase64) {
        alert("‚ö†Ô∏è Please upload a Payment Screenshot as proof.");
        return;
      }

      let btn = document.querySelector(".confirm-pay-btn");
      btn.innerText = "Submitting...";
      btn.disabled = true;

      // Make sure we have the latest user name from Firebase
      database.ref('users/' + currentUserMobile).once('value').then(snap => {
        let userName = "Student";
        if (snap.exists() && snap.val().name) {
          userName = snap.val().name;
        }

        let newReqId = Date.now().toString();
        let payload = {
          id: newReqId,
          mobile: currentUserMobile,
          name: userName,
          itemKey: selectedPremiumItem,
          utr: utrInput,
          screenshot: currentScreenshotBase64,
          status: "pending",
          timestamp: Date.now()
        };

        return database.ref('pendingPayments/' + newReqId).set(payload);
      }).then(() => {
        alert("‚è≥ Payment Request Submitted!\nAdmin will verify your UTR and Screenshot. Access will be granted shortly.");

        // Cleanup Modal
        document.getElementById("paymentUtrInput").value = "";
        document.getElementById("paymentScreenshotInput").value = "";
        document.getElementById("paymentScreenshotPreview").style.display = "none";
        currentScreenshotBase64 = "";

        btn.innerText = "Submit for Verification";
        btn.disabled = false;
        closePaymentModal();
      }).catch(err => {
        console.error(err);
        alert("‚ùå Failed to submit request due to a network error or the screenshot is too large.");
        btn.innerText = "Submit for Verification";
        btn.disabled = false;
      });
    }

    /* MOTIVATION ROTATION */
    /* MOTIVATION ROTATION */
    const motivations = [
      // Bhagavad Gita / Mahabharata
      "\"Karmanye Vadhikaraste, Ma Phaleshu Kadachana. (You have a right to perform your prescribed duty, but you are not entitled to the fruits of action.)\" - Bhagavad Gita",
      "\"A person can rise through the efforts of his own mind; or draw himself down, in the same manner. Because each person is his own friend or enemy.\" - Bhagavad Gita",
      "\"Whatever happened, happened for the good. Whatever is happening, is happening for the good. Whatever will happen, will also happen for the good.\" - Mahabharata",
      "\"There is neither this world nor the world beyond nor happiness for the one who doubts.\" - Bhagavad Gita",
      "\"No one who does good work will ever come to a bad end, either here or in the world to come.\" - Bhagavad Gita",
      "\"You are what you believe in. You become that which you believe you can become.\" - Bhagavad Gita",
      "\"Change is the law of the universe. You can be a millionaire, or a pauper in an instant.\" - Bhagavad Gita",
      "\"The power of God is with you at all times; through the activities of mind, senses, breathing, and emotions; and is constantly doing all the work using you as a mere instrument.\" - Bhagavad Gita",
      "\"When meditation is mastered, the mind is unwavering like the flame of a lamp in a windless place.\" - Bhagavad Gita",
      "\"We are kept from our goal not by obstacles, but by a clear path to a lesser goal.\" - Mahabharata Teachings",

      // Ramayana & Epics
      "\"Truth, righteousness, and morality will always triumph over evil and deception.\" - Valmiki Ramayana",
      "\"Only the timid and the weak leave things to destiny (Daivam), but the strong and the self-reliant never fold their hands to destiny.\" - Lakshmana (Ramayana)",
      "\"There is no deity powerful as time.\" - Valmiki Ramayana",
      "\"Grief destroys one's courage. It destroys one's learning. There is no enemy greater than grief.\" - Shri Rama (Ramayana)",
      "\"Even if a person is weak, if he has the courage and the will, he can defeat the strongest of enemies.\" - Ramayana",

      // Swami Vivekananda & Spiritual Leaders
      "\"Arise, awake, and stop not till the goal is reached.\" - Swami Vivekananda",
      "\"Take up one idea. Make that one idea your life - think of it, dream of it, live on that idea.\" - Swami Vivekananda",
      "\"You cannot believe in God until you believe in yourself.\" - Swami Vivekananda",
      "\"Truth can be stated in a thousand different ways, yet each one can be true.\" - Swami Vivekananda",
      "\"In a day, when you don't come across any problems - you can be sure that you are travelling in a wrong path.\" - Swami Vivekananda",
      "\"There is no limit to the power of the human mind. The more concentrated it is, the more power is brought to bear on one point.\" - Swami Vivekananda",
      "\"Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.\" - Gautama Buddha",
      "\"The mind is everything. What you think you become.\" - Gautama Buddha",
      "\"Your work is to discover your work and then with all your heart to give yourself to it.\" - Gautama Buddha",

      // Scientists & Modern Leaders (APJ Abdul Kalam, etc.)
      "\"Dream, dream, dream. Dreams transform into thoughts and thoughts result in action.\" - Dr. A.P.J. Abdul Kalam",
      "\"If you want to shine like a sun, first burn like a sun.\" - Dr. A.P.J. Abdul Kalam",
      "\"To succeed in your mission, you must have single-minded devotion to your goal.\" - Dr. A.P.J. Abdul Kalam",
      "\"You have to dream before your dreams can come true.\" - Dr. A.P.J. Abdul Kalam",
      "\"Man needs difficulties in life because they are necessary to enjoy success.\" - Dr. A.P.J. Abdul Kalam",
      "\"Be active! Take on responsibility! Work for the things you believe in. If you do not, you are surrendering your fate to others.\" - Dr. A.P.J. Abdul Kalam",
      "\"Excellence is a continuous process and not an accident.\" - Dr. A.P.J. Abdul Kalam",
      "\"Science is a beautiful gift to humanity; we should not distort it.\" - Dr. A.P.J. Abdul Kalam",
      "\"I can't change the direction of the wind, but I can adjust my sails to always reach my destination.\" - Jimmy Dean",
      "\"First they ignore you, then they laugh at you, then they fight you, then you win.\" - Mahatma Gandhi",
      "\"Live as if you were to die tomorrow. Learn as if you were to live forever.\" - Mahatma Gandhi",
      "\"The future depends on what you do today.\" - Mahatma Gandhi",
      "\"Strength does not come from physical capacity. It comes from an indomitable will.\" - Mahatma Gandhi",
      "\"Let new India arise out of peasants' cottage, grasping the plough, out of huts, cobbler and sweeper.\" - Netaji Subhas Chandra Bose",
      "\"One individual may die for an idea, but that idea will, after his death, incarnate itself in a thousand lives.\" - Netaji Subhas Chandra Bose",
      "\"Freedom is not given, it is taken.\" - Netaji Subhas Chandra Bose",

      // Chanakya (Vishnugupta)
      "\"Education is the best friend. An educated person is respected everywhere. Education beats the beauty and the youth.\" - Chanakya",
      "\"A man is born alone and dies alone; and he experiences the good and bad consequences of his karma alone; and he goes alone to hell or the Supreme abode.\" - Chanakya",
      "\"Learn from the mistakes of others... you can't live long enough to make them all yourselves.\" - Chanakya",
      "\"As soon as the fear approaches near, attack and destroy it.\" - Chanakya",
      "\"There is no present and future of the lazy.\" - Chanakya",
      "\"Even if a snake is not poisonous, it should pretend to be venomous.\" - Chanakya",

      // IAS / IPS / Civil Services Aspirant Motivation
      "\"A dream does not become reality through magic; it takes sweat, determination, and hard work.\" - Colin Powell (UPSC Ethos)",
      "\"The rougher the seas, the smoother we sail. Ahoy!\" - Indian Navy / Armed forces ethos",
      "\"Kadi mehnat, pakka iraada, aur khud par vishwas ‚Äì yahi ekmatra rasta hai safalta ka.\" - UPSC Aspirant's Mantra",
      "\"When you feel like quitting, remember why you started.\" - IAS Training Ethos",
      "\"It‚Äôs not about how many hours you study, it‚Äôs about how much you study in those hours.\" - Civil Services Motivation",
      "\"Service before Self.\" - NDA/Defense Motto",
      "\"No matter how tough the grind, the steel is forged only in the hottest fire.\" - IPS Training Academy (SVPNPA)",
      "\"Hard work beats talent when talent doesn't work hard.\" - Tim Notke (Student Ethos)",
      "\"Push yourself, because no one else is going to do it for you.\" - Student Motivation",
      "\"Success doesn‚Äôt just find you. You have to go out and get it.\" - General Motivation",
      "\"The harder you work for something, the greater you‚Äôll feel when you achieve it.\" - General Motivation",
      "\"Don‚Äôt stop when you‚Äôre tired. Stop when you‚Äôre done.\" - General Motivation",
      "\"Wake up with determination. Go to bed with satisfaction.\" - Student Ethos",
      "\"Do something today that your future self will thank you for.\" - General Motivation"
    ];

    let currentMotivationIndex = 0;
    // Set random initial tip to feel dynamic on reload
    currentMotivationIndex = Math.floor(Math.random() * motivations.length);
    document.getElementById("motivationText").innerText = motivations[currentMotivationIndex];

    setInterval(() => {
      currentMotivationIndex = (currentMotivationIndex + 1) % motivations.length;
      document.getElementById("motivationText").innerText = motivations[currentMotivationIndex];
    }, 60000); // 60,000 ms = 1 minute


    /* ADVANCED VFX: INTERACTIVE PARTICLE ENGINE */
    const canvas = document.getElementById('vfx-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let mouse = { x: null, y: null, radius: 150 };

    window.addEventListener('mousemove', (e) => {
      mouse.x = e.x;
      mouse.y = e.y;
    });

    window.addEventListener('touchmove', (e) => {
      if (e.touches.length > 0) {
        mouse.x = e.touches[0].clientX;
        mouse.y = e.touches[0].clientY;
      }
    });

    window.addEventListener('touchstart', (e) => {
      if (e.touches.length > 0) {
        mouse.x = e.touches[0].clientX;
        mouse.y = e.touches[0].clientY;
      }
    });

    window.addEventListener('touchend', () => {
      mouse.x = null;
      mouse.y = null;
    });

    function initParticles() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      particles = [];
      let numberOfParticles = (canvas.width * canvas.height) / 9000;
      for (let i = 0; i < numberOfParticles; i++) {
        let size = Math.random() * 2 + 1;
        let x = Math.random() * canvas.width;
        let y = Math.random() * canvas.height;
        let directionX = (Math.random() * 0.4) - 0.2;
        let directionY = (Math.random() * 0.4) - 0.2;
        let color = 'rgba(0, 242, 254, 1)';
        particles.push(new Particle(x, y, directionX, directionY, size, color));
      }
    }

    class Particle {
      constructor(x, y, dx, dy, size, color) {
        this.x = x;
        this.y = y;
        this.dx = dx;
        this.dy = dy;
        this.size = size;
        this.color = color;
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
        ctx.fillStyle = 'rgba(0, 242, 254, 0.8)';
        ctx.fill();
      }
      update() {
        if (this.x > canvas.width || this.x < 0) this.dx = -this.dx;
        if (this.y > canvas.height || this.y < 0) this.dy = -this.dy;

        // Mouse collision
        let dx = mouse.x - this.x;
        let dy = mouse.y - this.y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < mouse.radius) {
          if (mouse.x < this.x && this.x < canvas.width - this.size * 10) this.x += 3;
          if (mouse.x > this.x && this.x > this.size * 10) this.x -= 3;
          if (mouse.y < this.y && this.y < canvas.height - this.size * 10) this.y += 3;
          if (mouse.y > this.y && this.y > this.size * 10) this.y -= 3;
        }

        this.x += this.dx;
        this.y += this.dy;
        this.draw();
      }
    }

    function connect() {
      let opacityValue = 1;
      for (let a = 0; a < particles.length; a++) {
        for (let b = a; b < particles.length; b++) {
          let distance = ((particles[a].x - particles[b].x) * (particles[a].x - particles[b].x)) +
            ((particles[a].y - particles[b].y) * (particles[a].y - particles[b].y));
          if (distance < (canvas.width / 7) * (canvas.height / 7)) {
            opacityValue = 1 - (distance / 20000);
            ctx.strokeStyle = `rgba(0, 242, 254, ${opacityValue})`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(particles[a].x, particles[a].y);
            ctx.lineTo(particles[b].x, particles[b].y);
            ctx.stroke();
          }
        }
      }
    }

    function animateParticles() {
      requestAnimationFrame(animateParticles);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < particles.length; i++) {
        particles[i].update();
      }
      connect();
    }

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      initParticles();
    });

    initParticles();
    animateParticles();


    /* 3D TILT EFFECT LOGIC (Mouse & Touch) */
    function handleTilt(e, isTouch = false) {
      const target = isTouch ? e.touches[0].target : e.target;
      const box = target.closest('.box');
      if (!box) return;

      const clientX = isTouch ? e.touches[0].clientX : e.clientX;
      const clientY = isTouch ? e.touches[0].clientY : e.clientY;

      const rect = box.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;

      const centerX = rect.width / 2;
      const centerY = rect.height / 2;

      const percentX = (x - centerX) / centerX;
      const percentY = (y - centerY) / centerY;

      const rotateX = percentY * -15;
      const rotateY = percentX * 15;

      box.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-10px) scale(1.02)`;
      box.style.transition = 'none';
    }

    function resetTilt(e) {
      const box = e.target.closest('.box') || (e.target && e.target.style && e.target.style.transform ? e.target : null);
      if (!box || !box.classList.contains('box')) return;

      box.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) translateY(0) scale(1)`;
      box.style.transition = 'transform 0.5s ease';
    }

    document.addEventListener('mousemove', (e) => handleTilt(e));
    document.addEventListener('touchmove', (e) => handleTilt(e, true), { passive: true });

    document.addEventListener('mouseout', (e) => {
      const box = e.target.closest('.box');
      if (!box) return;
      if (e.relatedTarget && box.contains(e.relatedTarget)) return;
      resetTilt(e);
    });

    document.addEventListener('touchend', (e) => {
      // Small delay to let the eye catch the final tilt
      setTimeout(() => {
        const boxes = document.querySelectorAll('.box');
        boxes.forEach(b => {
          b.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) translateY(0) scale(1)`;
          b.style.transition = 'transform 0.5s ease';
        });
      }, 150);
    });


    /* GLOBAL SEARCH ALGORITHM */
    function searchLibrary() {
      const q = document.getElementById('globalSearchInput').value.toLowerCase().trim();
      const resBox = document.getElementById('searchResultsModal');

      if (!q) {
        resBox.style.display = 'none';
        resBox.innerHTML = '';
        return;
      }

      let matches = [];
      let maxResults = 15;

      // Deep scan the data object
      for (let course in data) {
        for (let branch in data[course]) {
          let sems = data[course][branch];
          for (let semNum in sems) {
            let subjects = sems[semNum];
            for (let subName in subjects) {

              // Keyword match in Subject Name
              if (subName.toLowerCase().includes(q)) {
                matches.push({ type: 'Subject', name: subName, course, branch, semNum, icon: 'üìñ' });
              }

              let chapters = subjects[subName].chapters || [];
              chapters.forEach(ch => {
                // Keyword match in Chapter Content
                if (ch.name.toLowerCase().includes(q) || (ch.description && ch.description.toLowerCase().includes(q))) {
                  matches.push({
                    type: 'Chapter',
                    name: ch.name + ` <span style="font-size:10px;color:#aaa;">(${subName})</span>`,
                    cleanName: ch.name,
                    course, branch, semNum, subName,
                    icon: 'üìù'
                  });
                }
              });
            }
          }
        }
      }

      if (matches.length === 0) {
        resBox.innerHTML = '<div style="padding:10px; text-align:center; color:#ff4757; font-size:13px;">No results found for "' + q + '"</div>';
      } else {
        let html = '';
        matches.slice(0, maxResults).forEach(m => {
          if (m.type === 'Chapter') {
            html += `<div style="padding: 10px; border-bottom: 1px solid rgba(0,255,255,0.1); cursor: pointer; transition: 0.3s; color: white; display:flex; align-items:center; gap:8px;" 
                        onmouseover="this.style.background='rgba(0,242,254,0.2)'" onmouseout="this.style.background='transparent'"
                        onclick="jumpToChapter('${m.course}', '${m.branch}', '${m.semNum}', '${m.subName}', \`${m.cleanName}\`)">
                        <span>${m.icon}</span> <div><div style="font-size:13px; font-weight:bold; color: cyan;">${m.name}</div><div style="font-size:10px; color:#aaa;">${m.course} > ${m.branch} > Sem ${m.semNum}</div></div>
                     </div>`;
          } else {
            html += `<div style="padding: 10px; border-bottom: 1px solid rgba(0,255,255,0.1); cursor: pointer; transition: 0.3s; color: white; display:flex; align-items:center; gap:8px;" 
                        onmouseover="this.style.background='rgba(0,242,254,0.2)'" onmouseout="this.style.background='transparent'"
                        onclick="jumpToSubject('${m.course}', '${m.branch}', '${m.semNum}', '${m.name}')">
                        <span>${m.icon}</span> <div><div style="font-size:13px; font-weight:bold; color: #38ef7d;">${m.name}</div><div style="font-size:10px; color:#aaa;">${m.course} > ${m.branch} > Sem ${m.semNum}</div></div>
                     </div>`;
          }
        });
        resBox.innerHTML = html;
      }
      resBox.style.display = 'block';
    }

    // Direct Navigation Helpers from Search
    function jumpToSubject(course, branch, semNum, subName) {
      document.getElementById('globalSearchInput').value = '';
      document.getElementById('searchResultsModal').style.display = 'none';

      // Re-hydrate the native state to let UI handle the jump
      studentNavState.course = course;
      studentNavState.branch = branch;
      studentNavState.sem = semNum;

      // Navigate to the semester view where subjects are listed
      openStudentLevel('semester', semNum);

      // Auto-trigger the subject selection
      setTimeout(() => {
        openStudentLevel('subject', subName);
        window.scrollTo(0, 0);
      }, 50);
    }

    function jumpToChapter(course, branch, semNum, subName, chapterName) {
      document.getElementById('globalSearchInput').value = '';
      document.getElementById('searchResultsModal').style.display = 'none';

      studentNavState.course = course;
      studentNavState.branch = branch;
      studentNavState.sem = semNum;
      studentNavState.subject = subName;

      // Open the Subject to see Chapter lists natively
      openStudentLevel('semester', semNum);
      setTimeout(() => {
        openStudentLevel('subject', subName);
        // Delay to allow UI mount, then hit actual chapter 
        setTimeout(() => {
          if (chapterName) {
            openStudentChapter(chapterName);
          }
        }, 50);
      }, 50);
    }

    // Hide Search on Outside Click
    document.addEventListener("click", function (evt) {
      let searchBox = document.getElementById("searchResultsModal");
      let searchInput = document.getElementById("globalSearchInput");
      if (searchBox && searchInput && !searchBox.contains(evt.target) && evt.target !== searchInput) {
        searchBox.style.display = "none";
      }
    });

  </script>

  <footer id="mainFooter" style="display:none;">
    <div class="footer-text">¬© 2026 <span class="footer-brand">NextGen Digital Library</span> | Designed & Developed by
      <span style="color: white; font-weight: bold;">Aditya Kumar</span>
    </div>
    <div class="social-links">
      <a href="https://www.linkedin.com/in/aditya-kumar-878b3b289" target="_blank" class="social-btn" title="LinkedIn">
        <svg viewBox="0 0 24 24">
          <path
            d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
        </svg>
      </a>
      <a href="https://www.instagram.com/mr_insaan_kumar?igsh=MTh1MDVoOGpnZ2lneg==" target="_blank" class="social-btn"
        title="Instagram">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849s-.011 3.585-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.849-.07c-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849s.012-3.584.07-4.849c.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.667.072 4.947c.2 4.337 2.615 6.76 6.98 6.98 1.281.058 1.689.072 4.948.072s3.667-.014 4.947-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.2-4.337-2.617-6.761-6.98-6.98-1.28-.058-1.689-.072-4.948-.072zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
        </svg>
      </a>
    </div>
  </footer>
</body>

</html>
