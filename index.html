<!DOCTYPE html>
<html lang="en">

<head>
  <title>NextGen Digital Library | Web Development Project by Aditya Kumar</title>
  <meta name="description"
    content="NextGen Digital Library - A modern web platform for digital resources. Created by Aditya Kumar, Web Developer.">
  <meta name="keywords" content="NextGen, Digital Library, Aditya Kumar, Web Developer, NIELIT, Project">
  <meta name="author" content="Aditya Kumar">

  <meta property="og:type" content="website">
  <meta property="og:url" content="https://adityakumar12xyz.github.io/NextGen/">
  <meta property="og:title" content="NextGen Digital Library - Aditya Kumar">
  <meta property="og:description"
    content="Explore the NextGen Digital Library, a web development project showcasing digital resource management.">
  <meta name="google-site-verification" content="9uLHaP53sHpPBy6U9jzpeNOmJIbCl11ZRMo8hN7dyaw" />

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="icon" type="image/png" href="favicon1.png">

  <!-- Cropper.js CSS for circular photo cropping -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
  <!-- Google Fonts: Outfit for Premium Branding -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;900&display=swap" rel="stylesheet">
  <!-- html2canvas for card sharing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    /* Add external dependencies here */
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      /* Animated Gradient Background */
      background: linear-gradient(-45deg, #0f2027, #203a43, #2c5364, #0b132b, #1c2541);
      background-size: 400% 400%;
      animation: gradientBG 15s ease infinite;
      color: white;
      transition: 0.4s;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* Interactive VFX Canvas */
    #vfx-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      pointer-events: none;
      opacity: 0.6;
    }

    /* Background Animation Keyframes */
    @keyframes gradientBG {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    /* HEADER */
    #globalTicker {
      background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
      color: #000;
      padding: 10px 0;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-size: 13px;
      display: none;
      border-bottom: 2px solid rgba(0, 242, 254, 0.5);
      position: relative;
      overflow: hidden;
      white-space: nowrap;
      z-index: 1001;
      box-shadow: 0 5px 15px rgba(0, 242, 254, 0.3);
    }

    .ticker-content {
      display: inline-block;
      padding-left: 100%;
      animation: tickerMove 25s linear infinite;
    }

    @keyframes tickerMove {
      0% {
        transform: translateX(0);
      }

      100% {
        transform: translateX(-100%);
      }
    }

    .neural-subtitle {
      font-size: 22px !important;
      color: #00f2fe !important;
      letter-spacing: 3px !important;
      font-weight: 300 !important;
      margin-bottom: 35px !important;
      text-transform: uppercase;
      text-shadow: 0 0 10px rgba(0, 242, 254, 0.8);
      position: relative;
      display: inline-block;
    }

    .neural-subtitle::after {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 50px;
      height: 2px;
      background: #00f2fe;
      box-shadow: 0 0 10px #00f2fe;
    }

    header {
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #000000cc;
      flex-wrap: wrap;
    }

    @media (max-width: 480px) {
      header {
        padding: 10px;
        flex-direction: row;
        justify-content: space-between;
        gap: 10px;
      }

      header h2 {
        margin: 0;
        font-size: 20px;
      }
    }

    /* SEARCH */
    input {
      padding: 8px;
      border: none;
      border-radius: 5px;
    }

    /* LOGIN SCREEN */
    #loginScreen {
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      /* Transparent background to show body animated gradient */
      background: transparent;
      backdrop-filter: blur(5px);
      position: fixed;
      width: 100%;
      top: 0;
      left: 0;
      z-index: 999;
    }

    .light #loginScreen {
      background: rgba(240, 244, 248, 0.8);
    }

    .login-box {
      /* Advanced Glassmorphism */
      background: rgba(15, 32, 39, 0.45);
      border: 1px solid rgba(0, 255, 255, 0.2);
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), inset 0 0 15px rgba(0, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      width: 95%;
      max-width: 420px;
      margin: 10px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .login-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 45px rgba(0, 255, 255, 0.3);
    }

    /* BATTLE ARENA STYLES */
    .battle-card {
      background: rgba(11, 19, 43, 0.8);
      border: 1px solid #ff4757;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .battle-card:hover {
      box-shadow: 0 0 20px rgba(255, 71, 87, 0.4);
      transform: scale(1.02);
    }

    .battle-card.active {
      border-color: #00f2fe;
      box-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
    }

    .battle-card h3 {
      margin: 0 0 10px 0;
      color: #fff;
    }

    .battle-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 10px;
      border-radius: 5px;
      font-size: 10px;
      font-weight: bold;
      color: #fff;
      z-index: 1;
    }

    .join-battle-btn {
      background: #2ecc71;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 800;
      cursor: pointer;
      width: 100%;
      margin-top: 15px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
    }

    .join-battle-btn:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(46, 204, 113, 0.5);
    }

    .wallet-status {
      background: linear-gradient(135deg, #1c2541, #0b132b);
      border: 1px solid rgba(0, 242, 254, 0.3);
      padding: 15px 25px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
    }

    .wallet-balance {
      font-size: 24px;
      font-weight: 900;
      color: gold;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .light .login-box {
      background: rgba(255, 255, 255, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }

    .login-box h2 {
      margin-bottom: 25px;
      color: cyan;
      font-size: 28px;
      text-shadow: 0 0 10px cyan;
    }

    .light .login-box h2 {
      color: #0056b3;
      text-shadow: none;
    }

    .login-input {
      width: 100%;
      padding: 14px;
      margin-bottom: 20px;
      border-radius: 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 255, 0.3);
      color: white;
      font-size: 16px;
      outline: none;
      box-sizing: border-box;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }

    .light .login-input {
      background: rgba(255, 255, 255, 0.7);
      color: #333;
      border: 1px solid rgba(0, 86, 179, 0.3);
    }

    .login-input:focus {
      box-shadow: 0 0 10px cyan;
    }

    .light .login-input:focus {
      box-shadow: 0 0 10px #0056b3;
      border-color: #0056b3;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      margin-top: 10px;
      font-size: 18px;
      background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
      color: white;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .light .login-btn {
      background: linear-gradient(90deg, #0056b3 0%, #007bff 100%);
      color: white;
      box-shadow: 0 4px 10px rgba(0, 86, 179, 0.3);
    }

    .login-btn:hover {
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 8px 25px rgba(79, 172, 254, 0.6);
      transform: translateY(-3px) scale(1.02);
    }

    .light .login-btn:hover {
      background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
      box-shadow: 0 6px 15px rgba(0, 86, 179, 0.4);
      transform: translateY(-2px);
    }

    .auth-toggle {
      margin-top: 15px;
      font-size: 14px;
      color: #ddd;
    }

    .light .auth-toggle {
      color: #666;
    }

    .auth-toggle span {
      color: cyan;
      cursor: pointer;
      text-decoration: underline;
      font-weight: bold;
    }

    .light .auth-toggle span {
      color: #0056b3;
    }

    .admin-link {
      margin-top: 15px;
      font-size: 13px;
      color: #888;
      text-align: right;
      cursor: pointer;
      transition: 0.3s;
    }

    .admin-link:hover {
      color: cyan;
    }

    /* ADMIN DASHBOARD */
    #adminDashboard {
      display: none;
      padding: 40px;
      max-width: 1200px;
      margin: 40px auto;
      background: rgba(15, 32, 39, 0.85);
      border: 1px solid rgba(0, 242, 254, 0.3);
      border-radius: 20px;
      color: white;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6), inset 0 0 20px rgba(0, 242, 254, 0.05);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }

    .light #adminDashboard {
      background: rgba(255, 255, 255, 0.9);
      border-color: rgba(0, 86, 179, 0.3);
      color: #333;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
    }

    .admin-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 25px;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .admin-table th,
    .admin-table td {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      padding: 16px;
      text-align: left;
      background: rgba(0, 0, 0, 0.2);
    }

    .admin-table tr:last-child td {
      border-bottom: none;
    }

    .admin-table tr:hover td {
      background: rgba(0, 242, 254, 0.05);
    }

    .light .admin-table th,
    .light .admin-table td {
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.5);
    }

    .admin-table th {
      background: linear-gradient(90deg, #0f2027 0%, #203a43 100%);
      color: #00f2fe;
      font-size: 16px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-weight: 700;
    }

    .light .admin-table th {
      background: #f0f4f8;
      color: #0056b3;
    }

    /* CMS DYNAMIC FIELDS */
    .cms-dynamic-field {
      display: flex;
      gap: 15px;
      margin-top: 10px;
      margin-bottom: 10px;
      align-items: center;
    }

    .cms-add-btn {
      background: linear-gradient(90deg, #00cec9 0%, #81ecec 100%);
      color: #2d3436;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      margin-top: 5px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0, 206, 201, 0.3);
    }

    .cms-add-btn:hover {
      box-shadow: 0 6px 15px rgba(0, 206, 201, 0.5);
      transform: translateY(-2px);
    }

    .cms-del-btn {
      background: linear-gradient(90deg, #ff4757 0%, #ff6b81 100%);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(255, 71, 87, 0.3);
      font-weight: 600;
    }

    .cms-del-btn:hover {
      box-shadow: 0 6px 15px rgba(255, 71, 87, 0.5);
      transform: translateY(-2px);
    }

    /* SELECT DROPDOWN FOR SIGN UP */
    select.login-input {
      appearance: none;
      -webkit-appearance: none;
      background-image: url('data:image/svg+xml;utf8,<svg fill="cyan" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
      background-repeat: no-repeat;
      background-position-x: 95%;
      background-position-y: 50%;
    }

    .light select.login-input {
      background-image: url('data:image/svg+xml;utf8,<svg fill="%230056b3" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
    }

    select.login-input option {
      background: #001f3f;
      color: white;
    }

    .light select.login-input option {
      background: white;
      color: black;
    }

    /* WELCOME */
    #welcomeScreen {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      position: fixed;
      width: 100%;
      height: 100vh;
      top: 0;
      left: 0;
      background: transparent;
      backdrop-filter: blur(10px);
      z-index: 998;
    }

    #typingText {
      font-size: 48px;
      font-weight: 800;
      background: linear-gradient(90deg, #00f2fe, #4facfe, #00f2fe);
      background-size: 200% auto;
      color: transparent;
      -webkit-background-clip: text;
      background-clip: text;
      animation: shine 3s linear infinite;
      margin-bottom: 10px;
      text-shadow: 0 0 30px rgba(0, 242, 254, 0.3);
    }

    @keyframes shine {
      to {
        background-position: 200% center;
      }
    }

    /* PREMIUM BRANDING */
    @keyframes brandShimmer {
      0% {
        background-position: 0% 50%;
      }

      100% {
        background-position: 200% 50%;
      }
    }

    .premium-brand {
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(90deg, #00f2fe, #4facfe, #706fd3, #00f2fe);
      background-size: 200% auto;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      animation: brandShimmer 5s linear infinite;
      text-shadow: 0 0 15px rgba(0, 242, 254, 0.4);
      font-weight: 900;
      letter-spacing: 1.5px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform 0.3s ease;
    }

    .premium-brand:hover {
      transform: scale(1.02);
      text-shadow: 0 0 25px rgba(0, 242, 254, 0.7);
    }

    .brand-emoji {
      filter: drop-shadow(0 0 8px cyan);
      animation: floatEmoji 3s ease-in-out infinite;
    }

    @keyframes floatEmoji {

      0%,
      100% {
        transform: translateY(0) rotate(0);
      }

      50% {
        transform: translateY(-5px) rotate(10deg);
      }
    }

    @media (max-width: 768px) {
      #typingText {
        font-size: 32px;
      }
    }

    @media (max-width: 480px) {
      #typingText {
        font-size: 24px;
      }
    }

    /* SUBJECTS */
    .subjects {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .subjects {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        padding: 15px;
      }
    }

    @media (max-width: 480px) {
      .subjects {
        grid-template-columns: 1fr;
        gap: 10px;
        padding: 10px;
      }
    }

    .box {
      /* Deep space glassmorphic */
      background: rgba(15, 32, 39, 0.6);
      padding: 30px;
      border-radius: 20px;
      cursor: pointer;
      border: 1px solid rgba(0, 242, 254, 0.2);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), inset 0 0 10px rgba(0, 242, 254, 0.05);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 15px;
      position: relative;
      overflow: hidden;
      /* 3D TILT FOUNDATION */
      transform-style: preserve-3d;
      perspective: 1000px;
    }

    /* Glow effect on hover */
    .box::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      border-radius: 20px;
      box-shadow: 0 0 20px rgba(0, 242, 254, 0.4);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: -1;
    }

    .box h1 {
      margin: 0;
      font-size: 48px;
      filter: drop-shadow(0 0 15px rgba(0, 242, 254, 0.6));
      transition: transform 0.3s ease;
    }

    @media (max-width: 768px) {
      .box {
        padding: 20px;
        font-size: 16px;
      }
    }

    @media (max-width: 480px) {
      .box {
        padding: 15px;
        font-size: 14px;
      }
    }

    .box:hover {
      transform: translateY(-10px) scale(1.02);
      border-color: rgba(0, 242, 254, 0.6);
    }

    .box:hover::after {
      opacity: 1;
    }

    .box:hover h1 {
      transform: scale(1.1);
    }

    /* CHAPTERS */
    .chapters,
    .content {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    li {
      padding: 10px;
      margin: 8px 0;
      background: #ffffff22;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* Admin Delete Subject Button inside li */
    .delete-subject-btn {
      background: #ff4757;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }

    /* CONTENT */
    .section {
      background: rgba(15, 32, 39, 0.6);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      border: 1px solid rgba(0, 242, 254, 0.2);
      backdrop-filter: blur(10px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 242, 254, 0.15);
      border-color: rgba(0, 242, 254, 0.4);
    }

    /* PROGRESS TRACKING STYLES */
    .progress-box {
      background: rgba(15, 32, 39, 0.7);
      padding: 30px;
      border-radius: 20px;
      border: 1px solid rgba(46, 204, 113, 0.4);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4), inset 0 0 20px rgba(46, 204, 113, 0.05);
      backdrop-filter: blur(15px);
      transition: transform 0.3s ease;
    }

    .progress-box:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5), 0 0 15px rgba(46, 204, 113, 0.2);
    }

    .subj-progress {
      margin-bottom: 25px;
    }

    .subj-progress-title {
      display: flex;
      justify-content: space-between;
      color: #00f2fe;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #00f2fe, #4facfe, #00f2fe);
      background-size: 200% auto;
      border-radius: 10px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      animation: shine 3s linear infinite;
    }

    .progress-details {
      font-size: 13px;
      color: #ccc;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .progress-details span {
      background: rgba(0, 0, 0, 0.3);
      padding: 3px 8px;
      border-radius: 4px;
    }



    /* BUTTON */
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: linear-gradient(90deg, #00f2fe 0%, #4facfe 100%);
      color: white;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 242, 254, 0.3);
    }

    button:hover {
      background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 242, 254, 0.5);
    }

    @media (max-width: 480px) {
      button {
        padding: 10px 15px;
        font-size: 14px;
      }
    }

    /* SEMESTER VIEW WITH MOTIVATION */
    #semesters {
      display: grid !important;
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 20px;
      align-items: start;
    }

    #semesterContainer {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }



    /* DARK AND LIGHT MODE */
    .light {
      background: #f0f4f8;
      /* Soft light background */
      color: #333;
    }

    .light header {
      background: #ffffff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .light header h2 {
      text-shadow: none;
      color: #0056b3;
    }

    .light .box,
    .light .info-box,
    .light .motivation-box,
    .light .tasks-box {
      background: #ffffff;
      border-color: #d1d5db;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      color: #333;
    }

    .light .box h1 {
      filter: invert(0.8) hue-rotate(180deg) drop-shadow(0 0 5px rgba(0, 0, 0, 0.2));
    }

    .light .box:hover,
    .light .info-box:hover {
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
      border-color: #0056b3;
    }

    .light .motivation-box h3,
    .light .progress-box h3,
    .light .info-box h3 {
      color: #0056b3;
      border-bottom-color: #0056b3;
    }

    .light .motivation-box p {
      color: #444;
      text-shadow: none;
    }

    .light .progress-box {
      border-color: #0056b3;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      background: white;
    }

    .light .subj-progress-title {
      color: #0056b3;
    }

    .light .progress-bar {
      background: #e5e7eb;
    }

    .light .progress-details span {
      background: #f0f4f8;
      color: #0056b3;
      border: 1px solid #d1d5db;
    }


    .light h2,
    .light #subjectTitle,
    .light #chapterTitle {
      color: #222;
    }

    .light .section {
      background: #ffffff;
      color: #333;
      border: 1px solid #e5e7eb;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* ABOUT & TERMS SECTION */
    .info-section {
      display: block;
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .info-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 30px;
    }

    .info-box {
      background: rgba(15, 32, 39, 0.6);
      border: 1px solid rgba(0, 242, 254, 0.3);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
      transition: all 0.4s ease;
    }

    .info-box:hover {
      box-shadow: 0 15px 40px rgba(0, 242, 254, 0.15);
      transform: translateY(-8px);
      border-color: rgba(0, 242, 254, 0.6);
    }

    .info-box h3 {
      color: #00f2fe;
      font-size: 26px;
      margin-top: 0;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(0, 242, 254, 0.3);
      padding-bottom: 12px;
      text-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
    }

    .info-box p {
      font-size: 14px;
      line-height: 1.8;
      color: #ddd;
    }

    .info-box ul {
      list-style: none;
      padding: 0;
      margin: 10px 0;
    }

    .info-box li {
      padding: 8px 0;
      padding-left: 20px;
      position: relative;
      font-size: 13px;
      color: #ccc;
    }

    .info-box li:before {
      content: "â–¸";
      position: absolute;
      left: 0;
      color: cyan;
      font-weight: bold;
    }

    @media (max-width: 768px) {
      .info-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }

      .info-box {
        padding: 20px;
      }

      .info-box h3 {
        font-size: 20px;
      }
    }

    /* SEMESTER MOTIVATION & TASKS */
    .semester-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      padding: 20px;
      max-width: 1200px;
      margin: 20px auto;
    }

    .motivation-box,
    .tasks-box {
      background: rgba(15, 32, 39, 0.6);
      border: 1px solid rgba(0, 242, 254, 0.3);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(15px);
      transition: transform 0.3s ease;
    }

    .motivation-box:hover,
    .tasks-box:hover {
      transform: translateY(-5px);
    }

    .motivation-box h3,
    .tasks-box h3 {
      color: cyan;
      font-size: 20px;
      margin-top: 0;
      margin-bottom: 15px;
      text-align: center;
    }

    .motivation-box p {
      font-size: 18px;
      line-height: 1.6;
      color: #fff;
      font-style: italic;
      text-shadow: 0 0 10px rgba(0, 255, 255, 0.4);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .task-list li {
      display: flex;
      align-items: center;
      padding: 12px;
      margin: 8px 0;
      background: #ffffff11;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.3s;
    }

    .task-list li:hover {
      background: #ffffff22;
      transform: translateX(5px);
    }

    .task-list input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      cursor: pointer;
      accent-color: cyan;
    }

    .task-list li.completed {
      opacity: 0.6;
      text-decoration: line-through;
    }

    .task-list li.completed input[type="checkbox"] {
      accent-color: #00ff00;
    }

    /* PREMIUM NOTES & BOOK */
    .premium-box {
      background: rgba(30, 25, 10, 0.7);
      border: 1px solid rgba(255, 215, 0, 0.5);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4), inset 0 0 20px rgba(255, 215, 0, 0.05);
    }

    .premium-box::after {
      box-shadow: 0 0 25px rgba(255, 215, 0, 0.5);
    }

    .premium-box:hover {
      border-color: rgba(255, 215, 0, 0.8);
    }

    .premium-box h1 {
      filter: drop-shadow(0 0 15px gold) contrast(1.2) brightness(1.2);
    }

    .locked-option {
      position: relative;
    }

    .locked-option::after {
      content: 'ðŸ”’';
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      filter: drop-shadow(0 0 5px gold);
    }

    .light .premium-box {
      background: #fff8e1;
      border-color: #ffc107;
      color: #333;
      box-shadow: 0 4px 6px rgba(255, 193, 7, 0.3);
    }

    .light .premium-box:hover {
      box-shadow: 0 10px 15px rgba(255, 193, 7, 0.5);
    }

    .light .locked-option::after {
      filter: none;
    }

    /* PAYMENT MODAL */
    #paymentModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.3s ease-in-out;
    }

    .payment-box {
      background: rgba(10, 20, 30, 0.95);
      border: 2px solid gold;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
      max-width: 400px;
      width: 90%;
      max-height: 90vh;
      /* Set maximum height relative to viewport */
      overflow-y: auto;
      /* Enable vertical scrolling */
      position: relative;
    }

    .light .payment-box {
      background: white;
      border-color: #ffc107;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
    }

    .payment-box h2 {
      color: gold;
      margin-top: 0;
    }

    .light .payment-box h2 {
      color: #ff9800;
    }

    .payment-amount {
      font-size: 32px;
      font-weight: bold;
      color: white;
      margin: 15px 0;
    }

    .light .payment-amount {
      color: #333;
    }

    .qr-container img {
      width: 200px;
      height: 200px;
      border-radius: 10px;
      border: 2px solid cyan;
      margin-bottom: 10px;
    }

    .upi-id {
      font-size: 16px;
      color: cyan;
      margin-bottom: 20px;
      letter-spacing: 1px;
    }

    .light .upi-id {
      color: #0056b3;
    }

    .pay-btn-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .pay-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      transition: 0.3s;
    }

    .gpay-btn {
      background: #ea4335;
      color: white;
    }

    .phonepe-btn {
      background: #5f259f;
      color: white;
    }

    /* CERTIFICATE STORE STYLES */
    #certificateStoreScreen {
      padding: 40px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .cert-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 30px;
      margin-top: 30px;
    }

    .cert-card {
      background: rgba(15, 32, 39, 0.7);
      border: 1px solid rgba(0, 242, 254, 0.3);
      border-radius: 20px;
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      position: relative;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .cert-card:hover {
      transform: translateY(-10px);
      border-color: cyan;
      box-shadow: 0 15px 40px rgba(0, 242, 254, 0.2);
    }

    .cert-image {
      width: 100%;
      height: 180px;
      object-fit: cover;
      border-bottom: 1px solid rgba(0, 242, 254, 0.2);
    }

    .cert-info {
      padding: 20px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .cert-title {
      font-size: 20px;
      font-weight: 800;
      color: white;
      text-shadow: 0 0 10px rgba(0, 242, 254, 0.3);
    }

    .cert-price {
      display: flex;
      align-items: center;
      gap: 8px;
      color: gold;
      font-weight: bold;
      font-size: 18px;
    }

    .cert-actions {
      margin-top: auto;
      padding-top: 15px;
    }

    .cert-unlock-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(90deg, #00f2fe, #4facfe);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .cert-unlock-btn:hover {
      box-shadow: 0 0 20px rgba(0, 242, 254, 0.5);
      transform: scale(1.02);
    }

    .cert-unlocked-btn {
      background: linear-gradient(90deg, #00b09b, #96c93d);
    }

    .cert-locked-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(3px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 5;
      pointer-events: none;
      opacity: 0;
      transition: 0.3s;
    }

    .cert-card.is-locked .cert-locked-overlay {
      opacity: 1;
    }

    /* ADMIN CERTIFICATE SECTION */
    .cert-admin-form {
      background: rgba(255, 255, 255, 0.05);
      padding: 25px;
      border-radius: 15px;
      border: 1px solid rgba(0, 242, 254, 0.2);
      margin-bottom: 30px;
    }

    .cert-admin-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }

    .cert-admin-card {
      background: rgba(0, 0, 0, 0.3);
      padding: 15px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cert-admin-info h4 {
      margin: 0;
      color: cyan;
    }

    .cert-admin-info p {
      margin: 5px 0 0;
      font-size: 12px;
      color: #aaa;
    }

    .confirm-pay-btn {
      background: gold;
      color: black;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
    }

    .confirm-pay-btn:hover {
      background: #ffcc00;
      box-shadow: 0 0 25px gold;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      background: transparent;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
    }

    .light .close-modal {
      color: black;
    }

    /* CONFETTI ANIMATION */
    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background: gold;
      animation: fall linear forwards;
    }

    @keyframes fall {
      to {
        transform: translateY(100vh) rotate(720deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* MODAL SYSTEM (REFINED) */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 20000;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-content {
      background: rgba(15, 32, 39, 0.95);
      border: 1px solid rgba(0, 242, 254, 0.3);
      padding: 30px;
      border-radius: 20px;
      width: 90%;
      max-width: 500px;
      position: relative;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), inset 0 0 20px rgba(0, 242, 254, 0.1);
    }

    /* BANNER SLIDER */
    .slider-main {
      width: 100%;
      max-width: 1472px;
      margin: 0 auto 20px auto;
      position: relative;
      overflow: hidden;
      border-radius: 15px;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }

    .slider-wrapper {
      display: flex;
      transition: transform 0.5s ease-in-out;
      width: 100%;
    }

    .slider-slide {
      min-width: 100%;
      position: relative;
      cursor: pointer;
    }

    .slider-slide img {
      width: 100%;
      aspect-ratio: 92/45;
      max-width: 1472px;
      max-height: 720px;
      object-fit: cover;
      display: block;
      margin: 0 auto;
    }

    @media (max-width: 768px) {
      .slider-slide img {
        height: auto;
      }
    }

    @media (max-width: 480px) {
      .slider-slide img {
        height: auto;
      }
    }

    .slider-nav {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
    }

    .slider-dot {
      width: 12px;
      height: 12px;
      background: rgba(255, 255, 255, 0.5);
      border-radius: 50%;
      cursor: pointer;
      transition: 0.3s;
    }

    .slider-dot.active {
      background: cyan;
      box-shadow: 0 0 10px cyan;
    }

    /* PREMIUM FOOTER */
    footer {
      padding: 40px 20px;
      margin-top: auto;
      background: rgba(15, 32, 39, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(0, 242, 254, 0.2);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      position: relative;
      z-index: 10;
      width: 100%;
      box-sizing: border-box;
    }

    .social-links {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 25px;
      margin-top: 5px;
      width: 100%;
    }

    .social-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 242, 254, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    .social-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(0, 242, 254, 0.2), transparent);
      transform: translateX(-100%);
      transition: 0.5s;
    }

    .social-btn:hover::before {
      transform: translateX(100%);
    }

    .social-btn:hover {
      transform: translateY(-8px) scale(1.1);
      border-color: cyan;
      box-shadow: 0 0 25px rgba(0, 242, 254, 0.5), inset 0 0 10px rgba(0, 242, 254, 0.2);
      background: rgba(0, 242, 254, 0.1);
    }

    .social-btn svg {
      width: 24px;
      height: 24px;
      fill: #aaa;
      transition: all 0.3s ease;
    }

    .social-btn:hover svg {
      fill: cyan;
      filter: drop-shadow(0 0 5px cyan);
    }

    .social-btn i {
      font-size: 22px;
      color: #aaa;
      transition: all 0.3s ease;
      z-index: 2;
    }

    .social-btn:hover i {
      color: cyan;
      text-shadow: 0 0 8px cyan;
    }

    .footer-text {
      font-family: 'Outfit', sans-serif;
      font-size: 15px;
      color: #888;
      letter-spacing: 1px;
      text-align: center;
      width: 100%;
    }

    .footer-brand {
      font-weight: bold;
      color: cyan;
      text-shadow: 0 0 10px rgba(0, 242, 254, 0.3);
    }

    /* NEURAL HUD OVERLAY */
    #neuralHUD {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 900;
      pointer-events: none;
      display: none;
      flex-direction: column;
      gap: 10px;
      font-family: 'Outfit', sans-serif;
    }

    .hud-panel {
      background: rgba(15, 32, 39, 0.6);
      border: 1px solid rgba(0, 242, 254, 0.4);
      padding: 12px 20px;
      border-radius: 12px;
      backdrop-filter: blur(15px);
      box-shadow: 0 0 20px rgba(0, 242, 254, 0.1), inset 0 0 10px rgba(0, 242, 254, 0.1);
      display: flex;
      flex-direction: column;
      animation: hudSlide 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes hudSlide {
      from {
        transform: translateX(100%) skewX(-10deg);
        opacity: 0;
      }

      to {
        transform: translateX(0) skewX(0);
        opacity: 1;
      }
    }

    .hud-label {
      font-size: 10px;
      text-transform: uppercase;
      color: #00f2fe;
      letter-spacing: 1px;
      font-weight: 700;
      margin-bottom: 2px;
    }

    .hud-value {
      font-size: 18px;
      color: white;
      font-weight: 800;
      text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
    }

    /* FACE-SCAN AUTH SIMULATION */
    #faceScanOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 20, 20, 0.9);
      display: none;
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(10px);
    }

    .scan-line {
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, transparent, #00f2fe, transparent);
      box-shadow: 0 0 30px #00f2fe, 0 0 60px #00f2fe;
      position: absolute;
      top: 0;
      z-index: 2;
      animation: scanAnim 2s ease-in-out infinite;
    }

    @keyframes scanAnim {
      0% {
        top: 0%;
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        top: 100%;
        opacity: 0;
      }
    }

    .scan-mask {
      width: 320px;
      height: 320px;
      border: 3px solid rgba(0, 242, 254, 0.4);
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle, rgba(0, 242, 254, 0.15) 0%, transparent 80%);
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 0 50px rgba(0, 242, 254, 0.2), inset 0 0 30px rgba(0, 242, 254, 0.2);
    }

    .scan-asset {
      width: 200px;
      height: 200px;
      filter: drop-shadow(0 0 15px rgba(0, 242, 254, 0.8));
      animation: assetFloat 3s ease-in-out infinite alternate;
      z-index: 1;
    }

    @keyframes assetFloat {
      from {
        transform: scale(1) translateY(0);
        opacity: 0.8;
      }

      to {
        transform: scale(1.05) translateY(-5px);
        opacity: 1;
      }
    }

    .recognition-box {
      position: absolute;
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
      border: 1px solid rgba(0, 242, 254, 0.6);
      padding: 8px 15px;
      font-family: 'Outfit';
      font-size: 14px;
      color: #00f2fe;
      text-transform: uppercase;
      letter-spacing: 3px;
      background: rgba(0, 20, 20, 0.6);
      backdrop-filter: blur(5px);
      box-shadow: 0 0 20px rgba(0, 242, 254, 0.4);
      animation: pulseRecognize 1.5s infinite alternate;
      z-index: 3;
      white-space: nowrap;
    }

    @keyframes pulseRecognize {
      from {
        opacity: 0.4;
        transform: scale(0.95);
      }

      to {
        opacity: 1;
        transform: scale(1.05);
      }
    }

    .scan-mask::after {
      content: 'RECOGNIZING...';
      position: absolute;
      bottom: 20px;
      width: 100%;
      text-align: center;
      color: #00f2fe;
      font-family: 'Outfit', sans-serif;
      font-weight: 900;
      letter-spacing: 5px;
      text-shadow: 0 0 10px #00f2fe;
      animation: blink 0.5s infinite;
    }

    @keyframes blink {
      50% {
        opacity: 0.3;
      }
    }

    /* 3D FLIP-BOOK VIEWER */
    .book-opening {
      animation: bookFlip 1.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      transform-origin: left center;
      perspective: 2000px;
    }

    @keyframes bookFlip {
      from {
        transform: rotateY(-90deg);
        opacity: 0;
      }

      to {
        transform: rotateY(0deg);
        opacity: 1;
      }
    }
  </style>
</head>

<body>
  <canvas id="vfx-canvas"></canvas>
  <div id="faceScanOverlay">
    <div class="scan-line"></div>
    <div class="scan-mask">
      <img src="face-recognition.png" alt="Face" class="scan-asset">
      <div class="recognition-box">Biometric Scan Active</div>
    </div>
    <h3 style="color: white; margin-top: 40px; font-family: 'Outfit'; letter-spacing: 2px; margin-bottom: 5px;">NEURAL
      INTERFACE: ACTIVATED</h3>
    <p style="color: #00f2fe; font-size: 14px; letter-spacing: 1px; opacity: 0.8; font-family: 'Outfit';">Neural
      Recognition in Progress...</p>
  </div>

  <div id="neuralHUD">
    <div class="hud-panel">
      <span class="hud-label">User Rank</span>
      <span id="hudRank" class="hud-value">--</span>
    </div>
    <div class="hud-panel">
      <span class="hud-label">Knowledge Points</span>
      <span id="hudPoints" class="hud-value">--</span>
    </div>
  </div>

  <!-- CERTIFICATE STORE SCREEN -->
  <div id="certificateStoreScreen"
    style="display: none; flex-direction: column; padding: 20px; max-width: 1200px; margin: 0 auto; min-height: 80vh;">
    <!-- Back Button -->
    <div style="margin-bottom: 20px;">
      <button onclick="showPage('programsWrapper')" class="login-btn"
        style="width: auto; padding: 10px 25px; background: rgba(255,255,255,0.1); color: cyan; border: 1px solid cyan;">â¬…
        BACK TO DASHBOARD</button>
    </div>

    <div style="text-align: center; margin-bottom: 40px;">
      <h1 class="premium-brand" style="font-size: 36px;">ðŸ“œ PREMIUM <span style="color: cyan;">CERTIFICATIONS</span>
      </h1>
      <p style="color: #aaa; letter-spacing: 2px; font-weight: 700; font-size: 12px;">UNLOCK YOUR CAREER WITH NEURAL
        CREDENTIALS</p>
    </div>

    <div class="wallet-status" style="justify-content: center; margin-bottom: 40px; background: rgba(0,242,254,0.05);">
      <div style="text-align: center;">
        <small style="color: #888; text-transform: uppercase; letter-spacing: 1px;">Neural Wallet Balance</small>
        <div class="wallet-balance" id="certStoreBalance">ðŸª™ 0</div>
      </div>
    </div>

    <div id="certificateGrid"
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
      <!-- Certificates injected here -->
    </div>

    <!-- Link to My Collection -->
    <div style="text-align: center; margin-top: 40px;">
      <button onclick="openMyCollection()" class="login-btn"
        style="width: auto; padding: 12px 30px; background: rgba(0,242,254,0.1); color: #00f2fe; border: 1px solid #00f2fe; font-size: 14px;">ðŸ“‚
        VIEW MY PERSONAL COLLECTION</button>
    </div>
  </div>

  <!-- MY COLLECTION SCREEN -->
  <div id="myCollectionScreen"
    style="display: none; flex-direction: column; padding: 20px; max-width: 1200px; margin: 0 auto; min-height: 80vh;">
    <!-- Back Button -->
    <div style="margin-bottom: 20px;">
      <button onclick="showPage('programsWrapper')" class="login-btn"
        style="width: auto; padding: 10px 25px; background: rgba(255,255,255,0.1); color: #00f2fe; border: 1px solid #00f2fe;">â¬…
        BACK TO DASHBOARD</button>
    </div>

    <div style="text-align: center; margin-bottom: 40px;">
      <h1 class="premium-brand" style="font-size: 36px;">ðŸ“‚ MY <span style="color: #00f2fe;">COLLECTION</span></h1>
      <p style="color: #aaa; letter-spacing: 2px; font-weight: 700; font-size: 12px;">YOUR PRIVATE VAULT FOR
        CERTIFICATES & DOCUMENTS</p>
      <button onclick="openCertificateStore()" class="login-btn"
        style="width: auto; margin-top: 15px; background: rgba(255,255,255,0.05); color: cyan; border: 1px solid cyan; font-size: 12px;">ðŸ“œ
        GO TO CERTIFICATE STORE</button>
    </div>

    <div class="box"
      style="margin-bottom: 30px; padding: 30px; text-align: center; border: 2px dashed #00f2fe; background: rgba(0,242,254,0.05);">
      <h3 style="color: #fff; margin-top: 0;">âž• Add New Document</h3>
      <p style="color: #888; font-size: 13px;">Upload your Certificates, Marksheets, or IDs (Images & PDFs supported)
      </p>

      <div
        style="display: flex; flex-direction: column; align-items: center; gap: 15px; max-width: 400px; margin: 20px auto;">
        <input type="text" id="myCollFileName" class="login-input" placeholder="Document Name (e.g. 10th Marksheet)">
        <input type="file" id="myCollFileUpload" class="login-input" accept="image/*,application/pdf"
          style="padding: 10px;">
        <button onclick="uploadToMyCollection()" class="login-btn"
          style="background: #00f2fe; color: black; font-weight: 900; width: 100%;">ðŸš€ UPLOAD & SAVE</button>
      </div>
    </div>

    <div id="myCollectionGrid"
      style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px;">
      <!-- Personal documents injected here -->
    </div>
  </div>

  <!-- CLAIM MODAL (GUIDELINES) -->
  <div id="claimModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10006; justify-content: center; align-items: center; backdrop-filter: blur(15px); padding: 20px; box-sizing: border-box;">
    <div
      style="background: rgba(15, 32, 39, 0.95); border: 1px solid cyan; border-radius: 20px; width: 100%; max-width: 500px; padding: 30px; position: relative; box-shadow: 0 0 50px rgba(0,242,254,0.3);">
      <button onclick="closeClaimModal()"
        style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: #ff4757; font-size: 24px; cursor: pointer;">âœ•</button>

      <div style="text-align: center; margin-bottom: 25px;">
        <h2 style="color: cyan; margin-bottom: 5px;">ðŸ“œ CLAIM GUIDELINES</h2>
        <h4 id="claimModalTitle" style="color: #fff; margin-top: 0;"></h4>
      </div>

      <div
        style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 4px solid cyan;">
        <h4 style="color: cyan; margin-top: 0; font-size: 14px; text-transform: uppercase;">Instructions:</h4>
        <p id="claimModalInstructions" style="color: #ddd; font-size: 14px; line-height: 1.6; white-space: pre-line;">
        </p>
      </div>

      <button id="claimRedirectBtn" class="login-btn" style="background: cyan; color: black; font-weight: 900;">ðŸš€
        PROCEED TO PARTNER WEBSITE</button>
      <p style="text-align: center; color: #666; font-size: 11px; margin-top: 15px;">Registration and further steps will
        be handled by our partner.</p>
    </div>
  </div>

  <div id="globalTicker">
    <div id="tickerText" class="ticker-content"></div>
  </div>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <!-- Firebase Realtime Database -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <!-- Firebase Analytics -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-analytics.js"></script>
  <!-- html2canvas for ID Card Download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    // Initialize Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCeW3RJPGLgP1uKbN5zKQhQDJ6KTkAhPaY",
      authDomain: "nextgen-6c99e.firebaseapp.com",
      projectId: "nextgen-6c99e",
      storageBucket: "nextgen-6c99e.firebasestorage.app",
      messagingSenderId: "774793697681",
      appId: "1:774793697681:web:6bcf573562be65701c2230",
      measurementId: "G-NESY4XEM9R"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    firebase.analytics();
  </script>

  <!-- SheetJS for Excel Export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Cropper.js for Photo Cropping -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <style>
    @keyframes neuralPulse {
      0% {
        box-shadow: 0 0 5px rgba(0, 242, 254, 0.5);
        border-color: rgba(0, 242, 254, 0.5);
      }

      50% {
        box-shadow: 0 0 20px rgba(0, 242, 254, 0.8), 0 0 40px rgba(0, 242, 254, 0.4);
        border-color: cyan;
      }

      100% {
        box-shadow: 0 0 5px rgba(0, 242, 254, 0.5);
        border-color: rgba(0, 242, 254, 0.5);
      }
    }

    @keyframes slideInUp {
      from {
        transform: translateY(100%) translateX(-50%);
        opacity: 0;
      }

      to {
        transform: translateY(0) translateX(-50%);
        opacity: 1;
      }
    }

    #neuralSyncHUD {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(11, 19, 43, 0.9);
      backdrop-filter: blur(10px);
      border: 1px solid cyan;
      color: cyan;
      padding: 12px 25px;
      border-radius: 30px;
      font-family: monospace;
      font-size: 14px;
      font-weight: bold;
      z-index: 20002;
      display: none;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
  </style>

  <div id="neuralSyncHUD">ðŸ“¡ Incoming Data Stream...</div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- SUNO PROFILE ID CARD â€” Premium CSS Styles                  -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <style>
    /* â”€â”€ WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .profile-idcard-wrapper {
      width: 100%;
      margin: 0 0 20px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
    }

    .profile-idcard-label {
      font-size: 11px;
      font-weight: 900;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: rgba(0, 242, 254, 0.7);
      text-shadow: 0 0 10px rgba(0, 242, 254, 0.4);
    }

    /* â”€â”€ CARD SHELL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .profile-live-idcard {
      position: relative;
      width: 100%;
      max-width: 420px;
      min-height: 220px;
      border-radius: 20px;
      border: 1.5px solid rgba(0, 242, 254, 0.35);
      overflow: hidden;
      background: linear-gradient(140deg, #050a14 0%, #0b1a30 60%, #0d0621 100%);
      box-shadow:
        0 0 0 1px rgba(0, 242, 254, 0.08),
        0 8px 40px rgba(0, 0, 0, 0.8),
        0 0 60px rgba(0, 100, 255, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.06);
      font-family: 'Outfit', sans-serif;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      cursor: default;
    }

    .profile-live-idcard:hover {
      transform: translateY(-4px) scale(1.01);
      box-shadow:
        0 0 0 1px rgba(0, 242, 254, 0.2),
        0 16px 60px rgba(0, 0, 0, 0.9),
        0 0 80px rgba(0, 180, 255, 0.25),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }

    /* â”€â”€ BACKGROUND EFFECTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .plc-holo-layer {
      position: absolute;
      inset: 0;
      z-index: 0;
      background: linear-gradient(110deg,
          transparent 20%,
          rgba(0, 242, 254, 0.04) 35%,
          rgba(100, 0, 255, 0.04) 50%,
          rgba(255, 0, 150, 0.03) 65%,
          transparent 80%);
      animation: holoShimmer 5s ease-in-out infinite alternate;
    }

    @keyframes holoShimmer {
      0% {
        background-position: 0% 50%;
        opacity: 0.6;
      }

      100% {
        background-position: 100% 50%;
        opacity: 1;
      }
    }

    .plc-grid-layer {
      position: absolute;
      inset: 0;
      z-index: 0;
      background-image:
        linear-gradient(rgba(0, 242, 254, 0.04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 242, 254, 0.04) 1px, transparent 1px);
      background-size: 30px 30px;
      opacity: 0.5;
    }

    .plc-glow-orb {
      position: absolute;
      z-index: 0;
      border-radius: 50%;
      filter: blur(40px);
    }

    .plc-orb1 {
      width: 180px;
      height: 180px;
      top: -60px;
      right: -60px;
      background: radial-gradient(circle, rgba(0, 242, 254, 0.15), transparent 70%);
      animation: orbFloat1 6s ease-in-out infinite alternate;
    }

    .plc-orb2 {
      width: 160px;
      height: 160px;
      bottom: -50px;
      left: -40px;
      background: radial-gradient(circle, rgba(180, 0, 255, 0.12), transparent 70%);
      animation: orbFloat2 7s ease-in-out infinite alternate;
    }

    @keyframes orbFloat1 {
      from {
        transform: translate(0, 0);
      }

      to {
        transform: translate(15px, 20px);
      }
    }

    @keyframes orbFloat2 {
      from {
        transform: translate(0, 0);
      }

      to {
        transform: translate(20px, -15px);
      }
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .plc-header {
      position: relative;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px 10px;
      background: rgba(0, 0, 0, 0.4);
      border-bottom: 1px solid rgba(0, 242, 254, 0.12);
      backdrop-filter: blur(4px);
    }

    .plc-header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .plc-logo-ring {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #00f2fe;
      box-shadow: 0 0 12px rgba(0, 242, 254, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .plc-school-name {
      font-size: 14px;
      font-weight: 900;
      color: #fff;
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .plc-school-sub {
      font-size: 7.5px;
      color: rgba(170, 170, 170, 0.8);
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-top: 1px;
    }

    /* Chip design */
    .plc-chip {
      width: 32px;
      height: 22px;
      background: linear-gradient(135deg, #c8a84b, #f5e07e, #c8a84b);
      border-radius: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 3px;
      padding: 3px 5px;
      box-sizing: border-box;
      box-shadow: 0 0 8px rgba(200, 160, 70, 0.6);
    }

    .plc-chip-line {
      width: 100%;
      height: 2px;
      background: rgba(80, 50, 0, 0.5);
      border-radius: 1px;
    }

    /* â”€â”€ BODY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .plc-body {
      position: relative;
      z-index: 5;
      display: flex;
      align-items: center;
      gap: 18px;
      padding: 16px 18px;
    }

    /* Avatar ring */
    .plc-avatar-ring {
      position: relative;
      flex-shrink: 0;
      width: 90px;
      height: 90px;
    }

    .plc-avatar-border-spin {
      position: absolute;
      inset: -3px;
      border-radius: 50%;
      background: conic-gradient(from 0deg, #00f2fe, #ff007a, #7b00ff, #00f2fe);
      animation: spinBorder 3s linear infinite;
      z-index: 0;
    }

    @keyframes spinBorder {
      to {
        transform: rotate(360deg);
      }
    }

    .plc-avatar-img {
      position: relative;
      z-index: 2;
      width: 90px;
      height: 90px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #050a14;
    }

    .plc-scan-line {
      position: absolute;
      z-index: 3;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(0, 242, 254, 0.8), transparent);
      box-shadow: 0 0 8px #00f2fe;
      animation: scanLine 2.5s ease-in-out infinite;
      top: 0;
    }

    @keyframes scanLine {
      0% {
        top: 0;
        opacity: 0;
      }

      10% {
        opacity: 1;
      }

      90% {
        opacity: 1;
      }

      100% {
        top: 90px;
        opacity: 0;
      }
    }

    /* Info section */
    .plc-info {
      flex: 1;
      overflow: hidden;
    }

    .plc-name {
      font-size: 18px;
      font-weight: 900;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
      text-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 3px;
    }

    .plc-rank {
      font-size: 9.5px;
      font-weight: 800;
      color: #ff4dc5;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      margin-bottom: 10px;
    }

    .plc-fields {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
    }

    .plc-field {
      display: flex;
      flex-direction: column;
      border-left: 2px solid rgba(0, 242, 254, 0.4);
      padding: 2px 0 2px 8px;
      background: rgba(0, 242, 254, 0.03);
      border-radius: 0 4px 4px 0;
    }

    .plc-field-gold {
      border-left-color: gold;
      background: rgba(255, 215, 0, 0.04);
    }

    .plc-field-label {
      font-size: 7.5px;
      font-weight: 900;
      color: rgba(140, 180, 200, 0.7);
      letter-spacing: 1.5px;
      text-transform: uppercase;
    }

    .plc-field-value {
      font-size: 12px;
      font-weight: 700;
      color: #fff;
      font-family: 'Outfit', monospace;
    }

    .plc-field-gold .plc-field-value {
      color: gold;
    }

    /* â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .plc-footer {
      position: relative;
      z-index: 5;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 18px;
      background: rgba(0, 0, 0, 0.45);
      border-top: 1px solid rgba(0, 242, 254, 0.1);
    }

    .plc-barcode {
      font-family: monospace;
      font-size: 13px;
      color: rgba(0, 242, 254, 0.25);
      letter-spacing: -1px;
      transform: scaleY(1.5);
    }

    .plc-site-tag {
      font-size: 8px;
      font-weight: 900;
      color: rgba(0, 242, 254, 0.5);
      letter-spacing: 1.5px;
      text-transform: uppercase;
      font-family: monospace;
    }

    /* â”€â”€ ACTION BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .plc-action-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      width: 100%;
      max-width: 420px;
    }

    .plc-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 13px 10px;
      border: none;
      border-radius: 14px;
      font-size: 14px;
      font-weight: 800;
      font-family: 'Outfit', sans-serif;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .plc-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: rgba(255, 255, 255, 0.15);
      transform: translateX(-110%) skewX(-15deg);
      transition: transform 0.4s ease;
    }

    .plc-btn:hover::before {
      transform: translateX(110%) skewX(-15deg);
    }

    .plc-btn:hover {
      transform: translateY(-3px) scale(1.03);
    }

    .plc-btn:active {
      transform: scale(0.97);
    }

    .plc-btn-icon {
      font-size: 18px;
    }

    .plc-btn-download {
      background: linear-gradient(135deg, #0f9b58, #38ef7d);
      color: #fff;
      box-shadow: 0 6px 25px rgba(56, 239, 125, 0.45);
    }

    .plc-btn-download:hover {
      box-shadow: 0 10px 35px rgba(56, 239, 125, 0.65);
    }

    .plc-btn-share {
      background: linear-gradient(135deg, #0b72e4, #00f2fe);
      color: #000;
      box-shadow: 0 6px 25px rgba(0, 200, 255, 0.45);
    }

    .plc-btn-share:hover {
      box-shadow: 0 10px 35px rgba(0, 200, 255, 0.65);
    }
  </style>



  <header style="display:none;">
    <div style="display:flex; align-items:center; gap:10px; flex-grow:1;">
      <div style="position: relative; cursor: pointer; display: flex; align-items: center; gap: 8px;"
        onclick="openEditProfile()" title="Edit Profile">
        <img id="userProfilePicHeader" src="https://ui-avatars.com/api/?name=U&background=cyan&color=000" alt="Profile"
          style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid cyan; object-fit: cover; display: none;">
        <!-- Header Badge -->
        <div id="headerGamificationBadge"
          style="display: none; background: rgba(0,242,254,0.1); border: 1px solid rgba(0,242,254,0.3); padding: 4px 10px; border-radius: 15px; font-size: 11px; font-weight: bold; color: gold; box-shadow: 0 0 10px rgba(0,242,254,0.2);">
          --
        </div>
      </div>
      <img src="img1.png" alt="Logo" style="width: 40px; height: 40px; filter: drop-shadow(0 0 5px cyan);">
      <h2 class="premium-brand">
        <span class="brand-emoji">ðŸ›¡ï¸</span>
        NextGen Library
      </h2>
    </div>
    <div style="display: flex; gap: 10px; align-items: center;">
      <!-- Global Search Bar -->
      <div class="search-wrapper">
        <input type="text" id="globalSearchInput" placeholder="Search courses, library..." oninput="searchLibrary()">
        <div id="searchResultsModal" class="search-dropdown"></div>
      </div>
      <div id="headerWalletDisplay" style="margin-left: 15px; display: flex; align-items: center; gap: 10px;">
        <!-- NEW NEURAL WALLET BALANCE SQUARE -->
        <div
          style="background: rgba(11, 19, 43, 0.8); padding: 5px 15px; border: 2px solid cyan; border-radius: 10px; font-weight: 900; box-shadow: 0 0 15px rgba(0,242,254,0.4); text-align: center; min-width: 140px;">
          <span
            style="color: #00f2fe; font-size: 10px; display: block; text-transform: uppercase; letter-spacing: 1px;">Neural
            Wallet Balance</span>
          <span style="color: gold; font-size: 18px; text-shadow: 0 0 10px gold;">ðŸª™ <span
              id="headerWalletBalance">0.00</span></span>
        </div>
        <button onclick="topUpWallet()"
          style="background: #00cec9; border: none; color: black; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 0 10px rgba(0, 206, 201, 0.3);">âž•
          RECHARGE</button>
        <button onclick="openWithdrawalModal()"
          style="background: rgba(255, 71, 87, 0.2); border: 1px solid #ff4757; color: #ff4757; padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.3s;">ðŸ’¸
          WITHDRAW</button>
      </div>
      <button onclick="openLeaderboard()"
        style="font-size: 14px; padding: 6px 12px; background: gold; color: black; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; box-shadow: 0 0 10px gold;">ðŸ†
        Leadership</button>
      <button id="themeToggleBtn" onclick="toggleMode()"
        style="font-size: 20px; padding: 8px 15px; background: transparent; border: none; box-shadow: none; cursor: pointer;"></button>
    </div>
  </header>


  <!-- LEADERBOARD MODAL -->
  <div id="loginScreen">
    <div class="login-box">

      <!-- SIGN UP FORM -->
      <div id="signUpForm">
        <img src="img1.png" alt="Logo"
          style="width: 80px; height: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px cyan);">
        <h2 class="premium-brand" style="margin-bottom: 25px; font-size: 24px;">
          <span class="brand-emoji">ðŸ“</span> NextGen Library Registration
        </h2>
        <input type="text" id="regName" class="login-input" placeholder="Name (Letters & Spaces only)">
        <input type="number" id="regRoll" class="login-input"
          placeholder="University Roll Number / Registation Number (13 Digits)"
          style="appearance: none; -moz-appearance: textfield;">

        <div style="display: flex; gap: 10px;">
          <select id="regBranch" class="login-input" style="flex: 1;">
            <option value="" disabled selected>Course</option>
            <!-- Courses injected dynamically -->
          </select>
          <select id="regSection" class="login-input" style="flex: 1;">
            <option value="" disabled selected>Section</option>
            <option value="A1">Section A1</option>
            <option value="A2">Section A2</option>
            <option value="A3">Section A3</option>
            <option value="A4">Section A4</option>
            <option value="A5">Section A5</option>
            <option value="A6">Section A6</option>
            <option value="A7">Section A7</option>
            <option value="A8">Section A8</option>
          </select>
        </div>

        <input type="tel" id="regMobile" class="login-input" placeholder="Mobile Number">

        <button class="login-btn" onclick="handleSignUp()">Sign Up & Enter</button>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
          <p class="auth-toggle" style="margin: 0;">Already have an account? <span
              onclick="toggleAuthMode('login')">Login</span></p>
          <div class="admin-link" onclick="toggleAuthMode('admin')">Admin Login</div>
        </div>
      </div>

      <!-- LOGIN FORM -->
      <div id="loginForm" style="display: none;">
        <img src="img1.png" alt="Logo"
          style="width: 80px; height: 80px; margin-bottom: 10px; filter: drop-shadow(0 0 10px cyan);">
        <h2 class="premium-brand" style="margin-bottom: 25px; font-size: 24px;">
          <span class="brand-emoji">ðŸ”‘</span> NextGen Library Login
        </h2>
        <input type="text" id="loginName" class="login-input" placeholder="Name">
        <select id="loginSection" class="login-input">
          <option value="" disabled selected>Section</option>
          <option value="A1">Section A1</option>
          <option value="A2">Section A2</option>
          <option value="A3">Section A3</option>
          <option value="A4">Section A4</option>
          <option value="A5">Section A5</option>
          <option value="A6">Section A6</option>
          <option value="A7">Section A7</option>
          <option value="A8">Section A8</option>
        </select>
        <input type="tel" id="loginMobile" class="login-input" placeholder="Mobile Number">
        <button class="login-btn" onclick="handleLogin()">Log In</button>
        <p class="auth-toggle" style="text-align: right; margin-top: 5px;">Forgot Details? <span
            onclick="recoverDetails()">Click Here</span></p>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
          <p class="auth-toggle" style="margin: 0;">New user? <span onclick="toggleAuthMode('signup')">Sign Up</span>
          </p>
          <div class="admin-link" onclick="toggleAuthMode('admin')">Admin Login</div>
        </div>
      </div>

      <!-- ADMIN LOGIN FORM -->
      <div id="adminLoginForm" style="display: none;">
        <h2>ðŸ›¡ï¸ Admin Access</h2>
        <input type="text" id="adminUser" class="login-input" placeholder="Admin Username">
        <input type="password" id="adminPass" class="login-input" placeholder="Admin Password">
        <button class="login-btn" onclick="handleAdminLogin()"
          style="background: #ff4757; color: white; box-shadow: 0 0 15px rgba(255, 71, 87, 0.5);">Authenticate</button>
        <p class="auth-toggle" style="margin-top: 20px;">Return to <span onclick="toggleAuthMode('login')">Student
            Login</span></p>
      </div>

    </div>
  </div>

  <!-- EDIT PROFILE SCREEN -->
  <div id="editProfileScreen"
    style="display: none; height: 100vh; flex-direction: column; justify-content: center; align-items: center; text-align: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); position: fixed; width: 100%; top: 0; left: 0; z-index: 10000;">

    <!-- Floating Close Button Outside the Layout -->
    <button onclick="closeEditProfile()"
      style="position: absolute; top: 30px; right: 30px; background: #ff4757; border: 2px solid #fff; border-radius: 50%; color: white; width: 45px; height: 45px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; box-shadow: 0 0 20px rgba(255,71,87,0.8); transition: transform 0.2s; z-index: 10001;"
      onmouseover="this.style.transform='scale(1.1) rotate(90deg)'"
      onmouseout="this.style.transform='scale(1) rotate(0deg)'">âœ•</button>

    <div class="login-box" style="position: relative; max-height: 85vh; overflow-y: auto;">
      <h2
        style="background: linear-gradient(90deg, #00f2fe, #4facfe); -webkit-background-clip: text; background-clip: text; color: transparent; margin-bottom: 20px;">
        âœï¸ Edit Profile</h2>
      <div style="margin-bottom: 20px;">
        <img id="editProfilePicPreview" src="https://ui-avatars.com/api/?name=U"
          style="width: 110px; height: 110px; border-radius: 50%; border: 3px solid cyan; object-fit: cover; margin-bottom: 10px; box-shadow: 0 0 20px rgba(0,255,255,0.6);">
      </div>
      <div style="margin-bottom: 15px;">
        <input type="file" id="editProfilePicInput" accept="image/*" class="login-input"
          onchange="previewEditProfilePic(event)" style="padding: 5px; max-width: 250px; margin: 0 auto;">
        <p style="font-size: 11px; color: #00f2fe; margin-top: 5px; letter-spacing: 0.5px;">*Picture auto-crops to
          circle</p>
      </div>
      <input type="text" id="editName" class="login-input" placeholder="Name (Letters & Spaces only)">

      <!-- Gamification Badge Display -->
      <div id="gamificationBadge"
        style="margin-bottom: 20px; font-weight: bold; font-size: 14px; text-shadow: 0 0 5px rgba(0,255,255,0.5); padding: 10px; border-radius: 8px; background: rgba(0, 242, 254, 0.1); border: 1px solid rgba(0, 242, 254, 0.3);">
        ðŸ† Points: <span id="userPoints" style="color: cyan;">0</span> | Rank: <span id="userRank"
          style="color: gold;">Beginner ðŸŒ±</span>
      </div>

      <input type="number" id="editRoll" class="login-input" placeholder="University Roll Number (13 Digits)"
        style="appearance: none; -moz-appearance: textfield;">

      <div style="display: flex; gap: 10px;">
        <select id="editBranch" class="login-input" style="flex: 1;">
          <option value="BCA">BCA</option>
          <option value="BTECH">BTECH</option>
          <option value="BBA">BBA</option>
        </select>
        <select id="editSection" class="login-input" style="flex: 1;">
          <option value="A1">Section A1</option>
          <option value="A2">Section A2</option>
          <option value="A3">Section A3</option>
          <option value="A4">Section A4</option>
          <option value="A5">Section A5</option>
          <option value="A6">Section A6</option>
          <option value="A7">Section A7</option>
          <option value="A8">Section A8</option>
        </select>
      </div>

      <input type="tel" id="editMobile" class="login-input" placeholder="Mobile Number">

      <button class="login-btn" onclick="saveProfileChanges()" style="margin-bottom: 18px; border-radius: 10px;">ðŸ’¾ Save
        Changes</button>

      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <!-- LIVE SUNO PROFILE ID CARD PREVIEW (Visible in Profile) -->
      <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
      <div class="profile-idcard-wrapper">
        <div class="profile-idcard-label">ðŸªª Your id card</div>

        <!-- THE LIVE CARD -->
        <div class="profile-live-idcard" id="profileLiveCard">

          <!-- Animated holographic background layers -->
          <div class="plc-holo-layer"></div>
          <div class="plc-grid-layer"></div>
          <div class="plc-glow-orb plc-orb1"></div>
          <div class="plc-glow-orb plc-orb2"></div>

          <!-- Top Header Bar -->
          <div class="plc-header">
            <div class="plc-header-left">
              <div class="plc-logo-ring">
                <img src="favicon1.png" style="width:22px;height:22px;object-fit:contain;" alt="Logo">
              </div>
              <div>
                <div class="plc-school-name">NEXTGEN <span style="color:#00f2fe;">LIBRARY</span></div>
                <div class="plc-school-sub">NEURAL LEARNING NETWORK</div>
              </div>
            </div>
            <div class="plc-chip">
              <div class="plc-chip-line"></div>
              <div class="plc-chip-line"></div>
              <div class="plc-chip-line"></div>
            </div>
          </div>

          <!-- Body: Avatar + Info -->
          <div class="plc-body">
            <!-- Avatar -->
            <div class="plc-avatar-ring">
              <div class="plc-avatar-border-spin"></div>
              <img id="plcAvatar" src="https://ui-avatars.com/api/?name=S&background=0b132b&color=00f2fe"
                class="plc-avatar-img" alt="Avatar">
              <div class="plc-scan-line"></div>
            </div>

            <!-- Info -->
            <div class="plc-info">
              <div class="plc-name" id="plcName">STUDENT NAME</div>
              <div class="plc-rank" id="plcRank">âš¡ LEVEL: EXPLORER</div>
              <div class="plc-fields">
                <div class="plc-field">
                  <span class="plc-field-label">ROLL NO</span>
                  <span class="plc-field-value" id="plcRoll">â€”</span>
                </div>
                <div class="plc-field">
                  <span class="plc-field-label">COURSE</span>
                  <span class="plc-field-value" id="plcCourse">â€”</span>
                </div>
                <div class="plc-field">
                  <span class="plc-field-label">SECTION</span>
                  <span class="plc-field-value" id="plcSection">â€”</span>
                </div>
                <div class="plc-field plc-field-gold">
                  <span class="plc-field-label">TECH XP</span>
                  <span class="plc-field-value" id="plcPoints">0 âœ¨</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Footer Bar -->
          <div class="plc-footer">
            <div class="plc-barcode">|| | ||| | || ||| | | || |||</div>
            <div class="plc-site-tag">nextgen-6c99e.web.app</div>
          </div>

        </div>
        <!-- /LIVE CARD -->

        <!-- Action Buttons Under Card -->
        <div class="plc-action-row">
          <button class="plc-btn plc-btn-download" onclick="downloadIDCard()">
            <span class="plc-btn-icon">ðŸ“¥</span>
            <span>Download Card</span>
          </button>
          <button class="plc-btn plc-btn-share" onclick="shareIDCard()">
            <span class="plc-btn-icon">ðŸš€</span>
            <span>Share Card</span>
          </button>
        </div>
      </div>
      <!-- /ID CARD PREVIEW SECTION -->

      <!-- Withdrawal Modal moved to bottom of body for better visibility -->
      <button class="login-btn" onclick="logoutUser()"
        style="background: linear-gradient(90deg, #ff416c, #ff4b2b); color: white; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(255,75,43,0.4); border-radius: 10px;">ðŸšª
        Logout Identity</button>
      <button class="login-btn" onclick="closeEditProfile()"
        style="background: transparent; border: 1px solid rgba(0,242,254,0.5); color: #00f2fe; box-shadow: none;">âŒ
        Cancel</button>
    </div>

    <!-- DIGITAL ID CARD UI (Restored and Redesigned for Premium Look) -->
    <div id="studentIdCard"
      style="width: 500px; height: 320px; background: linear-gradient(135deg, #050a14 0%, #0b132b 100%); position: fixed; left: -10000px; top: 0; overflow: hidden; border-radius: 20px; border: 2px solid rgba(0,242,254,0.3); font-family: 'Outfit', sans-serif; box-shadow: 0 10px 50px rgba(0,0,0,1); text-align: left; box-sizing: border-box; z-index: -9999; pointer-events: none;">

      <!-- Premium Background Elements -->
      <div
        style="position: absolute; top: -100px; right: -100px; width: 250px; height: 250px; background: radial-gradient(circle, rgba(0,242,254,0.1) 0%, transparent 70%); border-radius: 50%;">
      </div>
      <div
        style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(255,0,150,0.08) 0%, transparent 70%); border-radius: 50%;">
      </div>

      <!-- Header Section -->
      <div
        style="display: flex; align-items: center; justify-content: space-between; padding: 18px 25px; background: rgba(0,0,0,0.4); border-bottom: 1px solid rgba(0,242,254,0.15);">
        <div style="display: flex; align-items: center; gap: 12px;">
          <div
            style="width: 38px; height: 38px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid cyan; box-shadow: 0 0 15px rgba(0,242,254,0.4);">
            <img src="favicon1.png" style="width: 25px; height: 25px; object-fit: contain;">
          </div>
          <div>
            <h3
              style="margin: 0; font-size: 16px; font-weight: 900; color: #fff; letter-spacing: 1px; text-transform: uppercase;">
              NEXTGEN <span style="color: cyan;">LIBRARY</span></h3>
            <p style="margin: 0; font-size: 8px; color: #aaa; letter-spacing: 2.5px; font-weight: 700;">NEURAL LEARNING
              NETWORK</p>
          </div>
        </div>
        <div id="idCardRankIcon"
          style="width: 35px; height: 35px; border-radius: 50%; background: linear-gradient(135deg, #00f2fe, #4facfe); display: flex; align-items: center; justify-content: center; box-shadow: 0 0 15px rgba(0,242,254,0.5); border: 1px solid rgba(255,255,255,0.2);">
          <span style="font-size: 16px;">ðŸŽ“</span>
        </div>
      </div>

      <!-- Detail Body -->
      <div
        style="display: flex; padding: 25px 30px; gap: 25px; align-items: flex-start; position: relative; z-index: 5;">
        <!-- Avatar Section -->
        <div style="position: relative; flex-shrink: 0; width: 110px; height: 110px;">
          <div
            style="position: absolute; inset: -3px; border-radius: 50%; background: linear-gradient(45deg, cyan, #ff007a, cyan); animation: neuralPulse 3s infinite linear; z-index: 0; opacity: 0.6;">
          </div>
          <img id="idCardPic" src="" crossorigin="anonymous"
            style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; position: relative; z-index: 2; border: 3px solid #050a14;">
        </div>

        <!-- Name & Bio -->
        <div style="flex-grow: 1;">
          <h2 id="idCardName"
            style="margin: 0; font-size: 24px; font-weight: 900; color: #fff; text-shadow: 0 0 10px rgba(0,242,254,0.3); text-transform: uppercase;">
            STUDENT NAME</h2>
          <p id="idCardCongrats"
            style="margin: 3px 0 12px 0; font-size: 10px; font-weight: 900; color: #ff007a; letter-spacing: 1px;"> <span
              id="idCardRankText" style="color: cyan;">LEVEL: EXPLORER</span> âœ¨</p>

          <div style="display: grid; grid-template-columns: 1fr; gap: 6px;">
            <div
              style="display: flex; border-left: 2px solid cyan; padding-left: 10px; background: rgba(0,242,254,0.03); padding-top: 2px; padding-bottom: 2px;">
              <div style="width: 80px;"><small
                  style="color: #666; font-size: 9px; font-weight: 900; text-transform: uppercase;">Roll No</small>
              </div>
              <div style="color: white; font-weight: 700; font-size: 13px; font-family: monospace;" id="idCardRoll">--
              </div>
            </div>
            <div
              style="display: flex; border-left: 2px solid #ff007a; padding-left: 10px; background: rgba(255,0,122,0.03); padding-top: 2px; padding-bottom: 2px;">
              <div style="width: 80px;"><small
                  style="color: #666; font-size: 9px; font-weight: 900; text-transform: uppercase;">Course</small></div>
              <div style="color: white; font-weight: 700; font-size: 12px;" id="idCardCourse">--</div>
            </div>
            <div
              style="display: flex; border-left: 2px solid gold; padding-left: 10px; background: rgba(255,215,0,0.03); padding-top: 2px; padding-bottom: 2px;">
              <div style="width: 80px;"><small
                  style="color: #666; font-size: 9px; font-weight: 900; text-transform: uppercase;">Tech XP</small>
              </div>
              <div style="color: gold; font-weight: 900; font-size: 14px;" id="idCardPoints">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer / ID Bar -->
      <div
        style="position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.5); border-top: 1px solid rgba(0,242,254,0.2); padding: 10px 25px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box;">
        <div
          style="font-family: monospace; font-size: 14px; color: rgba(0,242,254,0.3); letter-spacing: -1px; transform: scaleY(1.4);">
          || ||| | || |||| | |</div>
        <div style="color: cyan; font-size: 11px; font-weight: 900; font-family: monospace;">
          ADITYAKUMAR12XYZ.GITHUB.IO/NEXTGEN/</div>
      </div>
    </div>
  </div>
  </div>
  </div>

  <!-- CROPPER UI MODAL (For Profile Photos) -->
  <div id="cropModal"
    style="display: none; position: fixed; z-index: 10005; top: 0; left: 0; width: 100%; height: 100vh; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box;">
    <h3 style="color: #00f2fe; margin-bottom: 20px; font-family: sans-serif;">âœ‚ï¸ Adjust Your Profile Photo</h3>
    <div style="max-width: 90%; max-height: 60vh; overflow: hidden; border: 2px solid cyan; border-radius: 10px;">
      <img id="imageToCrop" src="" style="max-width: 100%; display: block;">
    </div>
    <div style="display: flex; gap: 15px; margin-top: 25px;">
      <button class="login-btn" onclick="cancelCrop()"
        style="background: transparent; border: 1px solid #ff4757; color: #ff4757; width: auto; padding: 10px 25px;">Cancel</button>
      <button class="login-btn" onclick="applyCrop()"
        style="background: linear-gradient(90deg, #11998e, #38ef7d); color: white; border: none; width: auto; padding: 10px 25px;">Crop
        & Save</button>
    </div>
  </div>
  <!-- ADMIN DASHBOARD -->
  <div id="adminDashboard">
    <div
      style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
      <h2
        style="background: linear-gradient(90deg, #00f2fe, #4facfe); -webkit-background-clip: text; background-clip: text; color: transparent; margin: 0;">
        ðŸ›¡ï¸ Secure Admin Dashboard</h2>
      <div style="display: flex; gap: 15px; margin-top: 10px;">
        <!-- ADMIN HACK: ONE-CLICK DATA BACKUP -->
        <button onclick="backupFullData()"
          style="background: linear-gradient(90deg, #6c5ce7 0%, #a29bfe 100%); color: white; padding: 10px 20px; font-size: 14px; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4);">ðŸ’¾
          JSON Backup</button>
        <button onclick="exportToExcel()"
          style="background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%); color: white; padding: 10px 20px; font-size: 14px; box-shadow: 0 4px 15px rgba(56, 239, 125, 0.4);">ðŸ“Š
          Export to Excel</button>
        <button onclick="adminLogout()"
          style="background: linear-gradient(90deg, #ff416c 0%, #ff4b2b 100%); color: white; padding: 10px 20px; font-size: 14px; box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4);">ðŸšª
          Logout Admin</button>
      </div>
    </div>

    <div
      style="background: rgba(255,255,255,0.05); padding: 5px; border-radius: 10px; margin-bottom: 20px; display: flex; gap: 5px; overflow-x: auto; position: sticky; top: 0; z-index: 1000; backdrop-filter: blur(10px);">
      <button onclick="switchAdminTab('students')" class="admin-tab-btn active">ðŸ‘¥ Student Database</button>
      <button onclick="switchAdminTab('cms')" class="admin-tab-btn">ðŸ“ CMS Editor</button>
      <button onclick="switchAdminTab('recharges')" class="admin-tab-btn">ðŸ’° Recharge Requests</button>
      <button onclick="switchAdminTab('withdrawals')" class="admin-tab-btn">ðŸ’¸ Withdrawal Requests</button>
      <button onclick="switchAdminTab('battles')" class="admin-tab-btn">âš”ï¸ Battle Manager</button>
      <button onclick="switchAdminTab('premium')" class="admin-tab-btn">ðŸ’Ž Premium MGMT</button>
      <button onclick="switchAdminTab('certificates')" class="admin-tab-btn">ðŸ“œ Certificates</button>
      <button onclick="switchAdminTab('settings')" class="admin-tab-btn">âš™ï¸ Site Settings</button>
      <button onclick="switchAdminTab('codeStudio')" class="admin-tab-btn">ðŸ’» Code Studio</button>
      <button onclick="switchAdminTab('security')" class="admin-tab-btn">ðŸ” Security</button>
    </div>

    <!-- STUDENT DATABASE SECTION -->
    <div id="adminSection_students" class="admin-section">
      <p>View all registered student data below. This info is protected.</p>
      <div style="overflow-x: auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Roll Number</th>
              <th>Branch</th>
              <th>Section</th>
              <th>Mobile Number</th>
              <th>Wallet (ðŸª™)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminTableBody">
            <!-- Rows injected via JS -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- RECHARGE REQUESTS SECTION -->
    <div id="adminSection_recharges" class="admin-section" style="display:none;">
      <h3 style="color: #00cec9;">ðŸ’° Pending Wallet Recharges</h3>
      <p style="color: #888; font-size: 13px;">Approve users who have sent money and uploaded UTR screenshot.</p>
      <div style="overflow-x: auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Type</th>
              <th>Amount</th>
              <th>Verification (UTR)</th>
              <th>Proof</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="pendingRechargesTableBody">
            <!-- Filtered for Recharges only -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- PENDING WITHDRAWALS SECTION -->
    <div id="adminSection_withdrawals" class="admin-section" style="display:none;">
      <h3 style="color: #ff4757;">ðŸ’¸ Pending Withdrawal Requests</h3>
      <p style="color: #888; font-size: 13px;">Transfer money to the user's UPI ID and mark as paid here.</p>
      <div style="overflow-x: auto;">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Amount</th>
              <th>UPI ID</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="pendingWithdrawalsTableBody">
            <!-- Rows for Withdrawals only -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ADMIN HACK: USER SHADOW MODAL (Activity Logs - ID Card Style) -->
    <div id="userShadowModal"
      style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 20000; justify-content: center; align-items: center; backdrop-filter: blur(15px);">
      <div style="position: relative;">
        <!-- Close Button Overlaid -->
        <button onclick="document.getElementById('userShadowModal').style.display='none'"
          style="position: absolute; top: -20px; right: -20px; background: #ff4757; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; z-index: 20001; font-weight: bold; box-shadow: 0 0 10px rgba(0,0,0,0.5);">âœ•</button>

        <div id="shadowIdCard"
          style="width: 486px; height: 306px; background: #000; position: relative; overflow: hidden; border-radius: 16px; border: 1px solid rgba(0,242,254,0.5); font-family: 'Segoe UI', sans-serif; box-shadow: 0 0 50px rgba(0,242,254,0.3); text-align: left; box-sizing: border-box;">

          <!-- Premium Tech/AI Background (Replicated from ID Card) -->
          <img src="https://images.unsplash.com/photo-1614850523459-c2f4c699c52e?q=80&w=600&auto=format&fit=crop"
            style="position: absolute; width:100%; height:100%; object-fit:cover; opacity: 0.5; z-index: 1; filter: contrast(1.2) hue-rotate(180deg);">
          <div
            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: linear-gradient(135deg, #0b132b, #1c2541);">
          </div>

          <!-- Content -->
          <div style="position: relative; z-index: 3; display: flex; flex-direction: column; height: 100%;">
            <!-- Header -->
            <div
              style="display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,242,254,0.3);">
              <div style="display: flex; align-items: center; gap: 10px;">
                <img src="img1.png" style="width: 30px; height: 30px; filter: drop-shadow(0 0 5px cyan);">
                <div>
                  <h3 style="margin: 0; font-size: 16px; font-weight: 800; color: #fff; letter-spacing: 1px;">SHADOW
                    <span style="color: #ff4757;">SYSTEM</span>
                  </h3>
                  <p style="margin: 0; font-size: 9px; color: #aaa; letter-spacing: 2px;">NEURAL ACTIVITY OVERRIDE</p>
                </div>
              </div>
              <div
                style="width: 30px; height: 30px; border-radius: 50%; background: rgba(255,71,87,0.2); border: 1px solid #ff4757; display: flex; align-items: center; justify-content: center;">
                <span id="shadowStatusIcon" style="font-size: 14px; color: #ff4757;">ðŸ‘ï¸</span>
              </div>
            </div>

            <!-- Body -->
            <div style="display: flex; padding: 15px 20px; gap: 20px; align-items: center; flex-grow: 1;">
              <!-- Photo Container -->
              <div style="position: relative; flex-shrink: 0; width: 100px; height: 100px;">
                <div
                  style="position: absolute; inset: -3px; border-radius: 50%; background: linear-gradient(135deg, #ff4757, #00f2fe); z-index: 0; box-shadow: 0 0 15px rgba(255,71,87,0.5);">
                </div>
                <img id="shadowPic" src=""
                  style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover; position: relative; z-index: 1; border: 2px solid #000;">
              </div>

              <!-- Details -->
              <div id="shadowDetails" style="flex-grow: 1; color: white;">
                <!-- Injected via JS -->
              </div>
            </div>

            <!-- Footer -->
            <div
              style="padding: 10px 20px; background: rgba(255,71,87,0.1); border-top: 1px solid rgba(255,71,87,0.3); display: flex; justify-content: space-between; align-items: center;">
              <div
                style="font-family: monospace; font-size: 14px; color: rgba(255,71,87,0.7); letter-spacing: -1px; transform: scaleY(1.5);">
                || | ||| || || | | ||||</div>
              <div id="shadowTimestamp" style="font-size: 9px; color: #ff4757; font-weight: bold; letter-spacing: 1px;">
                SECURE_LINK_ENCRYPTED
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="adminSection_cms" class="admin-section" style="display:none;">
      <div id="adminCMS" style="margin-top: 0; border: none; padding-top: 0;">
        <h3 style="color: cyan; text-align: left;">ðŸ“‚ Manage Course Content</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
          <select id="cmsCourse" class="login-input" style="flex: 1; margin: 0; min-width: 150px;"
            onchange="onAdminCMSCourseChange()">
            <option value="" disabled selected>Course</option>
          </select>
          <select id="cmsBranch" class="login-input" style="flex: 1; margin: 0; min-width: 150px;"
            onchange="onAdminCMSBranchChange()">
            <option value="" disabled selected>Branch</option>
          </select>
        </div>

        <!-- NEW INTEGRATED INTERACTION AREA -->
        <div id="cmsInteractionArea" style="margin-top: 20px;">
          <p style="color: #888; text-align: center; padding: 20px;">Select Course and Branch to manage Semesters,
            Subjects,
            and Chapters.</p>
        </div>

        <!-- Content Editor (Visible only when a chapter is selected) -->
        <div id="cmsContentEditor"
          style="display: none; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
          <h4 id="selectedPathDisplay" style="color: cyan; margin-bottom: 15px;">Selected: ...</h4>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <!-- Existing Editor Fields -->
            <div style="text-align: left;">
              <label style="color: #aaa; font-size: 14px;">ðŸ“¹ Video URLs (one per line)</label>
              <textarea id="cmsVideo" class="login-input" style="height: 80px;"></textarea>
            </div>
            <div style="text-align: left;">
              <label style="color: #aaa; font-size: 14px;">ðŸ“„ PDF Google Drive Links (one per line)</label>
              <textarea id="cmsPdf" class="login-input" style="height: 80px;"></textarea>
            </div>
            <div style="text-align: left;">
              <label style="color: #aaa; font-size: 14px;">ðŸ“ Explanatory Notes (Multi-line Support)</label>
              <textarea id="cmsNotes" class="login-input" style="height: 120px;"></textarea>
            </div>
            <div style="text-align: left;">
              <label style="color: #aaa; font-size: 14px;">âœï¸ Assignment Text (Multi-line Support)</label>
              <textarea id="cmsAssignment" class="login-input" style="height: 100px;"></textarea>
            </div>
            <div style="text-align: left;">
              <label style="color: #aaa; font-size: 14px;">ðŸ  Homework Text (Multi-line Support)</label>
              <textarea id="cmsHomework" class="login-input" style="height: 100px;"></textarea>
            </div>
            <button class="login-btn" onclick="saveAdminContent()"
              style="background: cyan; color: black; margin-top: 10px;">ðŸ’¾ Save Data to Firebase</button>
          </div>
        </div>
      </div>

      <!-- ADMIN SUBJECT MANAGEMENT -->
      <div id="adminSubjectManager"
        style="margin-top: 40px; border-top: 1px solid rgba(0,255,255,0.3); padding-top: 20px;">

        <!-- MANAGE COURSES -->
        <h3 style="color: cyan; text-align: left;">ðŸ¢ Manage Courses</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
          <input type="text" id="newCourseName" class="login-input" placeholder="New Course Name (e.g. MCA)"
            style="flex: 2; margin-bottom: 0;">
          <button class="login-btn" onclick="addAdminCourse()"
            style="flex: 1; margin-top: 0; background: #00cec9; color: black;">âž• Add Course</button>
        </div>
        <div style="display: flex; gap: 10px; margin-bottom: 25px;">
          <select id="deleteCourseSelect" class="login-input" style="flex: 2; margin: 0;">
            <option value="" disabled selected>Select Course to Delete</option>
          </select>
          <button class="login-btn" onclick="deleteAdminCourse()"
            style="flex: 1; margin-top: 0; background: #ff4757; color: white;">ðŸ—‘ï¸ Delete Course</button>
        </div>

      </div>
      <!-- /adminSubjectManager -->

      <!-- ADMIN WALLET RECHARGE SETTINGS -->
      <div id="adminWalletSettings"
        style="margin-top: 40px; border-top: 1px solid rgba(255,215,0,0.5); padding-top: 20px;">
        <h3 style="color: gold; text-align: left;">ðŸª™ Wallet Recharge Settings</h3>
        <p style="color: #ccc; font-size: 14px;">Set the global QR code and UPI ID for all Neural Wallet Recharges.
        </p>

        <div id="walletConfigEditor">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <label style="color: #ccc; font-size: 14px;">Upload QR Code Image:</label>
              <input type="file" id="walletQRFile" class="login-input" accept="image/*"
                onchange="previewWalletQR(event)" style="padding: 5px;">
              <img id="walletQRPreview" src="" alt="QR Preview"
                style="width: 100px; height: 100px; object-fit: contain; border: 1px solid cyan; border-radius: 5px; display: none;">
            </div>
            <div>
              <label style="color: #ccc; font-size: 14px;">UPI ID:</label>
              <input type="text" id="walletUPI" class="login-input" placeholder="e.g. 9876543210@ybl">
            </div>
          </div>
          <button class="login-btn" onclick="saveWalletConfig()"
            style="background: gold; color: black; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); margin-top: 15px;">ðŸ’¾
            Save
            Wallet Settings</button>
        </div>
      </div>

      <!-- ADMIN PREMIUM CONTENT CMS MOVED TO PREMIUM SECTION -->

    </div>

    <!-- /DUPLICATE RECHARGES REMOVED -->

    <!-- ACTIVE PREMIUM MEMBERS & MGMT -->
    <div id="adminSection_premium" class="admin-section" style="display:none;">

      <!-- ====== SECTION 1: PREMIUM COURSE MANAGER ====== -->
      <div
        style="margin-bottom: 30px; padding: 20px; background: rgba(255,215,0,0.05); border: 1px solid rgba(255,215,0,0.3); border-radius: 12px;">
        <h3 style="color: gold; margin-top: 0;">ðŸ† Premium Course Manager</h3>
        <p style="color: #aaa; font-size: 13px;">Add/delete top-level premium courses. Each course holds multiple
          options (plans/semesters).</p>

        <!-- Add Course -->
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
          <input type="text" id="newPremCourseName" class="login-input" placeholder="New Course Name (e.g. MBA)"
            style="flex: 2; margin-bottom: 0;">
          <button class="login-btn" onclick="addPremiumCourse()"
            style="flex: 1; margin-top: 0; background: gold; color: black; min-width:120px;">âž• Add Course</button>
        </div>

        <!-- Delete Course -->
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
          <select id="deletePremCourseSelect" class="login-input" style="flex: 2; margin: 0;">
            <option value="" disabled selected>Select Course to Delete</option>
          </select>
          <button class="login-btn" onclick="deletePremiumCourse()"
            style="flex: 1; margin-top: 0; background: #ff4757; color: white; min-width:120px;">ðŸ—‘ï¸ Delete
            Course</button>
        </div>

        <!-- Live Course List -->
        <div id="premCourseListDisplay" style="margin-top: 15px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
      </div>

      <!-- ====== SECTION 2: PREMIUM CONTENT MANAGEMENT ====== -->
      <div id="adminPremiumCMS"
        style="margin-bottom: 40px; border-bottom: 2px solid rgba(255,215,0,0.3); padding-bottom: 30px;">
        <h3 style="color: gold; text-align: left;">ðŸ’Ž Premium Content Management</h3>
        <p style="color: #aaa; font-size: 13px;">Select a course & option to set prices, manage sub-options, and
          upload
          PDF/Image/Video files.</p>

        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
          <select id="premCmsCourse" class="login-input" style="flex: 1; margin: 0; min-width: 120px;"
            onchange="onPremCourseChange()">
            <option value="" disabled selected>Select Premium Course</option>
          </select>
          <select id="premCmsOption" class="login-input" style="flex: 1; margin: 0; min-width: 120px;"
            onchange="onPremOptionChange()">
            <option value="" disabled selected>Select Option</option>
          </select>
          <button onclick="deletePremiumOption()"
            style="background:#ff4757; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:bold; white-space:nowrap;">ðŸ—‘ï¸
            Del Option</button>
          <button onclick="renamePremiumOption()"
            style="background:#6c5ce7; color:white; border:none; padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:bold; white-space:nowrap;">âœï¸
            Rename</button>
        </div>

        <div id="premEditor" style="display: none; text-align: left;">
          <!-- Price Settings -->
          <div
            style="display:grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: flex-end; margin-bottom:15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
            <div>
              <h4 id="activePremOptionTitle" style="color:cyan; margin:0; font-size:14px;">Editing: ...</h4>
            </div>
            <div>
              <label style="color:#aaa; font-size:10px; display:block;">Price (Coins):</label>
              <input type="number" id="premOptionPrice" placeholder="49" class="login-input"
                style="width:100%; margin:0; padding:8px;">
            </div>
            <div>
              <label style="color:#aaa; font-size:10px; display:block;">Duration (Days):</label>
              <input type="number" id="premOptionDuration" placeholder="365" class="login-input"
                style="width:100%; margin:0; padding:8px;">
            </div>
            <button onclick="saveOptionPrice()"
              style="background:gold; color:black; border:none; padding:10px 15px; border-radius:4px; font-weight:bold; cursor:pointer; height:fit-content;">SET
              PRICE</button>
          </div>

          <!-- Add New Option -->
          <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: stretch;">
            <input type="text" id="newPremOptionName" class="login-input"
              placeholder="Create New Option (e.g. MBA Agra)" style="flex: 2; margin-bottom: 0;">
            <button class="login-btn" onclick="addPremiumOption()"
              style="flex: 1; margin-top: 0; background: gold; color: black;">âž• Add Option</button>
          </div>

          <!-- ======= SUB-OPTIONS MANAGER ======= -->
          <div
            style="background: rgba(108,92,231,0.08); border: 1px solid rgba(108,92,231,0.4); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: #a29bfe; margin-top: 0;">ðŸ“‚ Sub-Options (Chapters / Modules)</h4>
            <p style="color: #888; font-size: 12px; margin-top: 0;">Add sub-options under the selected option. Each
              sub-option can hold its own PDF, Image, & Video uploads.</p>

            <!-- Add Sub-Option -->
            <div style="display: flex; gap: 10px; margin-bottom: 12px; flex-wrap: wrap;">
              <input type="text" id="newPremSubOptionName" class="login-input"
                placeholder="Sub-Option Name (e.g. Semester 1)" style="flex: 2; margin-bottom: 0;">
              <button class="login-btn" onclick="addPremiumSubOption()"
                style="flex: 1; margin-top: 0; background: #a29bfe; color: black; min-width: 120px;">âž• Add
                Sub-Option</button>
            </div>

            <!-- Sub-Option List -->
            <div id="premSubOptionList" style="max-height: 300px; overflow-y: auto;">
              <p style="color: #666; font-style: italic; text-align: center;">Select an option first to manage
                sub-options.</p>
            </div>
          </div>

          <!-- ======= MEDIA UPLOAD FOR OPTION ======= -->
          <div
            style="background: rgba(0,255,255,0.05); border: 1px solid rgba(0,255,255,0.2); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
            <h4 style="color: cyan; margin-top: 0;">ðŸ“¤ Upload Files to Selected Option</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
              <div>
                <label style="color: #aaa; font-size: 12px;">ðŸ“„ PDF Title:</label>
                <input type="text" id="newPremPdfTitle" class="login-input" placeholder="e.g. Chapter 1 Notes"
                  style="margin-bottom: 8px;">
                <label style="color: #aaa; font-size: 12px;">ðŸ”— PDF Link (Drive/URL):</label>
                <input type="text" id="newPremPdfLink" class="login-input" placeholder="https://drive.google.com/...">
                <button class="login-btn" onclick="addPremiumPdf()"
                  style="background: #00cec9; color: black; margin-top: 5px;">âž• Add PDF Link</button>
              </div>
              <div>
                <label style="color: #aaa; font-size: 12px;">ðŸ–¼ï¸ Image Title:</label>
                <input type="text" id="newPremImgTitle" class="login-input" placeholder="e.g. Mind Map"
                  style="margin-bottom: 8px;">
                <label style="color: #aaa; font-size: 12px;">ðŸ”— Image Link (URL):</label>
                <input type="text" id="newPremImgLink" class="login-input" placeholder="https://...">
                <button class="login-btn" onclick="addPremiumImage()"
                  style="background: #fd79a8; color: black; margin-top: 5px;">âž• Add Image Link</button>
              </div>
            </div>
            <div style="margin-top: 12px;">
              <label style="color: #aaa; font-size: 12px;">ðŸŽ¬ Video Title:</label>
              <input type="text" id="newPremVideoTitle" class="login-input" placeholder="e.g. Lecture 1"
                style="margin-bottom: 8px;">
              <label style="color: #aaa; font-size: 12px;">ðŸ”— Video Link (YouTube/Drive):</label>
              <input type="text" id="newPremVideoLink" class="login-input" placeholder="https://youtube.com/...">
              <button class="login-btn" onclick="addPremiumVideo()"
                style="background: #e17055; color: white; margin-top: 5px;">âž• Add Video Link</button>
            </div>
          </div>

          <!-- Existing Files in Option -->
          <h4 style="color: #ddd;">ðŸ“ Files in Selected Option</h4>
          <ul id="adminPremPdfList" style="list-style: none; padding: 0; max-height: 250px; overflow-y: auto;"></ul>
        </div>
      </div>

      <div id="adminActivePremium" style="margin-top: 0; border: none; padding-top: 0;">
        <h3 style="color: gold; text-align: left;">ðŸ’Ž Active Premium Members</h3>
        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; overflow-x: auto;">
          <table style="width: 100%; text-align: left; border-collapse: collapse;">
            <thead>
              <tr style="border-bottom: 1px solid gold;">
                <th style="padding: 10px; color: gold;">Student</th>
                <th style="padding: 10px; color: gold;">Mobile</th>
                <th style="padding: 10px; color: gold;">Detailed Plans</th>
              </tr>
            </thead>
            <tbody id="activePremiumTableBody">
              <!-- Dynamically populated -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 8. CERTIFICATE BROKERAGE MANAGER -->
    <div id="adminSection_certificates" class="admin-section" style="display:none;">
      <div
        style="padding:20px; background:rgba(0,242,254,0.05); border:1px solid rgba(0,242,254,0.3); border-radius:12px;">
        <h3 style="color:cyan; margin-top:0;">ðŸ“œ Certificate Brokerage Manager</h3>
        <p style="color:#aaa; font-size:13px;">Add and manage external certificates that students can unlock with coins.
        </p>

        <div class="cert-admin-form">
          <h4 style="color:#fff; margin-top:0;">âž• Add New Certificate</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <input type="text" id="adminCertTitle" class="login-input"
              placeholder="Certificate Title (e.g. AI Mastery)">
            <input type="number" id="adminCertPrice" class="login-input" placeholder="Price (Coins)">

            <div style="display: flex; flex-direction: column; gap: 5px;">
              <label style="color: #aaa; font-size: 11px;">ðŸ“‚ Upload Image (Recommended 16:9):</label>
              <input type="file" id="adminCertFileUpload" class="login-input" accept="image/*" style="padding: 5px;">
            </div>

            <div style="display: flex; flex-direction: column; gap: 5px;">
              <label style="color: #aaa; font-size: 11px;">ðŸ”— OR Paste Image/Drive URL:</label>
              <input type="text" id="adminCertImage" class="login-input" placeholder="https://drive.google.com/...">
            </div>

            <input type="text" id="adminCertLink" class="login-input" placeholder="Partner/Redirection Link"
              style="grid-column: span 2;">
          </div>
          <div style="margin-top: 15px;">
            <textarea id="adminCertInstructions" class="login-input"
              placeholder="Claim Instructions / Guidelines (e.g. Step 1: Visit link, Step 2: Use code...)"
              style="height: 80px;"></textarea>
          </div>
          <button class="login-btn" onclick="addAdminCertificate()"
            style="background: cyan; color: black; margin-top: 15px;">ðŸš€ Publish Certificate</button>
        </div>

        <h4 style="color:cyan;">ðŸ“¦ Existing Certificates</h4>
        <div id="adminCertList" class="cert-admin-grid">
          <p style="color:#666;">No certificates added yet.</p>
        </div>
      </div>
    </div>

    <!-- 5. SITE SETTINGS & BATTLES -->
    <div id="adminSection_settings" class="admin-section" style="display:none;">
      <!-- SITE SETTINGS -->
      <div id="adminSiteSettings"
        style="margin-top: 40px; border-top: 1px solid rgba(0, 255, 255, 0.3); padding-top: 20px; margin-bottom: 40px;">
        <h3 style="color: cyan; text-align: left;">âš™ï¸ Advanced Site Settings</h3>
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <div>
            <label style="color: #ccc; font-size: 14px;">Enable Premium Hub Globally:</label>
            <select id="sitePremiumToggle" class="login-input" style="margin-bottom: 0;">
              <option value="true">ON (Users can see Premium Hub)</option>
              <option value="false">OFF (Hide Premium Hub)</option>
            </select>
          </div>
          <div>
            <label style="color: #ccc; font-size: 14px;">Live Scrolling Announcement (Top Ticker):</label>
            <input type="text" id="siteTickerText" class="login-input"
              placeholder="Type announcement here... Leave blank to hide." style="margin-bottom: 0;">
          </div>
          <div>
            <label style="color: #ccc; font-size: 14px;">Welcome Subtitle (under logo):</label>
            <input type="text" id="siteWelcomeText" class="login-input" placeholder="e.g. Your Digital Learning Hub"
              style="margin-bottom: 0;">
          </div>
          <div>
            <label style="color: #ccc; font-size: 14px;">About Us Content:</label>
            <textarea id="siteAboutText" class="login-input" placeholder="Welcome to NextGen Library..."
              style="height: 80px; margin-bottom: 0;"></textarea>
          </div>

          <div style="margin-top: 15px; border-top: 1px dashed cyan; padding-top: 15px;">
            <label style="color: cyan; font-size: 16px; font-weight: bold;">ðŸ–¼ï¸ Announcement Banners
              (Auto-Swiping)</label>
            <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-top: 10px;">
              <input type="file" id="siteBannerImageInput" accept="image/*" class="login-input" style="padding: 5px;">
              <input type="text" id="siteBannerLinkInput" class="login-input"
                placeholder="Redirect Link (e.g. https://google.com) Optional">
              <button class="login-btn" onclick="addSiteBanner()"
                style="background: #00cec9; color: black; margin-top: 0;">âž• Add Banner</button>
            </div>
            <ul id="adminBannerList"
              style="list-style: none; padding: 0; margin-top: 15px; max-height: 250px; overflow-y: auto;">
              <!-- Banners injected here -->
            </ul>
          </div>

        </div>

        <div style="margin-top: 20px;">
          <button onclick="saveSiteSettings()" class="login-btn" style="background: cyan; color: black;">ðŸ’¾ SAVE SITE
            CONFIGURATION</button>
        </div>
      </div>
    </div>

    <!-- ====== SECTION: SECURITY SETTINGS ====== -->
    <div id="adminSection_security" class="admin-section" style="display:none;">
      <h3 style="color: gold; text-align: left;">ðŸ” Admin Security Settings</h3>
      <p style="color: #aaa; font-size: 14px;">Update your Admin Login credentials below. <b>WARNING:</b> Your new
        password will be your login from now on.</p>

      <div class="box"
        style="border: 1px solid gold; background: rgba(255,215,0,0.05); padding: 25px; max-width: 500px; margin: 20px 0;">
        <div style="margin-bottom: 15px;">
          <label style="color: #ccc; font-size: 14px; display: block; margin-bottom: 5px;">New Username:</label>
          <input type="text" id="newAdminUser" class="login-input" placeholder="Enter new username" style="margin:0;">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="color: #ccc; font-size: 14px; display: block; margin-bottom: 5px;">New Password:</label>
          <input type="password" id="newAdminPass" class="login-input" placeholder="Enter new password"
            style="margin:0;">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="color: #ccc; font-size: 14px; display: block; margin-bottom: 5px;">Confirm New
            Password:</label>
          <input type="password" id="confirmAdminPass" class="login-input" placeholder="Confirm new password"
            style="margin:0;">
        </div>

        <button onclick="updateAdminCredentials()" class="login-btn"
          style="background: gold; color: black; font-weight: 900; margin-top: 15px; width: 100%;">ðŸ’¾ SAVE & UPDATE
          CREDENTIALS</button>
      </div>
    </div>

    <!-- 6. NEXTGEN BATTLE ARENA MANAGER -->
    <div id="adminSection_battles" class="admin-section" style="display:none;">
      <div id="adminBattleManager"
        style="margin-top: 0; border-top: 2px solid #ff4757; padding-top: 20px; background: rgba(255, 71, 87, 0.05); padding: 20px; border-radius: 15px;">
        <h3 style="color: #ff4757; text-align: left; margin-top: 0;">âš”ï¸ NextGen Battle Arena Manager</h3>
        <p style="color: #ccc; font-size: 14px;">Create and manage competitive MCQ battles for students.</p>

        <div style="margin-bottom: 15px;">
          <input type="text" id="battleTitle" class="login-input" placeholder="Battle Title (e.g. Weekly Math Combat)">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <div style="display: flex; gap: 5px; align-items: stretch;">
            <select id="battleCourse" class="login-input" onchange="updateBattleSubjects()" style="flex: 1; margin: 0;">
              <option value="" disabled selected>Target Course</option>
            </select>
            <button onclick="populateBattleCourses()"
              style="background: rgba(0,242,254,0.1); border: 1px solid cyan; color: cyan; padding: 0 10px; border-radius: 8px; cursor: pointer; height: 45px;"
              title="Refresh Courses">ðŸ”„</button>
          </div>
          <select id="battleSubject" class="login-input" onchange="updateBattleChapters()">
            <option value="" disabled selected>Target Subject</option>
          </select>
          <select id="battleChapter" class="login-input" style="grid-column: span 2;">
            <option value="ALL">ALL CHAPTERS (Subject-wise Battle)</option>
          </select>
          <input type="number" id="battleEntryFee" class="login-input" placeholder="Entry Fee (â‚¹)">
          <input type="number" id="battleMaxStudents" class="login-input" placeholder="Max Participating Students">
          <input type="number" id="battlePrizePool" class="login-input" placeholder="Initial Prize Pool (â‚¹)">
          <input type="datetime-local" id="battleStartTime" class="login-input">
          <input type="text" id="battleUPI" class="login-input" placeholder="UPI ID for this battle (e.g. user@okaxis)">
          <div style="grid-column: span 2;">
            <label style="color: #888; font-size: 12px; display: block; margin-bottom: 5px;">Battle-Specific QR Code
              (Optional):</label>
            <input type="file" id="battleQRInput" accept="image/*" class="login-input" style="padding: 5px;">
          </div>
        </div>

        <!-- QUESTION BUILDER -->
        <div
          style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; border: 1px dashed #ff4757; margin-bottom: 20px;">
          <h4 style="color: #fff; margin-top: 0;">ðŸ“ Question Builder</h4>
          <textarea id="battleQuestText" class="login-input" placeholder="Enter Question here..."
            style="height: 60px;"></textarea>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <input type="text" id="battleOpt1" class="login-input" placeholder="Option A">
            <input type="text" id="battleOpt2" class="login-input" placeholder="Option B">
            <input type="text" id="battleOpt3" class="login-input" placeholder="Option C">
            <input type="text" id="battleOpt4" class="login-input" placeholder="Option D">
          </div>
          <div style="margin-top: 10px;">
            <input type="number" id="battleDuration" class="login-input" placeholder="Battle Duration (Minutes)">
          </div>
          <select id="battleCorrectOpt" class="login-input">
            <option value="" disabled selected>Select Correct Option</option>
            <option value="A">Option A</option>
            <option value="B">Option B</option>
            <option value="C">Option C</option>
            <option value="D">Option D</option>
          </select>
          <button class="login-btn" onclick="addBattleQuestion()" style="background: #ff4757; color: white;">âž• Add
            Question To Battle</button>

          <!-- QUESTION PREVIEW AND STATS -->
          <div
            style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <span id="battleQuestCount" style="color: cyan; font-weight: bold; font-size: 14px;">Total Questions:
              0</span>
            <span id="battleTotalMarks" style="color: gold; font-weight: bold; font-size: 14px;">Total Marks:
              0</span>
          </div>

          <div id="battleQuestionPreviewList"
            style="margin-top: 15px; max-height: 300px; overflow-y: auto; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px;">
            <p style="color: #666; font-style: italic; text-align: center;">No questions added yet.</p>
          </div>

          <div id="battleQuestionList" style="display:none;"></div>
        </div>

        <button class="login-btn" onclick="publishBattle()"
          style="background: linear-gradient(90deg, #ff4757, #ff6b81); color: white; font-weight: 900; letter-spacing: 2px; margin-bottom: 30px;">ðŸš€
          PUBLISH BATTLE ARENA</button>

        <!-- BATTLE MANAGEMENT LIST -->
        <div style="border-top: 1px solid rgba(255, 71, 87, 0.3); padding-top: 20px;">
          <h3
            style="margin: 30px 0 15px 0; color: cyan; display: flex; justify-content: space-between; align-items: center;">
            Managed Battles âš”ï¸
            <button onclick="loadAdminBattles()"
              style="background: none; border: 1px solid cyan; color: cyan; padding: 5px 15px; border-radius: 8px; cursor: pointer; font-size: 14px;">ðŸ”„
              Refresh List</button>
          </h3>
          <div
            style="overflow-x: auto; background: rgba(0,242,254,0.02); border-radius: 12px; border: 1px solid rgba(0,242,254,0.1);">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
              <thead>
                <tr style="background: rgba(0,242,254,0.1); color: cyan; text-align: left;">
                  <th style="padding: 12px;">Battle Info</th>
                  <th style="padding: 12px;">Schedule</th>
                  <th style="padding: 12px;">Stats</th>
                  <th style="padding: 12px;">Actions</th>
                </tr>
              </thead>
              <tbody id="adminBattleTableBody"></tbody>
            </table>
          </div>
        </div>

        <!-- BATTLE BOOKING VERIFICATION -->
        <div style="border-top: 1px solid rgba(255, 71, 87, 0.3); padding-top: 20px; margin-top: 30px;">
          <h4 style="color: #ff4757; text-align: left;">âœ… Battle Booking Approvals</h4>
          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px; color: #eee;">
              <thead>
                <tr style="border-bottom: 1px solid rgba(255, 71, 87, 0.2); text-align: left;">
                  <th style="padding: 10px;">User</th>
                  <th style="padding: 10px;">Battle</th>
                  <th style="padding: 10px;">Proof</th>
                  <th style="padding: 10px;">Action</th>
                </tr>
              </thead>
              <tbody id="battleBookingTableBody">
                <!-- Bookings injected here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="margin-top: 15px; border-top: 1px dashed cyan; padding-top: 15px;">
        <label style="color: cyan; font-size: 16px; font-weight: bold;">ðŸ”” Push Notifications (Broadcast)</label>
        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; margin-top: 10px;">
          <p style="color: #ccc; font-size: 14px; margin-top: 0; margin-bottom: 15px;">Send a real-time notification
            to all active web users.</p>
          <input type="text" id="notifTitle" class="login-input"
            placeholder="Notification Title (e.g., New Premium Content!)" style="margin-bottom: 10px;">
          <textarea id="notifBody" class="login-input" placeholder="Notification Body/Message..."
            style="height: 60px; margin-bottom: 10px;"></textarea>
          <button class="login-btn" onclick="sendBroadcastNotification()"
            style="background: #00cec9; color: black; margin-top: 0;">ðŸš€ Send Notification</button>
        </div>
      </div>
    </div>

    <!-- 7. CODE STUDIO ADMIN -->
    <div id="adminSection_codeStudio" class="admin-section" style="display:none;">
      <div
        style="padding:20px; background:rgba(0,184,148,0.05); border:1px solid rgba(0,184,148,0.3); border-radius:12px;">
        <h3 style="color:#00b894; margin-top:0;">ðŸ’» Code Studio Manager</h3>
        <p style="color:#aaa; font-size:13px;">Enable and manage Code Studio usage limits and pricing.</p>

        <div style="background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <h4 style="color: #00b894; margin-top: 0;">âš™ï¸ Usage Limit Settings</h4>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; align-items: center;">
            <div>
              <label style="color: #ccc; font-size: 14px; display: block; margin-bottom: 5px;">Free Usage Limit
                (Uses):</label>
              <input type="number" id="csFreeLimitInput" class="login-input" style="margin: 0; padding: 8px;"
                placeholder="2">
            </div>
            <div>
              <label style="color: #ccc; font-size: 14px; display: block; margin-bottom: 5px;">Trial Duration
                (Hours):</label>
              <input type="number" id="csTrialHoursInput" class="login-input" style="margin: 0; padding: 8px;"
                placeholder="24">
            </div>
            <div style="grid-column: span 1;">
              <label style="color: #ccc; font-size: 14px; display: block; margin-bottom: 5px;">Premium Price
                (Coins):</label>
              <input type="number" id="csPremiumPriceInput" class="login-input" style="margin: 0; padding: 8px;"
                placeholder="50">
            </div>
            <div style="grid-column: span 1;">
              <label style="color: #ccc; font-size: 14px; display: block; margin-bottom: 5px;">Premium Validity
                (Days):</label>
              <input type="number" id="csPremiumValidityInput" class="login-input" style="margin: 0; padding: 8px;"
                placeholder="365">
            </div>
          </div>
          <div style="margin-top: 15px; display: flex; gap: 15px;">
            <label style="color: #eee; font-size: 14px; display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="csLimitEnabled" style="width: 18px; height: 18px;"> Enable Usage Limit
            </label>
          </div>
          <button class="login-btn" onclick="saveCodeStudioAdminSettings()"
            style="background: #00b894; color: black; margin-top: 15px;">ðŸ’¾ Save Admin Settings</button>
        </div>

        <h4 style="color:#00b894;">ðŸ“¦ Language Support</h4>
        <div id="adminCodeStudioLangs" style="margin-top:15px; margin-bottom: 25px;">
          <p style="color:#666;">Loading...</p>
        </div>

        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin: 20px 0;">

        <h4 style="color:gold;">ðŸŒŸ Premium Members Dashboard</h4>
        <div style="overflow-x:auto; margin-top:15px;">
          <table class="admin-table" style="width:100%; min-width:600px;">
            <thead>
              <tr>
                <th>User Name</th>
                <th>Mobile NO.</th>
                <th>Premium Since</th>
                <th>Expiry Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="csPremiumUsersList">
              <tr>
                <td colspan="5" style="text-align:center; padding:20px; color:#666;">Loading members list...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <!-- WELCOME -->
  <div id="welcomeScreen" style="display:none;">
    <div style="position: absolute; top: 20px; right: 20px;">
      <button onclick="openEditProfile()"
        style="font-size: 14px; padding: 10px 20px; background: rgba(0, 242, 254, 0.1); border: 1px solid rgba(0, 242, 254, 0.5); border-radius: 8px; color: #00f2fe; cursor: pointer; backdrop-filter: blur(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.2);">âœï¸
        Edit Profile</button>
    </div>

    <!-- CSS Floating shapes for VFX -->
    <div style="position: absolute; width: 100%; height: 100%; overflow: hidden; z-index: -1;">
      <div
        style="position: absolute; top: 10%; left: 15%; width: 100px; height: 100px; background: radial-gradient(circle, rgba(0,242,254,0.4), transparent); filter: blur(20px); animation: float 6s ease-in-out infinite;">
      </div>
      <div
        style="position: absolute; bottom: 20%; right: 10%; width: 150px; height: 150px; background: radial-gradient(circle, rgba(79,172,254,0.3), transparent); filter: blur(30px); animation: float 8s ease-in-out infinite reverse;">
      </div>
    </div>
    <style>
      @keyframes float {
        0% {
          transform: translateY(0px) rotate(0deg);
        }

        50% {
          transform: translateY(-20px) rotate(10deg);
        }

        100% {
          transform: translateY(0px) rotate(0deg);
        }
      }

      .admin-tab-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(0, 242, 254, 0.2);
        color: #aaa;
        padding: 10px 18px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        font-size: 13px;
        white-space: nowrap;
        transition: 0.3s;
      }

      .admin-tab-btn:hover {
        background: rgba(0, 242, 254, 0.1);
        color: cyan;
      }

      .admin-tab-btn.active {
        background: cyan;
        color: black;
        border-color: cyan;
        box-shadow: 0 0 10px rgba(0, 242, 254, 0.4);
      }

      .admin-section {
        animation: fadeIn 0.4s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }

        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>

    <img src="img1.png" alt="NextGen Library"
      style="width:220px; height:220px; margin-bottom:20px; filter:drop-shadow(0 0 25px rgba(0, 242, 254, 0.6)); animation: float 4s ease-in-out infinite;">
    <h1 id="typingText"></h1>
    <p id="welcomeSubtitle" class="neural-subtitle">Your Digital Learning Hub</p>
    <button onclick="enterSite()" style="padding: 15px 40px; font-size: 18px; border-radius: 30px;">Enter
      Library</button>
  </div>

  <!-- PROGRAMS VIEW WITH INFO -->
  <div id="programsWrapper" style="display:none;">
    <div id="homeSliderContainer" style="display:none;"></div>
    <div class="subjects" id="programs">
      <!-- Courses injected dynamically -->
      <div class="box premium-box" onclick="openPremiumHub()" id="premiumLinkBox">
        <h1>ðŸ’Ž</h1>Premium Notes & Book
      </div>
      <div class="box" id="codeStudioBox" onclick="openCodeStudio()"
        style="border-color: #00b894; background: rgba(0,184,148,0.05); box-shadow: 0 0 15px rgba(0,184,148,0.2);">
        <h1 style="color: #00b894;">ðŸ’»</h1>Code Studio
      </div>
      <div class="box" id="battleArenaBox" onclick="openBattleArena()"
        style="border-color: #ff4757; background: rgba(255, 71, 87, 0.05); box-shadow: 0 0 15px rgba(255, 71, 87, 0.2);">
        <h1 style="color: #ff4757;">âš”ï¸</h1>NextGen Battle Arena
      </div>
      <div class="box" id="certStoreBox" onclick="openCertificateStore()"
        style="border-color: cyan; background: rgba(0,242,254,0.05); box-shadow: 0 0 15px rgba(0,242,254,0.2);">
        <h1 style="color: cyan;">ðŸ“œ</h1>Premium Certifications
      </div>
      <div class="box" id="myCollBox" onclick="openMyCollection()"
        style="border-color: #00f2fe; background: rgba(0,242,254,0.05); box-shadow: 0 0 15px rgba(0,242,254,0.2);">
        <h1 style="color: #00f2fe;">ðŸ“‚</h1>My Collection
      </div>
    </div>
  </div>

  <!-- BATTLE ARENA VIEW -->
  <!-- ========== CODE STUDIO ========== -->
  <div id="codeStudioScreen"
    style="display:none; min-height:100vh; background: #0a0f1e; font-family: 'Segoe UI', sans-serif;">
    <style>
      #csEditor {
        font-family: 'Courier New', monospace;
        font-size: 14px;
        background: #0d1117;
        color: #e6edf3;
        border: none;
        outline: none;
        resize: none;
        width: 100%;
        height: 100%;
        line-height: 1.6;
        padding: 15px;
        box-sizing: border-box;
        tab-size: 2;
      }

      .cs-tab-btn {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(0, 184, 148, 0.3);
        color: #aaa;
        padding: 6px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: 0.2s;
        white-space: nowrap;
      }

      .cs-tab-btn:hover,
      .cs-tab-btn.active {
        background: #00b894;
        color: #000;
        border-color: #00b894;
      }

      .cs-proj-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 10px;
        background: rgba(255, 255, 255, 0.04);
        border-radius: 6px;
        margin-bottom: 5px;
        cursor: pointer;
        border-left: 3px solid transparent;
        transition: 0.2s;
        font-size: 13px;
      }

      .cs-proj-item:hover {
        border-left-color: #00b894;
        background: rgba(0, 184, 148, 0.08);
      }

      .cs-proj-item.active {
        border-left-color: #00b894;
        background: rgba(0, 184, 148, 0.12);
        color: #00b894;
      }
    </style>

    <!-- TOP BAR -->
    <div
      style="display:flex; align-items:center; justify-content:space-between; padding:10px 20px; background:rgba(0,0,0,0.5); border-bottom:1px solid rgba(0,184,148,0.3); flex-wrap:wrap; gap:10px;">
      <div style="display:flex; align-items:center; gap:12px;">
        <button onclick="showPage('programsWrapper')"
          style="background:rgba(0,184,148,0.1); border:1px solid #00b894; color:#00b894; padding:7px 15px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:13px;">â¬…
          Back</button>
        <h2 style="margin:0; color:#00b894; font-size:18px;">ðŸ’» NextGen Code Studio</h2>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <select id="csLangSelect" onchange="onCSLangChange()"
          style="background:#0d1117; color:#e6edf3; border:1px solid rgba(0,184,148,0.4); padding:7px 12px; border-radius:6px; font-size:13px; cursor:pointer;"></select>
        <button onclick="runCode()" id="csRunBtn"
          style="background:linear-gradient(90deg,#00b894,#00cec9); color:#000; border:none; padding:8px 20px; border-radius:6px; font-weight:900; cursor:pointer; font-size:14px; letter-spacing:1px;">â–¶
          RUN</button>
        <button onclick="clearEditor()"
          style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.2); color:#aaa; padding:7px 14px; border-radius:6px; cursor:pointer; font-size:13px;">ðŸ—‘ï¸
          Clear</button>
        <button onclick="saveProject()"
          style="background:rgba(0,184,148,0.15); border:1px solid #00b894; color:#00b894; padding:7px 14px; border-radius:6px; cursor:pointer; font-size:13px; font-weight:bold;">ðŸ’¾
          Save</button>
        <button onclick="newProject()"
          style="background:rgba(108,92,231,0.15); border:1px solid #6c5ce7; color:#a29bfe; padding:7px 14px; border-radius:6px; cursor:pointer; font-size:13px; font-weight:bold;">âž•
          New</button>
      </div>
    </div>

    <!-- MAIN LAYOUT -->
    <div style="display:flex; height:calc(100vh - 60px);">

      <!-- LEFT: PROJECT SIDEBAR -->
      <div
        style="width:220px; flex-shrink:0; background:rgba(0,0,0,0.4); border-right:1px solid rgba(0,184,148,0.15); display:flex; flex-direction:column; overflow:hidden;">
        <div style="padding:12px; border-bottom:1px solid rgba(255,255,255,0.08);">
          <h4 style="color:#00b894; margin:0 0 8px 0; font-size:13px; letter-spacing:1px;">ðŸ“ MY PROJECTS</h4>
          <input id="csSearchProj" type="text" placeholder="Search..." oninput="filterProjects()"
            style="width:100%; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:#eee; padding:5px 8px; border-radius:5px; font-size:12px; box-sizing:border-box;">
        </div>
        <div id="csProjList" style="flex:1; overflow-y:auto; padding:10px;">
          <p style="color:#555; font-size:12px; text-align:center; margin-top:20px;">Login to see projects</p>
        </div>
        <div style="padding:10px; border-top:1px solid rgba(255,255,255,0.08);">
          <div id="csCurrentProject"
            style="color:#00b894; font-size:11px; font-weight:bold; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
            No file open</div>
        </div>
      </div>

      <!-- CENTER: EDITOR + OUTPUT -->
      <div style="flex:1; display:flex; flex-direction:column; overflow:hidden;">

        <!-- EDITOR -->
        <div style="flex:1; position:relative; min-height:200px;">
          <div style="position:absolute; top:0; left:0; width:100%; height:100%;">
            <textarea id="csEditor" placeholder="// Write your code here..." spellcheck="false"
              onkeydown="handleEditorTab(event)"></textarea>
          </div>
        </div>

        <!-- OUTPUT PANEL -->
        <div
          style="height:220px; background:#0a0f1e; border-top:2px solid rgba(0,184,148,0.3); display:flex; flex-direction:column;">
          <div
            style="display:flex; justify-content:space-between; align-items:center; padding:6px 15px; background:rgba(0,0,0,0.5); border-bottom:1px solid rgba(255,255,255,0.08);">
            <span style="color:#00b894; font-size:12px; font-weight:bold; letter-spacing:1px;">ðŸ“¤ OUTPUT</span>
            <div style="display:flex; gap:8px;">
              <button onclick="clearOutput()"
                style="background:none; border:1px solid rgba(255,255,255,0.15); color:#777; padding:3px 10px; border-radius:4px; cursor:pointer; font-size:11px;">Clear</button>
              <span id="csExecTime" style="color:#777; font-size:11px; align-self:center;"></span>
            </div>
          </div>
          <div id="csOutput"
            style="flex:1; overflow-y:auto; padding:12px 15px; font-family:'Courier New',monospace; font-size:13px; color:#e6edf3; white-space:pre-wrap; line-height:1.6;">
            <span style="color:#555;">â–¶ Click RUN to execute your code...</span>
          </div>
        </div>

      </div>

      <!-- RIGHT: HINTS & STDIN -->
      <div
        style="width:240px; flex-shrink:0; background:rgba(0,0,0,0.3); border-left:1px solid rgba(255,255,255,0.07); display:flex; flex-direction:column; overflow:hidden;">

        <!-- STDIN (hidden by default) -->
        <div style="display:none; padding:10px; border-bottom:1px solid rgba(255,255,255,0.08);">
          <label style="color:#aaa; font-size:11px; font-weight:bold; letter-spacing:1px;">ðŸ“¥ INPUT (stdin)</label>
          <textarea id="csStdin" placeholder="Enter program input here..."
            style="width:100%; height:80px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.1); color:#eee; border-radius:5px; resize:none; font-size:12px; padding:6px; margin-top:5px; box-sizing:border-box; font-family:monospace;"></textarea>
        </div>

        <!-- HINGLISH ERROR BOX -->
        <div style="padding:10px; flex:1; overflow-y:auto;">
          <label style="color:#fd79a8; font-size:11px; font-weight:bold; letter-spacing:1px;">ðŸ¤– SMART ERROR
            (Hinglish)</label>
          <div id="csHinglishError"
            style="margin-top:8px; color:#ddd; font-size:12px; line-height:1.7; background:rgba(255,100,100,0.05); border:1px solid rgba(255,100,100,0.1); border-radius:6px; padding:10px; min-height:60px;">
            <span style="color:#555;">Koi error nahi â€” sab theek hai! âœ…</span>
          </div>
        </div>

        <!-- LANGUAGE INFO -->
        <div style="padding:10px; border-top:1px solid rgba(255,255,255,0.08);">
          <div id="csLangInfo" style="color:#777; font-size:11px; line-height:1.5;"></div>
        </div>
      </div>
    </div>

    <!-- PREMIUM OVERLAY -->
    <div id="csPremiumOverlay"
      style="display:none; position:absolute; inset:0; z-index:100; background:rgba(10,15,30,0.95); backdrop-filter:blur(10px); display:none; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding:30px;">
      <div
        style="max-width:400px; padding:40px; border:2px solid gold; border-radius:24px; background:rgba(0,0,0,0.4); box-shadow:0 0 40px rgba(255,215,0,0.3); animation: fadeIn 0.5s;">
        <h1 style="font-size:60px; margin:0;">ðŸ”’</h1>
        <h1 style="color:gold; font-size:28px; margin:15px 0; letter-spacing:1px;">PREMIUM ACCESS</h1>
        <p style="color:#eee; font-size:16px;">Appne apana free limits (2 baar) use kar liya hai.</p>
        <p style="color:#aaa; font-size:14px; margin-bottom:30px;">Unlimited coding journeys unlock karne ke liye
          <b>NextGen Premium</b> choose karein.
        </p>
        <div
          style="background:rgba(255,215,0,0.1); border:1px dashed gold; border-radius:15px; padding:20px; margin-bottom:30px;">
          <span style="color:#aaa; font-size:12px; display:block; text-transform:uppercase;">Price</span>
          <span style="color:gold; font-size:32px; font-weight:bold;">ðŸª™ <span id="csPremiumPriceDisplay">50</span>
            Gold</span>
        </div>
        <button class="login-btn" onclick="buyCodeStudioPremium()"
          style="background:linear-gradient(90deg, gold, #ffaa00); color:black; font-weight:900; width:100%; height:50px; border-radius:12px;">ðŸš€
          UNLOCK UNLIMITED</button>
        <button onclick="showPage('programsWrapper')"
          style="background:none; border:none; color:#666; margin-top:20px; cursor:pointer; font-size:13px;">Wapis
          Jayein</button>
      </div>
    </div>
  </div>
  <!-- ========== /CODE STUDIO ========== -->

  <div id="combatArena" style="display:none; padding: 20px; max-width: 800px; margin: 0 auto;">
    <button onclick="showPage('programsWrapper')"
      style="margin-bottom:20px; padding: 10px 20px; background: rgba(255, 71, 87, 0.1); border: 1px solid #ff4757; color: #ff4757; border-radius: 5px; cursor: pointer; font-weight: bold;">â¬…
      Back to Dashboard</button>
    <div class="wallet-status">
      <div
        style="width: 50px; height: 50px; background: gold; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: black; box-shadow: 0 0 15px gold;">
        ðŸª™</div>
      <div>
        <p style="margin: 0; color: #aaa; font-size: 12px; letter-spacing: 1px;">NEURAL WALLET BALANCE</p>
        <span class="wallet-balance">â‚¹<span id="playerWalletBalance">0.00</span></span>
      </div>
      <button onclick="topUpWallet()"
        style="margin-left: auto; padding: 8px 15px; background: transparent; border: 1px solid gold; color: gold; border-radius: 20px; cursor: pointer; font-size: 11px; font-weight: bold;">+
        RECHARGE</button>
    </div>

    <h2 style="color: #ff4757; text-align: left; margin-bottom: 25px;">âš”ï¸ Active Combat Zones</h2>
    <div id="activeBattlesContainer">
      <!-- Upcoming Battles injected here -->
      <p style="color: #666; font-style: italic;">No active battles at the moment. Check back later!</p>
    </div>

    <div style="display: flex; gap: 10px; margin-top: 20px;">
      <button onclick="openBattleLeaderboard()"
        style="flex:1; background: rgba(0,242,254,0.1); border: 1px solid cyan; color: cyan; padding: 10px; border-radius: 8px; font-size: 13px; font-weight: bold;">ðŸ“Š
        Global Battle Leaderboard</button>
    </div>

    <div style="margin-top: 40px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
      <h3 style="color: #aaa; font-size: 16px;">ðŸ“œ Battle History</h3>
      <div id="battleHistoryList" style="color: #555; font-size: 14px;">You haven't participated in any battles yet.
      </div>
    </div>
  </div>

  <!-- BATTLE EXAM ENGINE -->
  <div id="battleExamEngine"
    style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b132b; z-index: 3000; overflow-y: auto; padding-bottom: 50px;">
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
      <!-- Header -->
      <div
        style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,242,254,0.3); padding-bottom: 15px; margin-bottom: 20px;">
        <div>
          <h2 id="engineBattleTitle" style="color: cyan; margin: 0;">Battle Loading...</h2>
          <p id="engineBattleProgress" style="color: #aaa; font-size: 12px; margin: 5px 0 0 0;">Question 0/0</p>
        </div>
        <div style="text-align: right;">
          <p style="color: #ff4757; font-size: 10px; margin: 0; font-weight: bold;">TIME REMAINING</p>
          <div id="engineTimer" style="color: white; font-size: 24px; font-weight: 900; font-family: monospace;">
            00:00
          </div>
        </div>
      </div>

      <!-- Instructions (Shown initially) -->
      <div id="engineInstructions"
        style="background: rgba(15,32,39,0.8); border: 1px solid cyan; border-radius: 15px; padding: 30px; text-align: center;">
        <h1 style="color: cyan; margin-bottom: 20px;">âš”ï¸ COMBAT PROTOCOL</h1>
        <div style="text-align: left; color: #ddd; line-height: 1.8; margin-bottom: 30px;">
          <p>1. Each correct answer awards <strong>+4 MARKS</strong>.</p>
          <p>2. Each incorrect answer deducts <strong>-2 MARKS</strong> (Negative Marking).</p>
          <p>3. Do not refresh or exit the page during the battle.</p>
          <p>4. The battle will auto-submit when the timer hits zero.</p>
          <p>5. Your performance will determine your rank in the Global Battle Leaderboard.</p>
        </div>
        <button onclick="startActiveBattle()"
          style="padding: 15px 40px; font-size: 18px; border-radius: 30px; background: linear-gradient(90deg, #00f2fe, #4facfe); box-shadow: 0 0 20px cyan;">INITIATE
          COMBAT</button>
      </div>

      <!-- Question View (Hidden initially) -->
      <div id="engineQuestionView" style="display: none;">
        <div class="box" id="engineQuestionBox"
          style="min-height: auto; text-align: left; padding: 25px; margin-bottom: 20px; font-size: 18px; line-height: 1.5; border-color: cyan;">
          <p id="engineQuestionText">Loading question...</p>
        </div>
        <div id="engineOptionsContainer" style="display: grid; grid-template-columns: 1fr; gap: 15px;">
          <!-- Options injected here -->
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
          <button onclick="prevBattleQuestion()" id="prevQuestBtn"
            style="background: transparent; border: 1px solid #555; color: #555;">PREVIOUS</button>
          <button onclick="nextBattleQuestion()" id="nextQuestBtn" style="background: cyan; color: black;">NEXT
            QUESTION</button>
          <button onclick="finishBattle()" id="submitBattleBtn"
            style="display:none; background: #2ecc71; color: white;">SUBMIT BATTLE</button>
        </div>
      </div>
    </div>
  </div>

  <!-- BATTLE LEADERBOARD SECTION -->
  <div id="battleLeaderboardSection" style="display:none; background: #050a14; min-height: 100vh; padding: 20px;">
    <div style="max-width: 800px; margin: 0 auto;">
      <button onclick="showPage('combatArena')"
        style="background:rgba(255,255,255,0.05); border:1px solid rgba(0,242,254,0.3); color: cyan; padding: 10px 20px; border-radius: 12px; margin-bottom: 25px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
        <i class="fas fa-arrow-left"></i> BACK TO ARENA
      </button>

      <div style="text-align: center; margin-bottom: 30px;">
        <h1
          style="color: gold; text-shadow: 0 0 20px rgba(255,215,0,0.5); font-size: 32px; font-weight: 900; margin-bottom: 5px;">
          ðŸ“Š GLOBAL LEADERBOARD</h1>
        <p style="color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 2px;">NextGen Library |
          Official Combat Rankings</p>
      </div>

      <!-- Battle Selector -->
      <div
        style="background: rgba(15,32,39,0.8); border: 1px solid rgba(0,242,254,0.3); padding: 20px; border-radius: 20px; margin-bottom: 25px;">
        <label
          style="display: block; color: cyan; font-size: 10px; font-weight: 900; margin-bottom: 10px; text-transform: uppercase;">Select
          Battle Zone:</label>
        <select id="leaderboardBattleSelect" onchange="loadBattleRankings(this.value)"
          style="width: 100%; background: #0b132b; border: 2px solid rgba(0,242,254,0.2); color: white; padding: 12px; border-radius: 12px; font-size: 16px; outline: none; transition: 0.3s;"
          onfocus="this.style.borderColor='cyan'">
          <option value="" disabled selected>Retrieving zones...</option>
        </select>
      </div>

      <!-- Rankings Container -->
      <div id="battleRankingList" style="display: flex; flex-direction: column; gap: 15px;">
        <div style="text-align: center; padding: 50px; color: #444;">
          <i class="fas fa-trophy" style="font-size: 48px; margin-bottom: 15px; opacity: 0.2;"></i>
          <p>Please select a battle above to view ranks</p>
        </div>
      </div>
    </div>
  </div>

  </div>

  <!-- VICTORY CARD MODAL -->
  <div id="victoryCardModal"
    style="display:none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:99999; justify-content:center; align-items:center;">
    <div
      style="background: #0b132b; border: 1px solid rgba(0, 242, 254, 0.3); border-radius: 20px; padding: 25px; position: relative; max-width: 95%; box-shadow: 0 10px 50px rgba(0,0,0,1);">
      <button onclick="closeVictoryModal()"
        style="position:absolute; right:15px; top:15px; background:rgba(255,255,255,0.1); border:none; color:white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size:16px; cursor:pointer; transition: 0.3s; z-index: 10;">âœ–</button>

      <!-- THE PREMIUM CARD -->
      <div id="victoryCard"
        style="width: 500px; height: 320px; background: linear-gradient(135deg, #050a14 0%, #0b132b 100%); border: 2px solid gold; border-radius: 16px; position: relative; overflow: hidden; font-family: 'Inter', sans-serif; box-shadow: inset 0 0 50px rgba(255,215,0,0.1);">

        <!-- Background VFX -->
        <div
          style="position: absolute; top: -100px; right: -100px; width: 250px; height: 250px; background: radial-gradient(circle, rgba(255,215,0,0.1) 0%, transparent 70%); border-radius: 50%;">
        </div>
        <div
          style="position: absolute; bottom: -50px; left: -50px; width: 200px; height: 200px; background: radial-gradient(circle, rgba(0,242,254,0.1) 0%, transparent 70%); border-radius: 50%;">
        </div>

        <!-- Header -->
        <div
          style="padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid rgba(255,215,0,0.2);">
          <div
            style="width: 50px; height: 50px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid gold; box-shadow: 0 0 15px rgba(255,215,0,0.5);">
            <img src="favicon1.png" style="width: 35px; height: 35px; object-fit: contain;" alt="Logo">
          </div>
          <div>
            <h2
              style="margin: 0; color: white; font-size: 18px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase;">
              NextGen Library</h2>
            <p style="margin: 2px 0 0 0; color: #00f2fe; font-size: 10px; font-weight: 700; letter-spacing: 2px;">
              BATTLE
              ARENA OFFICIAL RECOGNITION</p>
          </div>
          <div style="margin-left: auto; text-align: center;">
            <span id="vcardMedal" style="font-size: 40px; filter: drop-shadow(0 0 10px gold);">ðŸ¥‡</span>
          </div>
        </div>

        <!-- Content -->
        <div style="padding: 20px 30px; display: flex; flex-direction: column; gap: 8px;">
          <h1
            style="margin: 0; color: gold; font-size: 20px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; text-align: center; text-shadow: 0 2px 5px rgba(0,0,0,0.5);">
            CERTIFICATE OF EXCELLENCE</h1>

          <div style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div>
                <p style="margin: 0; font-size: 9px; color: #888; text-transform: uppercase; font-weight: bold;">
                  Participant Name</p>
                <p id="vcardName" style="margin: 2px 0 0 0; font-size: 15px; color: white; font-weight: 700;">--</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 9px; color: #888; text-transform: uppercase; font-weight: bold;">Rank
                  Achieved</p>
                <p id="vcardRank" style="margin: 2px 0 0 0; font-size: 15px; color: gold; font-weight: 900;">RANK #1
                </p>
              </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 5px;">
              <div>
                <p style="margin: 0; font-size: 8px; color: #888; text-transform: uppercase;">Roll Number</p>
                <p id="vcardRoll" style="margin: 1px 0 0 0; font-size: 11px; color: #eee; font-weight: 600;">--</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 8px; color: #888; text-transform: uppercase;">University ID</p>
                <p id="vcardUniv" style="margin: 1px 0 0 0; font-size: 11px; color: #eee; font-weight: 600;">--</p>
              </div>
              <div>
                <p style="margin: 0; font-size: 8px; color: #888; text-transform: uppercase;">Mobile</p>
                <p id="vcardMobile" style="margin: 1px 0 0 0; font-size: 11px; color: #eee; font-weight: 600;">--</p>
              </div>
            </div>
          </div>

          <p style="margin: 15px 0 0 0; color: #ccc; font-size: 11px; font-style: italic; text-align: center;">
            "Congratulations on your outstanding performance! The NextGen Library team wishes you continued success in
            your academic journey."
          </p>
        </div>

        <!-- Footer -->
        <div
          style="position: absolute; bottom: 0; left: 0; width: 100%; border-top: 1px solid rgba(255,215,0,0.2); background: rgba(0,0,0,0.3); padding: 8px 0; display: flex; justify-content: center; align-items: center; gap: 5px;">
          <small style="color: #666; font-size: 9px; font-weight: bold;">VERIFY AT:</small>
          <a href="https://adityakumar12xyz.github.io/NextGen/"
            style="color: cyan; font-size: 10px; text-decoration: none; font-weight: 900; font-family: monospace;">adityakumar12xyz.github.io/NextGen/</a>
        </div>
      </div>

      <div style="margin-top: 25px; display: flex; gap: 15px; justify-content: center;">
        <button onclick="downloadVictoryCard()"
          style="background: linear-gradient(135deg, gold, #e67e22); color: black; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(230,126,34,0.3); transition: 0.3s;"
          onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          <i class="fas fa-download"></i> Download Card
        </button>
        <button onclick="shareVictoryCard()"
          style="background: linear-gradient(135deg, #00f2fe, #00c6ff); color: black; border: none; padding: 12px 25px; border-radius: 10px; font-weight: 800; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 15px rgba(0,198,255,0.3); transition: 0.3s;"
          onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
          <i class="fas fa-share-alt"></i> Share
        </button>
      </div>
    </div>
  </div>
  <!-- INFO SECTION (ABOUT & TERMS) - Managed via showPage -->
  <div class="info-section">
    <div class="info-container">
      <div class="info-box">
        <h3>ðŸ“š About NextGen Library</h3>
        <div id="aboutUsContent">
          <p>Welcome to NextGen Library, your premier digital learning platform designed for modern students. We
            believe
            that quality education should be structured, accessible, and interactive.</p>
          <p>Our platform integrates:</p>
          <ul>
            <li>High-quality Video Lectures</li>
            <li>Meticulously curated Study Notes</li>
            <li>Rigorous Assignments & Practice</li>
            <li>Comprehensive Homework Guidance</li>
            <li>Instant Doubt Resolution Support</li>
          </ul>
          <p>Whether you're tackling daily challenges or seeking clarity, we provide the tools necessary for academic
            excellence and personal growth.</p>
        </div>
      </div>

      <div class="info-box">
        <h3>âš–ï¸ Terms & Conditions</h3>
        <ul>
          <li><strong>Usage Rights:</strong> All content is for educational purposes only</li>
          <li><strong>Intellectual Property:</strong> Content owned by NextGen Library and respective creators</li>
          <li><strong>User Responsibility:</strong> Students must use resources ethically and legally</li>
          <li><strong>Account Security:</strong> Users are responsible for account confidentiality</li>
          <li><strong>Content Accuracy:</strong> We strive for accuracy but don't guarantee completeness</li>
          <li><strong>Limitation:</strong> Not liable for indirect damages or service interruptions</li>
          <li><strong>Updates:</strong> Terms may be updated. Continued use implies acceptance</li>
          <li><strong>Support:</strong> Contact us for queries or concerns regarding any content</li>
        </ul>
      </div>
    </div>
  </div>
  </div>

  <!-- DYNAMIC NAVIGATION SECTION -->
  <div id="dynamicNavSection" style="display:none; text-align:center;">
    <button onclick="goBackDynamicNav()" style="margin-bottom:20px; padding: 10px 20px; font-size:16px;">â¬… Back</button>
    <div id="branchSliderContainer" style="display:none;"></div>
    <div id="dynamicNavContainer" class="subjects"></div>
  </div>

  <!-- PREMIUM HUB NAVIGATION SECTION -->
  <div id="premiumNavSection" style="display:none; text-align:center;">
    <button onclick="goBackFromPremium()" style="margin-bottom:20px; padding: 12px 20px; font-size:16px;">â¬…
      Back</button>
    <h2 style="color: gold; text-shadow: 0 0 10px gold; font-size: 28px;">ðŸ’Ž Premium Notes & Book</h2>
    <p style="color: #ddd;">Unlock exclusive exam-oriented materials!</p>
    <div id="premiumCoursesContainer" class="subjects">
      <!-- Courses injected dynamically -->
    </div>
    <div id="premiumOptionsContainer" class="subjects" style="display:none;">
      <!-- Injected dynamically based on selection -->
    </div>

    <div id="premiumContentContainer"
      style="display:none; text-align:left; max-width: 800px; margin: 0 auto; padding: 20px;">
      <button onclick="goBackToPremiumOptions()"
        style="margin-bottom:20px; padding: 8px 15px; font-size:14px; background: rgba(255,215,0,0.2); border: 1px solid gold; color: gold;">â¬…
        Back to Options</button>
      <h3 id="activePremiumOptionTitle" style="color: gold; text-shadow: 0 0 10px gold; font-size: 24px;">Option Title
      </h3>
      <div id="premiumPdfsGrid"
        style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
        <!-- PDFs injected here -->
      </div>
    </div>
  </div>

  <!-- Wallet Recharge Modal -->
  <div id="walletRechargeModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;">
    <div class="payment-box" style="position: relative; max-height: 85vh; overflow-y: auto;">
      <button class="close-modal" onclick="closeWalletRechargeModal()"
        style="position: absolute; right: 10px; top: 10px;">âœ–</button>
      <h2>ðŸª™ Recharge Neural Wallet</h2>
      <p style="color: #ccc;">Pay via QR or UPI to get Gold Coins (â‚¹1 = 1 Coin)</p>

      <div class="qr-container">
        <!-- We will dynamically inject QR via JS when opening modal based on amount, but set default here -->
        <img id="rechargeQRDisplay" src="" alt="Scan QR Code to Pay"
          style="display: block; width: 150px; height: 150px; margin: 0 auto; object-fit: contain; border: 2px solid cyan; border-radius: 10px;">
      </div>
      <div class="upi-id" id="rechargeUPIDisplay">UPI ID: adityakumar84282-1@okaxis</div>

      <div style="text-align: left; margin: 15px 0;">
        <div style="margin-bottom: 15px;">
          <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 5px;">Recharge Amount (INR)</label>
          <input type="number" id="rechargeAmountInput" class="login-input" placeholder="Enter Amount (e.g. 500)"
            style="margin-bottom: 0;">
        </div>
        <div class="pay-btn-group"
          style="margin-bottom: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="pay-btn gpay-btn" onclick="payRechargeWithUpiApp('gpay')"
            style="padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #fff; color: #5f6368;"><img
              src="https://upload.wikimedia.org/wikipedia/commons/f/f2/Google_Pay_Logo.svg"
              style="height: 15px; vertical-align: middle;"> Pay</button>
          <button class="pay-btn phonepe-btn" onclick="payRechargeWithUpiApp('phonepe')"
            style="padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #5f259f; color: #fff;"><img
              src="https://upload.wikimedia.org/wikipedia/en/thumb/3/35/PhonePe_Logo.svg/2560px-PhonePe_Logo.svg.png"
              style="height: 15px; vertical-align: middle; filter: brightness(0) invert(1);"> Pay</button>
          <button class="pay-btn paytm-btn" onclick="payRechargeWithUpiApp('paytm')"
            style="padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #002970; color: #fff;"><img
              src="https://upload.wikimedia.org/wikipedia/commons/2/24/Paytm_Logo_%28standalone%29.svg"
              style="height: 12px; vertical-align: middle; filter: brightness(0) invert(1);"> Pay</button>
          <button class="pay-btn navi-btn" onclick="payRechargeWithUpiApp('navi')"
            style="padding: 10px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; background: #00b14f; color: #fff;"><img
              src="https://play-lh.googleusercontent.com/9nFfWntI5N8g9089KqB-iFjA8bZk8B2mE7B2iO3Fw0QZ-62nKxG_r8d64gV0k-pW4qI=w240-h480-rw"
              style="height: 15px; vertical-align: middle; border-radius: 3px;"> Navi Pay</button>
        </div>

        <div
          style="background: rgba(255, 71, 87, 0.1); border: 1px solid #ff4757; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
          <p style="color: #ff4757; font-size: 13px; font-weight: bold; margin: 0; text-align: center;">âš ï¸ COMPULSORY:
            After making the payment, you MUST upload the Payment Screenshot, enter your Mobile Number, and UTR below to
            get your money credited!</p>
        </div>



        <label style="color: #ccc; font-size: 14px;">12-Digit UTR / Transaction ID (Mandatory):</label>
        <input type="number" id="rechargeUtrInput" class="login-input" placeholder="Enter exactly 12 digits"
          style="margin-bottom: 10px;">

        <label style="color: #ccc; font-size: 14px;">Upload Payment Screenshot (Required):</label>
        <input type="file" id="rechargeScreenshotInput" class="login-input" accept="image/*" style="padding: 5px;"
          onchange="previewWalletRechargeScreenshot(event)">
        <img id="rechargeScreenshotPreview" src="" alt="Screenshot"
          style="width: 100%; max-height: 150px; object-fit: contain; border: 1px solid cyan; border-radius: 5px; display: none; margin-top: 10px;">
      </div>

      <button class="confirm-pay-btn" onclick="submitRechargeRequest()"
        style="background: gold; color: black; box-shadow: 0 0 15px rgba(255,215,0,0.4);">Submit Recharge
        Request</button>
    </div>
  </div>

  <!-- Leaderboard Modal -->
  <div id="leaderboardModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; justify-content: center; align-items: center;">
    <div class="login-box"
      style="text-align: center; max-height: 80vh; overflow-y: auto; width: 90%; max-width: 500px; position: relative;">
      <button class="close-modal" onclick="closeLeaderboard()">âœ–</button>
      <h2 style="color: gold; text-shadow: 0 0 10px gold; margin-top: 10px;">ðŸ† Leadership</h2>
      <p style="color: #ccc; font-size: 14px; margin-bottom: 20px;">Top explorers of NextGen</p>
      <div id="leaderboardList" style="display: flex; flex-direction: column; gap: 10px;">
        <!-- Injected via JS -->
      </div>
    </div>
  </div>

  <!-- MOTIVATION SECTION -->
  <div id="semesterMotivationSection" style="display:none;">
    <div class="semester-section">
      <div class="motivation-box">
        <h3>âœ¨ Daily Motivation</h3>
        <p id="motivationText">"Success is not final, failure is not fatal: It is the courage to continue that counts.
          Keep pushing your
          limits and remember, every expert was once a beginner. Your hard work today shapes your tomorrow. Focus on
          the
          process, and the results will follow!"</p>
      </div>

      <div class="progress-box" id="progressDashboard">
        <h3>ðŸ“Š Analytics & Progress Tracking</h3>
        <p style="color: #aaa; font-size: 14px; margin-bottom: 15px;">Automatically tracking your completed videos,
          PDFs, and assignments across all subjects in this semester.</p>
        <div id="progressContent">
          <!-- Dynamically Injected Progress Bars -->
        </div>
      </div>
    </div>
  </div>

  <!-- CHAPTERS -->
  <div class="chapters" id="chapters" style="display:none;">
    <button onclick="goBackToSubjects()" style="margin-bottom:15px; font-size:16px;">â¬… Back to Subjects</button>
    <h2 id="subjectTitle"></h2>
    <ul id="chapterList"></ul>
  </div>

  <!-- CONTENT -->
  <div class="content" id="content" style="display:none;">
    <button onclick="goBackChapter()" style="margin-bottom:15px; font-size:16px;">â¬… Back</button>
    <h2 id="chapterTitle"></h2>

    <div class="section" id="videoSection">
      ðŸ“¹ Video(s):<br>
      <div id="videoContainer" style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;"></div>
    </div>

    <div class="section" id="notesSection">
      ðŸ“ Notes:
      <div id="notesText" style="margin-top: 10px;"></div>
    </div>

    <div class="section" id="pdfSection" style="display:none;">
      ðŸ“„ PDF Notes:<br>
      <div id="pdfContainer" style="display: flex; flex-direction: column; gap: 15px; margin-top: 10px;"></div>
    </div>

    <div class="section" id="assignmentSection">
      ðŸ“„ Assignment:
      <div id="assignmentText" style="margin-top: 10px;"></div>
    </div>

    <div class="section" id="homeworkSection">
      ðŸ  Homework:
      <div id="homeworkText" style="margin-top: 10px;"></div>
    </div>

    <!-- AI TUTOR CHATBOT -->
    <div id="aiTutorWidget" style="position: fixed; bottom: 30px; right: 30px; z-index: 1000;">
      <button id="aiTutorBtn" onclick="toggleChat()"
        style="background: cyan; color: black; border: none; border-radius: 50%; width: 60px; height: 60px; font-size: 30px; box-shadow: 0 0 15px cyan; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.3s;"
        onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">ðŸ¤–</button>

      <div id="aiChatBox"
        style="display: none; position: absolute; bottom: 75px; right: 0; width: 350px; background: rgba(0, 15, 30, 0.95); border: 1px solid cyan; border-radius: 10px; box-shadow: 0 0 20px cyan; overflow: hidden; flex-direction: column; z-index: 1001;">
        <div
          style="background: cyan; color: black; padding: 12px; font-weight: bold; display: flex; justify-content: space-between; align-items: center;">
          <span style="font-size: 16px;">ðŸ¤– Gemini AI Tutor</span>
          <button onclick="toggleChat()"
            style="background: transparent; border: none; font-size: 18px; cursor: pointer; color: black; font-weight: bold;">âœ–</button>
        </div>

        <div id="aiChatHistory"
          style="height: 320px; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; font-size: 14px;">
          <div
            style="align-self: flex-start; background: rgba(0, 255, 255, 0.1); padding: 10px 14px; border-radius: 12px; border-bottom-left-radius: 0; max-width: 85%; border: 1px solid rgba(0, 255, 255, 0.3); color: white; line-height: 1.4;">
            Hello! I'm your AI Assistant. Ask me any doubt related to your studies, assignments, or
            homework!
          </div>
        </div>

        <div
          style="display: flex; gap: 8px; padding: 12px; border-top: 1px solid rgba(0, 255, 255, 0.3); background: rgba(0, 5, 15, 0.9);">
          <input type="text" id="aiChatInput" placeholder="Ask a doubt..."
            style="flex: 1; padding: 10px; border-radius: 5px; border: 1px solid cyan; background: rgba(0, 255, 255, 0.05); color: white; outline: none;"
            onkeypress="if(event.key === 'Enter') sendChatMessage()">
          <button onclick="sendChatMessage()"
            style="background: cyan; color: black; border: none; border-radius: 5px; padding: 0 15px; font-weight: bold; cursor: pointer; transition: background 0.3s;"
            onmouseover="this.style.background='#00cccc'" onmouseout="this.style.background='cyan'">Send</button>
        </div>
      </div>
    </div>
  </div>



  <script>
    /* AUTO TYPING */
    let text = "WELCOME TO NEXTGEN LIBRARY";
    let i = 0;
    function typing() {
      if (i < text.length) {
        let el = document.getElementById("typingText");
        if (el) el.innerHTML += text.charAt(i);
        i++;
        setTimeout(typing, 100);
      }
    }
    typing();

    /* SECURITY & UTILITY HELPERS */
    function sanitizeHTML(str) {
      if (!str) return "";
      const temp = document.createElement('div');
      temp.textContent = str;
      return temp.innerHTML;
    }

    function getAuthSession() {
      const sess = localStorage.getItem("nx_session");
      if (!sess) return null;
      try {
        const decoded = atob(sess).split(':');
        return { mobile: decoded[0], exp: parseInt(decoded[1]) };
      } catch (e) { return null; }
    }

    function setAuthSession(mobile, durationHours = 5) {
      const exp = Date.now() + (durationHours * 60 * 60 * 1000);
      localStorage.setItem("nx_session", btoa(mobile + ":" + exp));
    }

    function isAdminAuthenticated() {
      // Check legacy flag OR new secure token â€” both are valid
      return localStorage.getItem("adminSession") === "true";
    }

    /* PAGE NAVIGATION MANAGER */
    function showPage(pageId, pushToHistory = true, navContext = null) {
      if (!pageId) return;

      // Update Browser History if requested
      if (pushToHistory) {
        history.pushState({ pageId: pageId, navContext: navContext }, "", "#" + pageId);
      }

      // List of all main content segments
      const allPages = ["loginScreen", "welcomeScreen", "adminDashboard", "programsWrapper", "dynamicNavSection", "chapters", "content", "semesterMotivationSection", "premiumNavSection", "combatArena", "battleExamEngine", "battleLeaderboardSection", "codeStudioScreen", "certificateStoreScreen", "myCollectionScreen"];

      allPages.forEach(id => {
        let el = document.getElementById(id);
        if (el) {
          if (id === pageId) {
            el.style.display = (id === "loginScreen" || id === "welcomeScreen" || id === "battleExamEngine") ? "flex" : "block";
          } else {
            el.style.display = "none";
          }
        }
      });

      // Special handling for shared elements like AI Tutor, Header, Footer, Ticker
      const header = document.querySelector("header");
      const footer = document.getElementById("mainFooter");
      const aiTutor = document.getElementById("aiTutorWidget");
      const ticker = document.getElementById("globalTicker");

      const hideForAuth = ["loginScreen", "welcomeScreen", "adminDashboard"].includes(pageId);
      const isCertStore = (pageId === "certificateStoreScreen" || pageId === "myCollectionScreen");

      if (header) header.style.display = (hideForAuth || isCertStore) ? "none" : "flex";
      if (footer) footer.style.display = hideForAuth ? "none" : "block";
      if (aiTutor) aiTutor.style.display = (hideForAuth || isCertStore) ? "none" : "block";
      if (ticker) ticker.style.display = (hideForAuth || isCertStore) ? "none" : (globalSiteConfig.ticker ? "block" : "none");

      // Hide Info Section (About/Terms) for Battle & Certificate Pages
      const infoSection = document.querySelector(".info-section");
      if (infoSection) {
        const isBattlePage = ["combatArena", "battleExamEngine", "battleLeaderboardSection", "certificateStoreScreen"].includes(pageId);
        infoSection.style.display = (hideForAuth || isBattlePage) ? "none" : "block";
      }

      // Explicitly hide programsWrapper if we are in certificateStoreScreen or myCollectionScreen
      const progWrap = document.getElementById("programsWrapper");
      if (progWrap && (pageId === "certificateStoreScreen" || pageId === "myCollectionScreen")) {
        progWrap.style.display = "none";
      }

      // Show neuralHUD only on welcomeScreen; hide on all other pages
      const neuralHUD = document.getElementById('neuralHUD');
      if (neuralHUD) neuralHUD.style.display = (pageId === 'welcomeScreen') ? 'flex' : 'none';

      window.scrollTo(0, 0);

      // Trigger cleanup
      autoCleanupBattles();
    }

    /* AUTO-CLEANUP BATTLES (24 HOURS) */
    function autoCleanupBattles() {
      const dayInMs = 24 * 60 * 60 * 1000;
      const now = Date.now();

      database.ref('battles/active').once('value').then(snap => {
        const battles = snap.val();
        if (!battles) return;

        for (let id in battles) {
          const b = battles[id];
          if (b.createdAt && (now - b.createdAt > dayInMs)) {
            console.log(`Auto-cleaning battle: ${id}`);
            deleteBattle(id, true); // Silent delete
          }
        }
      });
    }

    function deleteBattle(id, silent = false) {
      if (!silent && !confirm("Are you sure you want to permanently delete this battle? This will also remove results.")) return;
      database.ref('battles/active/' + id).remove().then(() => {
        return database.ref('battleBookings/approved/' + id).remove();
      }).then(() => {
        return database.ref('battleBookings/pending/' + id).remove();
      }).then(() => {
        return database.ref('battleResults/' + id).remove();
      }).then(() => {
        if (!silent) alert("Battle and all related data removed successfully.");
      });
    }

    // Handle Browser Back/Forward Buttons
    window.onpopstate = function (event) {
      if (event.state && event.state.pageId) {
        const ctx = event.state.navContext;
        if (ctx) {
          // Restore Sub-Navigation State
          studentNavState = JSON.parse(JSON.stringify(ctx.state || {}));
          if (ctx.type === 'level') {
            openStudentLevel(ctx.level, ctx.selection, false);
          } else if (ctx.type === 'chapter') {
            openStudentChapter(ctx.selection, false);
          }
        } else {
          showPage(event.state.pageId, false);
        }
      } else {
        showPage("loginScreen", false);
      }
    };

    // Initial State Push
    window.addEventListener('load', () => {
      // Find what page is currently active (visible)
      const allPages = ["loginScreen", "welcomeScreen", "adminDashboard", "programsWrapper", "dynamicNavSection", "chapters", "content", "semesterMotivationSection", "premiumNavSection", "codeStudioScreen", "certificateStoreScreen", "myCollectionScreen"];
      let activePage = "loginScreen";
      allPages.forEach(id => {
        const el = document.getElementById(id);
        if (el && el.style.display !== 'none') activePage = id;
      });
      history.replaceState({ pageId: activePage }, "", "#" + activePage);
    });

    function switchAdminTab(tabId) {
      // Hide all sections
      document.querySelectorAll('.admin-section').forEach(sec => sec.style.display = 'none');
      // Show selected section
      const selected = document.getElementById('adminSection_' + tabId);
      if (selected) {
        selected.style.display = 'block';
      }

      // Highlight active button
      document.querySelectorAll('.admin-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        // Match by tabId or keywords in text
        const btnText = btn.innerText.toLowerCase();
        if (
          (tabId === 'students' && btnText.includes('student')) ||
          (tabId === 'cms' && btnText.includes('cms')) ||
          (tabId === 'recharges' && btnText.includes('recharge')) ||
          (tabId === 'withdrawals' && btnText.includes('withdrawal')) ||
          (tabId === 'battles' && btnText.includes('battle')) ||
          (tabId === 'premium' && btnText.includes('premium')) ||
          (tabId === 'settings' && btnText.includes('site settings')) ||
          (tabId === 'codeStudio' && btnText.includes('code studio')) ||
          (tabId === 'security' && btnText.includes('security')) ||
          (tabId === 'certificates' && btnText.includes('certificate'))
        ) {
          btn.classList.add('active');
        }
      });

      // Trigger specific load logic if needed
      if (tabId === 'recharges' && typeof renderAdminRechargeRequests === 'function') renderAdminRechargeRequests();
      if (tabId === 'withdrawals' && typeof renderAdminWithdrawalRequests === 'function') renderAdminWithdrawalRequests();
      if (tabId === 'battles' && typeof loadAdminBattles === 'function') loadAdminBattles();
      if (tabId === 'settings' && typeof loadSiteSettings === 'function') loadSiteSettings();
      if (tabId === 'premium' && typeof renderActivePremiumUsers === 'function') renderActivePremiumUsers();
      if (tabId === 'codeStudio' && typeof initAdminCodeStudio === 'function') initAdminCodeStudio();
      if (tabId === 'certificates' && typeof renderAdminCertificates === 'function') renderAdminCertificates();
    }

    /* GLOBAL DATA FETCH */
    let data = {};
    let premiumPrices = JSON.parse(localStorage.getItem("premiumPrices")) || {};

    database.ref('premiumPrices').on('value', snap => {
      if (snap.exists()) {
        premiumPrices = snap.val();
        localStorage.setItem("premiumPrices", JSON.stringify(premiumPrices));
      }
    });

    function saveOptionPrice(courseId, optionId, price) {
      if (!courseId || !optionId || price === undefined) {
        console.error("Invalid input for saveOptionPrice");
        return;
      }
      database.ref(`premiumPrices/${courseId}/${optionId}`).set(price)
        .then(() => {
          console.log(`Price for ${courseId} - ${optionId} updated to ${price}`);
          // Optionally update local storage and premiumPrices object immediately
          premiumPrices[courseId] = premiumPrices[courseId] || {};
          premiumPrices[courseId][optionId] = price;
          localStorage.setItem("premiumPrices", JSON.stringify(premiumPrices));
        })
        .catch(error => {
          console.error("Error updating price:", error);
        });
    }

    function onPremOptionChange(courseId, optionId) {
      const priceInput = document.getElementById('premiumOptionPriceInput');
      if (priceInput && premiumPrices[courseId] && premiumPrices[courseId][optionId]) {
        priceInput.value = premiumPrices[courseId][optionId];
      } else if (priceInput) {
        priceInput.value = ''; // Clear if no price found
      }
    }

    /* DATA */
    let oldData = {
      Math: {
        "UNIT 1: Set theory. Relations and Functions": {
          video: "https://www.youtube.com/embed/LK4TtZ_vkeM?si=rF8rcCWCYnUP52z1",
          notes: "Introduction to sets, subsets, operations.",
          pdf: "https://drive.google.com/file/d/15BlIRvpsrBmS-2566uqgrcNJKWINMWOp/view?usp=drive_link",
          assignment: "Solve 10 problems from Set Theory.",
          homework: "Revise union & intersection."
        },
        "UNIT 2: Permutation, Combination and Algebraic System:": {
          video:
            "https://www.youtube.com/embed/yurSCPPloMs?si=lLz2WObc1MDPpbD2",
          notes: "Graphs, trees, properties.",
          pdf: "https://drive.google.com/file/d/1Hf9igdkNSUthYv4Ow6aKiQl3hHusU3dW/view?usp=drive_link",
          assignment: "Draw 5 graphs.",
          homework: "Study tree traversal."
        },
        "UNTI 3: Algebra of Logic:": {
          video: "https://www.youtube.com/embed/l5Vt5bzkLK0?si=G3PrWBLUvQx_3aIT",
          notes: "Boolean algebra, logical operators, truth tables.",
          pdf: "",
          assignment: "Solve 8 problems on propositional calculus.",
          homework: "Study De Morgan's laws."
        },
        "UNIT 4: Recursion and recurrence:": {
          video: "https://www.youtube.com/embed/2ii8mCFXj88?si=idXwvor_pEm4jySM",
          notes: "Lattice structures, Boolean operations, applications.",
          pdf: "",
          assignment: "Design a Boolean circuit.",
          homework: "Revise lattice properties."
        },
        "UNIT 5: Graph and Trees:": {
          video: "https://www.youtube.com/embed/la7b2jWFuhQ?si=7AeONZ9vcfbJu8D7",
          notes: "Graph traversal, connectivity, shortest paths.",
          pdf: "",
          assignment: "Solve graph problems.",
          homework: "Study BFS and DFS algorithms."
        }
      },

      Accounting: {
        "UNIT 1: Introduction to Accounting": {
          video: "https://www.youtube.com/embed/B0jZsLg8pks?si=PCIH4MLVJ09W8cBf",
          notes: "Meaning, Characteristics, Purposes and Limitations; Concepts, Convention and Generally Accepted Accounting Principles.",
          pdf: "https://drive.google.com/file/d/1urySIm4IyaEfc5KWraOTnL1bsAf9koOt/view?usp=drive_link",
          assignment: "Prepare journal entries.",
          homework: "Revise rules."
        },
        "UNIT 2:  Financial Accounting: ": {
          video: "https://www.youtube.com/embed/5pmh4cl9GKY?si=Wm9xem8uGXS_a86H",
          notes: " Double Entry Framework, Basic Concept of Journal, Ledgers-Purchase Book, Sales Book, Cash Book; Trading and Profit & Loss Account, Balance Sheet",
          pdf: "https://drive.google.com/file/d/1Z-BAht5KXnw5V4wlT1QIVqsYUcnoZJwi/view?usp=drive_link",
          assignment: "Prepare journal and ledger entries.",
          homework: "Study golden rules of accounting."
        },
        "UNIT 3: Management Accounting:": {
          video: "https://www.youtube.com/embed/gnRmh4OI3pw?si=ilYJCzzw4ZaOG8jG",
          notes: "Nature, Scope, Advantage and Limitations; Differences between Management Accounting and Financial Accounting.",
          pdf: "",
          assignment: "Prepare complete financial statements.",
          homework: "Verify trial balance."
        },
        "UNIT 4: Raising Funds:": {
          video: "https://www.youtube.com/embed/82u1qyHBMQ4?si=oygKhom2yJ7BYjq",
          notes: "Sources of Raising Funds, Simple Treatment to Issue of Shares, Forfeiture of Shares and Reissue of Forfeited Shares.",
          pdf: "",
          assignment: "Calculate depreciation and adjustments.",
          homework: "Study adjustment process."
        },
        "UNIT 5:  Computer Application:": {
          video: "https://www.youtube.com/embed/8Haz0xLfcbA?si=rzLQu9kw1WA2DMHx",
          notes: " Role of Computers in Accounting, Software Packages for Accounting",
          pdf: "",
          assignment: "Analyze financial statements.",
          homework: "Study key financial ratios."
        }
      },

      Dcld: {
        "DCLD - UNIT 1: Number Systems": {
          video: "https://www.youtube.com/embed/MxjJqq3BJU?si=6rhZmrISZh_PnFVu",
          notes: "Decimal, Binary, Octal, Hexadecimal number system, inter conversion between different number systems, different codes, gray code, ASCII code, Floating point numbers.",
          pdf: "",
          assignment: "Convert numbers between different bases.",
          homework: "Study number system conversions."
        },
        "DCLD - UNIT 2: Logic Gates and Boolean Algebra": {
          video: "https://www.youtube.com/embed/EW_2MhFu7tE?si=ti8E8NYs7Dtw4pHH",
          notes: "Elements and functions of digital Logic gates, Gate propagation delay time, logic gates applications. Boolean algebra: Boolean operations, SOP and POS forms and simplification using Karnaugh maps, Realization of expressions using universal logic gates.",
          pdf: "",
          assignment: "Simplify Boolean expressions using K-maps.",
          homework: "Study Boolean theorems."
        },
        "DCLD - UNIT 3: Combinational logical circuits": {
          video: "https://www.youtube.com/embed/pHNbm-4reIc?si=BcNoKtnKTlYu7e90",
          notes: "Design of Binary Adder- half and full, Serial, Parallel, Carry look ahead adder. Full subtracter, code converters, MUX and DEMUX, encoders and decoders, seven segment decoder.",
          pdf: "",
          assignment: "Design combinational logic circuits.",
          homework: "Study gate implementations."
        },
        "DCLD - UNIT 4: Sequential logic circuits: ": {
          video: "https://www.youtube.com/embed/v0pxOfTg18Y?si=4nq0hPKMPrurDPIj",
          notes: "Latches, key debouncer, Flip flop: SR, J-K, D, T, Master slave J-K, flipflops with preset and clear . Counters; Binary counter, synchronous counter, mod-10 counter, Generation of control signals; Controlled counter; Up-down counter, Shift register, Parity generator or checker, Synchronization of an asynchronous pulse.",
          pdf: "",
          assignment: "Design sequential circuits.",
          homework: "Study flip-flop types."
        },
        "DCLD - UNIT 5:  Microprocessor:": {
          video: "https://www.youtube.com/embed/SBh6dJMM6AI?si=5HwK09d1CBVzUZ6z",
          notes: "Architecture of a basic microcomputer, some general microprocessor system concepts: I/O ports and buses, internal architecture of a microprocessor, Microprocessor fetches, decode, execute cycle memory mapped and I/O mapped ports, I/O controls.",
          pdf: "",
          assignment: "Implement digital devices.",
          homework: "Study device applications."
        },
      },

      Oops: {
        "OOPS - UNIT 1: Principles of Object Oriented Programming (OOP)": {
          video: "https://www.youtube.com/embed/mlIUKyZIUUU?si=SBp5sE2BdgTR8UaY",
          notes: "Basic Concepts of OOP, Comparison of procedural programming and OOP, Advantages of OOP, OOP Languages, Definitions: .Class, Objects, Concepts of inheritance and encapsulation, Operator overloading, Dynamic binding. Over view of OOP using C++, Basic Program construction: main and functions, Program statements, class declaration, comments++ compilation.",
          pdf: "",
          assignment: "Write simple C++ program with classes.",
          homework: "Homework 1 (1) Define low-level, mid-level and high-level languages , (2) Write applications of OOP concepts. Homework 2 (1) Explain how namespace and header files differ from each other using real-life examples. (2) Why is procedural programming unsuitable for large-scale software systems? Explain in depth. (3) Homework 3 (1) Write the difference between function prototype and function declaration with syntax. (2) Explain the difference between class and structure. Write a small code to explain the same."
        },
        "OOPS - UNIT 2: Elements of C++ Language": {
          video: "https://www.youtube.com/embed/TOG6xCEJU3M?si=2lA-jZb7wHUhh1j7",
          notes: "Tokens and identifiers: Character set and symbols, Keywords. C++, identifiers. Variables and constants. Data Types: Basic data types, Arrays and strings, User defined data types; Operators, type conversions and type cast operators, Console I/O : cin, cout functions, Control statements: The if statement, if else; else.... if: switch statements, Loops: for and while do statements, Break, continue, go to, Functions Simple functions: Declaration of functions. Calling functions, Function definition, Passing arguments and returning values: Passing constants and variables, Pass by value. Return statement, types of functions, Passing and returning structure variables, Inline functions, Default arguments, returning by reference, pointers.",
          pdf: "",
          assignment: "Create classes with constructors and destructors.",
          homework: "Study access specifiers."
        },
        "OOPS - UNIT 3:  Classes and Objects": {
          video: "https://www.youtube.com/embed/YNuFnhRMoVs?si=zBd253Sg6HEmRzq-",
          notes: "Declaration of classes and objects in C++, Class definition. Declaration of members, objects as date time, Objects as function arguments. Array of objects, Returning objects from function, Structures and classes. Basic constructors, Parameterized constructors. Constructors with default arguments. Dynamic initialization of objects, use of copy constructor, shallow copying and deep copying, Dynamic constructors. Destructors, constraints on constructors and destructors.",
          pdf: "",
          assignment: "Create derived classes with inheritance.",
          homework: "Study inheritance types."
        },
        "OOPS - UNIT 4:  Operator Overloading": {
          video: "https://www.youtube.com/embed/0QjDxmSVryU?si=KeuZ3RawSubAmCWG",
          notes: "Overloading unary operators: Operator keyword, Arguments and return values, Laminations of increment operators, overloading binary operators. Arithmetic operators Examples: Addition of polar coordinates and concatenation of strings Multiple overloading, Comparison operators, Arithmetic assignment operators. Data and type conversions: Conversion between basic types, Conversion between objects and basic types, conversion between objects of different classes, Constraints on type conversion",
          pdf: "",
          assignment: "Implement polymorphism examples.",
          homework: "Study virtual functions."
        },
        "OOPS - UNIT 5: Derived Classes and Inheritance": {
          video: "https://www.youtube.com/embed/7ZfEp71tIec?si=ch_z8CDdZsAacdFW",
          notes: "Derived, classes and base class: Defining a derived class, accessing the bases class members, the protected access specifier, specifer. Derived class constructors. Overriding the member functions, Class hierarchies: Abstract base class. Inheritance: Public and private inheritance. Types of Inheritance single level, multi level, multiple, hybrid etc., virtual function, stream classes.",
          pdf: "",
          assignment: "Handle exceptions in C++ programs.",
          homework: "Study STL containers."
        }
      },

      Labwork: {
        "L1": { notes: "Lab 1", pdf: "https://drive.google.com/file/d/1i0CEGHhiHYnZZ7ChWoMI_QQIlDh_wElA/view?usp=drive_link" },
        "L2": { notes: "Lab 2", pdf: "https://drive.google.com/file/d/1zolBnOeqZ8nFpRAaWCresFFMEF_RO9H3/view?usp=drive_link" },
        "L3": { notes: "Lab 3", pdf: "https://drive.google.com/file/d/1XDM_QariM46DrngARJyAyJE3wMC1trUT/view?usp=drive_link" },
        "L4": { notes: "Lab 4", pdf: "https://drive.google.com/file/d/1s0haqXOUyHbgKLv9482R6e5iQ30X8T3g/view?usp=drive_link" },
        "L5": { notes: "Lab 5", pdf: "https://drive.google.com/file/d/17VEQ8xkqd8GE-4L2CqCWoYD7fl-mSN8M/view?usp=drive_link" },
        "L6": { notes: "Lab 6", pdf: "https://drive.google.com/file/d/1v6Xe1dcACGTX5uT9jBYpEFvUWh3Sak3p/view?usp=drive_link" },
        "L7": { notes: "Lab 7", pdf: "https://drive.google.com/file/d/1jekV2UHtKTpcBkuZRGZjKceM5XXy1NAk/view?usp=drive_link" },
        "L8": { notes: "Lab 8", pdf: "https://drive.google.com/file/d/1IDVA0Yb-PzDqhMyGMo881HJjx4VVaRce/view?usp=drive_link" },
        "L9": { notes: "Lab 9", pdf: "https://drive.google.com/file/d/1VmSM4IQVXO8Wq_Gfmc_MA31MFTFEwfeZ/view?usp=drive_link" },
        "L10": { notes: "Lab 10", pdf: "https://drive.google.com/file/d/1x_DqpHKEe7VFFCSbbPDziQU4CmqV5h_9/view?usp=drive_link" },
        "L11": { notes: "Lab 11", pdf: "https://drive.google.com/file/d/11qvX83gzQ9-vtTc66T3-_h51b8PcHCur/view?usp=drive_link" },
        "L12": { notes: "Lab 12", pdf: "https://drive.google.com/file/d/1I-RJ3UBs9xRtrCPfUFzAixZ9440mWXKI/view?usp=drive_link" },
        "L13": { notes: "Lab 13", pdf: "https://drive.google.com/file/d/1tWpaL9j9XSIaYzeHNHJJuhDdAP-WX-L3/view?usp=drive_link" },
        "L14": { notes: "Lab 14", pdf: "https://drive.google.com/file/d/1K7_9X1Rnl1qNEaPW4jOFzwkm4455cWCO/view?usp=drive_link" },
        "L15": { notes: "Lab 15", pdf: "https://drive.google.com/file/d/1s5GkA6oqan2EZRZ8xru1Civ_Ce25rP2R/view?usp=drive_link" },
        "L16": { notes: "Lab 16", pdf: "https://drive.google.com/file/d/1WsjzxsOjacvIw-dNhSgySGavNgZfhlf4/view?usp=drive_link" },
        "L17": { notes: "Lab 17", pdf: "https://drive.google.com/file/d/1l7xrvtM0HBJAlNSBcBSC4UjZ8ffTFsNV/view?usp=drive_link" },
        "L18": { notes: "Lab 18", pdf: "https://drive.google.com/file/d/19I44HsJlFwcteidEEm57qO-ezsJcK3Cp/view?usp=drive_link" },
        "L19": { notes: "Lab 19", pdf: "" },
        "L20": { notes: "Lab 20", pdf: "https://drive.google.com/file/d/1ZAp9brogxL2H7P6tM0y6w7tdyn0BWdq2/view?usp=drive_link" },
        "L21": { notes: "Lab 21", pdf: "https://drive.google.com/file/d/1my2W98iS59W8BbG5QU1k8J_kQx14LhsT/view?usp=drive_link" },
        "L22": { notes: "Lab 22", pdf: "https://drive.google.com/file/d/1LATPKKK-0-6o8qWeoykRrfVQsGc5K_G6/view?usp=drive_link" },
        "L23": { notes: "Lab 23", pdf: "https://drive.google.com/file/d/1L-tmZcnLtvm0a3C09tovTigK0dSF0VnT/view?usp=drive_link" },
        "L24": { notes: "Lab 24", pdf: "https://drive.google.com/file/d/1mV_LEIH7YjlzhYtJOsWQrjuGAhfeqprT/view?usp=drive_link" },
        "L25": { notes: "Lab 25", pdf: "https://drive.google.com/file/d/1JQhIymezV4WfcdepiczEx929_nnkEp1M/view?usp=drive_link" },
        "L26": { notes: "Lab 26", pdf: "" },
        "L27": { notes: "Lab 27", pdf: "" },
        "L28": { notes: "Lab 28", pdf: "" },
        "L29": { notes: "Lab 29", pdf: "" },
        "L30": { notes: "Lab 30", pdf: "" },
        "L31": { notes: "Lab 31", pdf: "" },
        "L32": { notes: "Lab 32", pdf: "" },
        "L33": { notes: "Lab 33", pdf: "" },
        "L34": { notes: "Lab 34", pdf: "" },
        "L35": { notes: "Lab 35", pdf: "" },
        "L36": { notes: "Lab 36", pdf: "" },
        "L37": { notes: "Lab 37", pdf: "" },
        "L38": { notes: "Lab 38", pdf: "" },
        "L39": { notes: "Lab 39", pdf: "" },
        "L40": { notes: "Lab 40", pdf: "" }
      },

      ComputerSkill: {
        "UNIT 1: Introduction to Computers": {
          video: "https://www.youtube.com/embed/agaLaSafbwc?si=2OQLr54YVYxY93cr",
          notes: "Computer basics, hardware components, operating systems.",
          pdf: "",
        },
      },

      CommunicationSkill: {
        "UNIT 1: Introduction to Communication": {
          video: "https://www.youtube.com/embed/99W9-1I66Jw?si=oYHcAqt1irSsG2sq",
          notes: "Communication process, types of communication, importance.",
          pdf: "",

        },
        "UNIT 2: Written Communication": {
          video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
          notes: "Business writing, emails, reports, documentation skills.",
          pdf: "",

        },
        "UNIT 3: Verbal Communication": {
          video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
          notes: "Listening skills, speaking techniques, presentation skills.",
          pdf: "",
          assignment: "",
          homework: ""
        },
        "UNIT 4: Non-Verbal Communication": {
          video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
          notes: "Body language, gestures, facial expressions, tone of voice.",
          pdf: "",

        },
        "UNIT 5: Interpersonal and Professional Communication": {
          video: "https://www.youtube.com/embed/dQw4w9WgXcQ",
          notes: "Teamwork, conflict resolution, professional etiquette.",
          pdf: "",

        }
      }
    };

    let allSubjects = {
      "Discrete Maths": oldData.Math,
      "Accounting": oldData.Accounting,
      "Digital Logic": oldData.Dcld,
      "C++ Programming": oldData.Oops,
      "Lab Work": oldData.Labwork,
      "Computer Skills": oldData.ComputerSkill,
      "Communication": oldData.CommunicationSkill,
      "Important Qs": oldData.QuestionPractice
    };

    let defaultData = {
      "BCA": { "DDU": {}, "AKTU": {} }
    };

    for (let course in defaultData) {
      for (let branch in defaultData[course]) {
        for (let i = 1; i <= 6; i++) {
          defaultData[course][branch][i] = JSON.parse(JSON.stringify(allSubjects));
        }
      }
    }

    data = defaultData;
    let globalSiteConfig = { ticker: "", welcome: "", about: "", premiumEnabled: true, banners: [] };
    let globalPremiumConfig = { amount: "" };
    let globalPremiumCourseConfigs = {};
    let isRecoveringMode = false;
    let tempRecoverMobile = "";
    let currentUserMobile = "";

    function triggerNeuralSyncNotification(msg) {
      const hud = document.getElementById("neuralSyncHUD");
      if (!hud) return;
      hud.innerText = msg;
      hud.style.display = "block";
      hud.style.animation = "neuralPulse 2s infinite, slideInUp 0.5s ease-out";
      setTimeout(() => {
        hud.style.display = "none";
      }, 5000);
    }

    // CHECK PERSISTENT LOGIN ON LOAD
    window.onload = function () {
      Promise.all([
        database.ref('courseData').once('value'),
        database.ref('premiumConfig').once('value'),
        database.ref('premiumCourseConfigs').once('value'),
        database.ref('premiumData').once('value')
      ]).then(snapshots => {
        let [courseSnap, pConfSnap, pCourseConfSnap, pDataSnap] = snapshots;
        if (courseSnap.exists() && courseSnap.val()) data = courseSnap.val();
        if (pConfSnap.exists() && pConfSnap.val()) globalPremiumConfig = pConfSnap.val();
        if (pCourseConfSnap.exists() && pCourseConfSnap.val()) globalPremiumCourseConfigs = pCourseConfSnap.val();
        if (pDataSnap.exists() && pDataSnap.val()) premiumData = pDataSnap.val();

        // ENABLE REAL-TIME NEURAL SYNC
        database.ref('courseData').on('value', snap => {
          const newData = snap.val();
          if (newData && JSON.stringify(newData) !== JSON.stringify(data)) {
            data = newData;
            triggerNeuralSyncNotification("ðŸ“¡ Incoming Data Stream: Course Library Updated.");
            renderStudentCourses();
            if (currentUserMobile) restoreNavState(); // Gently refresh current view
          }
        });

        loadSiteSettings();
        initAdminCMS(); // Sync all dropdowns
        renderStudentCourses();
        renderPremiumHubCourses();

        // CHECK SECURE SESSIONS
        const session = getAuthSession();
        if (isAdminAuthenticated()) {
          showPage("adminDashboard");
          loadAdminData();
          if (typeof initAdminWalletSettings === 'function') initAdminWalletSettings();
          renderAdminRechargeRequests();
          if (typeof renderAdminWithdrawalRequests === 'function') renderAdminWithdrawalRequests();
          renderActivePremiumUsers();
          loadAdminBattles();
          if (typeof loadAdminBattleBookings === 'function') loadAdminBattleBookings();
          if (typeof loadSiteSettings === 'function') loadSiteSettings();
        } else if (session && Date.now() < session.exp) {
          currentUserMobile = session.mobile;
          database.ref('users/' + currentUserMobile).once('value').then((snapshot) => {
            let userData = snapshot.val();
            if (userData) {
              // Sync to LocalStorage using obfuscated key
              localStorage.setItem("user_" + btoa(currentUserMobile), JSON.stringify(userData));
              updateNeuralHUD(userData);
              enterSite();
            } else {
              showPage("loginScreen", false);
            }
          });
        } else {
          showPage("loginScreen", false);
        }
      }).catch(err => {
        console.error("Initialization failed:", err);
        showPage("loginScreen", false);
      });
    };

    function updateNeuralHUD(userData) {
      if (!userData) return;
      document.getElementById('neuralHUD').style.display = 'flex';

      let pts = userData.timeSpent || 0;
      let badge = "Beginner ðŸŒ±";
      let badgeColor = "#38ef7d";
      if (pts >= 300) { badge = "Master ðŸ‘‘"; badgeColor = "gold"; }
      else if (pts >= 60) { badge = "Explorer ðŸš€"; badgeColor = "cyan"; }

      document.getElementById('hudRank').innerText = badge;
      document.getElementById('hudRank').style.color = badgeColor;
      document.getElementById('hudPoints').innerText = pts + " XP";
    }

    // TIME TRACKING ENGINE
    let timeSpentInterval = null;
    let isTabVisible = true;

    document.addEventListener("visibilitychange", () => {
      isTabVisible = !document.hidden;
    });

    function startTimeTracking() {
      if (timeSpentInterval) clearInterval(timeSpentInterval);

      timeSpentInterval = setInterval(() => {
        if (!currentUserMobile || !isTabVisible) return;

        let stObj = JSON.parse(localStorage.getItem("user_" + btoa(currentUserMobile))) || {};
        stObj.timeSpent = (stObj.timeSpent || 0) + 1;

        // Sync to Local for instant UI response if needed
        localStorage.setItem("user_" + btoa(currentUserMobile), JSON.stringify(stObj));

        // Sync to Firebase directly
        database.ref('users/' + currentUserMobile + '/timeSpent').set(stObj.timeSpent);

        // Update HUD real-time
        updateNeuralHUD(stObj);
      }, 60000); // 1 minute intervals
    }

    /* AUTHENTICATION FUNCTIONS */

    function toggleAuthMode(mode) {
      document.getElementById('signUpForm').style.display = 'none';
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('adminLoginForm').style.display = 'none';

      if (mode === 'login') {
        document.getElementById('loginForm').style.display = 'block';
      } else if (mode === 'signup') {
        document.getElementById('signUpForm').style.display = 'block';
      } else if (mode === 'admin') {
        document.getElementById('adminLoginForm').style.display = 'block';
      }
    }

    // FORGOT DETAILS RECOVERY
    function recoverDetails() {
      let rollSearch = prompt("Enter your registered University Roll Number / Registation Number to recover/edit your details:");
      if (!rollSearch || rollSearch.trim() === "") return;

      let foundUser = null;
      // We search both local and Firebase for redundancy if needed, but primarily Firebase
      database.ref('users').once('value').then(snap => {
        let users = snap.val() || {};
        for (let mobile in users) {
          if (users[mobile].roll && users[mobile].roll === rollSearch.trim()) {
            foundUser = users[mobile];
            break;
          }
        }

        if (foundUser) {
          isRecoveringMode = true;
          tempRecoverMobile = foundUser.mobile;

          document.getElementById("editName").value = foundUser.name;
          document.getElementById("editRoll").value = foundUser.roll;
          document.getElementById("editBranch").value = foundUser.branch;
          document.getElementById("editSection").value = foundUser.section;
          document.getElementById("editMobile").value = foundUser.mobile;

          document.querySelector("#editProfileScreen h2").innerText = "ðŸ› ï¸ Fix Registration Details";
          document.getElementById("editProfileScreen").style.display = "flex";
        } else {
          alert("Sorry, no account found matching this Roll Number.");
        }
      });
    }

    // ID CARD GENERATOR
    function downloadIDCard() {
      renderIDCardPreview().then(() => {
        const idCard = document.getElementById('studentIdCard');
        html2canvas(idCard, { scale: 3, useCORS: true }).then(canvas => {
          const link = document.createElement('a');
          link.download = `NextGen_Digital_ID_${currentUserMobile}.png`;
          link.href = canvas.toDataURL('image/png', 1.0);
          link.click();
          triggerNeuralSyncNotification("âœ… Identity Card Downloaded!");
        });
      });
    }

    function shareIDCard() {
      if (!navigator.share) return alert("Sharing not supported on this browser.");
      renderIDCardPreview().then(() => {
        const idCard = document.getElementById('studentIdCard');
        html2canvas(idCard, { scale: 3, useCORS: true }).then(canvas => {
          canvas.toBlob(blob => {
            const file = new File([blob], `NextGen_ID_${currentUserMobile}.png`, { type: 'image/png' });
            navigator.share({
              files: [file],
              title: 'NextGen Digital Identity',
              text: 'Check out my official NextGen Library Digital Student ID Card!'
            }).catch(e => console.error("Share failed", e));
          }, 'image/png');
        });
      });
    }

    function renderIDCardPreview() {
      if (!currentUserMobile) return Promise.reject();
      let ud = JSON.parse(localStorage.getItem(currentUserMobile));
      if (!ud) return Promise.reject();

      let picURL = ud.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(ud.name || 'U')}&background=00f2fe&color=000`;
      document.getElementById("idCardPic").src = picURL;
      document.getElementById("idCardName").innerText = ud.name || "STUDENT NAME";
      document.getElementById("idCardRoll").innerText = ud.roll || "--";
      document.getElementById("idCardCourse").innerText = (ud.branch || "--") + (ud.section ? " | " + ud.section : "");

      let pts = ud.timeSpent || 0;
      let badge = "LEVEL: BEGINNER ðŸŒ±";
      let badgeColor = "#38ef7d";
      if (pts >= 300) { badge = "LEVEL: MASTER SCHOLAR ðŸ‘‘"; badgeColor = "gold"; }
      else if (pts >= 60) { badge = "LEVEL: EXPLORER ðŸš€"; badgeColor = "cyan"; }

      document.getElementById("idCardPoints").innerText = pts;
      document.getElementById("idCardRankText").innerText = badge;
      document.getElementById("idCardRankText").style.color = badgeColor;

      const idCard = document.getElementById('studentIdCard');
      const imgs = idCard.querySelectorAll('img');
      return Promise.all(Array.from(imgs).map(img => {
        if (img.complete) return Promise.resolve();
        return new Promise(resolve => { img.onload = resolve; img.onerror = resolve; });
      }));
    }

    // PROFILE MANAGEMENT
    let cropperInstance = null;

    function previewEditProfilePic(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          const image = document.getElementById('imageToCrop');
          image.src = e.target.result;
          document.getElementById('cropModal').style.display = 'flex';

          if (cropperInstance) {
            cropperInstance.destroy();
          }

          cropperInstance = new Cropper(image, {
            aspectRatio: 1, // enforced square for circle
            viewMode: 1,
            autoCropArea: 0.8,
            dragMode: 'move',
            background: false,
            minContainerHeight: 300,
            ready: function () {
              // Circle styling mask
              document.querySelector('.cropper-view-box').style.borderRadius = '50%';
              document.querySelector('.cropper-face').style.borderRadius = '50%';
            }
          });
        }
        reader.readAsDataURL(file);
      }
    }

    function cancelCrop() {
      document.getElementById('cropModal').style.display = 'none';
      document.getElementById('editProfilePicInput').value = ""; // Reset file input
      if (cropperInstance) cropperInstance.destroy();
    }

    function applyCrop() {
      if (!cropperInstance) return;

      // Output perfectly as circular PNG format if supported, or standard base64 square that our CSS rounds
      const canvas = cropperInstance.getCroppedCanvas({
        width: 300,
        height: 300
      });

      const base64Pic = canvas.toDataURL('image/png');

      document.getElementById('editProfilePicPreview').src = base64Pic;
      document.getElementById('idCardPic').src = base64Pic; // Sync to ID Card preview instantly

      // Clean up
      document.getElementById('cropModal').style.display = 'none';
      cropperInstance.destroy();
      cropperInstance = null;
    }
    function openEditProfile() {
      if (!currentUserMobile) return;
      let ud = JSON.parse(localStorage.getItem(currentUserMobile));
      if (!ud) return;

      document.getElementById("editName").value = ud.name;
      document.getElementById("editRoll").value = ud.roll;
      document.getElementById("editBranch").value = ud.branch;
      document.getElementById("editSection").value = ud.section;
      document.getElementById("editMobile").value = ud.mobile;
      document.getElementById("editMobile").disabled = true; // Cannot edit main key

      let picURL = ud.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(ud.name)}&background=cyan&color=000`;
      document.getElementById("editProfilePicPreview").src = picURL;

      // Calculate Gamification Badge
      let pts = ud.timeSpent || 0;
      let badge = "Beginner ðŸŒ±";
      let badgeColor = "#38ef7d";
      if (pts >= 300) { badge = "Master Scholar ðŸ‘‘"; badgeColor = "gold"; }
      else if (pts >= 60) { badge = "Explorer ðŸš€"; badgeColor = "cyan"; }

      document.getElementById("userPoints").innerText = pts;
      let rankEl = document.getElementById("userRank");
      if (rankEl) {
        rankEl.innerText = badge;
        rankEl.style.color = badgeColor;
      }

      // Update ID Card Data Behind the scenes
      document.getElementById("idCardPic").src = picURL;
      document.getElementById("idCardName").innerText = ud.name;
      document.getElementById("idCardRoll").innerText = ud.roll;
      document.getElementById("idCardCourse").innerText = ud.branch + (ud.section ? " | " + ud.section : "");
      if (document.getElementById("idCardMobile")) {
        document.getElementById("idCardMobile").innerText = "+91 " + ud.mobile;
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // UPDATE LIVE VISIBLE ID CARD (profileLiveCard)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const plcAvatar = document.getElementById("plcAvatar");
      if (plcAvatar) plcAvatar.src = picURL;

      const plcName = document.getElementById("plcName");
      if (plcName) plcName.textContent = ud.name.toUpperCase();

      const plcRoll = document.getElementById("plcRoll");
      if (plcRoll) plcRoll.textContent = ud.roll || "â€”";

      const plcCourse = document.getElementById("plcCourse");
      if (plcCourse) plcCourse.textContent = ud.branch || "â€”";

      const plcSection = document.getElementById("plcSection");
      if (plcSection) plcSection.textContent = ud.section || "â€”";

      const plcPoints = document.getElementById("plcPoints");
      if (plcPoints) plcPoints.textContent = pts + " âœ¨";

      const plcRank = document.getElementById("plcRank");
      if (plcRank) {
        plcRank.textContent = "âš¡ LEVEL: " + badge.replace(/[^\w\s]/gi, '').trim().toUpperCase();
        plcRank.style.color = badgeColor;
      }
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      document.querySelector("#editProfileScreen h2").innerText = "âœï¸ Edit Profile";
      document.getElementById("editProfileScreen").style.display = "flex";
      isRecoveringMode = false;
    }

    // VALIDATION HELPERS
    function validateInput(name, roll, mobile) {
      if (!/^[A-Za-z\s]+$/.test(name)) {
        alert("Validation Error: Name must contain only English alphabets and spaces.");
        return false;
      }
      if (!/^\d{13}$/.test(roll)) {
        alert("Validation Error: Roll Number must be exactly 13 digits long.");
        return false;
      }
      if (!/^\d{10}$/.test(mobile)) {
        alert("Validation Error: Mobile Number must be exactly 10 digits long.");
        return false;
      }
      return true;
    }

    function handleSignUp() {
      try {
        let name = sanitizeHTML(document.getElementById("regName").value.trim());
        let roll = sanitizeHTML(document.getElementById("regRoll").value.trim());
        let branch = document.getElementById("regBranch").value;
        let section = document.getElementById("regSection").value;
        let mobile = document.getElementById("regMobile").value.trim();

        if (!name || !roll || !branch || !section || !mobile) {
          alert("Please fill in all details to register!");
          return;
        }

        if (!validateInput(name, roll, mobile)) return;

        let btn = document.querySelector("#signUpForm .login-btn");
        btn.innerText = "Registering...";
        btn.disabled = true;

        database.ref('users/' + mobile).once('value').then((snapshot) => {
          if (snapshot.exists()) {
            alert("An account with this mobile number already exists! Please login.");
            toggleAuthMode('login');
            btn.innerText = "Sign Up & Enter";
            btn.disabled = false;
            return;
          }

          let userData = {
            name, roll, branch, section, mobile,
            registeredAt: Date.now(),
            timeSpent: 0
          };

          // FACE SCAN SIMULATION
          const overlay = document.getElementById('faceScanOverlay');
          if (overlay) overlay.style.display = 'flex';

          setTimeout(() => {
            database.ref('users/' + mobile).set(userData).then(() => {
              if (overlay) overlay.style.display = 'none';

              // Secure Session Storage
              setAuthSession(mobile);
              localStorage.setItem("user_" + btoa(mobile), JSON.stringify(userData));

              currentUserMobile = mobile;
              alert("Registration Successful!");
              showPage("welcomeScreen");

              const wsP = document.querySelector("#welcomeScreen p");
              if (wsP) wsP.innerText = `\nWelcome, ${name}!`;

              btn.innerText = "Sign Up & Enter";
              btn.disabled = false;
              startTimeTracking();
              updateNeuralHUD(userData);
            }).catch(err => {
              if (overlay) overlay.style.display = 'none';
              alert("Network error, please try again.");
              btn.innerText = "Sign Up & Enter";
              btn.disabled = false;
            });
          }, 2500);
        });
      } catch (e) {
        console.error("handleSignUp crash:", e);
        alert("Registration failed due to an unexpected error.");
      }
    }

    function handleLogin() {
      try {
        let name = document.getElementById("loginName").value.trim();
        let mobile = document.getElementById("loginMobile").value.trim();
        let section = document.getElementById("loginSection").value;

        if (!name || !mobile || !section) {
          alert("Please enter Name, Section, and Mobile Number!");
          return;
        }

        let btn = document.querySelector("#loginForm .login-btn");
        btn.innerText = "Logging in...";
        btn.disabled = true;

        database.ref('users/' + mobile).once('value').then((snapshot) => {
          let savedData = snapshot.val();
          if (savedData && savedData.name.toLowerCase() === name.toLowerCase() && savedData.section === section) {

            // FACE SCAN SIMULATION
            const overlay = document.getElementById('faceScanOverlay');
            if (overlay) overlay.style.display = 'flex';

            setTimeout(() => {
              if (overlay) overlay.style.display = 'none';

              // Secure Session Storage
              setAuthSession(mobile);
              localStorage.setItem("user_" + btoa(mobile), JSON.stringify(savedData));

              currentUserMobile = mobile;
              showPage("welcomeScreen");

              const wsP = document.querySelector("#welcomeScreen p");
              if (wsP) wsP.innerText = `\nWelcome back, ${savedData.name}!`;

              startTimeTracking();
              updateNeuralHUD(savedData);
              btn.innerText = "Log In";
              btn.disabled = false;
            }, 2500);
          } else {
            alert("Incorrect credentials or user not found.");
            btn.innerText = "Log In";
            btn.disabled = false;
          }
        }).catch(err => {
          console.error("Login database error:", err);
          alert("Login failed due to network error.");
          btn.innerText = "Log In";
          btn.disabled = false;
        });
      } catch (e) {
        console.error("handleLogin crash:", e);
        alert("An unexpected error occurred.");
      }
    }

    // ADMIN FUNCTIONS
    function handleAdminLogin() {
      let userInput = document.getElementById("adminUser").value.trim();
      let passInput = document.getElementById("adminPass").value.trim();

      if (!userInput || !passInput) {
        alert("Please enter both Username and Password!");
        return;
      }

      const doLogin = (creds) => {
        if (userInput === creds.user && passInput === creds.pass) {
          localStorage.setItem("adminSession", "true");
          localStorage.setItem("nx_admin_token", btoa("admin_" + Date.now()));
          showPage("adminDashboard");
          loadAdminData();
          if (typeof initAdminWalletSettings === 'function') initAdminWalletSettings();
          if (typeof renderAdminRechargeRequests === 'function') renderAdminRechargeRequests();
          if (typeof renderAdminWithdrawalRequests === 'function') renderAdminWithdrawalRequests();
          if (typeof renderActivePremiumUsers === 'function') renderActivePremiumUsers();
          if (typeof loadAdminBattles === 'function') loadAdminBattles();
          if (typeof loadAdminBattleBookings === 'function') loadAdminBattleBookings();
          if (typeof loadSiteSettings === 'function') loadSiteSettings();
        } else {
          alert("âŒ Wrong Username or Password! Please try again.");
        }
      };

      // Try Firebase first, fallback to defaults if offline/node missing
      database.ref('adminCredentials').once('value').then(snap => {
        const creds = (snap.exists() && snap.val()) ? snap.val() : { user: "admin", pass: "admin123" };
        doLogin(creds);
      }).catch(() => {
        // If Firebase is unreachable, try default credentials
        doLogin({ user: "admin", pass: "admin123" });
      });
    }

    function adminLogout() {
      try {
        if (!confirm("Are you sure you want to logout?")) return;
        localStorage.removeItem("adminSession");
        localStorage.removeItem("nx_admin_token");
        showPage("loginScreen");
        toggleAuthMode('admin');
        document.getElementById("adminUser").value = "";
        document.getElementById("adminPass").value = "";
      } catch (err) {
        console.error("Admin Logout Error:", err);
        location.reload(); // Hard reset as fallback
      }
    }

    function populateBattleCourses() {
      const sel = document.getElementById("battleCourse");
      if (!sel) return;
      sel.innerHTML = '<option value="" disabled selected>Target Course</option>';
      for (let c in data) {
        let opt = document.createElement("option");
        opt.value = c;
        opt.innerText = c;
        sel.appendChild(opt);
      }
      // Pre-fill UPI from wallet config
      database.ref('walletConfig').once('value').then(snap => {
        let config = snap.val();
        if (config && config.upi && !document.getElementById("battleUPI").value) {
          document.getElementById("battleUPI").value = config.upi;
        }
      });
    }

    function updateAdminCredentials() {
      const newUser = document.getElementById("newAdminUser").value.trim();
      const newPass = document.getElementById("newAdminPass").value.trim();
      const confPass = document.getElementById("confirmAdminPass").value.trim();

      if (!newUser || !newPass) {
        alert("âŒ Error: Username and Password cannot be empty.");
        return;
      }

      if (newPass !== confPass) {
        alert("âŒ Error: Passwords do not match!");
        return;
      }

      if (!confirm("Are you sure you want to change Admin credentials? You will be logged out instantly.")) return;

      database.ref('adminCredentials').set({
        user: newUser,
        pass: newPass,
        updatedAt: Date.now()
      }).then(() => {
        alert("âœ… Credentials Updated Successfully! Logging out...");
        // Clear session and logout
        localStorage.removeItem("adminSession");
        localStorage.removeItem("nx_admin_token");
        location.reload();
      }).catch(err => alert("Update Error: " + err));
    }

    /* PENDING WALLET RECHARGES ADMIN LOGIC */
    function renderAdminRechargeRequests() {
      let tbody = document.getElementById("pendingRechargesTableBody");
      if (!tbody) return;
      tbody.innerHTML = "<tr><td colspan='6' style='padding: 15px; text-align: center; color: cyan;'>Loading...</td></tr>";

      database.ref('rechargeRequests/pending').on('value', snap => {
        let pendingData = snap.val() || {};
        let pendingArr = Object.keys(pendingData)
          .map(key => ({ id: key, ...pendingData[key] }))
          .filter(req => req.type !== "withdrawal") // Show only recharges
          .sort((a, b) => b.timestamp - a.timestamp);

        tbody.innerHTML = "";
        if (pendingArr.length === 0) {
          tbody.innerHTML = "<tr><td colspan='6' style='padding: 15px; text-align: center; color: #aaa;'>No pending recharges.</td></tr>";
          return;
        }

        database.ref('users').once('value').then(uSnap => {
          let usersData = uSnap.val() || {};
          pendingArr.forEach(req => {
            let userName = usersData[req.mobile] ? usersData[req.mobile].name : "Student";
            let tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
            tr.innerHTML = `
              <td style="padding: 10px;">${userName}<br><small style="color:cyan;">${req.mobile}</small></td>
              <td style="padding: 10px;"><span style="color:#00cec9; font-weight:bold; font-size:10px; border:1px solid #00cec9; padding:2px 4px; border-radius:4px;">RECHARGE</span></td>
              <td style="padding: 10px; font-weight:bold; color: gold;">â‚¹${req.amount}</td>
              <td style="padding: 10px; font-family: monospace; font-size:12px;"><b>UTR:</b> ${req.utr || 'N/A'}</td>
              <td style="padding: 10px;">
                <button class="login-btn" onclick="viewRechargeScreenshot('${req.id}')" style="background: rgba(0,255,255,0.1); border:1px solid cyan; color: cyan; padding: 5px 10px; margin: 0; font-size: 10px;">ðŸ–¼ï¸ View Proof</button>
              </td>
              <td style="padding: 10px; display: flex; gap: 5px;">
                <button class="login-btn" onclick="approveRecharge('${req.id}', '${req.mobile}', ${req.amount}, 'recharge')" style="background: #28a745; color: white; padding: 5px 10px; margin: 0; font-size: 10px;">âœ… Approve</button>
                <button class="login-btn" onclick="rejectRecharge('${req.id}', 'recharge')" style="background: #ff4757; color: white; padding: 5px 10px; margin: 0; font-size: 10px;">âŒ Reject</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
      });
    }

    function renderAdminWithdrawalRequests() {
      let tbody = document.getElementById("pendingWithdrawalsTableBody");
      if (!tbody) return;
      tbody.innerHTML = "<tr><td colspan='5' style='padding: 15px; text-align: center; color: #ff4757;'>Loading...</td></tr>";

      database.ref('rechargeRequests/pending').on('value', snap => {
        let pendingData = snap.val() || {};
        let pendingArr = Object.keys(pendingData)
          .map(key => ({ id: key, ...pendingData[key] }))
          .filter(req => req.type === "withdrawal") // Show only withdrawals
          .sort((a, b) => b.timestamp - a.timestamp);

        tbody.innerHTML = "";
        if (pendingArr.length === 0) {
          tbody.innerHTML = "<tr><td colspan='5' style='padding: 15px; text-align: center; color: #aaa;'>No pending withdrawals.</td></tr>";
          return;
        }

        database.ref('users').once('value').then(uSnap => {
          let usersData = uSnap.val() || {};
          pendingArr.forEach(req => {
            let userName = usersData[req.mobile] ? usersData[req.mobile].name : "Student";
            let tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
            tr.innerHTML = `
              <td style="padding: 10px;">${userName}<br><small style="color:cyan;">${req.mobile}</small></td>
              <td style="padding: 10px; font-weight:bold; color: #ff4757;">â‚¹${req.amount}</td>
              <td style="padding: 10px; font-family: monospace; font-size:12px;"><b>UPI:</b> ${req.upiId || 'N/A'}</td>
              <td style="padding: 10px;"><span style="color:#ffcc00; font-size:11px;">PENDING APPROVAL</span></td>
              <td style="padding: 10px; display: flex; gap: 5px;">
                <button class="login-btn" onclick="approveRecharge('${req.id}', '${req.mobile}', ${req.amount}, 'withdrawal')" style="background: #28a745; color: white; padding: 5px 10px; margin: 0; font-size: 10px;">âœ… Mark Paid</button>
                <button class="login-btn" onclick="rejectRecharge('${req.id}', 'withdrawal')" style="background: #ff4757; color: white; padding: 5px 10px; margin: 0; font-size: 10px;">âŒ Reject</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        });
      });
    }

    function viewRechargeScreenshot(reqId) {
      database.ref('rechargeRequests/pending/' + reqId).once('value').then(snap => {
        let req = snap.val();
        if (req && req.screenshot) {
          let win = window.open("");
          win.document.write(`<img src="${req.screenshot}" style="max-width:100%; display:block; margin:auto;" />`);
        } else {
          alert("Screenshot not available.");
        }
      });
    }

    function approveRecharge(reqId, mobile, amount, type) {
      if (!confirm(`Are you sure you want to approve this ${type === 'withdrawal' ? 'WITHDRAWAL' : 'RECHARGE'} of â‚¹${amount} for ${mobile}?`)) return;

      if (type === "withdrawal") {
        // For withdrawals, coins were already deducted on submission (OR they should be now).
        // Let's ensure they are deducted now if not done already.
        // Actually, I'll update the submission logic to deduct immediately and the rejection logic to refund.
        // So for approval, just remove the request.
        database.ref('rechargeRequests/pending/' + reqId).remove().then(() => {
          alert("âœ… Withdrawal request marked as PAID.");
        });
      } else {
        // For recharge, credit the user
        const walletRef = database.ref('users/' + mobile + '/profile/wallet');
        walletRef.transaction(currentBalance => {
          return (currentBalance || 0) + parseFloat(amount);
        }).then(() => {
          return database.ref('rechargeRequests/pending/' + reqId).remove();
        }).then(() => {
          alert("âœ… Recharge Approved! " + amount + " Gold Coins credited.");
        }).catch(err => {
          console.error(err);
          alert("âŒ Failed to approve recharge.");
        });
      }
    }

    function rejectRecharge(reqId, type) {
      let reason = prompt("Enter rejection reason:");
      if (reason === null) return;

      database.ref('rechargeRequests/pending/' + reqId).once('value').then(snap => {
        let req = snap.val();
        if (req && req.type === "withdrawal") {
          // Refund coins for rejected withdrawal
          const walletRef = database.ref('users/' + req.mobile + '/profile/wallet');
          walletRef.transaction(currentBalance => (currentBalance || 0) + parseFloat(req.amount));
        }
        return database.ref('rechargeRequests/pending/' + reqId).remove();
      }).then(() => {
        alert("âŒ Request rejected and removed.");
      });
    }

    /* ADMIN HACK: ONE-CLICK DATA BACKUP */
    function backupFullData() {
      database.ref('/').once('value').then(snap => {
        const data = snap.val();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `NextGen_Backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert("âœ… Full Database Backup Downloaded!");
      });
    }

    /* ADMIN HACK: USER SHADOW MODE */
    function viewUserShadow(mobile) {
      database.ref(`users/${mobile}`).once('value').then(snap => {
        const u = snap.val();
        if (!u) return alert("User not found.");

        const shadowModal = document.getElementById('userShadowModal');
        const shadowDetails = document.getElementById('shadowDetails');
        const shadowPic = document.getElementById('shadowPic');
        const shadowTimestamp = document.getElementById('shadowTimestamp');

        shadowPic.src = u.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(u.name)}&background=ff4757&color=fff`;
        shadowTimestamp.innerText = `LAST_ACCESS: ${new Date().toLocaleTimeString()}`;

        let unlockedItems = "None";
        if (u.premiumUnlocked) {
          unlockedItems = Object.keys(u.premiumUnlocked).filter(k => u.premiumUnlocked[k] === true || (u.premiumUnlocked[k] && u.premiumUnlocked[k].active)).length + " SECTORS";
        }

        shadowDetails.innerHTML = `
            <h2 style="margin: 0 0 2px 0; font-size: 22px; font-weight: 900; text-transform: uppercase; color: #fff; text-shadow: 0 0 10px rgba(255,71,87,0.5);">${u.name}</h2>
            <p style="margin: 0 0 10px 0; font-size: 10px; color: #ff4757; font-weight: bold; text-transform: uppercase;">TARGET IDENTIFIED: SECURE NODE ACTIVE âœ¨</p>
            <table style="width: 100%; font-size: 11px; border-collapse: separate; border-spacing: 0 4px;">
              <tr>
                <td style="color: #ff4757; font-weight: 600; width: 80px; letter-spacing: 1px;">MOBILE NUM</td>
                <td style="color: #fff; font-weight: bold; font-family: monospace; font-size: 12px;">+91 ${mobile}</td>
              </tr>
              <tr>
                <td style="color: gold; font-weight: 600; letter-spacing: 1px;">WALLET</td>
                <td style="color: gold; font-weight: bold; font-size: 12px;">â‚¹${u.profile && u.profile.wallet ? parseFloat(u.profile.wallet).toFixed(2) : '0.00'} GOLD</td>
              </tr>
              <tr>
                <td style="color: #ff4757; font-weight: 600; letter-spacing: 1px;">KNOWLEDGE</td>
                <td style="color: cyan; font-weight: bold; font-size: 12px;">${u.timeSpent || 0} XP POINTS</td>
              </tr>
              <tr>
                <td style="color: #ff4757; font-weight: 600; letter-spacing: 1px;">ACCESS</td>
                <td style="color: #fff; font-weight: bold;">${unlockedItems} UNLOCKED</td>
              </tr>
              <tr>
                <td style="color: #ff4757; font-weight: 600; letter-spacing: 1px;">JOINED</td>
                <td style="color: #ccc; font-size: 10px;">${u.registeredAt ? new Date(u.registeredAt).toLocaleDateString() : '--'}</td>
              </tr>
            </table>
        `;

        if (shadowModal) shadowModal.style.display = 'flex';
      });
    }

    function rejectRecharge(reqId) {
      let reason = prompt("Enter rejection reason (e.g., Fake UTR, Unclear Image, Invalid Amount):");
      if (reason === null || reason.trim() === "") return; // cancelled

      // Either move to a rejected collection or delete. It's safer to just delete and alert
      database.ref('rechargeRequests/pending/' + reqId).once('value').then(snap => {
        let req = snap.val();
        if (req) {
          req.status = "rejected";
          req.reason = reason.trim();
          // optionally save to rejected history, but for now we'll just remove from pending
          database.ref('rechargeRequests/rejected/' + reqId).set(req).then(() => {
            database.ref('rechargeRequests/pending/' + reqId).remove();
            alert("âŒ Recharge request rejected.");
          });
        }
      });
    }

    function loadAdminData() {
      let tbody = document.getElementById("adminTableBody");
      tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>Loading data...</td></tr>";

      database.ref('users').once('value').then(snap => {
        tbody.innerHTML = "";
        let hasData = false;
        let usersData = snap.val();

        if (usersData) {
          for (let key in usersData) {
            let userRecord = usersData[key];
            if (userRecord && userRecord.name && userRecord.mobile && userRecord.mobile === key && userRecord.role !== "admin") {
              hasData = true;
              let isPremium = userRecord.premiumUnlocked && Object.keys(userRecord.premiumUnlocked).some(k => {
                let pu = userRecord.premiumUnlocked[k];
                if (typeof pu === 'object' && pu.active) {
                  if (!pu.expiresAt || Date.now() <= pu.expiresAt) return true;
                }
                return pu === true;
              });

              let rowStyle = isPremium ? "background: rgba(255, 215, 0, 0.1);" : "";
              let nameDisplay = isPremium ? `ðŸ‘‘ <span style="color: gold;">${userRecord.name}</span>` : userRecord.name;

              let tr = document.createElement("tr");
              tr.style.cssText = rowStyle;
              tr.innerHTML = `
                <td>${nameDisplay}</td>
                <td>${userRecord.roll || 'N/A'}</td>
                <td>${userRecord.branch || 'N/A'}</td>
                <td>${userRecord.section || 'N/A'}</td>
                <td>${userRecord.mobile}</td>
                <td style="color: gold; font-weight: bold;">â‚¹${userRecord.profile && userRecord.profile.wallet ? parseFloat(userRecord.profile.wallet).toFixed(2) : '0.00'}</td>
                <td>
                  <button onclick="viewUserShadow('${userRecord.mobile}')" style="background:#6c5ce7; color:white; padding:5px; border-radius:5px; font-size:12px;">ðŸ‘¤ Shadow</button>
                  <button onclick="promptRemoveUser('${userRecord.mobile}')" style="background:#ff4757; color:white; padding:5px; border-radius:5px; font-size:12px; margin-left:5px;">Remove</button>
                  <button onclick="grantPremiumManually('${userRecord.mobile}')" style="background:gold; color:black; padding:5px; border-radius:5px; margin-left:5px; font-size:12px;">+ Prem</button>
                </td>
              `;
              tbody.appendChild(tr);
            }
          }
        }
        if (!hasData) {
          tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No registered students yet.</td></tr>";
        }
      }).catch(err => {
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:red;'>Error loading data!</td></tr>";
        console.error(err);
      });

      initAdminCMS(); // Initialize the Content Management dropdowns

      // Initialize Premium Config Dropdowns (QR/UPI removed - payment via wallet recharge only)
      let pConf = JSON.parse(localStorage.getItem("premiumConfig")) || { amount: "" };
      if (document.getElementById("premiumAmount")) {
        document.getElementById("premiumAmount").value = pConf.amount || "";
      }
      let pCmsCourse = document.getElementById("premConfigCourse");
      if (pCmsCourse) {
        pCmsCourse.innerHTML = '<option value="" disabled selected>Select Premium Course</option>';
        for (let c in premiumData) {
          let opt = document.createElement("option"); opt.value = c; opt.innerText = c; pCmsCourse.appendChild(opt);
        }
      }
      if (document.getElementById("premiumConfigEditor")) {
        document.getElementById("premiumConfigEditor").style.display = "none";
      }
    }

    function initAdminWalletSettings() {
      database.ref('walletConfig').once('value').then(snap => {
        let config = snap.val() || { qr: "", upi: "" };
        let wPreview = document.getElementById("walletQRPreview");
        if (config.qr) {
          wPreview.src = config.qr;
          wPreview.style.display = "block";
        } else {
          wPreview.style.display = "none";
        }
        document.getElementById("walletUPI").value = config.upi || "";
      });
    }

    // Legacy CMS fields logic removed (migrated to simpler integrated drill-down UI)

    function exportToExcel() {
      database.ref('users').once('value').then(snap => {
        let studentInfoList = [];
        let usersData = snap.val();
        if (usersData) {
          for (let key in usersData) {
            let data = usersData[key];
            if (data && data.name && data.mobile && key === data.mobile && data.role !== "admin") {
              studentInfoList.push({
                Name: data.name,
                RollNumber: data.roll || 'N/A',
                Branch: data.branch || 'N/A',
                Section: data.section || 'N/A',
                Mobile: data.mobile,
                TimeSpentMins: data.timeSpent || 0,
                RegisteredAt: data.registeredAt ? new Date(data.registeredAt).toLocaleString() : 'N/A'
              });
            }
          }
        }

        if (studentInfoList.length === 0) {
          alert("No student data available to export.");
          return;
        }

        let ws = XLSX.utils.json_to_sheet(studentInfoList);
        let wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Students");
        XLSX.writeFile(wb, "NextGenLibrary_Students.xlsx");
      }).catch(err => {
        alert("Failed to fetch data for export.");
      });
    }

    /* ADVANCED SITE SETTINGS */
    function loadSiteSettings() {
      database.ref('siteConfig').once('value').then(snapshot => {
        let fbConfig = snapshot.val();
        if (fbConfig) {
          if (!fbConfig.banners) fbConfig.banners = [];
          globalSiteConfig = fbConfig;
          applySiteSettings(fbConfig);
        } else {
          applySiteSettings(globalSiteConfig);
        }
      });
    }

    function applySiteSettings(config) {
      if (!config.banners) config.banners = [];
      let premToggle = document.getElementById("sitePremiumToggle");
      if (premToggle) {
        premToggle.value = (config.premiumEnabled !== false) ? "true" : "false";
      }

      let tickerEl = document.getElementById("globalTicker");
      let tickerTextEl = document.getElementById("tickerText");

      if (config.ticker && config.ticker.trim() !== "") {
        // Create seamless loop by duplicating text
        tickerTextEl.innerText = config.ticker + " â€¢ " + config.ticker + " â€¢ " + config.ticker + " â€¢ " + config.ticker;
        tickerEl.style.display = "block";
        if (document.getElementById("siteTickerText")) document.getElementById("siteTickerText").value = config.ticker;
      } else {
        tickerEl.style.display = "none";
        if (document.getElementById("siteTickerText")) document.getElementById("siteTickerText").value = "";
      }

      let welcomeEl = document.getElementById("welcomeSubtitle");
      if (document.getElementById("siteWelcomeText")) {
        if (config.welcome && config.welcome.trim() !== "") {
          if (welcomeEl) welcomeEl.innerText = config.welcome;
          document.getElementById("siteWelcomeText").value = config.welcome;
        } else {
          if (welcomeEl) welcomeEl.innerText = "Your Digital Learning Hub"; // fallback
          document.getElementById("siteWelcomeText").value = "";
        }
      }

      let aboutEl = document.getElementById("aboutUsContent");
      if (document.getElementById("siteAboutText")) {
        if (config.about && config.about.trim() !== "") {
          let formattedAbout = config.about.split('\n').filter(p => p.trim() !== '').map(p => `<p>${p}</p>`).join('');
          if (aboutEl) aboutEl.innerHTML = formattedAbout;
          document.getElementById("siteAboutText").value = config.about;
        } else {
          let def = `
            <p>Welcome to NextGen Library, your premier digital learning platform designed for modern students. We believe that quality education should be structured, accessible, and interactive.</p>
            <p>Our platform integrates:</p>
            <ul>
              <li>High-quality Video Lectures</li>
              <li>Meticulously curated Study Notes</li>
              <li>Rigorous Assignments & Practice</li>
              <li>Comprehensive Homework Guidance</li>
              <li>Instant Doubt Resolution Support</li>
            </ul>
            <p>Whether you're tackling daily challenges or seeking clarity, we provide the tools necessary for academic excellence and personal growth.</p>
          `;
          if (aboutEl) aboutEl.innerHTML = def;
          document.getElementById("siteAboutText").value = "";
        }
      }

      if (document.getElementById("adminBannerList")) {
        renderAdminBanners(config.banners);
      }
      renderUserBanners(config.banners);
    }

    function saveSiteSettings() {
      let config = globalSiteConfig;
      let ticker = document.getElementById("siteTickerText").value.trim();
      let welcome = document.getElementById("siteWelcomeText").value.trim();
      let about = document.getElementById("siteAboutText").value.trim();
      let premiumEnabled = document.getElementById("sitePremiumToggle").value === "true";
      let banners = config.banners || [];

      let payload = { ticker, welcome, about, premiumEnabled, banners };

      database.ref('siteConfig').set(payload).then(() => {
        globalSiteConfig = payload;
        loadSiteSettings();
        alert("âœ… Site settings updated!");
      }).catch(err => {
        console.error(err);
        alert("âŒ Failed to update site settings.");
      });
    }

    // --- CERTIFICATE BROKERAGE SYSTEM (ADMIN) ---
    function addAdminCertificate() {
      const title = document.getElementById("adminCertTitle").value.trim();
      const price = parseFloat(document.getElementById("adminCertPrice").value);
      let imageUrl = document.getElementById("adminCertImage").value.trim();
      const fileInput = document.getElementById("adminCertFileUpload");
      const link = document.getElementById("adminCertLink").value.trim();
      const instructions = document.getElementById("adminCertInstructions").value.trim();

      if (!title || isNaN(price) || !link) {
        alert("Please fill Title, Price, and Redirection Link.");
        return;
      }

      const proceedWithData = (finalImage) => {
        const certId = "cert_" + Date.now();
        const certData = { id: certId, title, price, image: finalImage, link, instructions, createdAt: Date.now() };

        database.ref('certificates/' + certId).set(certData).then(() => {
          alert("ðŸ“œ Certificate published successfully!");
          document.getElementById("adminCertTitle").value = "";
          document.getElementById("adminCertPrice").value = "";
          document.getElementById("adminCertImage").value = "";
          document.getElementById("adminCertFileUpload").value = "";
          document.getElementById("adminCertLink").value = "";
          document.getElementById("adminCertInstructions").value = "";
          renderAdminCertificates();
        }).catch(err => alert("Error: " + err));
      };

      // Handle File Upload first
      if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function (e) {
          proceedWithData(e.target.result);
        };
        reader.readAsDataURL(fileInput.files[0]);
      } else if (imageUrl) {
        // AUTO-CONVERT GOOGLE DRIVE LINKS
        if (imageUrl.includes("drive.google.com") || imageUrl.includes("googledrive.com")) {
          try {
            const driveRegex = /(?:\/d\/|id=)([\w-]+)/;
            const match = imageUrl.match(driveRegex);
            if (match && match[1]) {
              imageUrl = `https://lh3.googleusercontent.com/d/${match[1]}`;
            }
          } catch (e) { console.error("Drive link conversion failed", e); }
        }
        proceedWithData(imageUrl);
      } else {
        alert("Please either upload an image or provide an Image URL.");
      }
    }

    function deleteAdminCertificate(id) {
      if (!confirm("Are you sure you want to delete this certificate?")) return;
      database.ref('certificates/' + id).remove().then(() => {
        alert("ðŸ—‘ï¸ Certificate deleted.");
        renderAdminCertificates();
      });
    }

    function renderAdminCertificates() {
      const list = document.getElementById("adminCertList");
      if (!list) return;

      database.ref('certificates').once('value').then(snap => {
        const certs = snap.val() || {};
        list.innerHTML = "";

        const certArray = Object.values(certs).sort((a, b) => b.createdAt - a.createdAt);

        if (certArray.length === 0) {
          list.innerHTML = "<p style='color:#777; text-align:center;'>No certificates added yet.</p>";
          return;
        }

        certArray.forEach(cert => {
          const card = document.createElement("div");
          card.style.cssText = "background: rgba(255,255,255,0.05); border: 1px solid cyan; border-radius: 12px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;";
          card.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px;">
              <div style="width: 100px; height: 60px; border-radius: 8px; overflow: hidden; border: 1px solid cyan; background: #000; flex-shrink: 0;">
                <img src="${cert.image}" style="width: 100%; height: 100%; object-fit: contain;">
              </div>
              <div>
                <h4 style="margin: 0; color: white;">${cert.title}</h4>
                <div style="font-size: 12px; color: cyan;">ðŸª™ ${cert.price} Coins</div>
              </div>
            </div>
            <button onclick="deleteAdminCertificate('${cert.id}')" style="background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer;">ðŸ—‘ï¸ Delete</button>
          `;
          list.appendChild(card);
        });
      });
    }

    // --- CERTIFICATE BROKERAGE SYSTEM (STUDENT STORE) ---
    function openCertificateStore() {
      showPage('certificateStoreScreen');
      renderCertificateStore();
    }

    function renderCertificateStore() {
      const grid = document.getElementById("certificateGrid");
      const balanceEl = document.getElementById("certStoreBalance");
      if (!grid) return;

      // Update balance display
      database.ref('users/' + currentUserMobile + '/profile/wallet').on('value', snap => {
        const balance = snap.val() || 0;
        if (balanceEl) balanceEl.innerHTML = `ðŸª™ ${balance}`;
      });

      // Get unlocked certs for this user
      database.ref('users/' + currentUserMobile + '/unlockedCertificates').on('value', userSnap => {
        const unlocked = userSnap.val() || {};

        database.ref('certificates').once('value').then(snap => {
          const certs = snap.val() || {};
          grid.innerHTML = "";

          Object.values(certs).forEach(cert => {
            const isUnlocked = !!unlocked[cert.id];
            const card = document.createElement("div");
            card.className = "box";
            card.style.padding = "20px";
            card.style.position = "relative";

            card.innerHTML = `
              <div style="text-align: center;">
                <div style="width: 100%; height: 140px; border-radius: 15px; overflow: hidden; border: 2px solid cyan; margin-bottom: 20px; background: #000; box-shadow: 0 0 20px rgba(0,242,254,0.3); ${!isUnlocked ? 'filter: grayscale(1) blur(2px); opacity: 0.6;' : ''}">
                  <img src="${cert.image}" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <h3 style="color: white; margin: 0 0 10px 0; font-size: 20px;">${cert.title}</h3>
                ${!isUnlocked ?
                `<div style="color: cyan; font-weight: 800; font-size: 18px; margin-bottom: 15px;">ðŸª™ ${cert.price}</div>
                   <button onclick="buyCertificate('${cert.id}', ${cert.price}, '${cert.title.replace(/'/g, "\\'")}')" class="login-btn" style="background: cyan; color: black; font-weight: 900;">ðŸ”“ UNLOCK NOW</button>`
                :
                `<div style="color: #38ef7d; font-weight: 800; font-size: 13px; margin-bottom: 15px;">âœ… UNLOCKED</div>
                   <button onclick="showClaimModal('${cert.id}')" class="login-btn" style="background: #38ef7d; color: black; font-weight: 900;">ðŸ“œ CLAIM NOW</button>`
              }
              </div>
            `;
            grid.appendChild(card);
          });
        });
      });
    }

    // --- MY COLLECTION SYSTEM ---
    function openMyCollection() {
      showPage('myCollectionScreen');
      renderMyCollection();
    }

    function uploadToMyCollection() {
      const name = document.getElementById("myCollFileName").value.trim();
      const fileInput = document.getElementById("myCollFileUpload");

      if (!name) {
        alert("Please enter a name for the document.");
        return;
      }
      if (!fileInput.files || !fileInput.files[0]) {
        alert("Please select a file to upload.");
        return;
      }

      const file = fileInput.files[0];
      const reader = new FileReader();

      reader.onload = function (e) {
        const fileData = e.target.result;
        const fileType = file.type.includes("pdf") ? "pdf" : "image";
        const fileId = "file_" + Date.now();

        const payload = {
          id: fileId,
          name: name,
          data: fileData,
          type: fileType,
          uploadedAt: Date.now()
        };

        database.ref('users/' + currentUserMobile + '/myCollection/' + fileId).set(payload).then(() => {
          alert("âœ… Document saved to your collection!");
          document.getElementById("myCollFileName").value = "";
          document.getElementById("myCollFileUpload").value = "";
          renderMyCollection();
        }).catch(err => alert("Upload Error: " + err));
      };

      reader.readAsDataURL(file);
    }

    function renderMyCollection() {
      const grid = document.getElementById("myCollectionGrid");
      if (!grid) return;

      // Combine uploaded files and purchased certificates
      Promise.all([
        database.ref('users/' + currentUserMobile + '/myCollection').once('value'),
        database.ref('users/' + currentUserMobile + '/unlockedCertificates').once('value'),
        database.ref('certificates').once('value')
      ]).then(results => {
        const [uploadSnap, unlockedSnap, allCertsSnap] = results;
        const uploadedDocs = uploadSnap.val() || {};
        const unlockedCertIds = unlockedSnap.val() || {};
        const allCertData = allCertsSnap.val() || {};

        grid.innerHTML = "";
        let items = [];

        // Add uploaded items
        Object.values(uploadedDocs).forEach(doc => {
          items.push({
            ...doc,
            isCert: false,
            sortKey: doc.uploadedAt || 0
          });
        });

        // Add purchased certificates
        Object.keys(unlockedCertIds).forEach(certId => {
          const cert = allCertData[certId];
          if (cert) {
            items.push({
              id: certId,
              name: cert.title,
              data: cert.image,
              link: cert.link,
              type: 'certificate',
              isCert: true,
              sortKey: Date.now()
            });
          }
        });

        items.sort((a, b) => b.sortKey - a.sortKey);

        if (items.length === 0) {
          grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #666;">
            <div style="font-size: 50px; margin-bottom: 10px;">ðŸ“­</div>
            <p>Your collection is empty. Upload documents or purchase certificates!</p>
          </div>`;
          return;
        }

        items.forEach(item => {
          const card = document.createElement("div");
          card.className = "box";
          card.style.cssText = "padding: 20px; position: relative; border: 1px solid rgba(0,242,254,0.3); background: rgba(0,242,254,0.02);";

          const isPdf = item.type === "pdf";
          const isPurchasedCert = item.isCert;

          card.innerHTML = `
            <div style="text-align: center;">
              <div style="width: 100%; height: 140px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(0,242,254,0.5); margin-bottom: 15px; background: #000; display: flex; align-items: center; justify-content: center;">
                ${isPdf ?
              `<div style="text-align: center;">
                    <div style="font-size: 50px;">ðŸ“„</div>
                    <div style="color: #ff4757; font-weight: bold; font-size: 14px;">PDF DOCUMENT</div>
                   </div>` :
              `<img src="${item.data}" style="width: 100%; height: 100%; object-fit: contain;">`
            }
              </div>
              <h3 style="color: white; margin: 0 0 5px 0; font-size: 18px; word-break: break-all;">${item.name}</h3>
              <p style="color: #666; font-size: 11px; margin-bottom: 20px;">
                ${isPurchasedCert ? '<span style="color: #38ef7d; font-weight:bold;">ðŸ† PURCHASED CERTIFICATE</span>' : `Uploaded: ${new Date(item.uploadedAt).toLocaleDateString()}`}
              </p>
              
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                ${isPurchasedCert ?
              `<button onclick="showClaimModal('${item.id}')" class="login-btn" style="padding: 8px; font-size: 12px; background: #38ef7d; color: black; border: none;">ðŸš€ CLAIM</button>
                   <button onclick="viewImageFull('${item.data}')" class="login-btn" style="padding: 8px; font-size: 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid white;">ðŸ‘ï¸ VIEW</button>`
              :
              `<button onclick="viewCollectionDoc('${item.id}')" class="login-btn" style="padding: 8px; font-size: 12px; background: rgba(0,242,254,0.1); color: #00f2fe; border: 1px solid #00f2fe;">ðŸ‘ï¸ VIEW</button>
                   <a href="${item.data}" download="${item.name}" class="login-btn" style="padding: 8px; font-size: 12px; background: #00f2fe; color: black; text-decoration: none; display: flex; align-items: center; justify-content: center;">ðŸ“¥ DOWNLOAD</a>`
            }
              </div>
              ${!isPurchasedCert ? `<button onclick="deleteFromCollection('${item.id}')" style="position: absolute; top: 10px; right: 10px; background: none; border: none; color: #ff4757; cursor: pointer; font-size: 18px;" title="Delete">ðŸ—‘ï¸</button>` : ''}
            </div>
          `;
          grid.appendChild(card);
        });
      });
    }

    function viewImageFull(src) {
      const win = window.open();
      win.document.write(`<img src="${src}" style="max-width: 100%; height: auto; display: block; margin: 0 auto;">`);
    }

    function viewCollectionDoc(id) {
      database.ref('users/' + currentUserMobile + '/myCollection/' + id).once('value').then(snap => {
        const doc = snap.val();
        if (!doc) return;

        const win = window.open();
        if (doc.type === "pdf") {
          win.document.write(`<iframe src="${doc.data}" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>`);
        } else {
          win.document.write(`<img src="${doc.data}" style="max-width: 100%; height: auto; display: block; margin: 0 auto;">`);
        }
        win.document.title = doc.name;
      });
    }

    function deleteFromCollection(id) {
      if (!confirm("Are you sure you want to delete this document from your collection?")) return;
      database.ref('users/' + currentUserMobile + '/myCollection/' + id).remove().then(() => {
        alert("ðŸ—‘ï¸ Document removed.");
      });
    }

    function buyCertificate(id, price, title) {
      if (!confirm(`Unlock "${title}" for ${price} Gold Coins?`)) return;

      database.ref('users/' + currentUserMobile + '/profile/wallet').once('value').then(snap => {
        const balance = parseFloat(snap.val() || 0);
        if (balance < price) {
          alert(`âŒ INSUFFICIENT BALANCE!\n\nYou need ${price} Coins but only have ${balance}.`);
          return;
        }

        // Transaction
        database.ref('users/' + currentUserMobile + '/profile/wallet').set(balance - price).then(() => {
          return database.ref(`users/${currentUserMobile}/unlockedCertificates/${id}`).set(true);
        }).then(() => {
          showCongratulations(
            'CERTIFICATE UNLOCKED!',
            `<b>${title}</b> is now in your collection!`,
            `You can now claim your actual certificate via our partner website.`,
            'VIEW IN STORE'
          );
          renderCertificateStore();
        }).catch(err => alert("Error: " + err));
      });
    }

    function showClaimModal(id) {
      database.ref('certificates/' + id).once('value').then(snap => {
        const cert = snap.val();
        if (!cert) return;

        document.getElementById("claimModalTitle").innerText = cert.title;
        document.getElementById("claimModalInstructions").innerText = cert.instructions || "No specific instructions provided. Please proceed to the partner website to claim your certificate.";

        const btn = document.getElementById("claimRedirectBtn");
        btn.onclick = () => {
          window.open(cert.link, "_blank");
          closeClaimModal();
        };

        document.getElementById("claimModal").style.display = "flex";
      });
    }

    function closeClaimModal() {
      document.getElementById("claimModal").style.display = "none";
    }

    function addSiteBanner() {
      let fileInput = document.getElementById("siteBannerImageInput");
      let linkInput = document.getElementById("siteBannerLinkInput");

      let file = fileInput.files[0];
      let link = linkInput.value.trim();

      if (!file) {
        alert("Please select an image for the banner.");
        return;
      }

      let reader = new FileReader();
      reader.onload = function (e) {
        let img = new Image();
        img.onload = function () {
          let canvas = document.createElement("canvas");
          let MAX_WIDTH = 1472;
          let MAX_HEIGHT = 720;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > MAX_WIDTH) {
              height *= MAX_WIDTH / width;
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width *= MAX_HEIGHT / height;
              height = MAX_HEIGHT;
            }
          }

          canvas.width = width;
          canvas.height = height;
          let ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, width, height);

          let base64 = canvas.toDataURL("image/jpeg", 0.7);

          let config = JSON.parse(localStorage.getItem("siteConfig")) || { banners: [] };
          if (!config.banners) config.banners = [];
          config.banners.push({ image: base64, link: link });

          localStorage.setItem("siteConfig", JSON.stringify(config));
          database.ref('siteConfig/banners').set(config.banners).then(() => {
            renderAdminBanners(config.banners);
            renderUserBanners(config.banners);
            fileInput.value = "";
            linkInput.value = "";
            alert("Banner added successfully!");
          });
        };
        img.src = e.target.result;
      };
      reader.readAsDataURL(file);
    }

    function deleteSiteBanner(index) {
      if (!confirm("Are you sure you want to delete this banner?")) return;
      let config = JSON.parse(localStorage.getItem("siteConfig")) || { banners: [] };
      if (!config.banners) return;

      config.banners.splice(index, 1);
      globalSiteConfig = config;

      database.ref('siteConfig/banners').set(config.banners).then(() => {
        renderAdminBanners(config.banners);
        renderUserBanners(config.banners);
      });
    }

    function renderAdminBanners(banners) {
      let list = document.getElementById("adminBannerList");
      if (!list) return;
      list.innerHTML = "";
      if (!banners || banners.length === 0) {
        list.innerHTML = "<p style='color:#ccc;'>No banners added yet.</p>";
        return;
      }

      banners.forEach((b, index) => {
        let li = document.createElement("li");
        li.style.display = "flex";
        li.style.justifyContent = "space-between";
        li.style.alignItems = "center";
        li.style.background = "rgba(255,255,255,0.05)";
        li.style.padding = "10px";
        li.style.marginBottom = "5px";
        li.style.borderRadius = "5px";

        let info = document.createElement("div");
        info.innerHTML = `<img src="${b.image}" style="width:100px; height:50px; object-fit:cover; vertical-align:middle; margin-right:10px; border-radius:5px;">` +
          `<a href="${b.link}" target="_blank" style="color:cyan; font-size:12px;">${b.link || 'No Link'}</a>`;

        let delBtn = document.createElement("button");
        delBtn.innerText = "âŒ Delete";
        delBtn.style.background = "#ff4757";
        delBtn.style.color = "white";
        delBtn.style.border = "none";
        delBtn.style.padding = "5px 10px";
        delBtn.style.borderRadius = "5px";
        delBtn.style.cursor = "pointer";
        delBtn.onclick = () => deleteSiteBanner(index);

        li.appendChild(info);
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    let sliderIntervals = {};
    window.sliderCurrentIndex = { home: 0, branch: 0 };

    function renderUserBanners(banners) {
      let homeContainer = document.getElementById("homeSliderContainer");
      let branchContainer = document.getElementById("branchSliderContainer");

      if (!banners || banners.length === 0) {
        if (homeContainer) { homeContainer.style.display = "none"; homeContainer.innerHTML = ""; }
        if (branchContainer) { branchContainer.style.display = "none"; branchContainer.innerHTML = ""; }
        return;
      }

      function buildSliderHtml(idPrefix) {
        let slidesHtml = banners.map((b, i) => {
          let onClick = i === 0 ? "openPremiumHub()" : (b.link ? `window.open('${b.link}', '_blank')` : '');
          return `
          <div class="slider-slide" ${onClick ? `onclick="${onClick}"` : ''}>
            <img src="${b.image}">
          </div>
          `;
        }).join('');

        let dotsHtml = banners.map((b, i) => `
          <div class="slider-dot ${i === 0 ? 'active' : ''}" onclick="goToSlide('${idPrefix}', ${i})"></div>
        `).join('');

        return `
          <div class="slider-main" id="${idPrefix}Main">
            <div class="slider-wrapper" id="${idPrefix}Wrapper" style="transform: translateX(0%); display: flex; transition: transform 0.5s ease-in-out;">
              ${slidesHtml}
            </div>
            ${banners.length > 1 ? `<div class="slider-nav" id="${idPrefix}Nav">${dotsHtml}</div>` : ''}
          </div>
        `;
      }

      if (homeContainer) {
        homeContainer.innerHTML = buildSliderHtml('home');
        homeContainer.style.display = "block";
        window.sliderCurrentIndex['home'] = 0;
        startBannerSlider('home', banners.length);
      }
      if (branchContainer) {
        branchContainer.innerHTML = buildSliderHtml('branch');
        branchContainer.style.display = "block";
        window.sliderCurrentIndex['branch'] = 0;
        startBannerSlider('branch', banners.length);
      }
    }

    window.goToSlide = function (idPrefix, index) {
      window.sliderCurrentIndex[idPrefix] = index;
      updateSlider(idPrefix);
      let totalSlides = document.querySelectorAll(`#${idPrefix}Wrapper .slider-slide`).length;
      if (totalSlides > 1) {
        startBannerSlider(idPrefix, totalSlides);
      }
    };

    function updateSlider(idPrefix) {
      let wrapper = document.getElementById(`${idPrefix}Wrapper`);
      let dots = document.querySelectorAll(`#${idPrefix}Nav .slider-dot`);
      if (!wrapper) return;

      let index = window.sliderCurrentIndex[idPrefix] || 0;
      wrapper.style.transform = `translateX(-${index * 100}%)`;

      dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === index);
      });
    }

    function startBannerSlider(idPrefix, totalSlides) {
      if (totalSlides <= 1) return;
      if (sliderIntervals[idPrefix]) clearInterval(sliderIntervals[idPrefix]);

      sliderIntervals[idPrefix] = setInterval(() => {
        let currentIndex = window.sliderCurrentIndex[idPrefix] || 0;
        window.sliderCurrentIndex[idPrefix] = (currentIndex + 1) % totalSlides;
        updateSlider(idPrefix);
      }, 3000);
    }

    /* PREMIUM CONTENT CMS SETTINGS */
    let premiumData = JSON.parse(localStorage.getItem("premiumData")) || {
      "BCA": {
        "Nimcet & MCA": [],
        "Exam point of view": []
      }
    };

    function renderStudentCourses() {
      const container = document.getElementById("programs");
      const regSelect = document.getElementById("regBranch");
      if (regSelect) regSelect.innerHTML = '<option value="" disabled selected>Course (e.g. BCA)</option>';

      if (!container) return;
      const premiumBox = document.getElementById("premiumLinkBox");
      const battleBox = document.getElementById("battleArenaBox");
      const codeBox = document.getElementById("codeStudioBox");
      const certBox = document.getElementById("certStoreBox");
      const myCollBox = document.getElementById("myCollBox");

      // Clear but keep premium, code studio, battle, cert, and collection boxes
      Array.from(container.children).forEach(child => {
        if (child !== premiumBox && child !== battleBox && child !== codeBox && child !== certBox && child !== myCollBox)
          container.removeChild(child);
      });

      for (let course in data) {
        let icon = "ðŸŽ“";
        if (course.includes("BTECH")) icon = "ðŸ¢";
        else if (course.includes("BBA")) icon = "ðŸ’¼";
        else if (course.includes("LAW")) icon = "âš–ï¸";
        else if (course.includes("BCA")) icon = "ðŸ’»"; // Keep existing LAW icon logic

        let box = document.createElement("div");
        box.className = "box";
        box.onclick = () => openStudentLevel('course', course);
        box.innerHTML = `<h1>${icon}</h1>${course}`; // Changed to h1
        container.insertBefore(box, premiumBox);

        if (regSelect) {
          let opt = document.createElement("option");
          opt.value = course;
          opt.innerText = course;
          regSelect.appendChild(opt);
        }
      }
    }

    function renderPremiumHubCourses() {
      const container = document.getElementById("premiumCoursesContainer");
      if (!container) return;
      container.innerHTML = "";

      for (let course in premiumData) {
        let icon = "ðŸŽ“";
        if (course.includes("BTECH")) icon = "ðŸ¢";
        else if (course.includes("BBA")) icon = "ðŸ’¼";

        let box = document.createElement("div");
        box.className = "box";
        box.onclick = () => showPremiumOptions(course);
        box.innerHTML = `<h1>${icon}</h1>Premium ${course}`;
        container.appendChild(box);
      }
    }

    function savePremiumData() {
      database.ref('premiumData').set(premiumData).then(() => {
        // Sync to local memory
        localStorage.setItem("premiumData", JSON.stringify(premiumData));
      }).catch(err => {
        console.error("Premium data save failed", err);
      });
    }

    function onPremCourseChange() {
      let course = document.getElementById("premCmsCourse").value;
      if (!course) return;
      document.getElementById("premEditor").style.display = "block";

      let optSelect = document.getElementById("premCmsOption");
      optSelect.innerHTML = '<option value="" disabled selected>Select Option</option>';

      let options = premiumData[course] || {};
      for (let opt in options) {
        let op = document.createElement("option");
        op.value = opt;
        op.innerText = opt;
        optSelect.appendChild(op);
      }

      document.getElementById("adminPremPdfList").innerHTML = "";
    }

    function onPremOptionChange() {
      renderPremPdfList();
      renderPremSubOptionList();
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      if (course && option) {
        let itemKey = course + "_" + option;
        document.getElementById("activePremOptionTitle").innerText = `Editing: ${course} > ${option}`;
        let conf = (premiumPrices && premiumPrices[itemKey]) ? premiumPrices[itemKey] : { price: 49, duration: 365 };
        document.getElementById("premOptionPrice").value = conf.price || 49;
        document.getElementById("premOptionDuration").value = conf.duration || 365;
      }
    }

    function saveOptionPrice() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      let price = document.getElementById("premOptionPrice").value.trim();
      let duration = document.getElementById("premOptionDuration").value.trim();

      if (!course || !option || !price) {
        alert("Please select an option and enter a price.");
        return;
      }

      let itemKey = course + "_" + option;
      if (!premiumPrices) premiumPrices = {};
      premiumPrices[itemKey] = {
        price: parseFloat(price),
        duration: parseInt(duration) || 365
      };

      database.ref('premiumPrices').set(premiumPrices).then(() => {
        localStorage.setItem("premiumPrices", JSON.stringify(premiumPrices));
        alert("âœ… Settings for " + option + " saved. Price: " + price + " Coins, Duration: " + duration + " Days.");
      }).catch(err => {
        alert("âŒ Failed to save settings: " + err);
      });
    }

    function addPremiumOption() {
      let course = document.getElementById("premCmsCourse").value;
      let newOptName = document.getElementById("newPremOptionName").value.trim();
      if (!course || !newOptName) {
        alert("Please select a course and type an option name.");
        return;
      }

      if (!premiumData[course]) premiumData[course] = {};
      if (premiumData[course][newOptName]) {
        alert("Option already exists!");
        return;
      }

      premiumData[course][newOptName] = [];
      savePremiumData();

      document.getElementById("newPremOptionName").value = "";
      onPremCourseChange(); // Reload dropdown
      document.getElementById("premCmsOption").value = newOptName;
      onPremOptionChange();
    }

    function addPremiumPdf() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      let title = document.getElementById("newPremPdfTitle").value.trim();
      let link = document.getElementById("newPremPdfLink").value.trim();

      if (!course || !option || !title || !link) {
        alert("Please fill out all fields.");
        return;
      }

      premiumData[course][option].push({ title, link });
      savePremiumData();

      document.getElementById("newPremPdfTitle").value = "";
      document.getElementById("newPremPdfLink").value = "";
      renderPremPdfList();
    }

    function removePremiumPdf(index) {
      if (!confirm("Are you sure you want to delete this PDF?")) return;
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;

      premiumData[course][option].splice(index, 1);
      savePremiumData();
      renderPremPdfList();
    }

    function renderPremPdfList() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      let list = document.getElementById("adminPremPdfList");
      list.innerHTML = "";

      if (!course || !option) return;
      if (!premiumData[course] || !premiumData[course][option]) {
        list.innerHTML = "<li style='color:#ccc;'>No files added yet.</li>";
        return;
      }

      let files = premiumData[course][option].files || premiumData[course][option];
      // Legacy: if it's an array (old format), treat all as pdfs
      if (!Array.isArray(files) && typeof files !== 'object') {
        list.innerHTML = "<li style='color:#ccc;'>No files added yet.</li>";
        return;
      }

      let items = Array.isArray(files) ? files.map(f => Object.assign({ type: 'pdf' }, f)) : Object.values(files);

      if (items.length === 0) {
        list.innerHTML = "<li style='color:#ccc;'>No files added yet.</li>";
        return;
      }

      const typeIcon = { pdf: 'ðŸ“„', image: 'ðŸ–¼ï¸', video: 'ðŸŽ¬' };
      const typeColor = { pdf: '#00cec9', image: '#fd79a8', video: '#e17055' };

      items.forEach((file, index) => {
        let li = document.createElement("li");
        li.style.cssText = "display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.04); margin-bottom: 6px; border-radius: 8px; border-left: 3px solid " + (typeColor[file.type] || '#aaa') + ";";
        li.innerHTML = `
          <span style="flex:1;">${typeIcon[file.type] || 'ðŸ“'} <b style="color:${typeColor[file.type] || '#fff'}">${file.title}</b> <small style="color:#777;">${file.type}</small><br><small style="color:#555;word-break:break-all;">${file.link}</small></span>
          <button onclick="removeOptionFile(${index})" style="background: transparent; color: #ff4757; border: 1px solid #ff4757; padding: 4px 10px; border-radius: 4px; cursor: pointer; flex-shrink:0; margin-left:10px;">ðŸ—‘ï¸</button>
        `;
        list.appendChild(li);
      });
    }

    function removeOptionFile(index) {
      if (!confirm("Delete this file entry?")) return;
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      if (!course || !option) return;

      let optData = premiumData[course][option];
      if (Array.isArray(optData)) {
        optData.splice(index, 1);
      } else if (optData.files) {
        optData.files.splice(index, 1);
      }
      savePremiumData();
      renderPremPdfList();
    }

    // Legacy: kept for backward compat (old removePremiumPdf calls)
    function removePremiumPdf(index) { removeOptionFile(index); }

    // ===== PREMIUM COURSE ADD/DELETE =====
    function addPremiumCourse() {
      let name = document.getElementById("newPremCourseName").value.trim().toUpperCase();
      if (!name) return alert("Course name cannot be empty.");
      if (!premiumData) premiumData = {};
      if (premiumData[name]) return alert(`Premium course '${name}' already exists!`);
      premiumData[name] = {};
      savePremiumData();
      document.getElementById("newPremCourseName").value = "";
      onPremCourseChange && null;
      initAdminCMS();
      renderPremCourseList();
      alert(`âœ… Premium course '${name}' added!`);
    }

    function deletePremiumCourse() {
      let course = document.getElementById("deletePremCourseSelect").value;
      if (!course) return alert("Select a course to delete.");
      if (!confirm(`Delete premium course '${course}' and ALL its options/files? This cannot be undone.`)) return;
      delete premiumData[course];
      database.ref(`premiumData/${course}`).remove().then(() => {
        alert(`ðŸ—‘ï¸ Premium course '${course}' deleted.`);
        initAdminCMS();
        renderPremCourseList();
        document.getElementById("premCmsCourse").value = "";
        document.getElementById("premEditor").style.display = "none";
      }).catch(e => alert("Error: " + e));
    }

    function renderPremCourseList() {
      let sel = document.getElementById("deletePremCourseSelect");
      let display = document.getElementById("premCourseListDisplay");
      if (!sel || !display) return;
      sel.innerHTML = '<option value="" disabled selected>Select Course to Delete</option>';
      display.innerHTML = "";
      let premSel = document.getElementById("premCmsCourse");
      if (premSel) premSel.innerHTML = '<option value="" disabled selected>Select Premium Course</option>';
      if (!premiumData) return;
      for (let c in premiumData) {
        let opt = document.createElement("option");
        opt.value = c; opt.innerText = c;
        sel.appendChild(opt);
        if (premSel) {
          let o2 = document.createElement("option");
          o2.value = c; o2.innerText = c;
          premSel.appendChild(o2);
        }
        let chip = document.createElement("span");
        chip.style.cssText = "background: rgba(255,215,0,0.1); border: 1px solid gold; color: gold; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;";
        chip.innerText = c;
        display.appendChild(chip);
      }
    }

    // ===== OPTION DELETE/RENAME =====
    function deletePremiumOption() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      if (!course || !option) return alert("Select a course and option first.");
      if (!confirm(`Delete option '${option}' from '${course}'? All its files and sub-options will be removed.`)) return;
      delete premiumData[course][option];
      savePremiumData();
      onPremCourseChange();
      document.getElementById("premEditor").style.display = "none";
      alert(`ðŸ—‘ï¸ Option '${option}' deleted.`);
    }

    function renamePremiumOption() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      if (!course || !option) return alert("Select a course and option first.");
      let newName = prompt(`Rename option '${option}' to:`, option);
      if (!newName || newName.trim() === option) return;
      newName = newName.trim();
      if (premiumData[course][newName]) return alert("An option with that name already exists.");
      premiumData[course][newName] = premiumData[course][option];
      delete premiumData[course][option];
      savePremiumData();
      onPremCourseChange();
      document.getElementById("premCmsOption").value = newName;
      onPremOptionChange();
    }

    // ===== SUB-OPTIONS =====
    function addPremiumSubOption() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      let subName = document.getElementById("newPremSubOptionName").value.trim();
      if (!course || !option) return alert("Select a course and option first.");
      if (!subName) return alert("Enter a sub-option name.");

      if (!premiumData[course][option] || typeof premiumData[course][option] !== 'object' || Array.isArray(premiumData[course][option])) {
        // Migrate from array to object
        let oldFiles = Array.isArray(premiumData[course][option]) ? premiumData[course][option] : [];
        premiumData[course][option] = { files: oldFiles, subOptions: {} };
      }
      if (!premiumData[course][option].subOptions) premiumData[course][option].subOptions = {};
      if (premiumData[course][option].subOptions[subName]) return alert("Sub-option already exists!");
      premiumData[course][option].subOptions[subName] = { files: [] };
      savePremiumData();
      document.getElementById("newPremSubOptionName").value = "";
      renderPremSubOptionList();
    }

    function renderPremSubOptionList() {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      let container = document.getElementById("premSubOptionList");
      if (!container) return;
      container.innerHTML = "";

      if (!course || !option || !premiumData[course] || !premiumData[course][option]) {
        container.innerHTML = "<p style='color:#666; font-style:italic; text-align:center;'>Select an option first.</p>";
        return;
      }

      let optData = premiumData[course][option];
      let subOptions = optData.subOptions || {};

      if (Object.keys(subOptions).length === 0) {
        container.innerHTML = "<p style='color:#666; font-style:italic; text-align:center;'>No sub-options yet. Add one above.</p>";
        return;
      }

      for (let subName in subOptions) {
        let subFiles = subOptions[subName].files || [];
        let card = document.createElement("div");
        card.style.cssText = "background: rgba(162,155,254,0.06); border: 1px solid rgba(162,155,254,0.3); border-radius: 8px; padding: 12px; margin-bottom: 10px;";
        card.innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <b style="color:#a29bfe;">ðŸ“‚ ${subName}</b>
            <div style="display:flex;gap:6px;">
              <button onclick="renamePremiumSubOption('${subName.replace(/'/g, "\\'")}', '${course.replace(/'/g, "\\'")}', '${option.replace(/'/g, "\\'")}') " style="background:#6c5ce7; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px;">âœï¸ Rename</button>
              <button onclick="deletePremiumSubOption('${subName.replace(/'/g, "\\'")}', '${course.replace(/'/g, "\\'")}', '${option.replace(/'/g, "\\'")}') " style="background:#ff4757; color:white; border:none; padding:4px 10px; border-radius:4px; cursor:pointer; font-size:12px;">ðŸ—‘ï¸ Delete</button>
            </div>
          </div>
          <div id="subFileList_${subName.replace(/[^a-z0-9]/gi, '_')}" style="margin-bottom:8px; max-height:150px; overflow-y:auto;">
            ${renderSubFileHTML(subFiles)}
          </div>
          <div style="display:grid; grid-template-columns:1fr 1fr auto; gap:6px; font-size:12px;">
            <input type="text" id="subFileTitle_${subName.replace(/[^a-z0-9]/gi, '_')}" class="login-input" placeholder="Title" style="margin:0; padding:6px; font-size:12px;">
            <input type="text" id="subFileLink_${subName.replace(/[^a-z0-9]/gi, '_')}" class="login-input" placeholder="Link URL" style="margin:0; padding:6px; font-size:12px;">
            <select id="subFileType_${subName.replace(/[^a-z0-9]/gi, '_')}" class="login-input" style="margin:0; padding:6px; font-size:12px;">
              <option value="pdf">ðŸ“„ PDF</option>
              <option value="image">ðŸ–¼ï¸ Image</option>
              <option value="video">ðŸŽ¬ Video</option>
            </select>
          </div>
          <button onclick="addSubOptionFile('${subName.replace(/'/g, "\\'")}', '${course.replace(/'/g, "\\'")}', '${option.replace(/'/g, "\\'")}') " style="background:#a29bfe; color:black; border:none; padding:6px 14px; border-radius:4px; cursor:pointer; font-weight:bold; margin-top:6px; font-size:12px;">âž• Add File to Sub-Option</button>
        `;
        container.appendChild(card);
      }
    }

    function renderSubFileHTML(files) {
      if (!files || files.length === 0) return "<p style='color:#666;font-size:12px;'>No files yet.</p>";
      const typeIcon = { pdf: 'ðŸ“„', image: 'ðŸ–¼ï¸', video: 'ðŸŽ¬' };
      return files.map((f, i) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 8px;background:rgba(255,255,255,0.03);border-radius:4px;margin-bottom:3px;font-size:12px;">
        <span>${typeIcon[f.type] || 'ðŸ“'} <b>${f.title}</b></span>
        <a href="${f.link}" target="_blank" style="color:cyan;font-size:11px;margin:0 8px;">View</a>
      </div>`).join('');
    }

    function addSubOptionFile(subName, course, option) {
      let safe = subName.replace(/[^a-z0-9]/gi, '_');
      let title = document.getElementById("subFileTitle_" + safe).value.trim();
      let link = document.getElementById("subFileLink_" + safe).value.trim();
      let type = document.getElementById("subFileType_" + safe).value;
      if (!title || !link) return alert("Enter both title and link.");

      let optData = premiumData[course][option];
      if (!optData.subOptions) optData.subOptions = {};
      if (!optData.subOptions[subName]) optData.subOptions[subName] = { files: [] };
      if (!optData.subOptions[subName].files) optData.subOptions[subName].files = [];
      optData.subOptions[subName].files.push({ title, link, type });

      savePremiumData();
      renderPremSubOptionList();
    }

    function deletePremiumSubOption(subName, course, option) {
      if (!confirm(`Delete sub-option '${subName}' and all its files?`)) return;
      delete premiumData[course][option].subOptions[subName];
      savePremiumData();
      renderPremSubOptionList();
    }

    function renamePremiumSubOption(subName, course, option) {
      let newName = prompt(`Rename '${subName}' to:`, subName);
      if (!newName || newName.trim() === subName) return;
      newName = newName.trim();
      let subOpts = premiumData[course][option].subOptions;
      if (subOpts[newName]) return alert("Sub-option with that name already exists.");
      subOpts[newName] = subOpts[subName];
      delete subOpts[subName];
      savePremiumData();
      renderPremSubOptionList();
    }

    // ===== ADD MEDIA TO OPTION =====
    function _addOptionFile(type) {
      let course = document.getElementById("premCmsCourse").value;
      let option = document.getElementById("premCmsOption").value;
      let titleId = type === 'pdf' ? 'newPremPdfTitle' : type === 'image' ? 'newPremImgTitle' : 'newPremVideoTitle';
      let linkId = type === 'pdf' ? 'newPremPdfLink' : type === 'image' ? 'newPremImgLink' : 'newPremVideoLink';
      let title = document.getElementById(titleId).value.trim();
      let link = document.getElementById(linkId).value.trim();
      if (!course || !option) return alert("Select a course and option first.");
      if (!title || !link) return alert("Please fill in both title and link.");

      // Ensure option data supports files array
      if (Array.isArray(premiumData[course][option])) {
        let oldArr = premiumData[course][option];
        premiumData[course][option] = { files: oldArr.map(f => Object.assign({ type: 'pdf' }, f)) };
      }
      if (!premiumData[course][option].files) premiumData[course][option].files = [];
      premiumData[course][option].files.push({ title, link, type });
      savePremiumData();
      document.getElementById(titleId).value = "";
      document.getElementById(linkId).value = "";
      renderPremPdfList();
      alert(`âœ… ${type.toUpperCase()} "${title}" added!`);
    }

    function addPremiumPdf() { _addOptionFile('pdf'); }
    function addPremiumImage() { _addOptionFile('image'); }
    function addPremiumVideo() { _addOptionFile('video'); }

    let cmsSelection = { course: "", branch: "", sem: "", sub: "", ch: "" };

    function initAdminCMS() {
      const selectors = [
        document.getElementById("cmsCourse"),
        document.getElementById("premConfigCourse"),
        document.getElementById("premCmsCourse"),
        document.getElementById("deleteCourseSelect"),
        document.getElementById("subCourse")
      ];

      selectors.forEach(sel => {
        if (!sel) return;
        sel.innerHTML = '<option value="" disabled selected>Select Course</option>';
        for (let c in data) {
          let opt = document.createElement("option");
          opt.value = c;
          opt.innerText = c;
          sel.appendChild(opt);
        }
      });
      populateBattleCourses();
      renderPremCourseList();
    }

    function onAdminCMSCourseChange() {
      cmsSelection.course = document.getElementById("cmsCourse").value;
      let bSelect = document.getElementById("cmsBranch");
      bSelect.innerHTML = '<option value="" disabled selected>Branch</option>';
      if (data[cmsSelection.course]) {
        for (let b in data[cmsSelection.course]) {
          let opt = document.createElement("option"); opt.value = b; opt.innerText = b; bSelect.appendChild(opt);
        }
      }
      renderCmsBranches();
      document.getElementById("cmsContentEditor").style.display = "none";
      cmsSelection.branch = "";
      cmsSelection.sem = "";
      cmsSelection.sub = "";
      cmsSelection.ch = "";
    }

    function renderCmsBranches() {
      let { course } = cmsSelection;
      if (!course) return;
      let area = document.getElementById("cmsInteractionArea");
      area.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
           <h4 style="color: cyan; margin:0;">ðŸ¢ Branches in ${course}</h4>
           <button class="login-btn" onclick="addCMSBranch()" style="width: auto; margin:0; background: #00cec9; color: black; padding: 5px 15px;">âž• Add Branch</button>
        </div>
        <div id="cmsListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
      `;
      let list = document.getElementById("cmsListContainer");
      let branches = data[course] ? Object.keys(data[course]) : [];
      if (branches.length === 0) {
        list.innerHTML = "<p style='grid-column: 1/-1; color: #888; text-align: center;'>No branches found. Add one above! (e.g. DDU, AKTU, CSE)</p>";
      } else {
        branches.forEach(b => {
          let item = document.createElement("div");
          item.className = "box";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.alignItems = "center";
          item.style.padding = "10px 15px";
          item.innerHTML = `
            <span onclick="cmsSelection.branch='${b}'; document.getElementById('cmsBranch').value='${b}'; renderCmsSemesters()" style="cursor:pointer; flex: 1;">ðŸ¢ ${b}</span>
            <button onclick="deleteCMSBranch('${b}')" style="background: #ff4757; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Delete</button>
          `;
          list.appendChild(item);
        });
      }
      document.getElementById("cmsContentEditor").style.display = "none";
    }

    function onAdminCMSBranchChange() {
      cmsSelection.course = document.getElementById("cmsCourse").value;
      cmsSelection.branch = document.getElementById("cmsBranch").value;
      renderCmsSemesters();
    }

    function renderCmsSemesters() {
      let { course, branch } = cmsSelection;
      if (!course || !branch) return;
      let area = document.getElementById("cmsInteractionArea");
      area.innerHTML = `
        <div style="margin-bottom: 15px;">
           <button onclick="renderCmsBranches()" style="background: none; border: 1px solid cyan; color: cyan; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">â¬…ï¸ Back to Branches</button>
           <div style="display: flex; justify-content: space-between; align-items: center;">
             <h4 style="color: cyan; margin:0;'>ðŸ“… Semesters in ${branch}</h4>
             <button class="login-btn" onclick="addCMSSemester()" style="width: auto; margin:0; background: #00cec9; color: black; padding: 5px 15px;">âž• Add Sem</button>
           </div>
        </div>
        <div id="cmsListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;"></div>
      `;
      let list = document.getElementById("cmsListContainer");

      let sems = data[course] && data[course][branch] ? Object.keys(data[course][branch]).filter(k => k !== "_initialized").sort((a, b) => a - b) : [];

      if (sems.length === 0) {
        list.innerHTML = "<p style='grid-column: 1/-1; color: #888; text-align: center;'>No semesters found. Add one above!</p>";
      } else {
        sems.forEach(s => {
          let item = document.createElement("div");
          item.className = "box";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.alignItems = "center";
          item.style.padding = "10px 15px";
          item.innerHTML = `
            <span onclick="cmsSelection.sem='${s}'; renderCmsSubjects()" style="cursor:pointer; flex: 1;">ðŸ“… Semester ${s}</span>
            <button onclick="deleteCMSSemester('${s}')" style="background: #ff4757; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Delete</button>
          `;
          list.appendChild(item);
        });
      }
      document.getElementById("cmsContentEditor").style.display = "none";
    }

    function renderCmsSubjects() {
      let { course, branch, sem } = cmsSelection;
      let area = document.getElementById("cmsInteractionArea");
      area.innerHTML = `
        <div style="margin-bottom: 15px;">
           <button onclick="renderCmsSemesters()" style="background: none; border: 1px solid cyan; color: cyan; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">â¬…ï¸ Back to Semesters</button>
           <div style="display: flex; justify-content: space-between; align-items: center;">
             <h4 style="color: cyan; margin:0;'>ðŸ“˜ Subjects in Semester ${sem}</h4>
             <button class="login-btn" onclick="addCMSSubject()" style="width: auto; margin:0; background: #00cec9; color: black; padding: 5px 15px;">âž• Add Subject</button>
           </div>
        </div>
        <div id="cmsListContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 10px;"></div>
      `;
      let list = document.getElementById("cmsListContainer");

      let subs = data[course][branch][sem] ? Object.keys(data[course][branch][sem]).filter(k => k !== "_initialized") : [];

      if (subs.length === 0) {
        list.innerHTML = "<p style='grid-column: 1/-1; color: #888; text-align: center;'>No subjects found. Add one above!</p>";
      } else {
        subs.forEach(sub => {
          let item = document.createElement("div");
          item.className = "box";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.alignItems = "center";
          item.style.padding = "10px 15px";
          item.innerHTML = `
            <span onclick="cmsSelection.sub='${sub}'; renderCmsChapters()" style="cursor:pointer; flex: 1;">ðŸ“˜ ${sub}</span>
            <button onclick="deleteCMSSubject('${sub}')" style="background: #ff4757; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Delete</button>
          `;
          list.appendChild(item);
        });
      }
      document.getElementById("cmsContentEditor").style.display = "none";
    }

    function renderCmsChapters() {
      let { course, branch, sem, sub } = cmsSelection;
      let area = document.getElementById("cmsInteractionArea");
      area.innerHTML = `
        <div style="margin-bottom: 15px;">
           <button onclick="renderCmsSubjects()" style="background: none; border: 1px solid cyan; color: cyan; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-bottom: 10px;">â¬…ï¸ Back to Subjects</button>
           <div style="display: flex; justify-content: space-between; align-items: center;">
             <h4 style="color: cyan; margin:0;'>ðŸ“‘ Chapters in ${sub}</h4>
             <button class="login-btn" onclick="addCMSChapter()" style="width: auto; margin:0; background: #00cec9; color: black; padding: 5px 15px;">âž• Add Chapter</button>
           </div>
        </div>
        <div id="cmsListContainer" style="display: grid; grid-template-columns: 1fr; gap: 8px;"></div>
      `;
      let list = document.getElementById("cmsListContainer");

      let chaps = data[course][branch][sem][sub] ? Object.keys(data[course][branch][sem][sub]).filter(k => k !== "_initialized") : [];

      if (chaps.length === 0) {
        list.innerHTML = "<p style='color: #888; text-align: center;'>No chapters found. Add one above!</p>";
      } else {
        chaps.forEach(ch => {
          let item = document.createElement("div");
          item.className = "box";
          item.style.display = "flex";
          item.style.justifyContent = "space-between";
          item.style.alignItems = "center";
          item.style.padding = "10px 15px";
          item.style.background = "rgba(255,255,255,0.05)";
          item.innerHTML = `
            <span onclick="openCmsChapter('${ch}')" style="cursor:pointer; flex: 1;">ðŸ“‘ ${ch}</span>
            <div style="display: flex; gap: 5px;">
              <button onclick="renameCMSChapter('${ch}')" style="background: #00e676; border: none; color: black; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Rename</button>
              <button onclick="deleteCMSChapter('${ch}')" style="background: #ff4757; border: none; color: white; border-radius: 4px; padding: 2px 6px; cursor: pointer; font-size: 12px;">Delete</button>
            </div>
          `;
          list.appendChild(item);
        });
      }
      document.getElementById("cmsContentEditor").style.display = "none";
    }

    function openCmsChapter(ch) {
      cmsSelection.ch = ch;
      let { course, branch, sem, sub } = cmsSelection;
      let content = data[course][branch][sem][sub][ch];

      document.getElementById("selectedPathDisplay").innerText = `Selected: Sem ${sem} > ${sub} > ${ch}`;

      document.getElementById("cmsVideo").value = Array.isArray(content.video) ? content.video.join('\n') : (content.video || "");
      document.getElementById("cmsPdf").value = Array.isArray(content.pdf) ? content.pdf.join('\n') : (content.pdf || "");
      document.getElementById("cmsNotes").value = Array.isArray(content.notes) ? content.notes.join('\n') : (content.notes || "");
      document.getElementById("cmsAssignment").value = Array.isArray(content.assignment) ? content.assignment.join('\n') : (content.assignment || "");
      document.getElementById("cmsHomework").value = Array.isArray(content.homework) ? content.homework.join('\n') : (content.homework || "");

      document.getElementById("cmsContentEditor").style.display = "block";
      document.getElementById("cmsContentEditor").scrollIntoView({ behavior: 'smooth' });
    }

    function saveAdminContent() {
      let { course, branch, sem, sub, ch } = cmsSelection;
      if (!ch) return alert("Please select a chapter first.");

      let payload = {
        video: document.getElementById("cmsVideo").value.split('\n').filter(x => x.trim()),
        pdf: document.getElementById("cmsPdf").value.split('\n').filter(x => x.trim()),
        notes: document.getElementById("cmsNotes").value.split('\n').filter(x => x.trim()),
        assignment: document.getElementById("cmsAssignment").value.split('\n').filter(x => x.trim()),
        homework: document.getElementById("cmsHomework").value.split('\n').filter(x => x.trim())
      };

      data[course][branch][sem][sub][ch] = payload;
      database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${ch}`).set(payload).then(() => {
        alert("âœ… Content Saved Successfully!");
      }).catch(err => alert("âŒ Save Failed: " + err));
    }

    function promptRemoveUser(mobile) {
      if (confirm(`Are you sure you want to permanently delete user with mobile ${mobile}? This action cannot be undone.`)) {
        database.ref('users/' + mobile).remove().then(() => {
          alert('User deleted successfully.');
          loadAdminData(); // Refresh the table and counts
        }).catch(err => {
          console.error(err);
          alert('Failed to delete user.');
        });
      }
    }

    function renameCMSChapter(oldCh) {
      let { course, branch, sem, sub } = cmsSelection;
      let newCh = prompt("Enter new name for chapter:", oldCh);
      if (!newCh || newCh.trim() === "" || newCh === oldCh) return;
      newCh = newCh.trim();

      if (data[course][branch][sem][sub][newCh]) return alert("Chapter with this name already exists!");

      let chData = data[course][branch][sem][sub][oldCh];
      data[course][branch][sem][sub][newCh] = chData;
      delete data[course][branch][sem][sub][oldCh];

      database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${oldCh}`).remove().then(() => {
        return database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${newCh}`).set(chData);
      }).then(() => {
        alert("âœ… Chapter renamed successfully!");
        renderCmsChapters();
      }).catch(err => alert("âŒ Rename failed: " + err));
    }

    function addCMSChapter() {
      let { course, branch, sem, sub } = cmsSelection;
      if (!sub) return alert("Select Subject first.");

      let chName = prompt("Enter new Chapter name:");
      if (!chName || chName.trim() === "") return;
      chName = chName.trim();

      if (data[course][branch][sem][sub][chName]) return alert("Chapter already exists!");

      let initPayload = { video: "", notes: "", pdf: "", assignment: "", homework: "" };
      data[course][branch][sem][sub][chName] = initPayload;

      database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${chName}`).set(initPayload).then(() => {
        alert("âœ… New chapter added successfully!");
        renderCmsChapters();
      }).catch(err => alert("âŒ Failed to add chapter: " + err));
    }

    function addCMSSemester() {
      let { course, branch } = cmsSelection;
      if (!course || !branch) return alert("Select Course and Branch first.");

      let newSem = prompt("Enter NEW semester number:");
      if (!newSem || newSem.trim() === "") return;
      newSem = newSem.trim();

      if (data[course] && data[course][branch] && data[course][branch][newSem]) {
        return alert("Semester already exists!");
      }

      let initPayload = { _initialized: true };
      if (!data[course]) data[course] = {};
      if (!data[course][branch]) data[course][branch] = {};
      data[course][branch][newSem] = initPayload;

      database.ref(`courseData/${course}/${branch}/${newSem}`).set(initPayload).then(() => {
        alert(`âœ… Semester '${newSem}' added successfully!`);
        renderCmsSemesters();
      }).catch(err => alert("âŒ Failed to add semester: " + err));
    }

    function deleteCMSSemester(sem) {
      let { course, branch } = cmsSelection;
      if (confirm(`Are you sure you want to delete Semester ${sem}? All contents will be lost.`)) {
        delete data[course][branch][sem];
        database.ref(`courseData/${course}/${branch}/${sem}`).remove().then(() => {
          alert(`ðŸ—‘ï¸ Semester ${sem} deleted successfully!`);
          renderCmsSemesters();
          initAdminCMS();
        }).catch(err => alert("âŒ Failed to delete semester: " + err));
      }
    }

    function addCMSBranch() {
      let { course } = cmsSelection;
      if (!course) return alert("Select Course first.");
      let bName = prompt("Enter NEW branch name (e.g. CSE, DDU, AKTU):");
      if (!bName || bName.trim() === "") return;
      bName = bName.trim();
      if (data[course][bName]) return alert("Branch already exists!");

      data[course][bName] = { _initialized: true };
      database.ref(`courseData/${course}/${bName}`).set({ _initialized: true }).then(() => {
        alert(`âœ… Branch '${bName}' added!`);
        onAdminCMSCourseChange(); // Refresh branches and dropdown
      });
    }

    function deleteCMSBranch(branch) {
      if (!confirm(`Are you sure you want to delete branch '${branch}' and all its content?`)) return;
      let { course } = cmsSelection;
      delete data[course][branch];
      database.ref(`courseData/${course}/${branch}`).remove().then(() => {
        alert(`ðŸ—‘ï¸ Branch '${branch}' deleted.`);
        onAdminCMSCourseChange();
      });
    }

    function addCMSSubject() {
      let { course, branch, sem } = cmsSelection;
      if (!sem) return alert("Select Semester first.");

      let subName = prompt("Enter NEW subject name:");
      if (!subName || subName.trim() === "") return;
      subName = subName.trim();

      if (data[course][branch][sem][subName]) return alert("Subject already exists!");

      let initPayload = { _initialized: true };
      data[course][branch][sem][subName] = initPayload;

      database.ref(`courseData/${course}/${branch}/${sem}/${subName}`).set(initPayload).then(() => {
        alert(`âœ… Subject '${subName}' added successfully!`);
        renderCmsSubjects();
      }).catch(err => alert("âŒ Failed to add subject: " + err));
    }

    function deleteCMSSubject(sub) {
      let { course, branch, sem } = cmsSelection;
      if (confirm(`Are you sure you want to delete Subject '${sub}'?`)) {
        delete data[course][branch][sem][sub];
        database.ref(`courseData/${course}/${branch}/${sem}/${sub}`).remove().then(() => {
          alert(`ðŸ—‘ï¸ Subject '${sub}' deleted successfully!`);
          renderCmsSubjects();
        }).catch(err => alert("âŒ Failed to delete subject: " + err));
      }
    }

    function deleteCMSChapter(ch) {
      let { course, branch, sem, sub } = cmsSelection;
      if (confirm(`Are you sure you want to delete Chapter '${ch}'?`)) {
        delete data[course][branch][sem][sub][ch];
        database.ref(`courseData/${course}/${branch}/${sem}/${sub}/${ch}`).remove().then(() => {
          alert("âœ… Chapter deleted successfully!");
          renderCmsChapters();
        }).catch(err => alert("âŒ Failed to delete chapter: " + err));
      }
    }

    // COURSE & SUBJECT MANAGER FUNCTIONS
    function addAdminCourse() {
      let newCourse = document.getElementById("newCourseName").value.trim().toUpperCase();
      if (!newCourse) return alert("Course name cannot be empty.");
      if (data[newCourse]) return alert(`Course '${newCourse}' already exists!`);

      // Initialize completely new course with generic branches & semesters
      data[newCourse] = {
        "General": {
          1: {}, 2: {}, 3: {}, 4: {}, 5: {}, 6: {}
        }
      };

      database.ref(`courseData/${newCourse}`).set(data[newCourse]).then(() => {
        document.getElementById("newCourseName").value = "";
        alert(`âœ… Course '${newCourse}' added successfully!`);
        initAdminCMS(); // Reload dropdowns
      });
    }

    function deleteAdminCourse() {
      let course = document.getElementById("deleteCourseSelect").value;
      if (!course) return alert("Select a course to delete.");
      if (!confirm(`CRITICAL: Are you sure you want to delete the ENTIRE course '${course}'? This cannot be undone.`)) return;

      delete data[course];
      if (premiumData[course]) delete premiumData[course];

      Promise.all([
        database.ref(`courseData/${course}`).remove(),
        database.ref(`premiumData/${course}`).remove()
      ]).then(() => {
        alert(`ðŸ—‘ï¸ Course '${course}' deleted successfully!`);
        initAdminCMS();
      }).catch(err => alert("âŒ Failed to delete course: " + err));
    }

    // Redundant Semester Management functions removed (moved to integrated CMS)

    // Subject Quick Links logic removed (integrated into CMS)

    function grantPremiumManually(mobile) {
      let itemKey = prompt("Enter Premium Option Key (e.g. BCA_Exam point of view):");
      if (!itemKey) return;
      let days = prompt("Enter number of days for premium access (leave blank for lifetime):");

      let expiresAt = null;
      if (days && !isNaN(days) && parseInt(days) > 0) {
        expiresAt = Date.now() + (parseInt(days) * 24 * 60 * 60 * 1000);
      }

      let payload = {
        active: true,
        expiresAt: expiresAt,
        grantedBy: 'Admin'
      };

      database.ref(`users/${mobile}/premiumUnlocked/${itemKey}`).set(payload).then(() => {
        alert("âœ… Premium granted to " + mobile + " for " + itemKey);
        loadAdminData();
        renderAdminBanners(snap.val()?.banners || []);
        populateBattleCourses();
      }).catch(err => {
        alert("âŒ Error granting premium.");
      });
    }

    function renderActivePremiumUsers() {
      let tbody = document.getElementById("activePremiumTableBody");
      if (!tbody) return;
      tbody.innerHTML = "<tr><td colspan='3' style='padding: 15px; text-align: center; color: cyan;'>Loading...</td></tr>";

      database.ref('users').once('value').then(snap => {
        let usersData = snap.val() || {};
        let count = 0;

        // Sort users by total time spent in descending order
        let sortedUsers = Object.values(usersData).filter(u => u.role !== 'admin' && u.name).sort((a, b) => (b.timeSpent || 0) - (a.timeSpent || 0));

        tbody.innerHTML = ""; // Clear loading message

        sortedUsers.forEach(u => {
          if (u.role === 'admin' || !u.premiumUnlocked) return;

          let activePlans = [];
          for (let itemKey in u.premiumUnlocked) {
            let pu = u.premiumUnlocked[itemKey];
            let isAct = false;
            let expText = "Lifetime";

            if (typeof pu === 'object' && pu.active) {
              if (!pu.expiresAt || Date.now() <= pu.expiresAt) {
                isAct = true;
                if (pu.expiresAt) {
                  let daysLeft = Math.ceil((pu.expiresAt - Date.now()) / (1000 * 60 * 60 * 24));
                  expText = `Expires in ${daysLeft} days`;
                }
              }
            } else if (pu === true) {
              isAct = true;
            }

            if (isAct) {
              activePlans.push(`<span style="background:rgba(255,215,0,0.2); padding:2px 5px; border-radius:3px; margin:2px; display:inline-block; font-size:12px;">${itemKey} (${expText})</span>`);
            }
          }

          if (activePlans.length > 0) {
            count++;
            let tr = document.createElement("tr");
            tr.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
            tr.innerHTML = `
               <td style="padding: 10px; color: white;">ðŸ‘‘ ${u.name}</td>
               <td style="padding: 10px; color: cyan;">${u.mobile}</td>
               <td style="padding: 10px;">${activePlans.join(' ')}</td>
             `;
            tbody.appendChild(tr);
          }
        });

        if (count === 0) {
          tbody.innerHTML = "<tr><td colspan='3' style='padding: 15px; text-align: center; color: #aaa;'>No active premium members.</td></tr>";
        }
      });
    }

    // FORGOT DETAILS RECOVERY & EDIT PROFILE VARS
    // isRecoveringMode is declared above

    function recoverDetails() {
      let rollSearch = prompt("Enter your registered University Roll Number / Registation Number to recover/edit your details:");
      if (!rollSearch || rollSearch.trim() === "") return;

      let foundUser = null;
      for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        try {
          let data = JSON.parse(localStorage.getItem(key));
          if (data && data.roll && data.roll.toLowerCase() === rollSearch.trim().toLowerCase()) {
            foundUser = data;
            break;
          }
        } catch (e) { }
      }

      if (foundUser) {
        // Open Edit Profile screen in recovery mode
        isRecoveringMode = true;
        tempRecoverMobile = foundUser.mobile;

        document.getElementById("editName").value = foundUser.name;
        document.getElementById("editRoll").value = foundUser.roll;
        document.getElementById("editBranch").value = foundUser.branch;
        document.getElementById("editSection").value = foundUser.section;
        document.getElementById("editMobile").value = foundUser.mobile;

        document.querySelector("#editProfileScreen h2").innerText = "ðŸ› ï¸ Fix Registration Details";
        showPage("editProfileScreen");
      } else {
        alert("Sorry, no account found matching this University Roll Number / Registation Number. You may need to Sign Up first.");
      }
    }

    // VALIDATION HELPERS
    function validateInput(name, roll, mobile) {
      if (!/^[A-Za-z\s]+$/.test(name)) {
        alert("Validation Error: Name must contain only English alphabets and spaces.");
        return false;
      }
      if (!/^\d{13}$/.test(roll)) {
        alert("Validation Error: DDU Roll Number must be exactly 13 digits long.");
        return false;
      }
      if (!/^\d{10}$/.test(mobile)) {
        alert("Validation Error: Mobile Number must be exactly 10 digits long.");
        return false;
      }
      return true;
    }

    /* Duplicated Auth Functions Removed - Consolidated at top of script */


    // EDIT PROFILE FUNCTIONS
    let editProfilePicBase64 = null;

    function previewEditProfilePic(event) {
      let file = event.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function (e) {
        let img = new Image();
        img.onload = function () {
          let canvas = document.createElement("canvas");
          canvas.width = 150;
          canvas.height = 150;
          let ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, 150, 150);
          editProfilePicBase64 = canvas.toDataURL("image/jpeg", 0.7);
          document.getElementById('editProfilePicPreview').src = editProfilePicBase64;
        }
        img.src = e.target.result;
      }
      reader.readAsDataURL(file);
    }

    function openEditProfile() {
      try {
        if (!currentUserMobile) {
          alert("Session expired. Please log in again.");
          return;
        }
        isRecoveringMode = false;

        const showModal = (user) => {
          document.getElementById("editName").value = user.name || "";
          document.getElementById("editRoll").value = user.roll || "";
          document.getElementById("editBranch").value = user.branch || "BCA";
          document.getElementById("editSection").value = user.section || "A1";
          document.getElementById("editMobile").value = user.mobile || "";

          editProfilePicBase64 = user.profilePic || null;
          if (editProfilePicBase64) {
            document.getElementById('editProfilePicPreview').src = editProfilePicBase64;
          } else {
            document.getElementById('editProfilePicPreview').src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(user.name || 'U') + "&background=cyan&color=000";
          }

          document.getElementById('editProfilePicInput').value = "";
          document.getElementById("editProfileScreen").style.display = "flex";
        };

        let savedData = localStorage.getItem("user_" + btoa(currentUserMobile));
        if (savedData) {
          showModal(JSON.parse(savedData));
        } else {
          database.ref('users/' + currentUserMobile).once('value').then(snap => {
            if (snap.exists()) {
              const user = snap.val();
              localStorage.setItem("user_" + btoa(currentUserMobile), JSON.stringify(user));
              showModal(user);
            } else {
              alert("User profile not found.");
            }
          });
        }
      } catch (err) {
        console.error("openEditProfile error:", err);
      }
    }

    function closeEditProfile() {
      document.getElementById("editProfileScreen").style.display = "none";
      isRecoveringMode = false;
    }

    function saveProfileChanges() {
      try {
        let newName = sanitizeHTML(document.getElementById("editName").value.trim());
        let newRoll = sanitizeHTML(document.getElementById("editRoll").value.trim());
        let newBranch = document.getElementById("editBranch").value;
        let newSection = document.getElementById("editSection").value;
        let newMobile = document.getElementById("editMobile").value.trim();

        if (!newName || !newRoll || !newBranch || !newSection || !newMobile) {
          alert("Please fill in all details!");
          return;
        }

        if (!validateInput(newName, newRoll, newMobile)) return;

        let activeMobileKey = isRecoveringMode ? tempRecoverMobile : currentUserMobile;
        executeProfileUpdate(activeMobileKey, newName, newRoll, newBranch, newSection, newMobile);
      } catch (err) {
        console.error("saveProfileChanges error:", err);
      }
    }

    function executeProfileUpdate(activeMobileKey, newName, newRoll, newBranch, newSection, newMobile) {
      try {
        let updatedData = {
          name: newName,
          roll: newRoll,
          branch: newBranch,
          section: newSection,
          mobile: newMobile
        };
        if (editProfilePicBase64) updatedData.profilePic = editProfilePicBase64;

        const sessionKey = "user_" + btoa(activeMobileKey);
        let stObj = JSON.parse(localStorage.getItem(sessionKey)) || {};

        let btn = document.querySelector("#editProfileScreen .login-btn");
        btn.innerText = "Processing...";
        btn.disabled = true;

        database.ref('users/' + newMobile).update(updatedData).then(() => {
          if (newMobile !== activeMobileKey) {
            database.ref('users/' + activeMobileKey).remove();
            localStorage.removeItem(sessionKey);
            localStorage.removeItem("nav_" + btoa(activeMobileKey));
          }

          let merged = { ...stObj, ...updatedData };
          localStorage.setItem("user_" + btoa(newMobile), JSON.stringify(merged));

          if (!isRecoveringMode) {
            currentUserMobile = newMobile;
            setAuthSession(newMobile);
            updateNeuralHUD(merged);
          }

          alert("Profile Synchronized!");
          closeEditProfile();
          setTimeout(() => location.reload(), 500);
        }).catch(err => {
          console.error("executeProfileUpdate error:", err);
          alert("Session update failed. Please check network.");
          btn.innerText = "ðŸ’¾ Save Changes";
          btn.disabled = false;
        });
      } catch (err) {
        console.error("executeProfileUpdate crash:", err);
      }
    }

    function logoutUser() {
      try {
        if (!confirm("Confirm Logout Securely?")) return;
        localStorage.removeItem("nx_session");
        localStorage.removeItem("user_" + btoa(currentUserMobile));
        localStorage.removeItem("nav_" + btoa(currentUserMobile));
        currentUserMobile = "";
        location.reload(); // Cleanest way to reset all states
      } catch (err) {
        localStorage.clear();
        location.reload();
      }
    }

    // -------------- PROGRESS TRACKING LOGIC --------------
    function getStudentTracker() {
      if (!currentUserMobile) return { progressTracker: {} };
      const sessionKey = "user_" + btoa(currentUserMobile);
      let stObj = JSON.parse(localStorage.getItem(sessionKey)) || { progressTracker: {} };
      if (!stObj.progressTracker) {
        stObj.progressTracker = {};
        localStorage.setItem(sessionKey, JSON.stringify(stObj));
      }
      return stObj;
    }

    function toggleProgress(type, index, isChecked) {
      if (!currentUserMobile) return;
      let stObj = getStudentTracker();
      stObj.progressTracker[type + "_" + index] = isChecked;

      database.ref('users/' + currentUserMobile + '/progressTracker').set(stObj.progressTracker);
      localStorage.setItem("user_" + btoa(currentUserMobile), JSON.stringify(stObj));
    }
    function isProgressCompleted(type, index) {
      let stObj = getStudentTracker();
      try {
        return !!stObj.progressTracker[type + "_" + index];
      } catch (e) {
        return false;
      }
    }

    function renderProgressDashboard() {
      let dashView = document.getElementById("progressContent");
      if (!dashView) return;
      dashView.innerHTML = "";

      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;

      if (!data[c] || !data[c][b] || !data[c][b][sem]) {
        dashView.innerHTML = "<p>No data to analyze for this semester.</p>";
        return;
      }

      let semesterData = data[c][b][sem];
      let stObj = getStudentTracker();
      let overallContentSum = 0;
      let overallCompletedSum = 0;

      let htmlOutput = "";

      for (let subName in semesterData) {
        if (subName === "_initialized") continue;
        let totalItems = 0;
        let completedItems = 0;
        let breakdown = { video: { t: 0, c: 0 }, pdf: { t: 0, c: 0 }, assign: { t: 0, c: 0 }, hw: { t: 0, c: 0 } };

        let subChapters = semesterData[subName];
        if (typeof subChapters !== 'object') continue;
        for (let chName in subChapters) {
          if (chName === "_initialized") continue;
          let content = subChapters[chName];

          const processType = (type, alias) => {
            let arr = [];
            if (Array.isArray(content[type])) arr = content[type];
            else if (typeof content[type] === "string" && content[type].trim()) arr = content[type].split('\n').filter(x => x.trim());

            totalItems += arr.length;
            breakdown[alias].t += arr.length;
            overallContentSum += arr.length;

            if (arr.length > 0) {
              for (let i = 0; i < arr.length; i++) {
                try {
                  if (stObj.progressTracker[c][b][sem][subName][chName][type][i]) {
                    completedItems++;
                    breakdown[alias].c++;
                    overallCompletedSum++;
                  }
                } catch (e) { }
              }
            }
          };

          processType('video', 'video');
          processType('pdf', 'pdf');
          processType('assignment', 'assign');
          processType('homework', 'hw');
        }

        if (totalItems > 0) {
          let percentage = Math.round((completedItems / totalItems) * 100);

          htmlOutput += `
            <div class="subj-progress">
              <div class="subj-progress-title">
                <span>${subName}</span>
                <span>${percentage}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="progress-details">
                ${breakdown.video.t > 0 ? `<span>ðŸ“¹ Videos: ${breakdown.video.c}/${breakdown.video.t}</span>` : ""}
                ${breakdown.pdf.t > 0 ? `<span>ðŸ“„ PDFs: ${breakdown.pdf.c}/${breakdown.pdf.t}</span>` : ""}
                ${breakdown.assign.t > 0 ? `<span>âœï¸ Assignments: ${breakdown.assign.c}/${breakdown.assign.t}</span>` : ""}
                ${breakdown.hw.t > 0 ? `<span>ðŸ  HW: ${breakdown.hw.c}/${breakdown.hw.t}</span>` : ""}
              </div>
            </div>
          `;
        }
      }

      if (htmlOutput) {
        let grandTotal = overallContentSum > 0 ? Math.round((overallCompletedSum / overallContentSum) * 100) : 0;
        dashView.innerHTML = `
          <h4 style="color: white; margin-bottom: 20px;">Semester Completion: ${grandTotal}% (${overallCompletedSum}/${overallContentSum} items)</h4>
          ${htmlOutput}
        `;
      } else {
        dashView.innerHTML = "<p>Ask your Admin to upload Videos/PDFs to start tracking your progress!</p>";
      }
    }

    function getProgress(chName) {
      let stObj = getStudentTracker();
      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;

      if (!data[c] || !data[c][b] || !data[c][b][sem] || !data[c][b][sem][sub] || !data[c][b][sem][sub][chName]) return 0;

      let content = data[c][b][sem][sub][chName];
      let total = 0;
      let completed = 0;

      const check = (type) => {
        let arr = [];
        if (Array.isArray(content[type])) arr = content[type];
        else if (typeof content[type] === "string" && content[type].trim()) arr = content[type].split('\n').filter(x => x.trim());

        total += arr.length;
        for (let i = 0; i < arr.length; i++) {
          try {
            if (stObj.progressTracker[c][b][sem][sub][chName][type][i]) completed++;
          } catch (e) { }
        }
      };

      check('video');
      check('pdf');
      check('assignment');
      check('homework');

      return total > 0 ? Math.round((completed / total) * 100) : 0;
    }

    // -------------- PROGRESS TRACKING LOGIC --------------
    function getStudentTracker() {
      let stObj = JSON.parse(localStorage.getItem(currentUserMobile));
      if (!stObj.progressTracker) {
        stObj.progressTracker = {}; // Backwards compat fix
        localStorage.setItem(currentUserMobile, JSON.stringify(stObj));
      }
      return stObj;
    }


    function toggleProgress(type, index, isChecked) {
      if (!currentUserMobile) return;

      let stObj = getStudentTracker();
      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;
      let ch = studentNavState.chapter;

      if (!stObj.progressTracker[c]) stObj.progressTracker[c] = {};
      if (!stObj.progressTracker[c][b]) stObj.progressTracker[c][b] = {};
      if (!stObj.progressTracker[c][b][sem]) stObj.progressTracker[c][b][sem] = {};
      if (!stObj.progressTracker[c][b][sem][sub]) stObj.progressTracker[c][b][sem][sub] = {};
      if (!stObj.progressTracker[c][b][sem][sub][ch]) stObj.progressTracker[c][b][sem][sub][ch] = {};
      if (!stObj.progressTracker[c][b][sem][sub][ch][type]) stObj.progressTracker[c][b][sem][sub][ch][type] = {};

      stObj.progressTracker[c][b][sem][sub][ch][type][index] = isChecked;

      localStorage.setItem(currentUserMobile, JSON.stringify(stObj));
    }

    function isProgressCompleted(type, index) {
      let stObj = getStudentTracker();
      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;
      let ch = studentNavState.chapter;

      try {
        return !!stObj.progressTracker[c][b][sem][sub][ch][type][index];
      } catch (e) {
        return false;
      }
    }

    function renderProgressDashboard() {
      let dashView = document.getElementById("progressContent");
      if (!dashView) return;
      dashView.innerHTML = "";

      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;

      if (!data[c] || !data[c][b] || !data[c][b][sem]) {
        dashView.innerHTML = "<p>No data to analyze for this semester.</p>";
        return;
      }

      let semesterData = data[c][b][sem];
      let stObj = getStudentTracker();
      let overallContentSum = 0;
      let overallCompletedSum = 0;

      let htmlOutput = "";

      for (let subName in semesterData) {
        if (subName === "_initialized") continue;
        let totalItems = 0;
        let completedItems = 0;
        let breakdown = { video: { t: 0, c: 0 }, pdf: { t: 0, c: 0 }, assign: { t: 0, c: 0 }, hw: { t: 0, c: 0 } };

        let subChapters = semesterData[subName];
        for (let chName in subChapters) {
          if (chName === "_initialized") continue;
          let content = subChapters[chName];

          const processType = (type, alias) => {
            let arr = [];
            if (Array.isArray(content[type])) arr = content[type];
            else if (typeof content[type] === "string" && content[type].trim()) arr = content[type].split('\n').filter(x => x.trim());

            totalItems += arr.length;
            breakdown[alias].t += arr.length;
            overallContentSum += arr.length;

            if (arr.length > 0) {
              for (let i = 0; i < arr.length; i++) {
                try {
                  if (stObj.progressTracker[c][b][sem][subName][chName][type][i]) {
                    completedItems++;
                    breakdown[alias].c++;
                    overallCompletedSum++;
                  }
                } catch (e) { }
              }
            }
          };

          processType('video', 'video');
          processType('pdf', 'pdf');
          processType('assignment', 'assign');
          processType('homework', 'hw');
        }

        if (totalItems > 0) {
          let percentage = Math.round((completedItems / totalItems) * 100);

          htmlOutput += `
            <div class="subj-progress">
              <div class="subj-progress-title">
                <span>${subName}</span>
                <span>${percentage}%</span>
              </div>
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${percentage}%"></div>
              </div>
              <div class="progress-details">
                ${breakdown.video.t > 0 ? `<span>ðŸ“¹ Videos: ${breakdown.video.c}/${breakdown.video.t}</span>` : ""}
                ${breakdown.pdf.t > 0 ? `<span>ðŸ“„ PDFs: ${breakdown.pdf.c}/${breakdown.pdf.t}</span>` : ""}
                ${breakdown.assign.t > 0 ? `<span>âœï¸ Assignments: ${breakdown.assign.c}/${breakdown.assign.t}</span>` : ""}
                ${breakdown.hw.t > 0 ? `<span>ðŸ  HW: ${breakdown.hw.c}/${breakdown.hw.t}</span>` : ""}
              </div>
            </div>
          `;
        }
      }

      if (htmlOutput) {
        let grandTotal = overallContentSum > 0 ? Math.round((overallCompletedSum / overallContentSum) * 100) : 0;
        dashView.innerHTML = `
          <h4 style="color: white; margin-bottom: 20px;">Semester Completion: ${grandTotal}% (${overallCompletedSum}/${overallContentSum} items)</h4>
          ${htmlOutput}
        `;
      } else {
        dashView.innerHTML = "<p>Ask your Admin to upload Videos/PDFs to start tracking your progress!</p>";
      }
    }

    // Notification & Service Worker Setup
    let serviceWorkerReg = null;
    let fallbackNotifTime = Date.now(); // Ignore old notifications on page load

    if ('serviceWorker' in navigator && 'Notification' in window) {
      navigator.serviceWorker.register('sw.js').then(reg => {
        serviceWorkerReg = reg;
      }).catch(err => console.error("SW Registration failed: ", err));

      // Listen for push broadcasts from Firebase
      database.ref('notifications/latest').on('value', snap => {
        let data = snap.val();
        if (data && data.timestamp > fallbackNotifTime) {
          fallbackNotifTime = data.timestamp;

          // COOL HOLOGRAPHIC HUD ALERT
          triggerNeuralSyncNotification(`ðŸ’¬ ADMIN: ${data.title} - ${data.body}`);

          if (Notification.permission === 'granted') {
            navigator.serviceWorker.ready.then(reg => {
              try {
                reg.showNotification(data.title, {
                  body: data.body,
                  icon: 'img1.png',
                  badge: 'img1.png',
                  vibrate: [200, 100, 200],
                  data: { url: window.location.href }
                });
              } catch (e) {
                let n = new Notification(data.title, { body: data.body, icon: 'img1.png' });
                n.onclick = function () {
                  window.focus();
                  this.close();
                };
              }
            }).catch(() => {
              let n = new Notification(data.title, { body: data.body, icon: 'img1.png' });
              n.onclick = function () {
                window.focus();
                this.close();
              };
            });
          }
        }
      });
    }

    function requestNotificationPermission() {
      if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
        Notification.requestPermission();
      }
    }

    function sendBroadcastNotification() {
      let title = document.getElementById("notifTitle").value.trim();
      let body = document.getElementById("notifBody").value.trim();
      if (!title || !body) return alert("Enter both title and body.");

      let payload = {
        title: title,
        body: body,
        timestamp: Date.now()
      };

      database.ref('notifications/latest').set(payload).then(() => {
        alert("âœ… Notification Broadcasted to active users!");
        document.getElementById("notifTitle").value = "";
        document.getElementById("notifBody").value = "";
      }).catch(err => alert("âŒ Failed to broadcast."));
    }

    function openLeaderboard() {
      document.getElementById('leaderboardModal').style.display = 'flex';
      let list = document.getElementById('leaderboardList');
      list.innerHTML = "<p style='color:cyan;'>Loading leaders...</p>";

      database.ref('users').once('value').then(snap => {
        let usersData = snap.val();
        if (!usersData) {
          list.innerHTML = "<p>No users found on platform yet.</p>";
          return;
        }
        let usersArr = [];
        for (let key in usersData) {
          let u = usersData[key];
          if (u.name && u.role !== 'admin') { // assume we only show students
            usersArr.push({
              name: u.name,
              timeSpent: u.timeSpent || 0,
              pic: u.profilePic || "https://ui-avatars.com/api/?name=" + encodeURIComponent(u.name) + "&background=cyan&color=000"
            });
          }
        }
        // Ranking by timeSpent highest first
        usersArr.sort((a, b) => b.timeSpent - a.timeSpent);

        list.innerHTML = "";
        usersArr.forEach((u, idx) => {
          let isTop = idx === 0 ? "ðŸ‘‘ " : (idx === 1 ? "ðŸ¥ˆ " : (idx === 2 ? "ðŸ¥‰ " : ""));
          let borderCol = idx === 0 ? "gold" : (idx === 1 ? "silver" : (idx === 2 ? "#cd7f32" : "rgba(0,255,255,0.3)"));
          let bgCol = idx === 0 ? "rgba(255,215,0,0.1)" : "rgba(255,255,255,0.05)";
          list.innerHTML += `
            <div style="display: flex; align-items: center; gap: 15px; background: ${bgCol}; padding: 10px; border-radius: 10px; border: 1px solid ${borderCol}; transition: transform 0.2s;">
              <span style="font-size: 20px; font-weight: bold; width: 25px; color:${borderCol};">${idx + 1}.</span>
              <img src="${u.pic}" style="width: 45px; height: 45px; border-radius: 50%; border: 2px solid ${borderCol}; object-fit: cover;">
              <div style="text-align: left; flex: 1;">
                <h4 style="margin: 0; color: white;">${isTop}${u.name}</h4>
                <small style="color: #aaa;">Score: ${u.timeSpent} pts</small>
              </div>
            </div>
          `;
        });
      }).catch(err => {
        list.innerHTML = "<p style='color:red;'>Failed to load leaderboard.</p>";
      });
    }

    function closeLeaderboard() {
      document.getElementById('leaderboardModal').style.display = "none";
    }

    function enterSite() {
      try {
        requestNotificationPermission();
        showPage("programsWrapper");
        startTimeTracking();

        // Setup profile pic in header using secure key
        let stObj = JSON.parse(localStorage.getItem("user_" + btoa(currentUserMobile)) || "{}");
        const headerPic = document.getElementById('userProfilePicHeader');
        if (headerPic) {
          if (stObj.profilePic) {
            headerPic.src = stObj.profilePic;
          } else {
            headerPic.src = "https://ui-avatars.com/api/?name=" + encodeURIComponent(stObj.name || 'U') + "&background=cyan&color=000";
          }
          headerPic.style.display = 'block';
        }

        setTimeout(restoreNavState, 100);
      } catch (err) {
        console.error("enterSite failed:", err);
      }
    }

    function saveNavState() {
      if (!currentUserMobile) return;
      let state = {
        studentNavState: studentNavState,
        currentNavLevel: currentNavLevel,
        timestamp: Date.now()
      };
      localStorage.setItem("nav_" + btoa(currentUserMobile), JSON.stringify(state));
    }

    function restoreNavState() {
      if (!currentUserMobile) return;
      let saved = localStorage.getItem("nav_" + btoa(currentUserMobile));
      if (!saved) return;

      let state = JSON.parse(saved);
      if (Date.now() - state.timestamp > 2 * 60 * 60 * 1000) return; // 2 hour expiry

      studentNavState = state.studentNavState;
      let targetLevel = state.currentNavLevel;

      if (targetLevel === 'programs') {
        goBackToPrograms();
      } else if (targetLevel === 'branches') {
        openStudentLevel('course', studentNavState.course);
      } else if (targetLevel === 'semesters') {
        openStudentLevel('branch', studentNavState.branch);
      } else if (targetLevel === 'subjects') {
        openStudentLevel('semester', studentNavState.sem);
      } else if (targetLevel === 'chapters' || studentNavState.chapter) {
        openStudentLevel('semester', studentNavState.sem);
        if (studentNavState.subject) {
          openStudentLevel('subject', studentNavState.subject);
          if (studentNavState.chapter) {
            openStudentChapter(studentNavState.chapter);
          }
        }
      }
    }

    /* BATTLE ARENA LOGIC */
    let currentBattleQuestions = [];

    function openBattleArena() {
      showPage("combatArena");
      loadBattleData();
      updateWalletDisplay();
    }

    function updateWalletDisplay() {
      if (!currentUserMobile) return;
      // Use real-time listener for instant updates
      database.ref('users/' + currentUserMobile + '/profile/wallet').on('value', snap => {
        let bal = snap.val() || 0;
        let balText = parseFloat(bal).toFixed(2);

        let el = document.getElementById('playerWalletBalance');
        if (el) el.innerText = balText;

        let headerEl = document.getElementById('headerWalletBalance');
        if (headerEl) headerEl.innerText = balText;
      });
    }

    function updateRechargeQR() {
      let amount = document.getElementById("rechargeAmountInput").value.trim() || "0";
      let baseUpi = "adityakumar84282-1@okaxis";
      let upiString = `upi://pay?pa=${baseUpi}&pn=NextGenWallet&am=${amount}&cu=INR`;
      document.getElementById('rechargeQRDisplay').src = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(upiString)}`;
    }

    // Attach event listener so QR updates when amount changes
    document.getElementById("rechargeAmountInput").addEventListener("input", updateRechargeQR);

    function topUpWallet() {
      updateRechargeQR(); // initial render
      document.getElementById("walletRechargeModal").style.display = "flex";
    }

    function closeWalletRechargeModal() {
      document.getElementById("walletRechargeModal").style.display = "none";
    }

    function previewWalletRechargeScreenshot(event) {
      let file = event.target.files[0];
      if (file) {
        let reader = new FileReader();
        reader.onload = function (e) {
          let img = new Image();
          img.onload = function () {
            let canvas = document.createElement("canvas");
            let MAX_WIDTH = 600;
            let MAX_HEIGHT = 800;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
            } else {
              if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
            }
            canvas.width = width;
            canvas.height = height;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            let preview = document.getElementById("rechargeScreenshotPreview");
            preview.src = canvas.toDataURL("image/jpeg", 0.6);
            preview.style.display = "block";
          };
          img.src = e.target.result;
        }
        reader.readAsDataURL(file);
      }
    }

    function payRechargeWithUpiApp(app) {
      let amount = document.getElementById("rechargeAmountInput").value.trim();
      if (!amount || amount <= 0) {
        alert("âš ï¸ Please enter the Recharge Amount first.");
        return;
      }

      let baseUpi = "adityakumar84282-1@okaxis";
      let upiStr = `upi://pay?pa=${baseUpi}&pn=NextGenWallet&am=${amount}&cu=INR`;

      if (app === 'gpay') {
        upiStr = `tez://upi/pay?pa=${baseUpi}&pn=NextGenWallet&am=${amount}&cu=INR`;
      } else if (app === 'phonepe') {
        upiStr = `phonepe://pay?pa=${baseUpi}&pn=NextGenWallet&am=${amount}&cu=INR`;
      } else if (app === 'paytm') {
        upiStr = `paytmmp://pay?pa=${baseUpi}&pn=NextGenWallet&am=${amount}&cu=INR`;
      } else if (app === 'navi') {
        // Navi uses standard UPI intents, but sometimes specific scheme
        upiStr = `upi://pay?pa=${baseUpi}&pn=NextGenWallet&am=${amount}&cu=INR`;
      }
      window.location.href = upiStr;
    }

    function submitRechargeRequest() {
      if (!currentUserMobile) {
        alert("Please login first!"); return;
      }
      let amount = document.getElementById("rechargeAmountInput").value.trim();
      let mobileInput = currentUserMobile; // Automated
      let utr = document.getElementById("rechargeUtrInput").value.trim();
      let preview = document.getElementById("rechargeScreenshotPreview");
      let screenshot = preview.src && preview.style.display !== "none" ? preview.src : "";

      if (!amount || amount <= 0) { alert("Enter a valid amount (â‚¹)"); return; }
      if (!mobileInput) { alert("Please enter your Mobile Number"); return; }
      if (utr.length !== 12) { alert("Enter exactly 12 digits UTR"); return; }
      if (!screenshot) { alert("Please upload a payment screenshot"); return; }

      let reqId = currentUserMobile + "_" + Date.now();
      let payload = {
        mobile: mobileInput,
        userAccountMobile: currentUserMobile,
        amount: parseFloat(amount),
        utr: utr,
        screenshot: screenshot,
        timestamp: Date.now(),
        status: "pending",
        type: "recharge"
      };

      database.ref('rechargeRequests/pending/' + reqId).set(payload).then(() => {
        alert("âœ… Recharge request submitted successfully! Admin will verify and credit your Gold Coins soon.");
        closeWalletRechargeModal();
        // reset form
        document.getElementById("rechargeAmountInput").value = "";
        document.getElementById("rechargeUtrInput").value = "";
        preview.src = "";
        preview.style.display = "none";
      });
    }

    function openWithdrawalModal() { document.getElementById("withdrawalModal").style.display = "flex"; }
    function closeWithdrawalModal() { document.getElementById("withdrawalModal").style.display = "none"; }

    function submitWithdrawalRequest() {
      if (!currentUserMobile) return alert("Please login first!");

      let amount = parseFloat(document.getElementById("withdrawalAmountInput").value.trim());
      let upiId = document.getElementById("withdrawalUpiIdInput").value.trim();

      if (!amount || amount < 100) return alert("âš ï¸ Minimum Withdrawal Amount is â‚¹100.");
      if (!upiId) return alert("âš ï¸ Please enter your UPI ID.");

      const walletRef = database.ref('users/' + currentUserMobile + '/profile/wallet');
      walletRef.once('value').then(snap => {
        let balance = parseFloat(snap.val() || 0);
        if (balance < amount) return alert("âŒ INSUFFICIENT BALANCE!\n\nYou cannot withdraw more than your current Neural Wallet balance. Please enter a valid amount.");

        if (confirm(`Confirm Withdrawal of â‚¹${amount} to UPI: ${upiId}?\n\n${amount} Gold Coins will be deducted from your wallet immediately.`)) {
          // Deduct coins first
          walletRef.transaction(current => (current || 0) - amount).then(() => {
            let reqId = "WD_" + currentUserMobile + "_" + Date.now();
            let payload = {
              mobile: currentUserMobile,
              amount: amount,
              upiId: upiId,
              timestamp: Date.now(),
              status: "pending",
              type: "withdrawal"
            };

            return database.ref('rechargeRequests/pending/' + reqId).set(payload);
          }).then(() => {
            alert("âœ… Withdrawal request submitted! Admin will transfer â‚¹" + amount + " to " + upiId + " after verification.");
            closeWithdrawalModal();
            document.getElementById("withdrawalAmountInput").value = "";
            document.getElementById("withdrawalUpiIdInput").value = "";
            updateWalletDisplay();
          }).catch(err => {
            console.error(err);
            alert("âŒ Submission failed. Please try again.");
          });
        }
      });
    }

    function joinBattle(id) {
      if (!currentUserMobile) return alert("Please login to join battles!");

      database.ref('battles/active/' + id).once('value').then(snap => {
        const b = snap.val();
        if (!b) return alert("Battle not found.");

        const now = Date.now();
        const startTime = new Date(b.startTime).getTime();
        const maxSt = parseInt(b.maxStudents || 0);
        const joined = parseInt(b.joinedCount || 0);

        if (joined >= maxSt) return alert("Sorry, this battle's seats are FULL!");

        let fee = parseInt(b.entryFee || 0);

        if (fee > 0) {
          database.ref('users/' + currentUserMobile + '/profile/wallet').once('value').then(wSnap => {
            let balance = parseFloat(wSnap.val() || 0);
            if (balance >= fee) {
              if (confirm(`Joining "${b.title}" will deduct â‚¹${fee} from your Neural Wallet. Confirm?`)) {
                // Deduct and Join
                database.ref('users/' + currentUserMobile + '/profile/wallet').set(balance - fee).then(() => {
                  return database.ref(`battleBookings/approved/${id}/${currentUserMobile}`).set({
                    mobile: currentUserMobile,
                    joinedAt: Date.now(),
                    battleTitle: b.title
                  });
                }).then(() => {
                  return database.ref(`battles/active/${id}/joinedCount`).transaction(c => (c || 0) + 1);
                }).then(() => {
                  showCongratulations(
                    'COMBAT READY!',
                    `You joined <b>${b.title}</b>!`,
                    'Your seat is booked. Get ready for the battle!',
                    'LET\'S GO'
                  );
                  updateWalletDisplay();
                });
              }
            } else {
              if (confirm(`âŒ INSUFFICIENT BALANCE!\n\nYou have ${balance} Gold Coins, but you need ${fee} Gold Coins to join this battle.\n\nWould you like to recharge your Neural Wallet now?`)) {
                topUpWallet();
              }
            }
          });
        } else {
          // Free Join
          database.ref(`battleBookings/approved/${id}/${currentUserMobile}`).set({
            mobile: currentUserMobile,
            joinedAt: Date.now(),
            battleTitle: b.title
          }).then(() => {
            return database.ref(`battles/active/${id}/joinedCount`).transaction(c => (c || 0) + 1);
          }).then(() => {
            showCongratulations(
              'COMBAT READY!',
              `You joined <b>${b.title}</b>!`,
              'Free entry confirmed. Get ready for the battle!',
              'LET\'S GO'
            );
          });
        }
      });
    }

    function loadBattleData() {
      let container = document.getElementById('activeBattlesContainer');
      database.ref('battles/active').on('value', snap => {
        let battles = snap.val();
        if (!battles) {
          container.innerHTML = '<p style="color: #666; font-style: italic;">No active battles at the moment. Check back later!</p>';
          return;
        }

        // Fetch bookings and results for current user to handle Join vs Enter vs View Rankings
        database.ref(`battleBookings/approved`).once('value').then(bookingSnap => {
          database.ref(`battleResults`).once('value').then(resultsSnap => {
            let allBookings = bookingSnap.val() || {};
            let allResults = resultsSnap.val() || {};
            let html = "";

            for (let id in battles) {
              let b = battles[id];
              const now = Date.now();
              const startTime = new Date(b.startTime).getTime();
              const isUpcoming = startTime > now;
              const totalSeats = parseInt(b.maxStudents || 0);
              const joinedCount = parseInt(b.joinedCount || 0);
              const seatsLeft = totalSeats - joinedCount;

              const isJoined = allBookings[id] && allBookings[id][currentUserMobile];
              const hasSubmitted = allResults[id] && allResults[id][currentUserMobile];

              let buttonHtml = "";
              if (hasSubmitted) {
                buttonHtml = `<button class="join-battle-btn" style="background: gold; color: black; font-weight: bold;" onclick="openBattleLeaderboard()">View Rankings</button>`;
              } else if (isJoined) {
                if (now >= startTime && joinedCount >= totalSeats) {
                  buttonHtml = `<button class="join-battle-btn" style="background: #2ecc71; color: white;" onclick="prepActiveBattle('${id}')">Enter Arena</button>`;
                } else if (now >= startTime && joinedCount < totalSeats) {
                  buttonHtml = `<button class="join-battle-btn" style="background: #e67e22; color: white; cursor: not-allowed;" disabled>Waiting for Seats (${joinedCount}/${totalSeats})</button>`;
                } else if (now < startTime && joinedCount >= totalSeats) {
                  buttonHtml = `<button class="join-battle-btn" style="background: #e67e22; color: white; cursor: not-allowed;" disabled>Waiting for Start Time</button>`;
                } else {
                  buttonHtml = `<button class="join-battle-btn" style="background: #7f8c8d; color: white; cursor: not-allowed;" disabled>Combat Pending...</button>`;
                }
              } else {
                if (seatsLeft > 0) {
                  buttonHtml = `<button class="join-battle-btn" onclick="joinBattle('${id}')">${isUpcoming ? 'Join Battle' : 'Join Now'}</button>`;
                } else {
                  buttonHtml = `<button class="join-battle-btn" style="background: #8e44ad; color: white; cursor: not-allowed;" disabled>Seats Full</button>`;
                }
              }

              html += `
                <div class="battle-card ${!isUpcoming ? 'active' : ''}">
                  <span class="battle-badge" style="background: ${isUpcoming ? '#ff9f43' : '#2ecc71'}">
                    ${isUpcoming ? 'UPCOMING' : 'LIVE NOW'}
                  </span>
                  <p style="font-size: 11px; color: cyan; margin-bottom: 5px; text-transform: uppercase; font-weight: bold; border-bottom: 1px solid rgba(0,242,254,0.2); padding-bottom: 5px;">
                    ${b.course} > ${b.subject} > ${b.chapter === "ALL" ? "Full Syllabus" : b.chapter}
                  </p>
                  <h3>${b.title}</h3>
                  <p style="font-size: 13px; color: #888;">
                    <span style="color: #ff4757; font-weight: bold;">Entry fees: â‚¹${b.entryFee || b.fee || 0}</span>
                  </p>
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
                    <div style="display: flex; flex-direction: column;">
                      <small style="color: #aaa; font-size: 10px;">Winner prize</small>
                      <span style="color: gold; font-weight: 900; font-size: 16px;">â‚¹${b.prize}</span>
                    </div>
                    <div style="display: flex; flex-direction: column; text-align: right;">
                      <small style="color: #aaa; font-size: 10px;">Total seats: ${totalSeats}</small>
                      <span style="color: ${seatsLeft > 5 ? '#2ecc71' : '#ff4757'}; font-weight: bold; font-size: 14px;">
                        ${joinedCount}/${totalSeats} Joined (${seatsLeft > 0 ? seatsLeft + ' left' : 'FULL'})
                      </span>
                    </div>
                  </div>
                  <p style="color: #666; font-size: 11px; margin-top: 10px;">
                    ðŸ•’ Starts: ${new Date(b.startTime).toLocaleString()}
                  </p>
                  ${buttonHtml}
                </div>
              `;
            }
            container.innerHTML = html;
          });
        });
      });
    }

    /* BATTLE EXAM ENGINE LOGIC */
    let activeBattleId = null;
    let battleQuestions = [];
    let userAnswers = {}; // { index: choice }
    let currentQuestIdx = 0;
    let battleTimerInterval = null;
    let timeLeft = 0;

    let currentBattleMetadata = null;

    function prepActiveBattle(id) {
      activeBattleId = id;
      database.ref(`battles/active/${id}`).once('value').then(snap => {
        const b = snap.val();
        if (!b) return;

        currentBattleMetadata = b;
        battleQuestions = b.questions || [];
        userAnswers = {};
        currentQuestIdx = 0;

        // Set Titles
        document.getElementById('engineBattleTitle').innerText = b.title;
        document.getElementById('engineBattleProgress').innerText = `Instruction Phase | ${battleQuestions.length} Questions`;

        // Toggle view
        document.getElementById('engineInstructions').style.display = "block";
        document.getElementById('engineQuestionView').style.display = "none";

        showPage('battleExamEngine');
      });
    }

    function startActiveBattle() {
      const now = Date.now();
      const startTime = new Date(currentBattleMetadata.startTime).getTime();
      const totalSeats = parseInt(currentBattleMetadata.maxStudents || 0);
      const joinedCount = parseInt(currentBattleMetadata.joinedCount || 0);

      if (now < startTime || joinedCount < totalSeats) {
        alert("ðŸ›¡ï¸ Combat Protocol Error: Arena requires both Start Time reached AND all participants present!");
        showPage('combatArena');
        return;
      }

      document.getElementById('engineInstructions').style.display = "none";
      document.getElementById('engineQuestionView').style.display = "block";

      // Start dynamic timer (mins -> secs)
      let durationMins = parseInt(currentBattleMetadata?.duration || 10);
      timeLeft = durationMins * 60;
      updateTimerDisplay();

      if (battleTimerInterval) clearInterval(battleTimerInterval);
      battleTimerInterval = setInterval(() => {
        timeLeft--;
        updateTimerDisplay();
        if (timeLeft <= 0) {
          clearInterval(battleTimerInterval);
          finishBattle(true); // Auto-submit
        }
      }, 1000);

      renderBattleQuestion(0);
    }

    function updateTimerDisplay() {
      let mins = Math.floor(timeLeft / 60);
      let secs = timeLeft % 60;
      document.getElementById('engineTimer').innerText = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      if (timeLeft < 60) document.getElementById('engineTimer').style.color = "#ff4757";
      else document.getElementById('engineTimer').style.color = "white";
    }

    function renderBattleQuestion(idx) {
      currentQuestIdx = idx;
      const q = battleQuestions[idx];
      document.getElementById('engineBattleProgress').innerText = `Question ${idx + 1}/${battleQuestions.length}`;
      document.getElementById('engineQuestionText').innerText = q.text;

      const container = document.getElementById('engineOptionsContainer');
      container.innerHTML = "";

      const choices = ['a', 'b', 'c', 'd'];
      choices.forEach((key, optionIdx) => {
        const btn = document.createElement('div');
        btn.className = "box";
        btn.style.cssText = `min-height: auto; text-align: left; padding: 15px; font-size: 16px; margin: 0; border: 1px solid rgba(255,255,255,0.1); transition: 0.2s;`;

        const isSelected = userAnswers[idx] === key;
        if (isSelected) {
          btn.style.borderColor = "cyan";
          btn.style.background = "rgba(0,242,254,0.1)";
        }

        btn.innerHTML = `<span style="color: cyan; font-weight: bold; margin-right: 15px;">${key.toUpperCase()}</span> ${q.options[optionIdx]}`;
        btn.onclick = () => selectBattleOption(idx, key);
        container.appendChild(btn);
      });

      // Navigation visibility
      document.getElementById('prevQuestBtn').style.visibility = idx === 0 ? "hidden" : "visible";
      if (idx === battleQuestions.length - 1) {
        document.getElementById('nextQuestBtn').style.display = "none";
        document.getElementById('submitBattleBtn').style.display = "block";
      } else {
        document.getElementById('nextQuestBtn').style.display = "block";
        document.getElementById('submitBattleBtn').style.display = "none";
      }
    }

    function selectBattleOption(idx, key) {
      userAnswers[idx] = key;
      renderBattleQuestion(idx);
    }

    function nextBattleQuestion() {
      if (currentQuestIdx < battleQuestions.length - 1) renderBattleQuestion(currentQuestIdx + 1);
    }

    function prevBattleQuestion() {
      if (currentQuestIdx > 0) renderBattleQuestion(currentQuestIdx - 1);
    }

    function finishBattle(isAuto = false) {
      if (!isAuto && !confirm("Are you sure you want to submit your battle answers?")) return;

      clearInterval(battleTimerInterval);

      // Calculate Score
      let correct = 0;
      let wrong = 0;
      let skipped = 0;

      battleQuestions.forEach((q, idx) => {
        if (userAnswers[idx]) {
          if (userAnswers[idx] === q.correct) correct++;
          else wrong++;
        } else {
          skipped++;
        }
      });

      const totalMarks = (correct * 4) - (wrong * 2);

      const resultPayload = {
        mobile: currentUserMobile,
        name: JSON.parse(localStorage.getItem("user_" + btoa(currentUserMobile)))?.name || "Unknown Warrior",
        correct, wrong, skipped,
        marks: totalMarks,
        timeUsed: 600 - timeLeft,
        timestamp: firebase.database.ServerValue.TIMESTAMP
      };

      database.ref(`battleResults/${activeBattleId}/${currentUserMobile}`).set(resultPayload).then(() => {
        alert(`COMBAT FINISHED!\n\nCorrect: ${correct}\nWrong: ${wrong}\nTotal Marks: ${totalMarks}`);
        openBattleLeaderboard();
        // pre-load relevant battle results
        if (typeof loadBattleRankings === 'function') {
          setTimeout(() => {
            document.getElementById('leaderboardBattleSelect').value = activeBattleId;
            loadBattleRankings(activeBattleId);
          }, 500);
        }
      });
    }

    /* LEADERBOARD LOGIC */
    function openBattleLeaderboard() {
      showPage('battleLeaderboardSection');
      const select = document.getElementById('leaderboardBattleSelect');
      select.innerHTML = '<option value="" disabled selected>Select a Battle</option>';

      database.ref('battles/active').once('value').then(snap => {
        const battles = snap.val();
        for (let id in battles) {
          const opt = document.createElement('option');
          opt.value = id;
          opt.innerText = battles[id].title;
          select.appendChild(opt);
        }
      });
    }

    function loadBattleRankings(id) {
      const list = document.getElementById('battleRankingList');
      list.innerHTML = "<p style='color: cyan; text-align:center;'>Fetching ranks...</p>";

      database.ref(`battleResults/${id}`).once('value').then(snap => {
        const data = snap.val();
        if (!data) {
          list.innerHTML = "<p style='color: #666; text-align:center;'>No results for this battle yet.</p>";
          return;
        }

        const results = Object.values(data).sort((a, b) => {
          if (b.marks !== a.marks) return b.marks - a.marks;
          return a.timeUsed - b.timeUsed; // Tie-breaker: Time taken
        });

        list.innerHTML = "";
        results.forEach((r, idx) => {
          const item = document.createElement('div');
          const isMe = r.mobile === currentUserMobile;
          const rank = idx + 1;
          const isWinner = rank === 1;

          item.style.cssText = `
            display: flex; align-items: center; gap: 15px; 
            background: ${isMe ? 'rgba(0,242,254,0.08)' : 'rgba(255,255,255,0.03)'}; 
            padding: 15px 20px; border-radius: 16px; 
            border: 1px solid ${isMe ? 'rgba(0,242,254,0.4)' : 'rgba(255,255,255,0.05)'};
            box-shadow: ${isMe ? '0 0 20px rgba(0,242,254,0.1)' : 'none'};
            position: relative; overflow: hidden;
            transition: 0.3s ease;
          `;

          const rankIco = rank === 1 ? "ðŸ¥‡" : (rank === 2 ? "ðŸ¥ˆ" : (rank === 3 ? "ðŸ¥‰" : `${rank}.`));

          item.innerHTML = `
            <!-- Rank Glow -->
            <div style="font-size: 24px; font-weight: 900; width: 45px; text-align: center; color: ${isWinner ? 'gold' : '#888'}; text-shadow: ${isWinner ? '0 0 10px gold' : 'none'};">
              ${rankIco}
            </div>
            
            <div style="flex: 1;">
                <h4 style="margin: 0; color: white; font-size: 16px; font-weight: 700;">${r.name} ${isMe ? '<span style="color:cyan; font-size:10px;">(YOU)</span>' : ''}</h4>
                <div style="display: flex; gap: 12px; margin-top: 4px;">
                  <small style="color: #666; font-size: 11px;"><i class="fas fa-clock"></i> ${Math.floor(r.timeUsed / 60)}m ${r.timeUsed % 60}s</small>
                  <small style="color: #666; font-size: 11px;"><i class="fas fa-check-circle"></i> ${r.correct} Correct</small>
                </div>
                <button onclick="openVictoryModal('${id}', ${rank})" 
                  style="background: ${isMe ? 'linear-gradient(90deg, gold, #e67e22)' : 'rgba(255,255,255,0.05)'}; 
                  color: ${isMe ? 'black' : 'white'}; 
                  border: ${isMe ? 'none' : '1px solid rgba(255,255,255,0.1)'}; 
                  font-size: 10px; padding: 4px 12px; border-radius: 6px; font-weight: 900; margin-top: 8px; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 0.5px;">
                  ðŸ† ${isMe ? 'MY VICTORY CARD' : 'VIEW CARD'}
                </button>
            </div>

            <div style="text-align: right; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.03);">
                <span style="color: cyan; font-weight: 900; font-size: 22px; display: block; line-height: 1;">${r.marks}</span>
                <p style="margin:2px 0 0 0; font-size: 9px; color: #555; font-weight: 900; text-transform: uppercase; letter-spacing: 1px;">POINTS</p>
            </div>
          `;

          item.onmouseover = () => { item.style.transform = 'translateX(5px)'; item.style.borderColor = 'cyan'; };
          item.onmouseout = () => { item.style.transform = 'translateX(0)'; item.style.borderColor = isMe ? 'rgba(0,242,254,0.4)' : 'rgba(255,255,255,0.05)'; };

          list.appendChild(item);
        });
      });
    }

    /* VICTORY CARD LOGIC */
    function openVictoryModal(battleId, rank) {
      if (!currentUserMobile) return;

      database.ref('users/' + currentUserMobile).once('value').then(snap => {
        const u = snap.val() || {};
        document.getElementById('vcardName').innerText = u.name || "Student";
        document.getElementById('vcardRoll').innerText = u.roll || "--";
        document.getElementById('vcardUniv').innerText = u.roll || "--"; // Using roll as Univ ID per signup pattern
        document.getElementById('vcardMobile').innerText = "+91 " + currentUserMobile;

        let rankText = `RANK #${rank}`;
        let medal = rank === 1 ? "ðŸ¥‡" : (rank === 2 ? "ðŸ¥ˆ" : (rank === 3 ? "ðŸ¥‰" : "ðŸ…"));

        document.getElementById('vcardRank').innerText = rankText;
        document.getElementById('vcardMedal').innerText = medal;

        document.getElementById('victoryCardModal').style.display = "flex";
        triggerNeuralSyncNotification("ðŸ† Opening your Battle Victory Card!");
      });
    }

    function closeVictoryModal() {
      document.getElementById('victoryCardModal').style.display = "none";
    }

    function downloadVictoryCard() {
      const card = document.getElementById('victoryCard');
      html2canvas(card, { scale: 3, useCORS: true }).then(canvas => {
        const link = document.createElement('a');
        link.download = `NextGen_Battle_Achievement_${currentUserMobile}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }

    function shareVictoryCard() {
      const card = document.getElementById('victoryCard');
      html2canvas(card, { scale: 2 }).then(canvas => {
        canvas.toBlob(blob => {
          const file = new File([blob], 'victory_card.png', { type: 'image/png' });
          if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
            navigator.share({
              files: [file],
              title: 'My Battle Arena Achievement!',
              text: 'I just participated in the NextGen Library Battle Arena! Check out my performance here: adityakumar12xyz.github.io/NextGen/'
            });
          } else {
            alert("Sharing files is not supported in this browser. Please download the card instead.");
          }
        });
      });
    }

    function joinBattle(id) {
      if (!currentUserMobile) {
        alert("Please login first! ðŸ›¡ï¸");
        return;
      }

      database.ref(`battles/active/${id}`).once('value').then(snap => {
        let b = snap.val();
        if (!b) return;

        const now = Date.now();
        const startTime = new Date(b.startTime).getTime();

        // Check if already approved/booked
        database.ref(`battleBookings/approved/${id}/${currentUserMobile}`).once('value').then(bookedSnap => {
          if (bookedSnap.exists()) {
            prepActiveBattle(id);
            return;
          }

          // Not booked yet
          if (b.joinedCount >= b.maxStudents) {
            alert("Sorry, this combat zone is FULL! ðŸš«");
            return;
          }

          let activeAmount = parseFloat(b.entryFee || b.fee || 0);

          if (confirm(`Join "${b.title}" for ${activeAmount} Gold Coins?\n\n(1 Gold Coin = â‚¹1)`)) {
            database.ref('users/' + currentUserMobile + '/profile/wallet').once('value').then(snap => {
              let balance = parseFloat(snap.val() || 0);
              if (balance >= activeAmount) {
                // Deduct
                database.ref('users/' + currentUserMobile + '/profile/wallet').set(balance - activeAmount).then(() => {
                  let payload = {
                    mobile: currentUserMobile,
                    userMobile: currentUserMobile,
                    battleId: id,
                    battleTitle: b.title,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    status: "approved"
                  };
                  return database.ref(`battleBookings/approved/${id}/${currentUserMobile}`).set(payload);
                }).then(() => {
                  // Increment joined count safely
                  return database.ref(`battles/active/${id}/joinedCount`).transaction(current => (current || 0) + 1);
                }).then(() => {
                  triggerNeuralSyncNotification("âœ… Congratulations! You have successfully joined the battle arena.");
                  alert(`Congratulations! You have successfully joined the battle arena.\nDeducted ${activeAmount} Gold Coins.`);
                  loadBattleData(); // Refresh UI to change button to Enter Arena
                }).catch(err => {
                  console.error(err);
                  alert("âŒ Failed to book seat due to a network error.");
                });
              } else {
                if (confirm(`âŒ INSUFFICIENT BALANCE!\n\nYou currently have ${balance} Gold Coins, but this costs ${activeAmount} Gold Coins.\n\nTo proceed, please recharge your Neural Wallet. Would you like to do it now?`)) {
                  topUpWallet();
                }
              }
            });
          }
        });
      });
    }


    // Admin Battle Functions
    function updateBattleSubjects() {
      let course = document.getElementById('battleCourse').value;
      let subSelect = document.getElementById('battleSubject');
      subSelect.innerHTML = '<option value="" disabled selected>Target Subject</option>';
      if (!data[course]) return;

      let subjects = new Set();
      for (let branch in data[course]) {
        for (let sem in data[course][branch]) {
          for (let sub in data[course][branch][sem]) {
            if (sub !== "_initialized") subjects.add(sub);
          }
        }
      }

      subjects.forEach(sub => {
        let opt = document.createElement("option");
        opt.value = sub;
        opt.innerText = sub;
        subSelect.appendChild(opt);
      });
    }

    function updateBattleChapters() {
      let course = document.getElementById('battleCourse').value;
      let sub = document.getElementById('battleSubject').value;
      let chSelect = document.getElementById('battleChapter');
      chSelect.innerHTML = '<option value="ALL">ALL CHAPTERS (Subject-wise Battle)</option>';
      // Find the first occurrence of this subject to get chapters
      for (let branch in data[course]) {
        for (let sem in data[course][branch]) {
          if (data[course][branch][sem][sub]) {
            let chapters = data[course][branch][sem][sub];
            for (let ch in chapters) {
              if (ch === "_initialized") continue;
              let opt = document.createElement("option");
              opt.value = ch;
              opt.innerText = ch;
              chSelect.appendChild(opt);
            }
          }
        }
      }
    }

    function addBattleQuestion() {
      let questText = document.getElementById('battleQuestText').value.trim();
      let opt1 = document.getElementById('battleOpt1').value.trim();
      let opt2 = document.getElementById('battleOpt2').value.trim();
      let opt3 = document.getElementById('battleOpt3').value.trim();
      let opt4 = document.getElementById('battleOpt4').value.trim();
      let correct = document.getElementById('battleCorrectOpt').value;

      if (!questText || !opt1 || !opt2 || !opt3 || !opt4 || !correct) {
        alert("Fill all question fields!"); return;
      }

      let q = {
        text: questText,
        options: [opt1, opt2, opt3, opt4],
        correct: correct
      };

      currentBattleQuestions.push(q);
      renderBattleQuestionPreview();

      // Clear Question Inputs
      document.getElementById("battleQuestText").value = "";
      document.getElementById("battleOpt1").value = "";
      document.getElementById("battleOpt2").value = "";
      document.getElementById("battleOpt3").value = "";
      document.getElementById("battleOpt4").value = "";
      document.getElementById("battleCorrectOpt").value = "";
    }

    function renderBattleQuestionPreview() {
      const list = document.getElementById("battleQuestionPreviewList");
      const countEl = document.getElementById("battleQuestCount");
      const marksEl = document.getElementById("battleTotalMarks");
      if (!list) return;

      list.innerHTML = "";
      if (currentBattleQuestions.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic; text-align: center;">No questions added yet.</p>';
        if (countEl) countEl.innerText = "Total Questions: 0";
        if (marksEl) marksEl.innerText = "Total Marks: 0";
        return;
      }

      currentBattleQuestions.forEach((q, idx) => {
        let div = document.createElement("div");
        div.style.cssText = "padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: start; border-left: 3px solid #ff4757;";
        div.innerHTML = `
          <div style="flex: 1;">
            <p style="margin: 0; color: #fff; font-size: 13px;"><b>Q${idx + 1}:</b> ${q.text}</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 5px; font-size: 11px; color: #aaa;">
              <span>A: ${q.options[0]}</span>
              <span>B: ${q.options[1]}</span>
              <span>C: ${q.options[2]}</span>
              <span>D: ${q.options[3]}</span>
            </div>
            <p style="margin: 5px 0 0 0; color: #2ecc71; font-size: 11px;">Correct: ${q.correct}</p>
          </div>
          <button onclick="deleteBattleQuestion(${idx})" style="background: none; border: none; color: #ff4757; cursor: pointer; padding: 5px; font-size: 16px;">ðŸ—‘ï¸</button>
        `;
        list.appendChild(div);
      });

      if (countEl) countEl.innerText = `Total Questions: ${currentBattleQuestions.length}`;
      if (marksEl) marksEl.innerText = `Total Marks: ${currentBattleQuestions.length * 4}`;
    }

    function deleteBattleQuestion(idx) {
      if (!confirm("Remove this question?")) return;
      currentBattleQuestions.splice(idx, 1);
      renderBattleQuestionPreview();
    }

    // =============================================
    // ========== CODE STUDIO ENGINE ==============
    // =============================================

    // Wandbox API â€” FREE, no API key needed! https://wandbox.org
    const CS_LANGUAGES = {
      python: { name: 'Python', icon: 'ðŸ', compiler: 'cpython-3.12.7', ext: '.py', template: 'print("Hello, World!")' },
      c: { name: 'C', icon: 'ðŸ”µ', compiler: 'gcc-13.2.0-c', ext: '.c', template: '#include <stdio.h>\n\nint main() {\n    printf("Hello, World!\\n");\n    return 0;\n}' },
      cpp: { name: 'C++', icon: 'ðŸŸ£', compiler: 'gcc-13.2.0', ext: '.cpp', template: '#include <iostream>\nusing namespace std;\n\nint main() {\n    cout << "Hello, World!" << endl;\n    return 0;\n}' },
      java: { name: 'Java', icon: 'â˜•', compiler: 'openjdk-jdk-22+36', ext: '.java', template: 'public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello, World!");\n    }\n}' },
      javascript: { name: 'JavaScript', icon: 'ðŸŸ¡', compiler: 'nodejs-20.17.0', ext: '.js', template: 'console.log("Hello, World!");' },
      typescript: { name: 'TypeScript', icon: 'ðŸ”·', compiler: 'typescript-5.6.2', ext: '.ts', template: 'console.log("Hello, World!");' },
      php: { name: 'PHP', icon: 'ðŸ˜', compiler: 'php-8.3.12', ext: '.php', template: '<?php\necho "Hello, World!";\n?>' },
      ruby: { name: 'Ruby', icon: 'â¤ï¸', compiler: 'ruby-3.4.1', ext: '.rb', template: 'puts "Hello, World!"' },
      go: { name: 'Go', icon: 'ðŸ”·', compiler: 'go-1.23.2', ext: '.go', template: 'package main\nimport "fmt"\nfunc main() {\n    fmt.Println("Hello, World!")\n}' },
      rust: { name: 'Rust', icon: 'ðŸ¦€', compiler: 'rust-1.82.0', ext: '.rs', template: 'fn main() {\n    println!("Hello, World!");\n}' },
      csharp: { name: 'C#', icon: 'ðŸ’œ', compiler: 'dotnetcore-8.0.402', ext: '.cs', template: 'using System;\nclass Program {\n    static void Main() {\n        Console.WriteLine("Hello, World!");\n    }\n}' },
      lua: { name: 'Lua', icon: 'ðŸŒ™', compiler: 'lua-5.4.7', ext: '.lua', template: 'print("Hello, World!")' },
      bash: { name: 'Bash', icon: 'âš¡', compiler: 'bash', ext: '.sh', template: 'echo "Hello, World!"' },
    };

    let csEnabledLangs = Object.keys(CS_LANGUAGES);
    let csCurrentLang = 'python';
    let csOpenProjectId = null;
    let csProjects = {};
    let csConfig = { price: 50, freeLimit: 2, trialHours: 24, limitEnabled: true };

    async function initCodeStudio() {
      // 1. Load Admin Config
      const configSnap = await database.ref('codeStudioConfig').once('value');
      if (configSnap.exists()) {
        const val = configSnap.val();
        csConfig = {
          price: parseInt(val.price) || 50,
          freeLimit: parseInt(val.freeLimit) || 2,
          trialHours: parseInt(val.trialHours) || 24,
          premiumValidityDays: parseInt(val.premiumValidityDays) || 365,
          limitEnabled: val.limitEnabled !== undefined ? val.limitEnabled : true
        };
        if (val.enabledLangs) csEnabledLangs = val.enabledLangs;
      }

      buildLangDropdown();
      loadUserProjects();

      // 2. Access Check
      checkCodeStudioAccess();
    }

    async function checkCodeStudioAccess() {
      const mobile = currentUserMobile;
      if (!mobile) {
        showPage('loginScreen');
        return;
      }

      // If limit is disabled globally
      if (!csConfig.limitEnabled) {
        document.getElementById('csPremiumOverlay').style.display = 'none';
        return;
      }

      const snap = await database.ref(`users/${mobile}/codeStudio`).once('value');
      const data = snap.val() || { usageCount: 0, isPremium: false, trialStartTime: null };

      if (data.isPremium) {
        if (data.premiumExpiresAt && Date.now() > data.premiumExpiresAt) {
          // Premium expired, treat as non-premium (re-enable overlay)
        } else {
          document.getElementById('csPremiumOverlay').style.display = 'none';
          return;
        }
      }

      // 1. Trial Start Time Logic
      let trialStartTime = data.trialStartTime;
      if (!trialStartTime) {
        trialStartTime = Date.now();
        await database.ref(`users/${mobile}/codeStudio/trialStartTime`).set(trialStartTime);
      }

      const expiryTime = trialStartTime + (csConfig.trialHours * 3600000);
      const isExpired = Date.now() > expiryTime;
      const isOverUsage = (data.usageCount || 0) >= csConfig.freeLimit;

      if (!isExpired && !isOverUsage) {
        // Active Trial
        const nextCount = (data.usageCount || 0) + 1;
        database.ref(`users/${mobile}/codeStudio/usageCount`).set(nextCount);
        document.getElementById('csPremiumOverlay').style.display = 'none';

        // Show remaining time/uses
        const msLeft = expiryTime - Date.now();
        const hrs = Math.floor(msLeft / 3600000);
        const mins = Math.floor((msLeft % 3600000) / 60000);
        const usesLeft = (csConfig.freeLimit || 0) - nextCount;

        document.getElementById('csOutput').innerHTML = `<span style="color:gold;">â³ Trial: ${hrs}h ${mins}m left | ðŸ’¡ Uses: ${usesLeft >= 0 ? usesLeft : 0} left</span><br><br>` +
          '<span style="color:#555;">â–¶ Click RUN to execute your code...</span>';
      } else {
        // Locked
        document.getElementById('csPremiumPriceDisplay').textContent = csConfig.price;
        const msg = isExpired ? `Aapka ${csConfig.trialHours}h trial khatam ho gaya hai.` : `Aapne free limit (${csConfig.freeLimit} uses) use kar liya hai.`;
        const pTag = document.querySelector('#csPremiumOverlay p');
        if (pTag) pTag.textContent = msg;
        document.getElementById('csPremiumOverlay').style.display = 'flex';
      }
    }

    async function buyCodeStudioPremium() {
      const mobile = currentUserMobile;
      if (!mobile) return;

      const balanceSnap = await database.ref(`users/${mobile}/profile/wallet`).once('value');
      const balance = balanceSnap.val() || 0;

      if (balance < csConfig.price) {
        alert(`âŒ Insufficient Coins!\nYou need ${csConfig.price} coins, but you only have ${balance} coins in your Neural Wallet.`);
        return;
      }

      if (confirm(`Unlock Premium Access for ${csConfig.price} Coins?`)) {
        const expiry = Date.now() + (csConfig.premiumValidityDays * 24 * 60 * 60 * 1000);
        await database.ref(`users/${mobile}/profile/wallet`).set(balance - csConfig.price);
        await database.ref(`users/${mobile}/codeStudio`).update({
          isPremium: true,
          premiumExpiresAt: expiry
        });

        // Success UI
        document.getElementById('csPremiumOverlay').style.display = 'none';
        showCongratulations(
          'CONGRATULATIONS!',
          'You are now a <b>Premium Code Studio Member</b>!',
          `Unlimited access unlocked for ${csConfig.premiumValidityDays} days.`,
          'START CODING'
        );
      }
    }

    function showCongratulations(title, message, subMessage, buttonText) {
      const div = document.createElement('div');
      div.style.cssText = 'position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.9); display:flex; justify-content:center; align-items:center; animation: fadeIn 0.5s;';
      div.innerHTML = `
        <div style="text-align:center; padding:40px; background:#0b132b; border:2px solid gold; border-radius:20px; box-shadow:0 0 50px gold; max-width: 450px; width: 90%;">
          <h1 style="font-size:80px; margin:0;">ðŸŽŠ</h1>
          <h1 style="color:gold; font-size:32px; margin:10px 0;">${title}</h1>
          <p style="color:#eee; font-size:18px;">${message}</p>
          <p style="color:#aaa; font-size:14px; margin-bottom:25px;">${subMessage}</p>
          <button class="login-btn" style="background:#00b894; color:black; width:200px;" onclick="this.parentElement.parentElement.remove()">${buttonText}</button>
        </div>
      `;
      document.body.appendChild(div);
      for (let i = 0; i < 30; i++) createParticle();
    }

    function createParticle() {
      const p = document.createElement('div');
      p.style.cssText = `position:fixed; width:10px; height:10px; background:hsl(${Math.random() * 360},100%,50%); z-index:99998; border-radius:50%; pointer-events:none;`;
      p.style.left = Math.random() * 100 + 'vw';
      p.style.top = '-10px';
      document.body.appendChild(p);
      const anim = p.animate([
        { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
        { transform: `translate(${(Math.random() - 0.5) * 200}px, 100vh) rotate(${Math.random() * 360}deg)`, opacity: 0 }
      ], { duration: 1500 + Math.random() * 2000, easing: 'ease-in' });
      anim.onfinish = () => p.remove();
    }

    function buildLangDropdown() {
      let sel = document.getElementById('csLangSelect');
      if (!sel) return;
      sel.innerHTML = '';
      csEnabledLangs.forEach(key => {
        if (!CS_LANGUAGES[key]) return;
        let opt = document.createElement('option');
        opt.value = key;
        opt.textContent = CS_LANGUAGES[key].icon + ' ' + CS_LANGUAGES[key].name;
        sel.appendChild(opt);
      });
      sel.value = csCurrentLang;
      onCSLangChange();
    }

    function onCSLangChange() {
      let sel = document.getElementById('csLangSelect');
      if (!sel) return;
      csCurrentLang = sel.value;
      let lang = CS_LANGUAGES[csCurrentLang];
      if (!lang) return;
      let infoEl = document.getElementById('csLangInfo');
      if (infoEl) infoEl.innerHTML = `<b style="color:#00b894">${lang.icon} ${lang.name}</b><br>Compiler: ${lang.compiler}<br>File: *${lang.ext}`;
      if (!document.getElementById('csEditor').value.trim() || document.getElementById('csEditor').value.includes('Hello, World!')) {
        document.getElementById('csEditor').value = lang.template;
      }
    }

    function openCodeStudio() {
      showPage('codeStudioScreen');
      initCodeStudio();
    }

    function handleEditorTab(e) {
      if (e.key === 'Tab') {
        e.preventDefault();
        let ta = document.getElementById('csEditor');
        let start = ta.selectionStart, end = ta.selectionEnd;
        ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(end);
        ta.selectionStart = ta.selectionEnd = start + 2;
      }
    }

    function clearEditor() {
      let lang = CS_LANGUAGES[csCurrentLang];
      document.getElementById('csEditor').value = lang ? lang.template : '';
      clearOutput();
    }
    function clearOutput() {
      document.getElementById('csOutput').innerHTML = '<span style="color:#555;">â–¶ Click RUN to execute your code...</span>';
      document.getElementById('csHinglishError').innerHTML = '<span style="color:#555;">Koi error nahi â€” sab theek hai! âœ…</span>';
      document.getElementById('csExecTime').textContent = '';
    }

    async function runCode() {
      let code = document.getElementById('csEditor').value.trim();
      let outEl = document.getElementById('csOutput');
      let runBtn = document.getElementById('csRunBtn');
      let lang = CS_LANGUAGES[csCurrentLang];
      if (!lang || !code) { outEl.innerHTML = '<span style="color:#777;">Kuch code likho pehle!</span>'; return; }

      runBtn.textContent = 'â³ Running...';
      runBtn.disabled = true;
      outEl.innerHTML = '<span style="color:#00b894;">âŸ³ Compiling and running...</span>';
      document.getElementById('csHinglishError').innerHTML = '<span style="color:#aaa;">Checking...</span>';

      let t0 = Date.now();
      try {
        let body = csCurrentLang === 'java'
          ? { compiler: lang.compiler, codes: [{ file: 'Main.java', code: code }], stdin: '', save: false }
          : { compiler: lang.compiler, code: code, stdin: '', save: false };

        let resp = await fetch('https://wandbox.org/api/compile.json', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        if (!resp.ok) throw new Error(`Server error ${resp.status}`);
        let data = await resp.json();

        let elapsed = ((Date.now() - t0) / 1000).toFixed(2);
        document.getElementById('csExecTime').textContent = `â± ${elapsed}s`;

        let stdout = (data.program_output || '').trim();
        let progErr = (data.program_error || '').trim();
        let compileMsg = (data.compiler_message || '').trim();
        let isSuccess = String(data.status || '0') === '0';
        let stderr = (!isSuccess && compileMsg) ? compileMsg : progErr;

        if (stdout) {
          outEl.innerHTML = `<span style="color:#a8ff78;">${escapeHtml(stdout)}</span>`;
          if (compileMsg && isSuccess) {
            outEl.innerHTML += `\n<span style="color:#fdcb6e;font-size:11px;">[warnings]:\n${escapeHtml(compileMsg)}</span>`;
          }
          document.getElementById('csHinglishError').innerHTML = '<span style="color:#00b894;">âœ… Code bilkul sahi chal gaya bhai! Koi error nahi.</span>';
        } else if (!isSuccess || progErr) {
          let errText = stderr || 'Unknown error.';
          outEl.innerHTML = `<span style="color:#ff6b81;">${escapeHtml(errText)}</span>`;
          document.getElementById('csHinglishError').innerHTML = getHinglishError(errText, csCurrentLang);
        } else {
          outEl.innerHTML = `<span style="color:#777;">Program chal gaya lekin koi output nahi aaya.<br><small>print() / cout / System.out.println() use karo.</small></span>`;
          document.getElementById('csHinglishError').innerHTML = '<span style="color:#00b894;">âœ… Code sahi hai â€” koi error nahi. Output ke liye print/cout add karo!</span>';
        }
      } catch (err) {
        outEl.innerHTML = `<span style="color:#ff6b81;">âŒ Connection error: ${escapeHtml(err.message)}<br><small>Internet check karo ya thodi der baad try karo.</small></span>`;
        document.getElementById('csHinglishError').innerHTML = '<span style="color:#fd79a8;">ðŸŒ Wandbox server se connect nahi hua. Internet check karo.</span>';
      } finally {
        runBtn.textContent = 'â–¶ RUN';
        runBtn.disabled = false;
      }
    }

    function escapeHtml(s) {
      return (s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function getHinglishError(stderr, lang) {
      if (!stderr) return '<span style="color:#00b894;">âœ… Koi error nahi!</span>';
      let e = stderr.toLowerCase();
      let hints = [];
      if (e.includes("expected ';'") || e.includes("missing ';'")) hints.push("ðŸ‘‰ Bhai, semicolon <b>(;)</b> lagaana bhool gaye!");
      if (e.includes("expected '}'") || e.includes("expected '{'") || e.includes("unmatched")) hints.push("ðŸ‘‰ Curly bracket <b>{ }</b> check karo mismatch lag raha hai.");
      if (e.includes("undeclared") || e.includes("undefined") || e.includes("not defined")) hints.push("ðŸ‘‰ Variable use kiya lekin <b>declare nahi kiya</b>.");
      if (e.includes("indentationerror")) hints.push("ðŸ‘‰ Python mein <b>indentation (space/tab)</b> galat hai!");
      if (e.includes("syntaxerror")) hints.push("ðŸ‘‰ <b>Syntax galat hai</b> â€” spelling ya brackets check karo.");
      if (hints.length === 0) hints.push(`ðŸ‘‰ <b>Error:</b> <code style="font-size:11px;color:#ff6b81;">${escapeHtml(stderr.substring(0, 150))}</code>`);
      return `<div style="color:#fff;">${hints.join('<br><br>')}</div>`;
    }

    // ===== PROJECT MANAGER =====
    function loadUserProjects() {
      let mobile = currentUserMobile;
      let list = document.getElementById('csProjList');
      if (!mobile || !list) { list && (list.innerHTML = '<p style="color:#555;font-size:12px;text-align:center;margin-top:20px;">Login karein projects save karne ke liye</p>'); return; }
      database.ref(`codeProjects/${mobile}`).on('value', snap => {
        csProjects = snap.val() || {};
        renderProjectList();
      });
    }

    function renderProjectList(filter = '') {
      let list = document.getElementById('csProjList');
      if (!list) return;
      list.innerHTML = '';
      let keys = Object.keys(csProjects).filter(k => k.toLowerCase().includes(filter.toLowerCase()));
      keys.sort((a, b) => (csProjects[b].updatedAt || 0) - (csProjects[a].updatedAt || 0));
      keys.forEach(id => {
        let p = csProjects[id];
        let item = document.createElement('div');
        item.className = 'cs-proj-item' + (id === csOpenProjectId ? ' active' : '');
        item.innerHTML = `
          <span onclick="openProject('${id}')" style="flex:1;">ðŸ“„ ${escapeHtml(p.name)}</span>
          <button onclick="deleteProject('${id}')" style="background:none;border:none;color:#ff4757;cursor:pointer;font-size:11px;">ðŸ—‘ï¸</button>
        `;
        list.appendChild(item);
      });
    }

    function filterProjects() {
      let q = document.getElementById('csSearchProj').value;
      renderProjectList(q);
    }

    function newProject() {
      let name = prompt('Project ka naam?', 'My Project');
      if (!name) return;
      let mobile = currentUserMobile;
      let id = 'proj_' + Date.now();
      let proj = { name: name.trim(), lang: csCurrentLang, code: CS_LANGUAGES[csCurrentLang].template, updatedAt: Date.now() };
      database.ref(`codeProjects/${mobile}/${id}`).set(proj).then(() => {
        csOpenProjectId = id;
        openProject(id);
      });
    }

    function openProject(id) {
      let p = csProjects[id];
      if (!p) return;
      csOpenProjectId = id;
      document.getElementById('csEditor').value = p.code || '';
      document.getElementById('csLangSelect').value = p.lang;
      csCurrentLang = p.lang;
      onCSLangChange();
      document.getElementById('csCurrentProject').textContent = 'ðŸ“„ ' + p.name;
      renderProjectList();
    }

    async function saveProject() {
      let mobile = currentUserMobile;
      if (!mobile) return alert('Login please!');
      if (!csOpenProjectId) { newProject(); return; }
      let update = { code: document.getElementById('csEditor').value, lang: csCurrentLang, updatedAt: Date.now() };
      await database.ref(`codeProjects/${mobile}/${csOpenProjectId}`).update(update);
      alert('ðŸ’¾ Project Saved!');
    }

    function deleteProject(id) {
      if (!confirm('Delete this project?')) return;
      database.ref(`codeProjects/${currentUserMobile}/${id}`).remove();
    }

    // ===== ADMIN CODE STUDIO CONTROLS =====
    async function initAdminCodeStudio() {
      const snap = await database.ref('codeStudioConfig').once('value');
      const val = snap.val() || { price: 50, freeLimit: 2, trialHours: 24, premiumValidityDays: 365, limitEnabled: true, enabledLangs: Object.keys(CS_LANGUAGES) };

      const flInput = document.getElementById('csFreeLimitInput');
      const thInput = document.getElementById('csTrialHoursInput');
      const ppInput = document.getElementById('csPremiumPriceInput');
      const pvInput = document.getElementById('csPremiumValidityInput');
      const leInput = document.getElementById('csLimitEnabled');

      if (flInput) flInput.value = val.freeLimit || 2;
      if (thInput) thInput.value = val.trialHours || 24;
      if (ppInput) ppInput.value = val.price || 50;
      if (pvInput) pvInput.value = val.premiumValidityDays || 365;
      if (leInput) leInput.checked = val.limitEnabled !== false;

      // Load Languages
      let container = document.getElementById('adminCodeStudioLangs');
      if (container) {
        container.innerHTML = '';
        Object.keys(CS_LANGUAGES).forEach(key => {
          let enabled = (val.enabledLangs || Object.keys(CS_LANGUAGES)).includes(key);
          let lang = CS_LANGUAGES[key];
          let div = document.createElement('div');
          div.style.cssText = 'display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(255,255,255,0.04);border-radius:6px;margin-bottom:6px;';
          div.innerHTML = `
            <span style="color:#eee;font-size:13px;">${lang.icon} ${lang.name}</span>
            <label style="cursor:pointer;"><input type="checkbox" class="cs-lang-cb" data-lang="${key}" ${enabled ? 'checked' : ''}> ON</label>
          `;
          container.appendChild(div);
        });
      }

      // Load Premium Users
      renderPremiumCSUsers();
    }

    async function renderPremiumCSUsers() {
      const tbody = document.getElementById('csPremiumUsersList');
      if (!tbody) return;

      const usersSnap = await database.ref('users').once('value');
      const users = usersSnap.val();
      let html = '';

      if (users) {
        Object.keys(users).forEach(mobile => {
          const u = users[mobile];
          if (u.codeStudio && u.codeStudio.isPremium) {
            const name = u.name || 'Unknown';
            const expiry = u.codeStudio.premiumExpiresAt ? new Date(u.codeStudio.premiumExpiresAt).toLocaleString() : 'LifeTime';
            const isExpired = u.codeStudio.premiumExpiresAt && Date.now() > u.codeStudio.premiumExpiresAt;
            const status = isExpired ? '<span style="color:#ff4757;">Expired</span>' : '<span style="color:#2ecc71;">Active</span>';
            const trialStart = u.codeStudio.trialStartTime ? new Date(u.codeStudio.trialStartTime).toLocaleString() : 'N/A';

            html += `
              <tr>
                <td>${name}</td>
                <td>${mobile}</td>
                <td style="font-size:11px;">${trialStart}</td>
                <td style="font-size:11px;">${expiry}</td>
                <td>${status}</td>
              </tr>
            `;
          }
        });
      }

      tbody.innerHTML = html || '<tr><td colspan="5" style="text-align:center; padding:20px; color:#666;">No premium members found yet.</td></tr>';
    }

    async function saveCodeStudioAdminSettings() {
      const freeLimit = parseInt(document.getElementById('csFreeLimitInput').value) || 0;
      const trialHours = parseInt(document.getElementById('csTrialHoursInput').value) || 0;
      const price = parseInt(document.getElementById('csPremiumPriceInput').value) || 0;
      const premiumValidityDays = parseInt(document.getElementById('csPremiumValidityInput').value) || 365;
      const limitEnabled = document.getElementById('csLimitEnabled').checked;
      const enabledLangs = [];
      document.querySelectorAll('.cs-lang-cb').forEach(cb => { if (cb.checked) enabledLangs.push(cb.getAttribute('data-lang')); });

      await database.ref('codeStudioConfig').set({ freeLimit, trialHours, price, premiumValidityDays, limitEnabled, enabledLangs });
      alert('âœ… Code Studio settings saved!');
      csConfig = { price, freeLimit, trialHours, premiumValidityDays, limitEnabled };
      csEnabledLangs = enabledLangs;
    }

    // Make showPage aware of codeStudioScreen
    // (it's already in allPages check via the existing showPage function)

    // =============================================
    // ========== /CODE STUDIO ENGINE ==============
    // =============================================

    function loadAdminBattles() {
      let tbody = document.getElementById('adminBattleTableBody');
      if (!tbody) return;
      database.ref('battles/active').on('value', snap => {
        tbody.innerHTML = "";
        let battles = snap.val();
        if (!battles) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px;">No battles published.</td></tr>';
          return;
        }
        for (let id in battles) {
          let b = battles[id];
          let tr = document.createElement('tr');
          tr.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
          let transferred = b.prizeTransferred ? true : false;
          tr.innerHTML = `
            <td style="padding:10px; font-family:monospace; font-size:10px;">${id.split('_')[1]}</td>
            <td style="padding:10px;">${b.title}<br><small style="color:gold;">ðŸª™ Prize: ${b.prize || 0} Coins</small></td>
            <td style="padding:10px;">${new Date(b.startTime).toLocaleString()}</td>
            <td style="padding:10px;">${b.joinedCount || 0} / ${b.maxStudents || '--'}</td>
            <td style="padding:10px; display: flex; gap: 5px; flex-wrap: wrap;">
              <button onclick="editBattle('${id}')" style="background:cyan; color:black; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px; font-weight:bold;">EDIT</button>
              <button onclick="deleteBattle('${id}')" style="background:#ff4757; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px; font-weight:bold;">DELETE</button>
              <button onclick="transferBattleWinnerPrize('${id}', ${b.prize || 0})" 
                style="background:${transferred ? '#555' : 'gold'}; color:${transferred ? '#aaa' : 'black'}; border:none; padding:4px 8px; border-radius:4px; font-size:11px; font-weight:bold; cursor:${transferred ? 'not-allowed' : 'pointer'};"
                ${transferred ? 'disabled' : ''}>
                ${transferred ? 'âœ… SENT' : 'ðŸ† TRANSFER'}
              </button>
            </td>
          `;
          tbody.appendChild(tr);
        }
      });
    }

    // Transfer battle winner prize coins to winner's wallet
    function transferBattleWinnerPrize(battleId, prizeCoins) {
      if (!prizeCoins || prizeCoins <= 0) {
        alert("âŒ Prize amount is 0 or not set for this battle.");
        return;
      }
      if (!confirm(`ðŸ† Winner ko ${prizeCoins} Gold Coins transfer karna chahte ho?\n\nYeh action winner ke wallet mein coins add kar dega.`)) return;

      database.ref(`battleResults/${battleId}`).once('value').then(snap => {
        const data = snap.val();
        if (!data) {
          alert("âŒ Is battle ke results nahi mile. Koi participate nahi kiya.");
          return;
        }
        // Sort to find rank 1 winner: highest marks, then lowest timeUsed
        const results = Object.values(data).sort((a, b) => {
          if (b.marks !== a.marks) return b.marks - a.marks;
          return a.timeUsed - b.timeUsed;
        });
        const winner = results[0];
        if (!winner || !winner.mobile) {
          alert("âŒ Winner determine nahi ho saka. Results check karo.");
          return;
        }
        // Add coins to winner's wallet
        database.ref(`users/${winner.mobile}/profile/wallet`).once('value').then(wSnap => {
          let currentBal = parseFloat(wSnap.val() || 0);
          let newBal = currentBal + parseFloat(prizeCoins);
          database.ref(`users/${winner.mobile}/profile/wallet`).set(newBal).then(() => {
            // Mark battle as prize transferred
            database.ref(`battles/active/${battleId}/prizeTransferred`).set(true).then(() => {
              alert(`âœ… ${prizeCoins} Gold Coins successfully transfer ho gaye!\n\nðŸ† Winner: ${winner.name || winner.mobile}\nðŸ“± Mobile: ${winner.mobile}\nðŸ’° Naya Balance: ${newBal} Coins`);
            });
          });
        });
      }).catch(err => {
        console.error(err);
        alert("âŒ Transfer fail ho gaya. Network error.");
      });
    }

    let currentlyEditingBattleId = null;

    function editBattle(id) {
      database.ref('battles/active/' + id).once('value').then(snap => {
        const b = snap.val();
        if (!b) return;

        currentlyEditingBattleId = id;

        // Populate Fields
        document.getElementById('battleTitle').value = b.title || "";
        document.getElementById('battleCourse').value = b.course || "";
        updateBattleSubjects();
        document.getElementById('battleSubject').value = b.subject || "";
        updateBattleChapters();
        document.getElementById('battleChapter').value = b.chapter || "ALL";

        document.getElementById('battleEntryFee').value = b.entryFee || b.fee || "";
        document.getElementById('battlePrizePool').value = b.prize || "";
        document.getElementById('battleDuration').value = b.duration || "";

        // Format date for datetime-local input
        if (b.startTime) {
          const dt = new Date(b.startTime);
          const tzOffset = dt.getTimezoneOffset() * 60000;
          const localISOTime = (new Date(dt - tzOffset)).toISOString().slice(0, 16);
          document.getElementById("battleMaxStudents").value = b.maxStudents || "";
          document.getElementById("battleDuration").value = b.duration || "";
          document.getElementById("battleStartTime").value = b.startTime;
        }

        currentBattleQuestions = b.questions || [];
        renderBattleQuestionPreview(); // Use the new preview function

        // Change Publish button to "Update Battle"
        const pubBtn = document.getElementById('publishBattleBtn');
        if (pubBtn) {
          pubBtn.innerText = "UPDATE BATTLE";
          pubBtn.style.background = "cyan";
          pubBtn.style.color = "black";
          pubBtn.onclick = () => updateExistingBattle();
        }

        triggerNeuralSyncNotification("ðŸ› ï¸ Loaded Battle for editing: " + b.title);
        alert("Battle data loaded! You can now modify the details above.");
        document.getElementById('adminBattleManager').scrollIntoView({ behavior: 'smooth' });
      });
    }

    function updateExistingBattle() {
      if (!currentlyEditingBattleId) return;

      let title = document.getElementById('battleTitle').value;
      let course = document.getElementById('battleCourse').value;
      let subject = document.getElementById('battleSubject').value;
      let chapter = document.getElementById('battleChapter').value;
      let entryFee = document.getElementById('battleEntryFee').value;
      let prize = document.getElementById('battlePrizePool').value;
      let startTime = document.getElementById('battleStartTime').value;
      let maxStudents = document.getElementById('battleMaxStudents').value;
      let duration = document.getElementById('battleDuration').value;

      if (!title || !course || !subject || !entryFee || !prize || !startTime || !maxStudents || !duration || currentBattleQuestions.length === 0) {
        alert("Complete battle setup first! (Including Duration, questions & max students)"); return;
      }

      if (parseInt(entryFee) < 0 || parseInt(maxStudents) <= 0 || parseInt(duration) <= 0) {
        alert("Please enter valid numeric values for Entry Fee, Max Students, and Duration.");
        return;
      }

      database.ref('battles/active/' + currentlyEditingBattleId).update({
        title, course, subject, chapter,
        entryFee: parseInt(entryFee),
        prize: parseInt(prize),
        startTime,
        maxStudents: parseInt(maxStudents),
        duration: parseInt(duration),
        questions: currentBattleQuestions
      }).then(() => {
        alert("Battle updated successfully!");
        currentlyEditingBattleId = null;
        resetBattleForm();
      });
    }

    function resetBattleForm() {
      document.getElementById('battleTitle').value = "";
      document.getElementById('battleCourse').value = "";
      document.getElementById('battleSubject').value = "";
      document.getElementById('battleChapter').value = "ALL";
      document.getElementById('battleEntryFee').value = "";
      document.getElementById('battlePrizePool').value = "";
      document.getElementById('battleMaxStudents').value = "";
      document.getElementById('battleStartTime').value = "";
      document.getElementById('battleDuration').value = "";
      document.getElementById('battleUPI').value = "";
      document.getElementById('battleQRInput').value = "";
      currentBattleQuestions = [];
      renderBattleQuestionPreview(); // Update preview list

      // Clear question input fields
      document.getElementById('battleQuestText').value = "";
      document.getElementById('battleOpt1').value = "";
      document.getElementById('battleOpt2').value = "";
      document.getElementById('battleOpt3').value = "";
      document.getElementById('battleOpt4').value = "";
      document.getElementById('battleCorrectOpt').value = "";

      const pubBtn = document.getElementById('publishBattleBtn');
      if (pubBtn) {
        pubBtn.innerText = "PUBLISH BATTLE";
        pubBtn.style.background = "#ff4757";
        pubBtn.style.color = "white";
        pubBtn.onclick = () => publishBattle();
      }
    }

    function deleteBattle(id) {
      if (!confirm("Are you sure you want to permanently delete this battle? This will also remove results.")) return;
      database.ref('battles/active/' + id).remove().then(() => {
        return database.ref('battleBookings/approved/' + id).remove();
      }).then(() => {
        return database.ref('battleBookings/pending/' + id).remove();
      }).then(() => {
        return database.ref('battleResults/' + id).remove();
      }).then(() => {
        alert("Battle and all related data removed successfully.");
      });
    }

    function loadAdminBattleBookings() {
      let tbody = document.getElementById('battleBookingTableBody');
      if (!tbody) return;
      database.ref('battleBookings/pending').on('value', snap => {
        tbody.innerHTML = "";
        let data = snap.val();
        if (!data) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:15px;">No pending bookings.</td></tr>';
          return;
        }
        for (let battleId in data) {
          for (let userMob in data[battleId]) {
            let req = data[battleId][userMob];
            let tr = document.createElement('tr');
            tr.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
            tr.innerHTML = `
              <td style="padding:10px;">${req.mobile}<br><small>${userMob}</small></td>
              <td style="padding:10px;">${req.battleTitle}</td>
              <td style="padding:10px;"><button class="login-btn" onclick="viewBattleProof('${req.proof}')" style="margin:0; padding:4px 8px; font-size:11px;">ðŸ–¼ï¸ View</button></td>
              <td style="padding:10px;">
                <button onclick="approveBattleBooking('${battleId}', '${userMob}')" style="background:#2ecc71; color:white; border:none; padding:4px 8px; border-radius:4px; font-size:11px;">APPROVE</button>
              </td>
            `;
            tbody.appendChild(tr);
          }
        }
      });
    }

    function viewBattleProof(src) {
      let w = window.open("");
      w.document.write(`<img src="${src}" style="max-width:100%;">`);
    }

    function approveBattleBooking(battleId, userMob) {
      if (!confirm("Approve this booking?")) return;
      database.ref(`battleBookings/pending/${battleId}/${userMob}`).once('value').then(snap => {
        let req = snap.val();
        database.ref(`battleBookings/approved/${battleId}/${userMob}`).set(req).then(() => {
          database.ref(`battleBookings/pending/${battleId}/${userMob}`).remove();
          database.ref(`battles/active/${battleId}/joinedCount`).transaction(c => (c || 0) + 1);
          alert("Booking Approved! Student is now in the battle.");
        });
      });
    }

    function publishBattle() {
      let course = document.getElementById('battleCourse').value;
      let subject = document.getElementById('battleSubject').value;
      let chapter = document.getElementById('battleChapter').value;
      let entryFee = document.getElementById('battleEntryFee').value;
      let prize = document.getElementById('battlePrizePool').value;
      let startTime = document.getElementById('battleStartTime').value;
      let maxStudents = document.getElementById('battleMaxStudents').value;
      let duration = document.getElementById('battleDuration').value;
      let upi = document.getElementById('battleUPI').value.trim();
      let qrFile = document.getElementById('battleQRInput').files[0];

      let title = document.getElementById('battleTitle').value.trim();
      if (!title) title = chapter === "ALL" ? `${subject} Mega Combat` : `${chapter} Tactical Battle`;

      if (!course || !subject || !entryFee || !prize || !startTime || !maxStudents || !duration || currentBattleQuestions.length === 0) {
        alert("Complete battle setup first! (Don't forget Duration, questions & max students)"); return;
      }

      if (parseInt(entryFee) < 0 || parseInt(maxStudents) <= 0 || parseInt(duration) <= 0) {
        alert("Please enter valid numeric values for Entry Fee, Max Students, and Duration.");
        return;
      }

      const uploadBattle = (qrBase64 = null) => {
        let battleId = "BTL_" + Date.now();

        let battleObj = {
          title,
          course, subject, chapter,
          entryFee: parseInt(entryFee),
          prize: parseInt(prize),
          startTime,
          upi,
          duration: parseInt(duration),
          qr: qrBase64,
          maxStudents: parseInt(maxStudents),
          joinedCount: 0,
          questions: currentBattleQuestions,
          type: chapter === "ALL" ? "Subject" : "Chapter",
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        database.ref('battles/active/' + battleId).set(battleObj).then(() => {
          alert("BATTLE ARENA LIVE!");
          resetBattleForm();
        });
      };

      if (qrFile) {
        let reader = new FileReader();
        reader.onload = (e) => uploadBattle(e.target.result);
        reader.readAsDataURL(qrFile);
      } else {
        uploadBattle();
      }
    }

    function goBackToPrograms() {
      document.getElementById("programsWrapper").style.display = "block";
      document.getElementById("semesterMotivationSection").style.display = "none";
      // Show About & Terms section when returning to main programs view
      var infoSec = document.querySelector(".info-section");
      if (infoSec) infoSec.style.display = "block";
    }

    let studentNavState = { course: "", branch: "", sem: "", subject: "" };
    let currentNavLevel = "programs"; // programs -> branches -> semesters -> subjects -> chapters

    function openStudentLevel(level, selection, pushHistory = true) {
      document.getElementById("programsWrapper").style.display = "none";
      // Hide About & Terms section when navigating into course content
      var infoSec = document.querySelector(".info-section");
      if (infoSec) infoSec.style.display = "none";
      document.getElementById("dynamicNavSection").style.display = "block";

      if (pushHistory) {
        history.pushState({
          pageId: "dynamicNavSection",
          navContext: { type: 'level', level: level, selection: selection, state: studentNavState }
        }, "", "#" + level + "-" + selection.replace(/\s+/g, '-'));
      }

      if (level === 'semester') {
        document.getElementById("semesterMotivationSection").style.display = "block";
      } else {
        document.getElementById("semesterMotivationSection").style.display = "none";
      }

      let container = document.getElementById("dynamicNavContainer");
      let html = "";

      if (level === 'course') {
        studentNavState.course = selection;
        currentNavLevel = 'branches';
        let branches = data[selection];
        for (let br in branches) {
          html += `<div class="box" onclick="openStudentLevel('branch', '${br}')">ðŸ›ï¸ ${br}</div>`;
        }
      }
      else if (level === 'branch') {
        studentNavState.branch = selection;
        currentNavLevel = 'semesters';
        let sems = data[studentNavState.course][selection];
        for (let s in sems) {
          if (s === "_initialized") continue;
          html += `<div class="box" onclick="openStudentLevel('semester', '${s}')">ðŸ“… Semester ${s}</div>`;
        }
        renderProgressDashboard(); // Show analytics on semester selection page
      }
      else if (level === 'semester') {
        studentNavState.sem = selection;
        currentNavLevel = 'subjects';
        let subs = data[studentNavState.course][studentNavState.branch][selection];
        for (let su in subs) {
          if (su === "_initialized") continue;
          html += `<div class="box" onclick="openStudentLevel('subject', '${su}')">ðŸ“˜ ${su}</div>`;
        }
      }
      else if (level === 'subject') {
        studentNavState.subject = selection;
        document.getElementById("dynamicNavSection").style.display = "none";
        document.getElementById("chapters").style.display = "block";

        let chapters = data[studentNavState.course][studentNavState.branch][studentNavState.sem][selection];
        let chList = document.getElementById("chapterList");
        chList.innerHTML = "";
        document.getElementById("subjectTitle").innerText = `ðŸ“š ${selection}`;

        for (let ch in chapters) {
          if (ch === "_initialized") continue;
          let prog = getProgress(ch);
          let li = document.createElement("li");
          li.innerHTML = `
            <div style="flex:1;">
              <strong>${ch}</strong>
              <div class="progress-bar-small" style="background: rgba(255,255,255,0.1); border-radius: 5px; height: 6px; margin-top: 5px; width: 80%;">
                <div style="background: #00e676; width: ${prog}%; height: 100%; border-radius: 5px; transition: width 0.3s;"></div>
              </div>
            </div>
            <button class="login-btn" onclick="openStudentChapter('${ch}')" style="margin:0; padding: 5px 15px; width:auto; font-size: 14px; margin-left:15px;">Open</button>
          `;
          chList.appendChild(li);
        }
      }
      if (level !== 'subject') {
        container.innerHTML = html;
      }
      saveNavState();
    }

    function goBackDynamicNav() {
      if (currentNavLevel === 'branches') {
        document.getElementById("dynamicNavSection").style.display = "none";
        document.getElementById("programsWrapper").style.display = "block";
        // Show About & Terms section when returning to main dashboard
        var infoSec = document.querySelector(".info-section");
        if (infoSec) infoSec.style.display = "block";
        currentNavLevel = 'programs';
      } else if (currentNavLevel === 'semesters') {
        openStudentLevel('course', studentNavState.course);
      } else if (currentNavLevel === 'subjects') {
        openStudentLevel('branch', studentNavState.branch);
      }
      saveNavState();
    }

    function goBackToSubjects() {
      document.getElementById("chapters").style.display = "none";
      openStudentLevel('semester', studentNavState.sem);
      saveNavState();
    }

    function openStudentChapter(ch, pushHistory = true) {
      if (pushHistory) {
        history.pushState({
          pageId: "content",
          navContext: { type: 'chapter', selection: ch, state: studentNavState }
        }, "", "#chapter-" + ch.replace(/\s+/g, '-'));
      }
      studentNavState.chapter = ch;
      document.getElementById("chapters").style.display = "none";
      document.getElementById("content").style.display = "block";

      document.getElementById("chapterTitle").innerText = ch;
      saveNavState();

      let c = studentNavState.course;
      let b = studentNavState.branch;
      let sem = studentNavState.sem;
      let sub = studentNavState.subject;
      let chapterData = data[c][b][sem][sub][ch];

      // Helper to uniformly process arrays or fallback legacy strings
      const getArray = (val) => {
        if (!val) return [];
        if (Array.isArray(val)) return val;
        if (typeof val === "string") return val.split('\n').filter(v => v.trim() !== "");
        return [];
      };

      // Format Multi-line Text blocks with Line Breaks cleanly
      const formatTextBlocks = (arr) => arr.map(t => t ? t.replace(/\n/g, '<br>') : "").join('<br><br>');

      // Render Multiple Videos
      let vContainer = document.getElementById("videoContainer");
      vContainer.innerHTML = "";
      let videoArr = getArray(chapterData.video);

      if (videoArr.length > 0) {
        videoArr.forEach((v, idx) => {
          let wrapper = document.createElement("div");
          let iframe = document.createElement("iframe");
          iframe.width = "560";
          iframe.height = "315";
          iframe.frameBorder = "0";
          iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture";
          iframe.allowFullscreen = true;
          iframe.style.maxWidth = "100%";
          iframe.src = v;
          wrapper.appendChild(iframe);

          // Auto-mark as completed
          toggleProgress('video', idx, true);

          vContainer.appendChild(wrapper);
        });
        document.getElementById("videoSection").style.display = "block";
      } else {
        document.getElementById("videoSection").style.display = "none";
      }

      // Render Content Blocks
      const renderBlock = (arr, elementId, secId, type) => {
        let wrapper = document.getElementById(elementId);
        wrapper.innerHTML = "";
        if (arr.length > 0) {
          arr.forEach((text, idx) => {
            let pDiv = document.createElement("div");
            pDiv.innerHTML = formatTextBlocks([text]);
            // Auto-mark as completed
            toggleProgress(type, idx, true);
            pDiv.appendChild(document.createElement("hr"));
            wrapper.appendChild(pDiv);
          });
          document.getElementById(secId).style.display = "block";
        } else {
          document.getElementById(secId).style.display = "none";
        }
      };

      renderBlock(getArray(chapterData.assignment), "assignmentText", "assignmentSection", "assignment");
      renderBlock(getArray(chapterData.homework), "homeworkText", "homeworkSection", "homework");

      let notesArr = getArray(chapterData.notes);
      document.getElementById("notesText").innerHTML = formatTextBlocks(notesArr);

      // Render Multiple PDFs
      let pContainer = document.getElementById("pdfContainer");
      pContainer.innerHTML = "";
      let pdfArr = getArray(chapterData.pdf);

      if (pdfArr.length > 0) {
        document.getElementById("pdfSection").classList.add('book-opening');
        pdfArr.forEach((pUrl, idx) => {
          let fileId = pUrl.match(/\/d\/(.*?)\//)?.[1];
          if (fileId) {
            let wrapper = document.createElement("div");
            wrapper.style.position = "relative"; // Key for absolute overlay

            let iframe = document.createElement("iframe");
            iframe.width = "100%";
            iframe.height = "500";
            iframe.frameBorder = "0";
            iframe.style.borderRadius = "8px";
            // Prevent pop-ups to block opening in a new tab for download
            iframe.setAttribute("sandbox", "allow-scripts allow-same-origin");
            iframe.src = "https://drive.google.com/file/d/" + fileId + "/preview?rm=minimal#toolbar=0";
            wrapper.appendChild(iframe);

            // Block clicks on the top-right toolbar (Google Drive action buttons)
            let securityOverlay = document.createElement("div");
            securityOverlay.style.position = "absolute";
            securityOverlay.style.top = "0";
            securityOverlay.style.left = "0";
            securityOverlay.style.width = "100%";
            securityOverlay.style.height = "60px"; // Size of the top header toolbar
            securityOverlay.style.background = "transparent";
            securityOverlay.style.zIndex = "10";
            securityOverlay.oncontextmenu = () => false; // Prevent right-click options in this zone
            wrapper.appendChild(securityOverlay);

            // Auto-mark as completed
            toggleProgress('pdf', idx, true);

            wrapper.style.marginBottom = "15px";
            pContainer.appendChild(wrapper);
          }
        });
        document.getElementById("pdfSection").style.display = pContainer.children.length > 0 ? "block" : "none";

        // Remove animation after play to avoid issues on re-renders
        setTimeout(() => {
          document.getElementById("pdfSection").classList.remove('book-opening');
        }, 1500);
      } else {
        document.getElementById("pdfSection").style.display = "none";
      }
    }

    function goBack() {
      document.getElementById("chapters").style.display = "none";
      document.getElementById("subjects").style.display = "grid";
    }

    function goBackChapter() {
      document.getElementById("content").style.display = "none";
      document.getElementById("chapters").style.display = "block";
      saveNavState();
    }

    function toggleTask(checkbox) {
      let taskItem = checkbox.parentElement;
      if (checkbox.checked) {
        taskItem.classList.add("completed");
      } else {
        taskItem.classList.remove("completed");
      }
    }

    function toggleMode() {
      document.body.classList.toggle("light");
      let btn = document.getElementById("themeToggleBtn");
      if (document.body.classList.contains("light")) {
        btn.innerText = "ðŸŒ™";
      } else {
        btn.innerText = "â˜€ï¸";
      }
    }

    function searchChapter(val) {
      let items = document.querySelectorAll("li");
      items.forEach(i => {
        i.style.display = i.innerText.toLowerCase().includes(val.toLowerCase()) ? "block" : "none";
      });
    }

    // --- GEMINI AI TUTOR LOGIC ---
    // PASTE YOUR NEW GEMINI API KEY HERE (Line 3376)
    const NEXTGEN_AI = "AIzaSyD5h0roGpYOMskKeB2lCLDqjGyase42DZ0";

    function toggleChat() {
      let chatBox = document.getElementById("aiChatBox");
      if (chatBox.style.display === "none" || chatBox.style.display === "") {
        chatBox.style.display = "flex";
      } else {
        chatBox.style.display = "none";
      }
    }

    async function sendChatMessage() {
      let inputField = document.getElementById("aiChatInput");
      let message = inputField.value.trim();
      if (!message) return;

      let chatHistory = document.getElementById("aiChatHistory");

      // Add user message
      let userBubble = document.createElement("div");
      userBubble.style.cssText = "align-self: flex-end; background: cyan; color: black; padding: 10px 14px; border-radius: 12px; border-bottom-right-radius: 0; max-width: 85%; font-weight: 500; font-size: 14px;";
      userBubble.innerText = message;
      chatHistory.appendChild(userBubble);
      inputField.value = "";

      // Scroll to bottom
      chatHistory.scrollTop = chatHistory.scrollHeight;

      // Add loading state
      let loadingBubble = document.createElement("div");
      loadingBubble.style.cssText = "align-self: flex-start; background: rgba(0, 255, 255, 0.1); padding: 10px 14px; border-radius: 12px; border-bottom-left-radius: 0; max-width: 85%; border: 1px solid rgba(0, 255, 255, 0.3); font-style: italic; color: cyan; font-size: 14px;";
      loadingBubble.innerText = "Thinking...";
      chatHistory.appendChild(loadingBubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;

      if (!NEXTGEN_AI) {
        setTimeout(() => {
          chatHistory.removeChild(loadingBubble);
          addAiResponse("âš ï¸ **API Key is missing!** <br><br>Developer needs to paste the Gemini API Key into the JavaScript code (`const NEXTGEN_AI = 'YOUR_KEY_HERE'; `) for me to connect to the internet and answer your questions.");
        }, 1500);
        return;
      }

      // Call Gemini API
      try {
        let response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${NEXTGEN_AI}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            contents: [{ parts: [{ text: "You are a helpful AI tutor for a college student. Keep your answers concise, educational, formatted nicely with markdown if needed, and easy to understand. Student's query: " + message }] }]
          })
        });

        let data = await response.json();
        chatHistory.removeChild(loadingBubble);

        if (data.candidates && data.candidates.length > 0) {
          let aiText = data.candidates[0].content.parts[0].text;
          addAiResponse(aiText);
        } else if (data.error) {
          addAiResponse("âš ï¸ API Error: " + data.error.message);
        } else {
          addAiResponse("Sorry, I couldn't generate a response. Please try again.");
        }
      } catch (error) {
        chatHistory.removeChild(loadingBubble);
        addAiResponse("Oops! A network error occurred while connecting to my brain. Please check your internet connection.");
      }
    }

    function addAiResponse(text) {
      let chatHistory = document.getElementById("aiChatHistory");
      let aiBubble = document.createElement("div");
      aiBubble.style.cssText = "align-self: flex-start; background: rgba(0, 255, 255, 0.1); padding: 10px 14px; border-radius: 12px; border-bottom-left-radius: 0; max-width: 85%; border: 1px solid rgba(0, 255, 255, 0.3); color: white; font-size: 14px; line-height: 1.5;";

      // Convert basic markdown to HTML for better readability
      text = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
      text = text.replace(/\*(.*?)\*/g, '<i>$1</i>');
      text = text.replace(/\n/g, '<br>');

      aiBubble.innerHTML = text;
      chatHistory.appendChild(aiBubble);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function previewWalletQR(event) {
      let file = event.target.files[0];
      if (file) {
        let reader = new FileReader();
        reader.onload = function (e) {
          let img = new Image();
          img.onload = function () {
            let canvas = document.createElement("canvas");
            let MAX_WIDTH = 400;
            let MAX_HEIGHT = 400;
            let width = img.width;
            let height = img.height;

            if (width > height) {
              if (width > MAX_WIDTH) {
                height *= MAX_WIDTH / width;
                width = MAX_WIDTH;
              }
            } else {
              if (height > MAX_HEIGHT) {
                width *= MAX_HEIGHT / height;
                height = MAX_HEIGHT;
              }
            }

            canvas.width = width;
            canvas.height = height;
            let ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);

            let preview = document.getElementById("walletQRPreview");
            preview.src = canvas.toDataURL("image/jpeg", 0.6); // Compress aggressively
            preview.style.display = "block";
          };
          img.src = e.target.result;
        }
        reader.readAsDataURL(file);
      }
    }



    function saveWalletConfig() {
      let preview = document.getElementById("walletQRPreview");
      let qrBase64 = preview.src && preview.style.display !== "none" ? preview.src : "";

      let upi = document.getElementById("walletUPI").value.trim();

      let payload = {
        qr: qrBase64,
        upi
      };

      database.ref('walletConfig').set(payload).then(() => {
        localStorage.setItem("walletConfig", JSON.stringify(payload));
        alert("âœ… Wallet Recharge Settings saved successfully!");
      }).catch(err => {
        console.error(err);
        alert("âŒ Failed to save! Your QR image might still be too large. Please upload an image under 1MB.");
      });
    }

    /* PREMIUM NOTES & BOOK LOGIC */
    let selectedPremiumItem = "";

    function openPremiumHub() {
      let config = globalSiteConfig;
      if (config.premiumEnabled === false) {
        alert("Premium features are currently disabled by Admin.");
        return;
      }
      document.getElementById("programsWrapper").style.display = "none";
      document.getElementById("semesterMotivationSection").style.display = "none";
      // Hide info-section (About & Terms) when premium hub opens
      var infoSec = document.querySelector(".info-section");
      if (infoSec) infoSec.style.display = "none";
      document.getElementById("premiumNavSection").style.display = "block";
      document.getElementById("premiumCoursesContainer").style.display = "grid";
      document.getElementById("premiumOptionsContainer").style.display = "none";
    }

    function goBackFromPremium() {
      if (document.getElementById("premiumContentContainer").style.display === "block") {
        document.getElementById("premiumContentContainer").style.display = "none";
        document.getElementById("premiumOptionsContainer").style.display = "grid";
      } else if (document.getElementById("premiumOptionsContainer").style.display === "grid") {
        document.getElementById("premiumOptionsContainer").style.display = "none";
        document.getElementById("premiumCoursesContainer").style.display = "grid";
      } else {
        document.getElementById("premiumNavSection").style.display = "none";
        document.getElementById("programsWrapper").style.display = "block";
        // Show info-section (About & Terms) when returning to main dashboard
        var infoSec = document.querySelector(".info-section");
        if (infoSec) infoSec.style.display = "block";
      }
    }

    function goBackToPremiumOptions() {
      document.getElementById("premiumContentContainer").style.display = "none";
      document.getElementById("premiumOptionsContainer").style.display = "grid";
    }

    function showPremiumOptions(course) {
      document.getElementById("premiumCoursesContainer").style.display = "none";
      document.getElementById("premiumContentContainer").style.display = "none"; // Hide content if any
      let container = document.getElementById("premiumOptionsContainer");
      container.style.display = "grid";
      container.innerHTML = "<p style='color:cyan; grid-column:1/-1;'>Loading premium items...</p>";

      let optionsObj = premiumData[course] || {};
      let options = Object.keys(optionsObj);

      if (options.length === 0) {
        container.innerHTML = "<p style='color:#ccc; grid-column:1/-1;'>No premium options available for this course yet.</p>";
        return;
      }

      database.ref('users/' + currentUserMobile).once('value').then(snap => {
        let stObj = snap.val() || {};
        if (!stObj.premiumUnlocked) stObj.premiumUnlocked = {};

        container.innerHTML = "";
        options.forEach(opt => {
          let itemKey = course + "_" + opt;

          let isUnlocked = false;
          let unlockData = stObj.premiumUnlocked[itemKey];
          if (unlockData) {
            if (typeof unlockData === 'object' && unlockData.active) {
              if (unlockData.expiresAt && Date.now() > unlockData.expiresAt) {
                isUnlocked = false; // Expired
              } else {
                isUnlocked = true;
              }
            } else if (unlockData === true) {
              isUnlocked = true; // Legacy
            }
          }

          let classes = "box premium-box ";
          let icon = isUnlocked ? "ðŸ”“" : "ðŸ”’";
          if (!isUnlocked) classes += "locked-option";

          container.innerHTML += `<div class="${classes}" onclick="handlePremiumClick('${course}', '${opt}', ${isUnlocked ? 'true' : 'false'})">
            <h2>${icon} ${opt}</h2>
          </div>`;
        });
      });
    }

    function handlePremiumClick(course, option, isUnlocked) {
      let itemKey = course + "_" + option;
      if (isUnlocked) {
        showPremiumContent(course, option);
      } else {
        selectedPremiumItem = itemKey;

        // Retrieve the configuration from premiumPrices
        let conf = (premiumPrices && premiumPrices[itemKey]) ? premiumPrices[itemKey] : { price: 49, duration: 365 };
        let activeAmount = parseFloat(conf.price || 49);
        let activeDuration = parseInt(conf.duration || 365);

        if (confirm(`Unlock "${option}" for ${activeAmount} Gold Coins?\n\nValidity: ${activeDuration} Days\n(1 Gold Coin = â‚¹1)`)) {
          database.ref('users/' + currentUserMobile + '/profile/wallet').once('value').then(snap => {
            let balance = parseFloat(snap.val() || 0);
            if (balance >= activeAmount) {
              // Deduct and unlock
              database.ref('users/' + currentUserMobile + '/profile/wallet').set(balance - activeAmount).then(() => {
                let expiry = Date.now() + (activeDuration * 24 * 60 * 60 * 1000);
                let payload = { active: true, expiresAt: expiry };
                return database.ref(`users/${currentUserMobile}/premiumUnlocked/${itemKey}`).set(payload);
              }).then(() => {
                showCongratulations(
                  'UNLOCKED!',
                  `<b>${option}</b> is now available!`,
                  `Full access granted for ${activeDuration} days. Happy learning!`,
                  'START LEARNING'
                );
                showPremiumOptions(course); // Refresh UI to show it's unlocked
                updateWalletDisplay(); // Update wallet UI if visible
              }).catch(err => {
                console.error(err);
                alert("âŒ Failed to unlock due to a network error.");
              });
            } else {
              alert(`âŒ INSUFFICIENT BALANCE!\n\nYou currently have ${balance} Gold Coins, but "${option}" costs ${activeAmount} Gold Coins.\n\nTo continue, please recharge your NEURAL WALLET by clicking 'âž• RECHARGE' in the header.`);
              topUpWallet();
            }
          });
        }
      }
    }

    function showPremiumContent(course, option) {
      document.getElementById("premiumOptionsContainer").style.display = "none";
      let pContainer = document.getElementById("premiumContentContainer");
      pContainer.style.display = "block";

      document.getElementById("activePremiumOptionTitle").innerHTML = `ðŸ’Ž ${course} - ${option}`;

      let grid = document.getElementById("premiumPdfsGrid");
      grid.innerHTML = "";

      let pdfs = premiumData[course][option] || [];

      if (pdfs.length === 0) {
        grid.innerHTML = "<p style='color:#ccc;'>No PDFs available in this section yet.</p>";
        return;
      }

      pdfs.forEach(pdf => {
        let box = document.createElement("div");
        box.style.cssText = "background: rgba(255, 255, 255, 0.05); border: 1px solid cyan; border-radius: 10px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; box-shadow: 0 0 10px rgba(0,255,255,0.1);";
        box.innerHTML = `<h1 style="margin:0 0 10px 0; font-size:40px; text-shadow: 0 0 10px gold;">ðŸ“„</h1>
                         <h3 style="margin:0; color:white;">${pdf.title}</h3>`;
        box.onmouseenter = () => box.style.transform = "scale(1.05)";
        box.onmouseleave = () => box.style.transform = "scale(1)";
        box.onclick = () => window.open(pdf.link, "_blank");
        grid.appendChild(box);
      });
    }



    /* MOTIVATION ROTATION */
    /* MOTIVATION ROTATION */
    const motivations = [
      // Bhagavad Gita / Mahabharata
      "\"Karmanye Vadhikaraste, Ma Phaleshu Kadachana. (You have a right to perform your prescribed duty, but you are not entitled to the fruits of action.)\" - Bhagavad Gita",
      "\"A person can rise through the efforts of his own mind; or draw himself down, in the same manner. Because each person is his own friend or enemy.\" - Bhagavad Gita",
      "\"Whatever happened, happened for the good. Whatever is happening, is happening for the good. Whatever will happen, will also happen for the good.\" - Mahabharata",
      "\"There is neither this world nor the world beyond nor happiness for the one who doubts.\" - Bhagavad Gita",
      "\"No one who does good work will ever come to a bad end, either here or in the world to come.\" - Bhagavad Gita",
      "\"You are what you believe in. You become that which you believe you can become.\" - Bhagavad Gita",
      "\"Change is the law of the universe. You can be a millionaire, or a pauper in an instant.\" - Bhagavad Gita",
      "\"The power of God is with you at all times; through the activities of mind, senses, breathing, and emotions; and is constantly doing all the work using you as a mere instrument.\" - Bhagavad Gita",
      "\"When meditation is mastered, the mind is unwavering like the flame of a lamp in a windless place.\" - Bhagavad Gita",
      "\"We are kept from our goal not by obstacles, but by a clear path to a lesser goal.\" - Mahabharata Teachings",

      // Ramayana & Epics
      "\"Truth, righteousness, and morality will always triumph over evil and deception.\" - Valmiki Ramayana",
      "\"Only the timid and the weak leave things to destiny (Daivam), but the strong and the self-reliant never fold their hands to destiny.\" - Lakshmana (Ramayana)",
      "\"There is no deity powerful as time.\" - Valmiki Ramayana",
      "\"Grief destroys one's courage. It destroys one's learning. There is no enemy greater than grief.\" - Shri Rama (Ramayana)",
      "\"Even if a person is weak, if he has the courage and the will, he can defeat the strongest of enemies.\" - Ramayana",

      // Swami Vivekananda & Spiritual Leaders
      "\"Arise, awake, and stop not till the goal is reached.\" - Swami Vivekananda",
      "\"Take up one idea. Make that one idea your life - think of it, dream of it, live on that idea.\" - Swami Vivekananda",
      "\"You cannot believe in God until you believe in yourself.\" - Swami Vivekananda",
      "\"Truth can be stated in a thousand different ways, yet each one can be true.\" - Swami Vivekananda",
      "\"In a day, when you don't come across any problems - you can be sure that you are travelling in a wrong path.\" - Swami Vivekananda",
      "\"There is no limit to the power of the human mind. The more concentrated it is, the more power is brought to bear on one point.\" - Swami Vivekananda",
      "\"Do not dwell in the past, do not dream of the future, concentrate the mind on the present moment.\" - Gautama Buddha",
      "\"The mind is everything. What you think you become.\" - Gautama Buddha",
      "\"Your work is to discover your work and then with all your heart to give yourself to it.\" - Gautama Buddha",

      // Scientists & Modern Leaders (APJ Abdul Kalam, etc.)
      "\"Dream, dream, dream. Dreams transform into thoughts and thoughts result in action.\" - Dr. A.P.J. Abdul Kalam",
      "\"If you want to shine like a sun, first burn like a sun.\" - Dr. A.P.J. Abdul Kalam",
      "\"To succeed in your mission, you must have single-minded devotion to your goal.\" - Dr. A.P.J. Abdul Kalam",
      "\"You have to dream before your dreams can come true.\" - Dr. A.P.J. Abdul Kalam",
      "\"Man needs difficulties in life because they are necessary to enjoy success.\" - Dr. A.P.J. Abdul Kalam",
      "\"Be active! Take on responsibility! Work for the things you believe in. If you do not, you are surrendering your fate to others.\" - Dr. A.P.J. Abdul Kalam",
      "\"Excellence is a continuous process and not an accident.\" - Dr. A.P.J. Abdul Kalam",
      "\"Science is a beautiful gift to humanity; we should not distort it.\" - Dr. A.P.J. Abdul Kalam",
      "\"I can't change the direction of the wind, but I can adjust my sails to always reach my destination.\" - Jimmy Dean",
      "\"First they ignore you, then they laugh at you, then they fight you, then you win.\" - Mahatma Gandhi",
      "\"Live as if you were to die tomorrow. Learn as if you were to live forever.\" - Mahatma Gandhi",
      "\"The future depends on what you do today.\" - Mahatma Gandhi",
      "\"Strength does not come from physical capacity. It comes from an indomitable will.\" - Mahatma Gandhi",
      "\"Let new India arise out of peasants' cottage, grasping the plough, out of huts, cobbler and sweeper.\" - Netaji Subhas Chandra Bose",
      "\"One individual may die for an idea, but that idea will, after his death, incarnate itself in a thousand lives.\" - Netaji Subhas Chandra Bose",
      "\"Freedom is not given, it is taken.\" - Netaji Subhas Chandra Bose",

      // Chanakya (Vishnugupta)
      "\"Education is the best friend. An educated person is respected everywhere. Education beats the beauty and the youth.\" - Chanakya",
      "\"A man is born alone and dies alone; and he experiences the good and bad consequences of his karma alone; and he goes alone to hell or the Supreme abode.\" - Chanakya",
      "\"Learn from the mistakes of others... you can't live long enough to make them all yourselves.\" - Chanakya",
      "\"As soon as the fear approaches near, attack and destroy it.\" - Chanakya",
      "\"There is no present and future of the lazy.\" - Chanakya",
      "\"Even if a snake is not poisonous, it should pretend to be venomous.\" - Chanakya",

      // IAS / IPS / Civil Services Aspirant Motivation
      "\"A dream does not become reality through magic; it takes sweat, determination, and hard work.\" - Colin Powell (UPSC Ethos)",
      "\"The rougher the seas, the smoother we sail. Ahoy!\" - Indian Navy / Armed forces ethos",
      "\"Kadi mehnat, pakka iraada, aur khud par vishwas â€“ yahi ekmatra rasta hai safalta ka.\" - UPSC Aspirant's Mantra",
      "\"When you feel like quitting, remember why you started.\" - IAS Training Ethos",
      "\"Itâ€™s not about how many hours you study, itâ€™s about how much you study in those hours.\" - Civil Services Motivation",
      "\"Service before Self.\" - NDA/Defense Motto",
      "\"No matter how tough the grind, the steel is forged only in the hottest fire.\" - IPS Training Academy (SVPNPA)",
      "\"Hard work beats talent when talent doesn't work hard.\" - Tim Notke (Student Ethos)",
      "\"Push yourself, because no one else is going to do it for you.\" - Student Motivation",
      "\"Success doesnâ€™t just find you. You have to go out and get it.\" - General Motivation",
      "\"The harder you work for something, the greater youâ€™ll feel when you achieve it.\" - General Motivation",
      "\"Donâ€™t stop when youâ€™re tired. Stop when youâ€™re done.\" - General Motivation",
      "\"Wake up with determination. Go to bed with satisfaction.\" - Student Ethos",
      "\"Do something today that your future self will thank you for.\" - General Motivation"
    ];

    let currentMotivationIndex = 0;
    // Set random initial tip to feel dynamic on reload
    currentMotivationIndex = Math.floor(Math.random() * motivations.length);
    document.getElementById("motivationText").innerText = motivations[currentMotivationIndex];

    setInterval(() => {
      currentMotivationIndex = (currentMotivationIndex + 1) % motivations.length;
      document.getElementById("motivationText").innerText = motivations[currentMotivationIndex];
    }, 60000); // 60,000 ms = 1 minute


    /* ADVANCED VFX: INTERACTIVE PARTICLE ENGINE */
    const canvas = document.getElementById('vfx-canvas');
    const ctx = canvas.getContext('2d');
    let particles = [];
    let mouse = { x: null, y: null, radius: 150 };

    window.addEventListener('mousemove', (e) => {
      mouse.x = e.x;
      mouse.y = e.y;
    });

    window.addEventListener('touchmove', (e) => {
      if (e.touches.length > 0) {
        mouse.x = e.touches[0].clientX;
        mouse.y = e.touches[0].clientY;
      }
    });

    window.addEventListener('touchstart', (e) => {
      if (e.touches.length > 0) {
        mouse.x = e.touches[0].clientX;
        mouse.y = e.touches[0].clientY;
      }
    });

    window.addEventListener('touchend', () => {
      mouse.x = null;
      mouse.y = null;
    });

    function initParticles() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      particles = [];
      let numberOfParticles = (canvas.width * canvas.height) / 9000;
      for (let i = 0; i < numberOfParticles; i++) {
        let size = Math.random() * 2 + 1;
        let x = Math.random() * canvas.width;
        let y = Math.random() * canvas.height;
        let directionX = (Math.random() * 0.4) - 0.2;
        let directionY = (Math.random() * 0.4) - 0.2;
        let color = 'rgba(0, 242, 254, 1)';
        particles.push(new Particle(x, y, directionX, directionY, size, color));
      }
    }

    class Particle {
      constructor(x, y, dx, dy, size, color) {
        this.x = x;
        this.y = y;
        this.dx = dx;
        this.dy = dy;
        this.size = size;
        this.color = color;
      }
      draw() {
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2, false);
        ctx.fillStyle = 'rgba(0, 242, 254, 0.8)';
        ctx.fill();
      }
      update() {
        if (this.x > canvas.width || this.x < 0) this.dx = -this.dx;
        if (this.y > canvas.height || this.y < 0) this.dy = -this.dy;

        // Mouse collision
        let dx = mouse.x - this.x;
        let dy = mouse.y - this.y;
        let distance = Math.sqrt(dx * dx + dy * dy);
        if (distance < mouse.radius) {
          if (mouse.x < this.x && this.x < canvas.width - this.size * 10) this.x += 3;
          if (mouse.x > this.x && this.x > this.size * 10) this.x -= 3;
          if (mouse.y < this.y && this.y < canvas.height - this.size * 10) this.y += 3;
          if (mouse.y > this.y && this.y > this.size * 10) this.y -= 3;
        }

        this.x += this.dx;
        this.y += this.dy;
        this.draw();
      }
    }

    function connect() {
      let opacityValue = 1;
      for (let a = 0; a < particles.length; a++) {
        for (let b = a; b < particles.length; b++) {
          let distance = ((particles[a].x - particles[b].x) * (particles[a].x - particles[b].x)) +
            ((particles[a].y - particles[b].y) * (particles[a].y - particles[b].y));
          if (distance < (canvas.width / 7) * (canvas.height / 7)) {
            opacityValue = 1 - (distance / 20000);
            ctx.strokeStyle = `rgba(0, 242, 254, ${opacityValue})`;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(particles[a].x, particles[a].y);
            ctx.lineTo(particles[b].x, particles[b].y);
            ctx.stroke();
          }
        }
      }
    }

    function animateParticles() {
      requestAnimationFrame(animateParticles);
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < particles.length; i++) {
        particles[i].update();
      }
      connect();
    }

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      initParticles();
    });

    initParticles();
    animateParticles();


    /* 3D TILT EFFECT LOGIC (Mouse & Touch) */
    function handleTilt(e, isTouch = false) {
      const target = isTouch ? e.touches[0].target : e.target;
      const box = target.closest('.box');
      if (!box) return;

      const clientX = isTouch ? e.touches[0].clientX : e.clientX;
      const clientY = isTouch ? e.touches[0].clientY : e.clientY;

      const rect = box.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;

      const centerX = rect.width / 2;
      const centerY = rect.height / 2;

      const percentX = (x - centerX) / centerX;
      const percentY = (y - centerY) / centerY;

      const rotateX = percentY * -15;
      const rotateY = percentX * 15;

      box.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-10px) scale(1.02)`;
      box.style.transition = 'none';
    }

    function resetTilt(e) {
      const box = e.target.closest('.box') || (e.target && e.target.style && e.target.style.transform ? e.target : null);
      if (!box || !box.classList.contains('box')) return;

      box.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) translateY(0) scale(1)`;
      box.style.transition = 'transform 0.5s ease';
    }

    document.addEventListener('mousemove', (e) => handleTilt(e));
    document.addEventListener('touchmove', (e) => handleTilt(e, true), { passive: true });

    document.addEventListener('mouseout', (e) => {
      const box = e.target.closest('.box');
      if (!box) return;
      if (e.relatedTarget && box.contains(e.relatedTarget)) return;
      resetTilt(e);
    });

    document.addEventListener('touchend', (e) => {
      // Small delay to let the eye catch the final tilt
      setTimeout(() => {
        const boxes = document.querySelectorAll('.box');
        boxes.forEach(b => {
          b.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) translateY(0) scale(1)`;
          b.style.transition = 'transform 0.5s ease';
        });
      }, 150);
    });


    /* GLOBAL SEARCH ALGORITHM */
    function searchLibrary() {
      const q = document.getElementById('globalSearchInput').value.toLowerCase().trim();
      const resBox = document.getElementById('searchResultsModal');

      if (!q) {
        resBox.style.display = 'none';
        resBox.innerHTML = '';
        return;
      }

      let matches = [];
      let maxResults = 15;

      // Deep scan the data object
      for (let course in data) {
        for (let branch in data[course]) {
          let sems = data[course][branch];
          for (let semNum in sems) {
            let subjects = sems[semNum];
            for (let subName in subjects) {

              // Keyword match in Subject Name
              if (subName.toLowerCase().includes(q)) {
                matches.push({ type: 'Subject', name: subName, course, branch, semNum, icon: 'ðŸ“–' });
              }

              let chapters = subjects[subName].chapters || [];
              chapters.forEach(ch => {
                // Keyword match in Chapter Content
                if (ch.name.toLowerCase().includes(q) || (ch.description && ch.description.toLowerCase().includes(q))) {
                  matches.push({
                    type: 'Chapter',
                    name: ch.name + ` <span style="font-size:10px;color:#aaa;">(${subName})</span>`,
                    cleanName: ch.name,
                    course, branch, semNum, subName,
                    icon: 'ðŸ“'
                  });
                }
              });
            }
          }
        }
      }

      if (matches.length === 0) {
        resBox.innerHTML = '<div style="padding:10px; text-align:center; color:#ff4757; font-size:13px;">No results found for "' + q + '"</div>';
      } else {
        let html = '';
        matches.slice(0, maxResults).forEach(m => {
          if (m.type === 'Chapter') {
            html += `<div style="padding: 10px; border-bottom: 1px solid rgba(0,255,255,0.1); cursor: pointer; transition: 0.3s; color: white; display:flex; align-items:center; gap:8px;" 
                        onmouseover="this.style.background='rgba(0,242,254,0.2)'" onmouseout="this.style.background='transparent'"
                        onclick="jumpToChapter('${m.course}', '${m.branch}', '${m.semNum}', '${m.subName}', \`${m.cleanName}\`)">
                        <span>${m.icon}</span> <div><div style="font-size:13px; font-weight:bold; color: cyan;">${m.name}</div><div style="font-size:10px; color:#aaa;">${m.course} > ${m.branch} > Sem ${m.semNum}</div></div>
                     </div>`;
          } else {
            html += `<div style="padding: 10px; border-bottom: 1px solid rgba(0,255,255,0.1); cursor: pointer; transition: 0.3s; color: white; display:flex; align-items:center; gap:8px;" 
                        onmouseover="this.style.background='rgba(0,242,254,0.2)'" onmouseout="this.style.background='transparent'"
                        onclick="jumpToSubject('${m.course}', '${m.branch}', '${m.semNum}', '${m.name}')">
                        <span>${m.icon}</span> <div><div style="font-size:13px; font-weight:bold; color: #38ef7d;">${m.name}</div><div style="font-size:10px; color:#aaa;">${m.course} > ${m.branch} > Sem ${m.semNum}</div></div>
                     </div>`;
          }
        });
        resBox.innerHTML = html;
      }
      resBox.style.display = 'block';
    }

    // Direct Navigation Helpers from Search
    function jumpToSubject(course, branch, semNum, subName) {
      document.getElementById('globalSearchInput').value = '';
      document.getElementById('searchResultsModal').style.display = 'none';

      // Re-hydrate the native state to let UI handle the jump
      studentNavState.course = course;
      studentNavState.branch = branch;
      studentNavState.sem = semNum;

      // Navigate to the semester view where subjects are listed
      openStudentLevel('semester', semNum);

      // Auto-trigger the subject selection
      setTimeout(() => {
        openStudentLevel('subject', subName);
        window.scrollTo(0, 0);
      }, 50);
    }

    function jumpToChapter(course, branch, semNum, subName, chapterName) {
      document.getElementById('globalSearchInput').value = '';
      document.getElementById('searchResultsModal').style.display = 'none';

      studentNavState.course = course;
      studentNavState.branch = branch;
      studentNavState.sem = semNum;
      studentNavState.subject = subName;

      // Open the Subject to see Chapter lists natively
      openStudentLevel('semester', semNum);
      setTimeout(() => {
        openStudentLevel('subject', subName);
        // Delay to allow UI mount, then hit actual chapter 
        setTimeout(() => {
          if (chapterName) {
            openStudentChapter(chapterName);
          }
        }, 50);
      }, 50);
    }

    // Hide Search on Outside Click
    document.addEventListener("click", function (evt) {
      let searchBox = document.getElementById("searchResultsModal");
      let searchInput = document.getElementById("globalSearchInput");
      if (searchBox && searchInput && !searchBox.contains(evt.target) && evt.target !== searchInput) {
        searchBox.style.display = "none";
      }
    });

  </script>

  <!-- BATTLE PAYMENT MODAL -->
  <div id="battlePaymentModal" class="modal" style="display: none; background: rgba(0,0,0,0.9); z-index: 20005;">
    <div class="modal-content"
      style="max-width: 450px; border: 1px solid #ff4757; background: #0a0a0a; position: relative;">
      <span class="close-btn" onclick="document.getElementById('battlePaymentModal').style.display='none'"
        style="position: absolute; right: 15px; top: 10px; color: #ff4757; cursor: pointer; font-size: 24px;">&times;</span>
      <h2 style="color: #ff4757; margin-top: 0; font-family: 'Outfit';">ðŸ›¡ï¸ Combat Entry Pre-booking</h2>
      <p style="color: #ccc; font-size: 14px; font-family: 'Outfit';">Scan QR below or use direct payment links to book
        your seat.</p>

      <div id="battleQRDisplay"
        style="text-align: center; margin: 20px 0; background: white; padding: 15px; border-radius: 10px; box-shadow: 0 0 20px rgba(255, 71, 87, 0.2);">
        <img id="battleQRImg" src="" style="max-width: 100%; height: auto; border: 2px solid #000;">
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
        <a id="linkGPay" href="#" class="login-btn"
          style="background: white; color: black; font-size: 12px; margin: 0; display: flex; align-items: center; justify-content: center; gap: 5px; height: 45px; text-decoration: none; border-radius: 8px;">
          <img src="https://www.gstatic.com/pay/pay_with_google_dark.png" height="20">
        </a>
        <a id="linkPhonePe" href="#" class="login-btn"
          style="background: #5f259f; color: white; font-size: 12px; margin: 0; display: flex; align-items: center; justify-content: center; gap: 5px; height: 45px; text-decoration: none; border-radius: 8px;">
          ðŸŸª PhonePe
        </a>
      </div>

      <div
        style="text-align: left; background: rgba(255, 71, 87, 0.05); padding: 20px; border-radius: 12px; border: 1px dashed #ff4757;">
        <label
          style="color: #ff4757; font-size: 13px; font-weight: bold; display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">Confirm
          Your Booking Proof:</label>
        <input type="text" id="battlePayMobile" class="login-input" placeholder="Your WhatsApp / Mobile Number"
          style="background: rgba(0,0,0,0.5); border: 1px solid rgba(255, 71, 87, 0.3);">
        <input type="file" id="battlePaySS" accept="image/*" class="login-input"
          style="padding: 10px; background: rgba(255, 71, 87, 0.1); border: 1px dashed #ff4757;">
        <button class="login-btn" id="btnSubmitBattlePay"
          style="background: linear-gradient(90deg, #ff4757, #ff6b81); color: white; margin-top: 15px; box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);">ðŸš€
          Submit Booking Proof</button>
      </div>
    </div>
  </div>

  <footer id="mainFooter" style="display:none;">
    <div class="footer-text">Â© 2026 <span class="footer-brand">NextGen Digital Library</span> | Designed & Developed by
      <span style="color: white; font-weight: bold;">Aditya Kumar</span>
    </div>
    <div class="social-links">
      <a href="https://www.linkedin.com/in/aditya-kumar-878b3b289" target="_blank" class="social-btn" title="LinkedIn">
        <svg viewBox="0 0 24 24">
          <path
            d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z" />
        </svg>
      </a>
      <a href="https://www.instagram.com/mr_insaan_kumar?igsh=MTh1MDVoOGpnZ2lneg==" target="_blank" class="social-btn"
        title="Instagram">
        <svg viewBox="0 0 24 24">
          <path
            d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849s-.011 3.585-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.584-.012-4.849-.07c-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849s.012-3.584.07-4.849c.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.667.072 4.947c.2 4.337 2.615 6.76 6.98 6.98 1.281.058 1.689.072 4.948.072s3.667-.014 4.947-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.2-4.337-2.617-6.761-6.98-6.98-1.28-.058-1.689-.072-4.948-.072zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z" />
        </svg>
      </a>
      <a href="https://nextgen-library.blogspot.com/" target="_blank" class="social-btn" title="Blogger">
        <i class="fab fa-blogger"></i>
      </a>
      <a href="https://wa.me/918009401313" target="_blank" class="social-btn" title="WhatsApp">
        <i class="fab fa-whatsapp"></i>
      </a>
    </div>
  </footer>
  <!-- Withdrawal Modal [FIXED POSITION] -->
  <div id="withdrawalModal" class="modal" style="z-index: 20002;">
    <div class="modal-content" style="max-width: 400px; text-align: center;">
      <span class="close-modal" onclick="closeWithdrawalModal()">&times;</span>
      <h2 style="color: #ff4757; text-transform: uppercase; letter-spacing: 2px;">ðŸ’¸ Withdrawal Request</h2>
      <p style="color: #ccc; font-size: 0.9em;">Withdraw your Gold Coins to your UPI ID (1 Coin = â‚¹1)</p>

      <div style="margin-top: 20px; text-align: left;">
        <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 5px;">Withdrawal Amount (Min
          â‚¹100)</label>
        <input type="number" id="withdrawalAmountInput" class="login-input" placeholder="Enter Amount (e.g. 200)"
          style="margin-bottom: 15px;">

        <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 5px;">Your UPI ID (Verify
          carefully)</label>
        <input type="text" id="withdrawalUpiIdInput" class="login-input" placeholder="your-name@upi"
          style="margin-bottom: 20px;">

        <button class="login-btn" onclick="submitWithdrawalRequest()" style="background: #ff4757; color: white;">ðŸš€
          SUBMIT WITHDRAWAL</button>
      </div>

      <p style="margin-top: 15px; font-size: 11px; color: #888;">Payments are usually processed within 24-48 hours after
        admin verification.</p>
    </div>
  </div>
</body>

</html>
